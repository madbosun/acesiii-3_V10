#--------------------------------------------------------------------------|
# This part of code does IP-EOM-CCSD(F12) calculations using               |
# new Davidson algorithm, which generates both left and right              | 
#  eigenvectors. Left eigenvectors are needed for                          | 
#                IP-EOM-CCSD(F12)(T) calculation                           | 
#  Added by Denis Bokhan, Moscow Lomonosov State University,               | 
#                 Moscow, Russian Federation                               | 
#--------------------------------------------------------------------------|


                       SIAL IP_EOMCCSDDAV_F12

#--------------------------------------------------------------|
# Maximal number of roots - 20, maximal number of iteration    |
#             before restart - 15                              |
#--------------------------------------------------------------|

      index   root = 1,20
      index   root1 = 1,20 
      index   root2 = 1,20
      index   target_roots = 1,20
      index   niter =  1,40
      index   niter_main = 1,40
      index   auxind1 = 1,800
      index   auxind2 = 1,800
      index   ind = 1, 3
      index   kk1 = 1,1


#--------------------------------------------------------------|
# Indices for molecular orbitals                               |
#--------------------------------------------------------------|

      moaindex i = baocc, eaocc
      moaindex j = baocc, eaocc
      moaindex k = baocc, eaocc
      moaindex l = baocc, eaocc

      moaindex i1= baocc, eaocc
      moaindex i2= baocc, eaocc
      moaindex i3= baocc, eaocc
#
      moaindex a = bavirt, eavirt
      moaindex a1= bavirt, eavirt
      moaindex a2= bavirt, eavirt
      moaindex a3= bavirt, eavirt
#
       moaindex j1= baocc, eaocc
       moaindex j2= baocc, eaocc
       moaindex j3= baocc, eaocc
#
       moaindex b = bavirt, eavirt
       moaindex b1= bavirt, eavirt
       moaindex b2= bavirt, eavirt
       moaindex b3= bavirt, eavirt
#
       moaindex p = baocc, eavirt
       moaindex p1= baocc, eavirt
       moaindex p2= baocc, eavirt
       moaindex p3= baocc, eavirt
#
       moaindex q = baocc, eavirt
       moaindex q1= baocc, eavirt
       moaindex q2= baocc, eavirt
       moaindex q3= baocc, eavirt
#

#--------------------------------------------------------------|
#            Arrays for Davidson iterations                    |
#--------------------------------------------------------------|


#----------Davidson vectors----------------------------------|
      distributed DAV_R_h_a(i,root,niter)
      distributed DAV_R_h_b(j,root,niter)
      distributed DAV_L_h_a(i,root,niter)
      distributed DAV_L_h_b(j,root,niter)
      
      local DAV_R_local_a(i,root,niter)
      local DAV_R_local_b(j,root,niter)
      local DAV_L_local_a(i,root,niter)
      local DAV_L_local_b(j,root,niter)

      served DAV_R_ija_aaa(i,k,a,root,niter)
      served DAV_R_ija_bbb(j,l,b,root,niter)
      served DAV_R_ija_abb(i,j,b,root,niter)
      served DAV_R_ija_baa(j,i,a,root,niter) 
      served DAV_L_ija_aaa(i,k,a,root,niter)
      served DAV_L_ija_bbb(j,l,b,root,niter)
      served DAV_L_ija_abb(i,j,b,root,niter)
      served DAV_L_ija_baa(j,i,a,root,niter)

      served DAV_aux_ija_aaa(i,k,a)
      served DAV_aux_ija_bbb(j,l,b)


      local DAV_R_local_aaa(i,k,a,root,niter)
      local DAV_R_local_bbb(j,l,b,root,niter)
      local DAV_R_local_abb(i,j,b,root,niter)
      local DAV_R_local_baa(j,i,a,root,niter)
      local DAV_L_local_aaa(i,k,a,root,niter)
      local DAV_L_local_bbb(j,l,b,root,niter)
      local DAV_L_local_abb(i,j,b,root,niter)
      local DAV_L_local_baa(j,i,a,root,niter)

#----------Diagonal elements of Hbar--------------------------|
      distributed DAV_Hbar_diag_a(i)
      distributed DAV_Hbar_diag_b(j)
      served DAV_Hbar_diag_aaa(i,k,a)
      served DAV_Hbar_diag_bbb(j,l,b)
      served DAV_Hbar_diag_abb(i,j,b)
      served DAV_Hbar_diag_baa(j,i,a)
      served diag_aux_aaa(i,a,i1,a1,i2,i3)
      served diag_aux_bbb(j,b,j1,b1,j2,j3)
      served diag_aux_abb(j,b,j1,b1,i2,i3) 
      served diag_aux_baa(i,a,i1,a1,j2,j3)

#-----------Correction vectors -------------------------------|      

      distributed DAV_RC_h_a(i,root)
      distributed DAV_RC_h_b(j,root)
      distributed DAV_LC_h_a(i,root)
      distributed DAV_LC_h_b(j,root)

      distributed DAV_RC_aux_h_a(i,root)
      distributed DAV_RC_aux_h_b(j,root)
      distributed DAV_LC_aux_h_a(i,root)
      distributed DAV_LC_aux_h_b(j,root)


      local DAV_RC_local_a(i,root)
      local DAV_RC_local_b(j,root)
      local DAV_LC_local_a(i,root)
      local DAV_LC_local_b(j,root) 

      served DAV_RC_ija_aaa(i,k,a,root)
      served DAV_RC_ija_bbb(j,l,b,root)
      served DAV_RC_ija_abb(i,j,b,root)
      served DAV_RC_ija_baa(j,i,a,root)
      served DAV_LC_ija_aaa(i,k,a,root)
      served DAV_LC_ija_bbb(j,l,b,root)
      served DAV_LC_ija_abb(i,j,b,root)
      served DAV_LC_ija_baa(j,i,a,root)

      served DAV_RC_aux_ija_aaa(i,k,a,root)
      served DAV_RC_aux_ija_bbb(j,l,b,root)
      served DAV_RC_aux_ija_abb(i,j,b,root)
      served DAV_RC_aux_ija_baa(j,i,a,root)
      served DAV_LC_aux_ija_aaa(i,k,a,root)
      served DAV_LC_aux_ija_bbb(j,l,b,root)
      served DAV_LC_aux_ija_abb(i,j,b,root)
      served DAV_LC_aux_ija_baa(j,i,a,root)


      local DAV_RC_local_aaa(i,k,a,root)
      local DAV_RC_local_bbb(j,l,b,root)
      local DAV_RC_local_abb(i,j,b,root)
      local DAV_RC_local_baa(j,i,a,root)
      local DAV_LC_local_aaa(i,k,a,root)
      local DAV_LC_local_bbb(j,l,b,root)
      local DAV_LC_local_abb(i,j,b,root)
      local DAV_LC_local_baa(j,i,a,root)

#-----------Initial guesses for |R> and <L| vectors-----------|

      distributed DAV_R_initguess_h_a(i,root)
      distributed DAV_R_initguess_h_b(j,root)
      distributed DAV_L_initguess_h_a(i,root)
      distributed DAV_L_initguess_h_b(j,root)

      served DAV_R_initguess_ija_aaa(i,k,a,root)
      served DAV_R_initguess_ija_bbb(j,l,b,root)
      served DAV_R_initguess_ija_abb(i,j,b,root)
      served DAV_R_initguess_ija_baa(j,i,a,root)
      served DAV_L_initguess_ija_aaa(i,k,a,root)
      served DAV_L_initguess_ija_bbb(j,l,b,root)
      served DAV_L_initguess_ija_abb(i,j,b,root)
      served DAV_L_initguess_ija_baa(j,i,a,root)



#-----------Approximation to the |R> and <L|------------------|

      distributed DAV_RX_h_a(i,root,niter)
      distributed DAV_RX_h_b(j,root,niter)
      distributed DAV_LX_h_a(i,root,niter)
      distributed DAV_LX_h_b(j,root,niter)

      distributed DAV_RX_aux_h_a(i,auxind1)
      distributed DAV_RX_aux_h_b(j,auxind1)
      distributed DAV_LX_aux_h_a(i,auxind1)
      distributed DAV_LX_aux_h_b(j,auxind1)

      local DAV_RX_local_a(i,auxind1)
      local DAV_RX_local_b(j,auxind1)
      local DAV_LX_local_a(i,auxind1)
      local DAV_LX_local_b(j,auxind1)

      served DAV_RX_ija_aaa(i,k,a,root,niter)
      served DAV_RX_ija_bbb(j,l,b,root,niter)
      served DAV_RX_ija_abb(i,j,b,root,niter)
      served DAV_RX_ija_baa(j,i,a,root,niter)
      served DAV_LX_ija_aaa(i,k,a,root,niter)
      served DAV_LX_ija_bbb(j,l,b,root,niter)
      served DAV_LX_ija_abb(i,j,b,root,niter)
      served DAV_LX_ija_baa(j,i,a,root,niter)

      served DAV_RX_aux_ija_aaa(i,k,a,auxind1)
      served DAV_RX_aux_ija_bbb(j,l,b,auxind1)
      served DAV_RX_aux_ija_abb(i,j,b,auxind1)
      served DAV_RX_aux_ija_baa(j,i,a,auxind1)
      served DAV_LX_aux_ija_aaa(i,k,a,auxind1)
      served DAV_LX_aux_ija_bbb(j,l,b,auxind1)
      served DAV_LX_aux_ija_abb(i,j,b,auxind1)
      served DAV_LX_aux_ija_baa(j,i,a,auxind1)

      local DAV_RX_local_aaa(i,k,a,auxind1)
      local DAV_RX_local_bbb(j,l,b,auxind1)
      local DAV_RX_local_abb(i,j,b,auxind1)
      local DAV_RX_local_baa(j,i,a,auxind1)
      local DAV_LX_local_aaa(i,k,a,auxind1)
      local DAV_LX_local_bbb(j,l,b,auxind1)
      local DAV_LX_local_abb(i,j,b,auxind1)
      local DAV_LX_local_baa(j,i,a,auxind1)

#--------------------- Hbar|R> --------------------------------| 

      distributed DAV_HR0_h_a(i,root)
      distributed DAV_HR0_h_b(j,root)

      served DAV_HR0_ija_aaa(i,k,a,root)
      served DAV_HR0_ija_bbb(j,l,b,root)
      served DAV_HR0_ija_abb(i,j,b,root)
      served DAV_HR0_ija_baa(j,i,a,root)

      distributed DAV_HR_h_a(i,root)
      distributed DAV_HR_h_b(j,root)

      served DAV_HR_ija_aaa(i,k,a,root)
      served DAV_HR_ija_bbb(j,l,b,root)
      served DAV_HR_ija_abb(i,j,b,root)
      served DAV_HR_ija_baa(j,i,a,root)

#----------------Hbar|R_dav>-----------------------------------|
      distributed DAV_HR_prev_h_a(i,root,niter)
      distributed DAV_HR_prev_h_b(j,root,niter)

      served DAV_HR_prev_ija_aaa(i,k,a,root,niter)
      served DAV_HR_prev_ija_bbb(j,l,b,root,niter)
      served DAV_HR_prev_ija_abb(i,j,b,root,niter)
      served DAV_HR_prev_ija_baa(j,i,a,root,niter)

#----------------Hbar|RC>--------------------------------------|
      distributed DAV_HRC_h_a(i,root)
      distributed DAV_HRC_h_b(j,root)

      served DAV_HRC_ija_aaa(i,k,a,root)
      served DAV_HRC_ija_bbb(j,l,b,root)
      served DAV_HRC_ija_abb(i,j,b,root)
      served DAV_HRC_ija_baa(j,i,a,root)

#--------------------------------------------------------------|
#    Arrays which will be used to dump eigenvalues and         | 
#           eigenvectors to disc                               |
#--------------------------------------------------------------|
      served IP_EVAL(kk1,target_roots)
      served IP_EVEC_R_h_a(i,target_roots)
      served IP_EVEC_R_h_b(j,target_roots)
      served IP_EVEC_R_ija_aaa(i,k,a,target_roots)
      served IP_EVEC_R_ija_bbb(j,l,b,target_roots)
      served IP_EVEC_R_ija_abb(i,l,b,target_roots)
      served IP_EVEC_R_ija_baa(j,k,a,target_roots)
      served IP_EVEC_L_h_a(i,target_roots)
      served IP_EVEC_L_h_b(j,target_roots)             
      served IP_EVEC_L_ija_aaa(i,k,a,target_roots)
      served IP_EVEC_L_ija_bbb(j,l,b,target_roots)
      served IP_EVEC_L_ija_abb(i,l,b,target_roots)
      served IP_EVEC_L_ija_baa(j,k,a,target_roots) 

      served Hbar_ijka_F12(i,j,k,a)
      served Hbar_ijka_F12S(i,j,k,a)

#----------------Temporal arrays-------------------------------|

      temp DAV_temp_R_h_a(i)
      temp DAV_temp_R_h_b(j)
      temp DAV_temp_L_h_a(i)
      temp DAV_temp_L_h_b(j)

      temp DAV_temp_R_h_a_k(i,kk1)
      temp DAV_temp_R_h_b_k(j,kk1)
      temp DAV_temp_L_h_a_k(i,kk1)
      temp DAV_temp_L_h_b_k(j,kk1)

      temp DAV_temp_R_h_a_targ(i,target_roots)
      temp DAV_temp_R_h_b_targ(j,target_roots)
      temp DAV_temp_L_h_a_targ(i,target_roots)
      temp DAV_temp_L_h_b_targ(j,target_roots)



      temp DAV_temp_RC_h_a(i)
      temp DAV_temp_RC_h_b(j)
      temp DAV_temp_LC_h_a(i)
      temp DAV_temp_LC_h_b(j)


      temp DAV_temp_RC_h_a_k(i,kk1)
      temp DAV_temp_RC_h_b_k(j,kk1)
      temp DAV_temp_LC_h_a_k(i,kk1)
      temp DAV_temp_LC_h_b_k(j,kk1)


      temp DAV_temp_2i_RC_h_a(i,root)
      temp DAV_temp_2i_RC_h_b(j,root)
      temp DAV_temp_2i_LC_h_a(i,root)
      temp DAV_temp_2i_LC_h_b(j,root)


      temp DAV_temp_2i_R_h_a(i,root)
      temp DAV_temp_2i_R_h_b(j,root)
      temp DAV_temp_2i_L_h_a(i,root)
      temp DAV_temp_2i_L_h_b(j,root)

      temp DAV_temp_2ii_R_h_a(i,auxind1)
      temp DAV_temp_2ii_R_h_b(j,auxind1)
      temp DAV_temp_2ii_L_h_a(i,auxind1)
      temp DAV_temp_2ii_L_h_b(j,auxind1)


      temp DAV_RX_temp_a(i,auxind1)
      temp DAV_RX_temp_b(j,auxind1)
      temp DAV_LX_temp_a(i,auxind1)
      temp DAV_LX_temp_b(j,auxind1)

      temp DAV_RX_temp_aaa(i,k,a,auxind1)   
      temp DAV_LX_temp_aaa(i,k,a,auxind1)
      temp DAV_RX_temp_bbb(j,l,b,auxind1) 
      temp DAV_LX_temp_bbb(j,l,b,auxind1)
      temp DAV_RX_temp_abb(i,l,b,auxind1)
      temp DAV_LX_temp_abb(i,l,b,auxind1)
      temp DAV_RX_temp_baa(j,i,a,auxind1)
      temp DAV_LX_temp_baa(j,i,a,auxind1)

      temp DAV_RX_temp_aaa_targ(i,k,a,target_roots)
      temp DAV_LX_temp_aaa_targ(i,k,a,target_roots)
      temp DAV_RX_temp_bbb_targ(j,l,b,target_roots)
      temp DAV_LX_temp_bbb_targ(j,l,b,target_roots)
      temp DAV_RX_temp_abb_targ(i,l,b,target_roots)
      temp DAV_LX_temp_abb_targ(i,l,b,target_roots)
      temp DAV_RX_temp_baa_targ(j,i,a,target_roots)
      temp DAV_LX_temp_baa_targ(j,i,a,target_roots)



      temp DAV_R_aux_temp(auxind2,auxind1)  
      temp DAV_L_aux_temp(auxind2,auxind1)

      temp DAV_temp_3i_RC_h_a(i,root,niter)
      temp DAV_temp_3i_RC_h_b(j,root,niter)
      temp DAV_temp_3i_LC_h_a(i,root,niter)
      temp DAV_temp_3i_LC_h_b(j,root,niter)

      temp DAV_temp_3i_R_h_a(i,root,niter)
      temp DAV_temp_3i_R_h_b(j,root,niter)
      temp DAV_temp_3i_L_h_a(i,root,niter)
      temp DAV_temp_3i_L_h_b(j,root,niter)

      temp DAV_temp_R_ija_aaa(i,k,a)
      temp DAV_temp_R_ija_bbb(j,l,b)
      temp DAV_temp_R_ija_abb(i,j,b)
      temp DAV_temp_R_ija_baa(j,i,a)
      temp DAV_temp_L_ija_aaa(i,k,a)
      temp DAV_temp_L_ija_bbb(j,l,b)
      temp DAV_temp_L_ija_abb(i,j,b)
      temp DAV_temp_L_ija_baa(j,i,a)
#-------------------------------------------

      temp DAV_temp_RC_ija_aaa_k(i,k,a,kk1)
      temp DAV_temp_RC_ija_bbb_k(j,l,b,kk1)
      temp DAV_temp_RC_ija_abb_k(i,j,b,kk1)
      temp DAV_temp_RC_ija_baa_k(j,i,a,kk1)
      temp DAV_temp_LC_ija_aaa_k(i,k,a,kk1)
      temp DAV_temp_LC_ija_bbb_k(j,l,b,kk1)
      temp DAV_temp_LC_ija_abb_k(i,j,b,kk1)
      temp DAV_temp_LC_ija_baa_k(j,i,a,kk1)

      temp DAV_temp_R_ija_aaa_k(i,k,a,kk1)
      temp DAV_temp_R_ija_bbb_k(j,l,b,kk1)
      temp DAV_temp_R_ija_abb_k(i,j,b,kk1)
      temp DAV_temp_R_ija_baa_k(j,i,a,kk1)
      temp DAV_temp_L_ija_aaa_k(i,k,a,kk1)
      temp DAV_temp_L_ija_bbb_k(j,l,b,kk1)
      temp DAV_temp_L_ija_abb_k(i,j,b,kk1)
      temp DAV_temp_L_ija_baa_k(j,i,a,kk1)
#-------------------------------------------
#-------------------------------------------

      temp DAV_temp_RC_ija_aaa(i,k,a)
      temp DAV_temp_RC_ija_bbb(j,l,b)
      temp DAV_temp_RC_ija_abb(i,j,b)
      temp DAV_temp_RC_ija_baa(j,i,a)
      temp DAV_temp_LC_ija_aaa(i,k,a)
      temp DAV_temp_LC_ija_bbb(j,l,b)
      temp DAV_temp_LC_ija_abb(i,j,b)
      temp DAV_temp_LC_ija_baa(j,i,a)
#---------------------------------------------
      temp DAV_temp_2i_R_ija_aaa(i,k,a,root1)
      temp DAV_temp_2i_R_ija_bbb(j,l,b,root1)
      temp DAV_temp_2i_R_ija_abb(i,j,b,root1)
      temp DAV_temp_2i_R_ija_baa(j,i,a,root1)
      temp DAV_temp_2i_L_ija_aaa(i,k,a,root1)
      temp DAV_temp_2i_L_ija_bbb(j,l,b,root1)
      temp DAV_temp_2i_L_ija_abb(i,j,b,root1)
      temp DAV_temp_2i_L_ija_baa(j,i,a,root1)

      temp DAV_temp_2ii_R_ija_aaa(i,k,a,auxind1)
      temp DAV_temp_2ii_R_ija_bbb(j,l,b,auxind1)
      temp DAV_temp_2ii_R_ija_abb(i,j,b,auxind1)
      temp DAV_temp_2ii_R_ija_baa(j,i,a,auxind1)
      temp DAV_temp_2ii_L_ija_aaa(i,k,a,auxind1)
      temp DAV_temp_2ii_L_ija_bbb(j,l,b,auxind1)
      temp DAV_temp_2ii_L_ija_abb(i,j,b,auxind1)
      temp DAV_temp_2ii_L_ija_baa(j,i,a,auxind1)


      temp DAV_temp_2i_RC_ija_aaa(i,k,a,root1)
      temp DAV_temp_2i_RC_ija_bbb(j,l,b,root1)
      temp DAV_temp_2i_RC_ija_abb(i,j,b,root1)
      temp DAV_temp_2i_RC_ija_baa(j,i,a,root1)
      temp DAV_temp_2i_LC_ija_aaa(i,k,a,root1)
      temp DAV_temp_2i_LC_ija_bbb(j,l,b,root1)
      temp DAV_temp_2i_LC_ija_abb(i,j,b,root1)
      temp DAV_temp_2i_LC_ija_baa(j,i,a,root1)
#----------------------------------------------------
      temp DAV_temp_3i_R_ija_aaa(i,k,a,root1,niter)
      temp DAV_temp_3i_R_ija_bbb(j,l,b,root1,niter)
      temp DAV_temp_3i_R_ija_abb(i,j,b,root1,niter)
      temp DAV_temp_3i_R_ija_baa(j,i,a,root1,niter)
      temp DAV_temp_3i_L_ija_aaa(i,k,a,root1,niter)
      temp DAV_temp_3i_L_ija_bbb(j,l,b,root1,niter)
      temp DAV_temp_3i_L_ija_abb(i,j,b,root1,niter)
      temp DAV_temp_3i_L_ija_baa(j,i,a,root1,niter)

      temp DAV_temp_3i_RC_ija_aaa(i,k,a,root1,niter)
      temp DAV_temp_3i_RC_ija_bbb(j,l,b,root1,niter)
      temp DAV_temp_3i_RC_ija_abb(i,j,b,root1,niter)
      temp DAV_temp_3i_RC_ija_baa(j,i,a,root1,niter)
      temp DAV_temp_3i_LC_ija_aaa(i,k,a,root1,niter)
      temp DAV_temp_3i_LC_ija_bbb(j,l,b,root1,niter)
      temp DAV_temp_3i_LC_ija_abb(i,j,b,root1,niter)
      temp DAV_temp_3i_LC_ija_baa(j,i,a,root1,niter)
#----------------------------------------------------
      temp kk1_aaa(i,k,a,kk1)
      temp kk1_bbb(j,l,b,kk1)  
      temp kk1_abb(i,j,b,kk1)
      temp kk1_baa(j,i,a,kk1)

      temp t2_aa(a,i,a1,i1)
      temp t2_bb(b,j,b1,j1)
      temp t2_ab(a,i,b1,j1) 
      temp t2_ba(b1,j1,a,i)

      temp tix(i,k)
      temp tjx(j,l)
      temp tiiii(i,i1,i2,i3)
      temp tjjjj(j3,j1,j2,j)
      temp t1aixi(i1,i,a)
      temp t1iaxi_k(i,a2,i3,kk1)
      temp t1aiii(a,i,i1)
      temp t1aiii_k(a,i,i1,kk1)
      temp t1ajxj(j1,j,b)
      temp tjjii(j1,j,i1,i)
      temp tii(i1,i)
      temp tjj(j1,j) 
      temp taa(a,a1)
      temp tbb(b,b1)
      temp tax(a1)
      temp tax1(a1) 
      temp taxk(a1,kk1) 
      temp tbx(b1)
      temp tbx1(b1)
      temp tbxk(b1,kk1)   
      temp tis(i)
      temp t1is(i)
      temp t2is(i)
      temp tjs(j)
      temp t1js(j)
      temp t2js(j)
      temp taixi(a,i,i1)
      temp taixi_k(a,i,i1,kk1)
      temp t2aixi(a,i,i1)
      temp t2aixi_k(a,i,i1,kk1)
      temp t3aixi(a,i,i1)
      temp tbjxj(b,j,j1)
      temp tbjxj_k(b,j,j1,kk1)
      temp t1bjxj(b,j,j1)
      temp t1bjxj_k(b,j,j1,kk1)
      temp t2bjxj(b,j,j1)
      temp t2bjxj_k(b,j,j1,kk1)
      temp t3bjxj(b,j,j1)
      temp tbjxi(b,j,i1)
      temp t1bjxi(b,j,i1)
      temp t2bjxi(b,j,i1)
      temp t3bjxi(b,j,i1)
      temp taixj(a,i,j1)
      temp taixj_k(a,i,j1,kk1)
      temp t1aixj(a,i,j1)
      temp t1aixj_k(a,i,j1,kk1)
      temp t2aixj(a,i,j1)
      temp t2aixj_k(a,i,j1,kk1)
      temp t3aixj(a,i,j1)
      temp tiaix(i2,a,i1)
      temp tiaix_k(i2,a,i1,kk1)
      temp tjbjx(j2,b,j)
      temp tjbjx_k(j2,b,j,kk1)
      temp tjaix(j2,a,i)
      temp tjaix_k(j2,a,i,kk1)
      temp tiajx(i2,a,j1)
      temp tiajx_k(i2,a,j1,kk1)
      temp tibjx(i2,b,j)
      temp tjbix(j2,b,i1)
      temp tjbai_test(j,b,a,i)
      temp tiabj_test(i,a,b,j)
      temp tiijj(i,i1,j2,j3)
      temp taaii(a,a1,i2,i3)
      temp taajj(a,a1,j2,j3)
      temp t1iaxi(i,a2,i3)
      temp tbbjj(b,b1,j2,j3)
      temp tbbii(b,b1,i2,i3)
      temp t1jbxj(j,b2,j3)
      temp t1jbxj_k(j,b2,j3,kk1)
      temp tbjxi_k(b,j,i1,kk1)
      temp t1bjxi_k(b,j,i1,kk1)
      temp t2bjxi_k(b2,j,i1,kk1)
      temp tibjx_k(i2,b,j,kk1) 
      temp tjbix_k(j2,b,i1,kk1)
      temp tbjia(b,j,i,a)  
      temp t_qjpi(b1,j1,a,i)       
      temp Uii_tmp(i,i1) 
      temp t1bixj_k(a1,i,j1,kk1)

      temp diag_temp_aaa(i,a,i1,a1,i2,i3)
      temp diag_temp_bbb(j,b,j1,b1,j2,j3)
      temp diag_temp_abb(j,b,j1,b1,i2,i3)
      temp diag_temp_baa(i,a,i1,a1,j2,j3)

      temp diag_temp1_aaa(i2,i,a,i1,a1,i3)
      temp diag_temp1_bbb(j2,j,b,j1,b1,j3)
      temp diag_temp1_abb(i2,j,b,j1,b1,i3)
      temp diag_temp1_baa(j2,i,a,i1,a1,j3)  

      temp aux_jaja(j,a,j1,a1)
      temp aux_jaik(j,a,i,kk1)
      temp aux_ibib(i,b,i1,b1)
      temp aux_ibjk(i,b,j,kk1)
      temp aux_iaia(i,a,i1,a1)
      temp aux_iajk(i,a,j,kk1)
      temp aux_iajb(i,a,j,b)
      temp aux_jbjk(j,b,j1,kk1)
      temp aux_jiji(j,i,j1,i1)
      temp aux_jbik(j,b,i,kk1)
      temp aux_jbjb(j,b,j1,b1)
      temp aux_iaik(i1,a,i,kk1) 
      temp aux_ijij(i,j,i1,j1)
      temp aux_jjjj(j2,j3,j,j1)
      temp aux_jbai(j2,b1,i1,a)
      temp aux_iiii(i,i1,i2,i3)
      temp aux_jbia(j,b,i,a)
      temp aux_ijbk(i3,j2,b,kk1)
      temp aux_ijak(i2,j3,a,kk1)
      temp aux_jjbk(j3,j2,b,kk1)
      temp aux_iiak(i3,i2,a,kk1) 
      temp tmp_IP_EVAL(kk1,target_roots)
#-----------------Static array - auxiliary matrix -------------|
      static DAV_Haux(auxind1,auxind2)
      static OVER_R(auxind1,root)
      static OVER_L(auxind1,root)
#------some auxiliary static arrays----------------------------|
      static Sii(i,i1)
      static Saa(a,a1)
      static Sjj(j,j1)
      static Sbb(b,b1)
      static Sdii(i,i1)
      static Sdjj(j,j1)
      static Sdaa(a,a1)
      static Sdbb(b,b1) 
#---------------- and its eigenvectors and eigenvalues---------|

       static DAV_roots(root)
       static DAV_R_aux(auxind1,auxind2) 
       static DAV_L_aux(auxind1,auxind2)
       static ip_eomcc_info(kk1,target_roots)
#--------------------------------------------------------------|


       distributed DAV_RC_norm(root)
       distributed DAV_LC_norm(root)    

       temp  DAV_RC_norm_tmp(root)    
       temp  DAV_LC_norm_tmp(root)

       temp DAV_temp_roots(root)
       temp DAV_temp_R_aux(auxind1,auxind2)
       temp DAV_temp_L_aux(auxind1,auxind2)
       temp over_temp(auxind1) 
#-------------some static arrays---------------------------------|
       static over_r_static(auxind1)
       static over_l_static(auxind1)
#-----static arrays for initial guess Hbar matrices--------------|
       static DAV_Hinitguess_a(i,k)
       static DAV_Hinitguess_b(j,l)
       static DAV_R_initguess_static_a(i,root)
       static DAV_L_initguess_static_a(i,root)
       static DAV_R_initguess_static_b(j,root)
       static DAV_L_initguess_static_b(j,root)
#--auxiliary arrays for generation of diagonal elements of Hbar-|
      distributed DDaa(a,a1)
      distributed DDii(i,i1)
      distributed DDia(i,a)
      distributed DDbb(b,b1)
      distributed DDjj(j,j1)
      distributed DDjb(j,b)
#--------Intermediates for 3-body term--------------------------|
      distributed Iax(a)
      distributed Ibx(b)
      distributed I1ax(a)
      distributed I1bx(b) 
#---------------------------------------------------------------|
       scalar rank
       scalar minus 
       scalar VNORM
       scalar COEF_R
       scalar COEF_L

       scalar COEF_R_a
       scalar COEF_L_a
       scalar COEF_R_b
       scalar COEF_L_b
       scalar COEF_R_aaa
       scalar COEF_L_aaa
       scalar COEF_R_bbb
       scalar COEF_L_bbb
       scalar COEF_R_abb
       scalar COEF_L_abb
       scalar COEF_R_baa
       scalar COEF_L_baa

       scalar VNORM_a
       scalar VNORM_b
       scalar VNORM_aaa
       scalar VNORM_bbb
       scalar VNORM_abb
       scalar VNORM_baa
          
       scalar VNORM_aux
       scalar ROVER_aux  
       scalar LOVER_aux
       scalar COEF_R_aux
       scalar COEF_L_aux
       scalar n_roots
       scalar n_target_roots
       scalar cnt_target_roots
       scalar chunk_type
       scalar cnt
       scalar cnt2
       scalar cnt3
       scalar cnt4
       scalar cnt6 
       scalar iter
       scalar iter_one
       scalar cnt_iter
       scalar cnt_iter1
       scalar iter_max 
       scalar tmpval
       scalar tmpval1
       scalar tmpval_R
       scalar tmpval_L
       scalar conv_true
       scalar half
       scalar RCNORM
       scalar LCNORM
       scalar RCNORM_a
       scalar LCNORM_a
       scalar RCNORM_b
       scalar LCNORM_b
       scalar RCNORM_aaa
       scalar LCNORM_aaa
       scalar RCNORM_bbb
       scalar LCNORM_bbb
       scalar RCNORM_abb
       scalar LCNORM_abb
       scalar RCNORM_baa
       scalar LCNORM_baa

       scalar RCNORM_aux
       scalar LCNORM_aux
       scalar tresh
       scalar tresh_denom
       scalar norm_sqrt
       scalar norm_sqr
       scalar haux_val
       scalar haux_val_a
       scalar haux_val_b
       scalar haux_val_aaa
       scalar haux_val_bbb
       scalar haux_val_abb
       scalar haux_val_baa
#--------------------------------|
       scalar over_val_r
       scalar over_val_l
       scalar over_val_r_a 
       scalar over_val_l_a
       scalar over_val_r_b
       scalar over_val_l_b
       scalar over_val_r_aaa
       scalar over_val_l_aaa
       scalar over_val_r_abb
       scalar over_val_l_abb
       scalar over_val_r_bbb
       scalar over_val_l_bbb
       scalar over_val_r_baa
       scalar over_val_l_baa
       scalar qqq  
#--------------------------------|
       scalar Mkcorr
       scalar Mkcorr1
       scalar Mkdav
       scalar ist
       scalar iuu
       scalar iqq
       scalar label1
       scalar label2
       scalar RL
       scalar izz
       scalar maxover_r
       scalar maxover_l
       scalar eig
       scalar printnumber
       scalar odin 
       scalar F12CALC
 
#
#     CCSD amplitudes 
#     --------------- 

      distributed t1a(a,i)
      distributed t1b(b,j)
      served T2aa(a,i,a1,i1)
      served T2bb(b,j,b1,j1)
      served T2ab(a,i,b,j)
#
#     Transformed integrals 
#     --------------------- 
#
      served VSpipi(p,i,p1,i1)
      served VSqjqj(q,j,q1,j1)
      served Vpiqj(p,i,q,j)
      served VSaaai(a,a1,a2,i)
      served VSbbbj(b,b1,b2,j)
      served Vaabj(a,a1,b,j)
      served Vbbai(b,b1,a,i)
      served Vjbii(j,b,i,i1)
      served Viabj(i,a,b,j)
      served Vaajj(a,a1,j,j1)
      served Vbbii(b,b1,i,i1)
      served Viaai(i,a1,a,i1)
      served Vaaii(a,a1,i,i1)
      served Vjbbj(j,b1,b,j1)
      served Vbbjj(b,b1,j,j1)
#
#     HBAR 
#     ---- 
      distributed Uaa(a,a1)
      distributed Ubb(b,b1)
      distributed Uii(i1,i)
      distributed Ujj(j1,j)
      distributed Uia(i,a)
      distributed Ujb(j,b)
#
      served Wiiii(i,i1,i2,i3)
      served Wjjjj(j,j1,j2,j3)
      served Wiijj(i,i1,j,j1)
#
      served Waaia(a,a1,i,a2)
      served Wbbjb(b,b1,j,b2)
      served Waajb(a,a1,j,b2)
      served Wbbia(b,b1,i,a2)
#
      served Wiiia(i1,i,i2,a)
      served Wjjjb(j1,j,j2,b)
      served Wiijb(i1,i,j2,b)
      served Wjjia(j1,j,i2,a)
#
      served Wiiai(i,i1,a,i2)
      served Wiibj(i,i1,b,j)
      served Wjjai(j,j1,a,i)
      served Wjjbj(j,j1,b,j2)
#
      served Wiaai(i1,a1,a,i)
      served Wjbbj(j1,b1,b,j)
      served Wiabj(i,a,b,j)
      served Wjbai(j,b,a,i)
      served Wiibb(i1,i,b,b1)
      served Wjjaa(j1,j,a,a1)
#
      served Waaai(a,a1,a2,i)
      served Wbbbj(b,b1,b2,j)
      served Waabj(a,a1,b,j)
      served Wbbai(b,b1,a,i)
#
# NOT USED ??? 
#
      served Waiaa(a,a1,i,a2) # HBAR_AIBC_aaaa
      served Wbjbb(b,b1,j,b2) # HBAR_AIBC_bbbb
      served Waibb(a,a1,j,b2) # HBAR_AIBC_aabb
      served Wbjaa(b,b1,i,a2) # HBAR_AIBC_bbaa
      served auxint2(a,i,p,j)
      served C_coef(i,j,k,l)
#
      served Waiia(a,i,i1,a1)
      served Wbjjb(b,j,j1,b1)
      served Waijb(a,i,j,b)
      served Wbjia(b,j,i,a)



#===========================================================================|
#     Read integrals and elements of Hbar                                   |
#===========================================================================|

      PROC READ_DATA
#     --------------

      create t1a
      create t1b
      create Uaa
      create Ubb
      create Uii
      create Ujj
      create Uia
      create Ujb
      execute sip_barrier
#
      execute list_to_blocks                VSpipi(p,i,p1,i1)
      execute list_to_blocks                Vaaii
      execute list_to_blocks                Viaai
      execute list_to_blocks                VSaaai
      execute list_to_blocks                VSqjqj(q,j,q1,j1)
      execute list_to_blocks                Vbbjj
      execute list_to_blocks                Vjbbj
      execute list_to_blocks                VSbbbj
      execute list_to_blocks                Vjbii
      execute list_to_blocks                Vbbai
      execute list_to_blocks                Vpiqj(p,i,q,j)
      execute list_to_blocks                Viabj
      execute list_to_blocks                Vaabj
      execute list_to_blocks                Vaajj
      execute list_to_blocks                Vbbii
#
      execute list_to_blocks                t1a
      execute list_to_blocks                t1b
      execute list_to_blocks                T2aa
      execute list_to_blocks                T2ab
      execute list_to_blocks                T2bb
#
      execute list_to_blocks                Uaa
      execute list_to_blocks                Ubb
      execute list_to_blocks                Uii
      execute list_to_blocks                Ujj
      execute list_to_blocks                Uia
      execute list_to_blocks                Ujb
#
      execute list_to_blocks                Wiiii
      execute list_to_blocks                Wjjjj
      execute list_to_blocks                Wiijj
#
      execute list_to_blocks                Waiaa # HBAR_AIBC_aaaa
      execute list_to_blocks                Wbjbb # HBAR_AIBC_bbbb
      execute list_to_blocks                Waibb # HBAR_AIBC_aabb
      execute list_to_blocks                Wbjaa # HBAR_AIBC_bbaa
#
      execute list_to_blocks                Wiiia # HBAR_JKIA_aaaa
      execute list_to_blocks                Wjjjb # HBAR_JKIA_bbbb
      execute list_to_blocks                Wiijb # HBAR_JKIA_aabb
      execute list_to_blocks                Wjjia # HBAR_JKIA_bbaa
#
      execute list_to_blocks                Wiiai # HBAR_IAJK_aaaa
      execute list_to_blocks                Wiibj # HBAR_IAJK_aabb
      execute list_to_blocks                Wjjai # HBAR_IAJK_bbaa
      execute list_to_blocks                Wjjbj # HBAR_IAJK_bbbb
#
      execute list_to_blocks                Wiaai # HBAR_AJIB_aaaa
      execute list_to_blocks                Wjbbj # HBAR_AJIB_bbbb
      execute list_to_blocks                Wiabj # HBAR_AJIB_aabb
      execute list_to_blocks                Wjbai # HBAR_AJIB_BBAA
      execute list_to_blocks                Wiibb # HBAR_AJIB_iibb
      execute list_to_blocks                Wjjaa # HBAR_AJIB_jjaa
#
      execute list_to_blocks                Waaai # HBAR_ABCI_aaaa
      execute list_to_blocks                Wbbbj # HBAR_ABCI_bbbb
      execute list_to_blocks                Waabj # HBAR_ABCI_aabb
      execute list_to_blocks                Wbbai # HBAR_ABCI_bbaa
#      execute list_to_blocks                auxint2
#

#      IF F12CALC == 1.0
#      execute list_to_blocks Hbar_ijka_F12
#      execute list_to_blocks Hbar_ijka_F12S
#      ENDIF

      execute read_list_to_blocks
      execute server_barrier
#

#       PARDO i,a,b,j
#       REQUEST Wiaai(i,a,b,j) i
#       tiabj_test(i,a,b,j) = Wiaai(i,a,b,j)
#       execute dump_amp tiabj_test
#       tjbai_test(j,b,a,i) = tiabj_test(i,a,b,j)
#       PREPARE Wjbai(j,b,a,i) = tjbai_test(j,b,a,i)
#       ENDPARDO i,a,b,j
#       execute server_barrier


#       PARDO i,a,b,j
#       REQUEST Wjbbj(j,b,a,i) j
#       tjbai_test(j,b,a,i) = Wjbbj(j,b,a,i)
#       execute dump_amp tjbai_test
#       ENDPARDO i,a,b,j
#       execute server_barrier


      ENDPROC READ_DATA
#     ----------------- 

#===========================================================================|
#                 Biorthogonalization procedure                             |
#===========================================================================|

           PROC BIORTH
#          -----------
#--on the iteration ITER we have NROOTS*ITER Davidson vectors, which are alreay--|  
#--------  bi-orthonormal with respect to each other ----------------------------|
           cnt = 0.0

#------------Loop over roots------------------------------------|
           DO root1
#----------Check if number of roots is exceeded-----------------|
           cnt += 1.0 
           IF cnt > n_roots
           EXIT
           ENDIF

           

#----------------------------------------------------------------|
#        Subtraction of projection on the other vectors          |
#----------------------------------------------------------------|

#-----------Loop over iterations---------------------------------|
           cnt_iter = 0.0 
                          
           DO niter 
#----------Check if number of current iteration is exceeded------|           
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF

#-----------Second Loop over roots-------------------------------|
           cnt2 = 0.0
            
           DO root2 
#----------Check if number of roots is exceeded------------------|
           cnt2 += 1.0
           IF cnt2 > n_roots
           EXIT
           ENDIF

#----------------------------------------------------------------|
#        Substep 1 - subtraction of previous Davidson vectors    |
#----------------------------------------------------------------|

#----------Norm and Gramm-Schmit coefficients---------------------|
          VNORM = 0.0
          COEF_R = 0.0
          COEF_L = 0.0
         
          VNORM_a = 0.0
          COEF_R_a = 0.0
          COEF_L_a = 0.0

          VNORM_b = 0.0
          COEF_R_b = 0.0
          COEF_L_b = 0.0  
          
          VNORM_aaa = 0.0
          COEF_R_aaa = 0.0
          COEF_L_aaa = 0.0

          VNORM_bbb = 0.0
          COEF_R_bbb = 0.0
          COEF_L_bbb = 0.0

          VNORM_abb = 0.0
          COEF_R_abb = 0.0
          COEF_L_abb = 0.0

          VNORM_baa = 0.0
          COEF_R_baa = 0.0
          COEF_L_baa = 0.0 
#  --------- singles contribution -----------------------------  |

#----------------alpha part------------------------------------  |

          VNORM_aux = 0.0
          COEF_R_aux = 0.0
          COEF_L_aux = 0.0


               PARDO i
                 GET DAV_R_h_a(i,root2,niter)
                 GET DAV_L_h_a(i,root2,niter)
                 GET DAV_RC_h_a(i,root1)
                 GET DAV_LC_h_a(i,root1)


                 DAV_temp_R_h_a(i) = DAV_R_h_a(i,root2,niter)
                 DAV_temp_L_h_a(i) = DAV_L_h_a(i,root2,niter)

                 DAV_temp_RC_h_a(i) = DAV_RC_h_a(i,root1)
                 DAV_temp_LC_h_a(i) = DAV_LC_h_a(i,root1)

                 tmpval =  DAV_temp_L_h_a(i)*DAV_temp_R_h_a(i)
                 tmpval_R = DAV_temp_L_h_a(i)*DAV_temp_RC_h_a(i)
                 tmpval_L = DAV_temp_R_h_a(i)*DAV_temp_LC_h_a(i)
                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L                 

               ENDPARDO i
               
               execute server_barrier  

               collective VNORM_a += VNORM_aux 
               collective COEF_R_a += COEF_R_aux
               collective COEF_L_a += COEF_L_aux



#----------------beta part-------------------------------------  |
               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0

               PARDO j
                 GET DAV_R_h_b(j,root2,niter)
                 GET DAV_L_h_b(j,root2,niter)
                 GET DAV_RC_h_b(j,root1)
                 GET DAV_LC_h_b(j,root1)

                 DAV_temp_R_h_b(j) = DAV_R_h_b(j,root2,niter)
                 DAV_temp_L_h_b(j) = DAV_L_h_b(j,root2,niter)
                 DAV_temp_RC_h_b(j) = DAV_RC_h_b(j,root1)
                 DAV_temp_LC_h_b(j) = DAV_LC_h_b(j,root1)

                 tmpval =  DAV_temp_L_h_b(j)*DAV_temp_R_h_b(j)
                 tmpval_R = DAV_temp_L_h_b(j)*DAV_temp_RC_h_b(j)
                 tmpval_L = DAV_temp_R_h_b(j)*DAV_temp_LC_h_b(j)
                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

               ENDPARDO j

               execute server_barrier

               collective VNORM_b += VNORM_aux
               collective COEF_R_b += COEF_R_aux
               collective COEF_L_b += COEF_L_aux

              
#----------------alpha-alpha-alpha part------------------------  |
               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0

                   PARDO i,k,a
                 REQUEST DAV_R_ija_aaa(i,k,a,root2,niter) i
                 REQUEST DAV_L_ija_aaa(i,k,a,root2,niter) i
                 REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root1) i


                 DAV_temp_R_ija_aaa(i,k,a) = DAV_R_ija_aaa(i,k,a,root2,niter)
                 DAV_temp_L_ija_aaa(i,k,a) = DAV_L_ija_aaa(i,k,a,root2,niter)
                 DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1)
                 DAV_temp_LC_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root1)
               
                 tmpval = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_L_ija_aaa(i,k,a)
                 tmpval_R = DAV_temp_L_ija_aaa(i,k,a)*DAV_temp_RC_ija_aaa(i,k,a)
                 tmpval_L = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_LC_ija_aaa(i,k,a)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

                   ENDPARDO i,k,a 

               execute server_barrier

               collective VNORM_aaa += VNORM_aux
               collective COEF_R_aaa += COEF_R_aux
               collective COEF_L_aaa += COEF_L_aux

#----------------beta-beta-beta part---------------------------  |
               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0


                   PARDO j,l,b
                 REQUEST DAV_R_ija_bbb(j,l,b,root2,niter) j
                 REQUEST DAV_L_ija_bbb(j,l,b,root2,niter) j
                 REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root1) j

                 DAV_temp_R_ija_bbb(j,l,b) = DAV_R_ija_bbb(j,l,b,root2,niter)
                 DAV_temp_L_ija_bbb(j,l,b) = DAV_L_ija_bbb(j,l,b,root2,niter)
                 DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
                 DAV_temp_LC_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root1)

                 tmpval = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_L_ija_bbb(j,l,b)
                 tmpval_R = DAV_temp_L_ija_bbb(j,l,b)*DAV_temp_RC_ija_bbb(j,l,b)
                 tmpval_L = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_LC_ija_bbb(j,l,b)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

                   ENDPARDO j,l,b

               execute server_barrier

               collective VNORM_bbb += VNORM_aux
               collective COEF_R_bbb += COEF_R_aux
               collective COEF_L_bbb += COEF_L_aux
#----------------alpha-beta-beta part--------------------------- |
               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0

                   
                   PARDO i,l,b  
                  REQUEST DAV_R_ija_abb(i,l,b,root2,niter) i
                  REQUEST DAV_L_ija_abb(i,l,b,root2,niter) i
                  REQUEST DAV_RC_ija_abb(i,l,b,root1) i
                  REQUEST DAV_LC_ija_abb(i,l,b,root1) i

                  DAV_temp_R_ija_abb(i,l,b) = DAV_R_ija_abb(i,l,b,root2,niter)
                  DAV_temp_L_ija_abb(i,l,b) = DAV_L_ija_abb(i,l,b,root2,niter)
                  DAV_temp_RC_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root1)
                  DAV_temp_LC_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root1)

                 tmpval = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_L_ija_abb(i,l,b)
                 tmpval_R = DAV_temp_L_ija_abb(i,l,b)*DAV_temp_RC_ija_abb(i,l,b)
                 tmpval_L = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_LC_ija_abb(i,l,b)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

                   ENDPARDO i,l,b

               execute server_barrier

               collective VNORM_abb += VNORM_aux
               collective COEF_R_abb += COEF_R_aux
               collective COEF_L_abb += COEF_L_aux
#----------------beta-alpha-alpha part------------------------  |
               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0


                   PARDO j,k,a
                 REQUEST DAV_R_ija_baa(j,k,a,root2,niter) j
                 REQUEST DAV_L_ija_baa(j,k,a,root2,niter) j
                 REQUEST DAV_RC_ija_baa(j,k,a,root1) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root1) j

                 DAV_temp_R_ija_baa(j,k,a) = DAV_R_ija_baa(j,k,a,root2,niter)
                 DAV_temp_L_ija_baa(j,k,a) = DAV_L_ija_baa(j,k,a,root2,niter)
                 DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
                 DAV_temp_LC_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root1)

                 tmpval = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_L_ija_baa(j,k,a)
                 tmpval_R = DAV_temp_L_ija_baa(j,k,a)*DAV_temp_RC_ija_baa(j,k,a)
                 tmpval_L = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_LC_ija_baa(j,k,a)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

                   ENDPARDO j,k,a

               execute server_barrier

               collective VNORM_baa += VNORM_aux
               collective COEF_R_baa += COEF_R_aux
               collective COEF_L_baa += COEF_L_aux
#-------------------------------------------------------------- |
               COEF_R += COEF_R_a
               COEF_L += COEF_L_a
               COEF_R += COEF_R_b
               COEF_L += COEF_L_b
               COEF_R += COEF_R_aaa
               COEF_L += COEF_L_aaa
               COEF_R += COEF_R_bbb
               COEF_L += COEF_L_bbb
               COEF_R += COEF_R_abb
               COEF_L += COEF_L_abb
               COEF_R += COEF_R_baa
               COEF_L += COEF_L_baa

               VNORM += VNORM_a
               VNORM += VNORM_b
               VNORM += VNORM_aaa
               VNORM += VNORM_bbb
               VNORM += VNORM_abb
               VNORM += VNORM_baa

               execute server_barrier 
#-------------------------------------------------------------- |
               norm_sqr = VNORM
               norm_sqr *= VNORM
               half = 0.5

               execute square_root norm_sqr half

               tmpval = 1.0/VNORM

#               IF norm_sqr > tresh_denom   
               tmpval = 1.0/VNORM
               COEF_R *= tmpval
               COEF_L *= tmpval
#               ENDIF

#               execute print_scalar VNORM
#-----------Gramm - Schmit coefficients are done--------------- |
#-----------Now the subtraction itselfs------------------------ |


#----------------alpha part-----------------------------------  |

                               PARDO i

                 GET DAV_R_h_a(i,root2,niter)
                 GET DAV_L_h_a(i,root2,niter)

                 DAV_temp_R_h_a(i) = DAV_R_h_a(i,root2,niter)
                 DAV_temp_L_h_a(i) = DAV_L_h_a(i,root2,niter)
             
                  DAV_temp_2i_R_h_a(i,root1) = 0.0
                  DAV_temp_2i_L_h_a(i,root1) = 0.0

                 DAV_temp_R_h_a(i) *= COEF_R 
                 DAV_temp_L_h_a(i) *= COEF_L
                 DAV_temp_R_h_a(i) *= -1.0
                 DAV_temp_L_h_a(i) *= -1.0

                 
                 execute addrootindex DAV_temp_R_h_a DAV_temp_2i_R_h_a
                 execute addrootindex DAV_temp_L_h_a DAV_temp_2i_L_h_a

                   
                 PUT DAV_RC_h_a(i,root1) += DAV_temp_2i_R_h_a(i,root1)
                 PUT DAV_LC_h_a(i,root1) += DAV_temp_2i_L_h_a(i,root1)
                               ENDPARDO i

               execute sip_barrier

#----------------beta part------------------------------------  |

                               PARDO j

                 GET DAV_R_h_b(j,root2,niter)
                 GET DAV_L_h_b(j,root2,niter)

                 DAV_temp_R_h_b(j) = DAV_R_h_b(j,root2,niter)
                 DAV_temp_L_h_b(j) = DAV_L_h_b(j,root2,niter)

                  DAV_temp_2i_R_h_b(j,root1) = 0.0
                  DAV_temp_2i_L_h_b(j,root1) = 0.0

                 DAV_temp_R_h_b(j) *= COEF_R
                 DAV_temp_L_h_b(j) *= COEF_L
                 DAV_temp_R_h_b(j) *= -1.0
                 DAV_temp_L_h_b(j) *= -1.0

                 execute addrootindex DAV_temp_R_h_b DAV_temp_2i_R_h_b
                 execute addrootindex DAV_temp_L_h_b DAV_temp_2i_L_h_b

                 PUT DAV_RC_h_b(j,root1) += DAV_temp_2i_R_h_b(j,root1)
                 PUT DAV_LC_h_b(j,root1) += DAV_temp_2i_L_h_b(j,root1)

                               ENDPARDO j

               execute sip_barrier

#----------------alpha-alpha-alpha part------------------------  |

                   PARDO i,k,a
                 REQUEST DAV_R_ija_aaa(i,k,a,root2,niter) i
                 REQUEST DAV_L_ija_aaa(i,k,a,root2,niter) i

                 DAV_temp_R_ija_aaa(i,k,a) = DAV_R_ija_aaa(i,k,a,root2,niter)
                 DAV_temp_L_ija_aaa(i,k,a) = DAV_L_ija_aaa(i,k,a,root2,niter)

                 DAV_temp_2i_R_ija_aaa(i,k,a,root1) = 0.0
                 DAV_temp_2i_L_ija_aaa(i,k,a,root1) = 0.0

                 DAV_temp_R_ija_aaa(i,k,a) *= COEF_R
                 DAV_temp_L_ija_aaa(i,k,a) *= COEF_L 
                 DAV_temp_R_ija_aaa(i,k,a) *= -1.0
                 DAV_temp_L_ija_aaa(i,k,a) *= -1.0
 
                   execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
                   execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa 

                   PREPARE DAV_RC_ija_aaa(i,k,a,root1) += DAV_temp_2i_R_ija_aaa(i,k,a,root1)               
                   PREPARE DAV_LC_ija_aaa(i,k,a,root1) += DAV_temp_2i_L_ija_aaa(i,k,a,root1)

                   ENDPARDO i,k,a

               execute server_barrier
                   
#----------------beta-beta-beta part---------------------------  |

                   PARDO j,l,b
                 REQUEST DAV_R_ija_bbb(j,l,b,root2,niter) j
                 REQUEST DAV_L_ija_bbb(j,l,b,root2,niter) j

                 DAV_temp_R_ija_bbb(j,l,b) = DAV_R_ija_bbb(j,l,b,root2,niter)
                 DAV_temp_L_ija_bbb(j,l,b) = DAV_L_ija_bbb(j,l,b,root2,niter)

                 DAV_temp_2i_R_ija_bbb(j,l,b,root1) = 0.0
                 DAV_temp_2i_L_ija_bbb(j,l,b,root1) = 0.0


                 DAV_temp_R_ija_bbb(j,l,b) *= COEF_R
                 DAV_temp_L_ija_bbb(j,l,b) *= COEF_L
                 DAV_temp_R_ija_bbb(j,l,b) *= -1.0
                 DAV_temp_L_ija_bbb(j,l,b) *= -1.0

                   execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
                   execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_L_ija_bbb  

                   PREPARE DAV_RC_ija_bbb(j,l,b,root1) += DAV_temp_2i_R_ija_bbb(j,l,b,root1)
                   PREPARE DAV_LC_ija_bbb(j,l,b,root1) += DAV_temp_2i_L_ija_bbb(j,l,b,root1)

                   ENDPARDO j,l,b

               execute server_barrier


#----------------alpha-beta-beta part--------------------------- |
                   PARDO i,l,b
                 REQUEST DAV_R_ija_abb(i,l,b,root2,niter) i
                 REQUEST DAV_L_ija_abb(i,l,b,root2,niter) i

                 DAV_temp_R_ija_abb(i,l,b) = DAV_R_ija_abb(i,l,b,root2,niter)
                 DAV_temp_L_ija_abb(i,l,b) = DAV_L_ija_abb(i,l,b,root2,niter)

                 DAV_temp_2i_R_ija_abb(i,l,b,root1) = 0.0
                 DAV_temp_2i_L_ija_abb(i,l,b,root1) = 0.0


                 DAV_temp_R_ija_abb(i,l,b) *= COEF_R
                 DAV_temp_L_ija_abb(i,l,b) *= COEF_L
                 DAV_temp_R_ija_abb(i,l,b) *= -1.0
                 DAV_temp_L_ija_abb(i,l,b) *= -1.0

                   execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
                   execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_L_ija_abb

                   PREPARE DAV_RC_ija_abb(i,l,b,root1) += DAV_temp_2i_R_ija_abb(i,l,b,root1)
                   PREPARE DAV_LC_ija_abb(i,l,b,root1) += DAV_temp_2i_L_ija_abb(i,l,b,root1)

                   ENDPARDO i,l,b

               execute server_barrier

#----------------beta-alpha-alpha part-------------------------  |
                   PARDO j,k,a


                 REQUEST DAV_R_ija_baa(j,k,a,root2,niter) j
                 REQUEST DAV_L_ija_baa(j,k,a,root2,niter) j

                 DAV_temp_R_ija_baa(j,k,a) = DAV_R_ija_baa(j,k,a,root2,niter)
                 DAV_temp_L_ija_baa(j,k,a) = DAV_L_ija_baa(j,k,a,root2,niter)

                 DAV_temp_2i_R_ija_baa(j,k,a,root1) = 0.0
                 DAV_temp_2i_L_ija_baa(j,k,a,root1) = 0.0

                 DAV_temp_R_ija_baa(j,k,a) *= COEF_R
                 DAV_temp_L_ija_baa(j,k,a) *= COEF_L
                 DAV_temp_R_ija_baa(j,k,a) *= -1.0
                 DAV_temp_L_ija_baa(j,k,a) *= -1.0

                   execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
                   execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_L_ija_baa

                   PREPARE DAV_RC_ija_baa(j,k,a,root1) += DAV_temp_2i_R_ija_baa(j,k,a,root1)
                   PREPARE DAV_LC_ija_baa(j,k,a,root1) += DAV_temp_2i_L_ija_baa(j,k,a,root1)

                   ENDPARDO j,k,a

               execute server_barrier




#------------End of second loop over roots-----------------------|
           ENDDO root2 
#------------End of loop over iterations-------------------------|
           ENDDO niter

#====================================================================================

#--------------------------------------------------------------------------------|
#        Substep 2 - subtraction of orthogonolized new vectors                   |
#--------------------------------------------------------------------------------|

          cnt3 = cnt
          cnt3 -= 1.0
          cnt4 = 0.0

#-----------------Loop over previous roots --------------------------------------|
          DO root2
          cnt4 += 1.0
          IF cnt4 > cnt3
          EXIT
          ENDIF

#----------Norm and Gramm-Schmit coefficients---------------------|

          VNORM = 0.0
          COEF_R = 0.0
          COEF_L = 0.0

          VNORM_a = 0.0
          COEF_R_a = 0.0
          COEF_L_a = 0.0

          VNORM_b = 0.0
          COEF_R_b = 0.0
          COEF_L_b = 0.0

          VNORM_aaa = 0.0
          COEF_R_aaa = 0.0
          COEF_L_aaa = 0.0

          VNORM_bbb = 0.0
          COEF_R_bbb = 0.0
          COEF_L_bbb = 0.0

          VNORM_abb = 0.0
          COEF_R_abb = 0.0
          COEF_L_abb = 0.0

          VNORM_baa = 0.0
          COEF_R_baa = 0.0
          COEF_L_baa = 0.0

#  --------- singles contribution ------------------------------  |


#-----------------alpha part------------------------------------  |

          VNORM_aux = 0.0
          COEF_R_aux = 0.0
          COEF_L_aux = 0.0


               PARDO i
                 GET DAV_RC_h_a(i,root2)
                 GET DAV_LC_h_a(i,root2)
                 GET DAV_RC_h_a(i,root1)
                 GET DAV_LC_h_a(i,root1)

                 DAV_temp_R_h_a(i) = DAV_RC_h_a(i,root2)
                 DAV_temp_L_h_a(i) = DAV_LC_h_a(i,root2)
                 DAV_temp_RC_h_a(i) = DAV_RC_h_a(i,root1)
                 DAV_temp_LC_h_a(i) = DAV_LC_h_a(i,root1)

                 tmpval =  DAV_temp_L_h_a(i)*DAV_temp_R_h_a(i)
                 tmpval_R = DAV_temp_L_h_a(i)*DAV_temp_RC_h_a(i)
                 tmpval_L = DAV_temp_R_h_a(i)*DAV_temp_LC_h_a(i)
                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

               ENDPARDO i

               execute server_barrier

               collective VNORM_a += VNORM_aux
               collective COEF_R_a += COEF_R_aux
               collective COEF_L_a += COEF_L_aux

#----------------------beta part--------------------------------  |

               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0

               PARDO j
                 GET DAV_RC_h_b(j,root2)
                 GET DAV_LC_h_b(j,root2)
                 GET DAV_RC_h_b(j,root1)
                 GET DAV_LC_h_b(j,root1)

                 DAV_temp_R_h_b(j) = DAV_RC_h_b(j,root2)
                 DAV_temp_L_h_b(j) = DAV_LC_h_b(j,root2)
                 DAV_temp_RC_h_b(j) = DAV_RC_h_b(j,root1)
                 DAV_temp_LC_h_b(j) = DAV_LC_h_b(j,root1)

                 tmpval =  DAV_temp_L_h_b(j)*DAV_temp_R_h_b(j)
                 tmpval_R = DAV_temp_L_h_b(j)*DAV_temp_RC_h_b(j)
                 tmpval_L = DAV_temp_R_h_b(j)*DAV_temp_LC_h_b(j)
                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

               ENDPARDO j

               execute sip_barrier

               collective VNORM_b += VNORM_aux
               collective COEF_R_b += COEF_R_aux
               collective COEF_L_b += COEF_L_aux


#----------------alpha-alpha-alpha part------------------------  |

               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0

                   PARDO i,k,a
                 REQUEST DAV_RC_ija_aaa(i,k,a,root2) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root2) i
                 REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root1) i

                 DAV_temp_R_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root2)
                 DAV_temp_L_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root2)
                 DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1)
                 DAV_temp_LC_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root1)

                 tmpval = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_L_ija_aaa(i,k,a)
                 tmpval_R = DAV_temp_L_ija_aaa(i,k,a)*DAV_temp_RC_ija_aaa(i,k,a)
                 tmpval_L = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_LC_ija_aaa(i,k,a)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

                   ENDPARDO i,k,a

               execute server_barrier

               collective VNORM_aaa += VNORM_aux
               collective COEF_R_aaa += COEF_R_aux
               collective COEF_L_aaa += COEF_L_aux


#----------------beta-beta-beta part---------------------------  |

               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0


                   PARDO j,l,b
                 REQUEST DAV_RC_ija_bbb(j,l,b,root2) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root2) j
                 REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root1) j

                 DAV_temp_R_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root2)
                 DAV_temp_L_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root2)
                 DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
                 DAV_temp_LC_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root1)

                 tmpval = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_L_ija_bbb(j,l,b)
                 tmpval_R = DAV_temp_L_ija_bbb(j,l,b)*DAV_temp_RC_ija_bbb(j,l,b)
                 tmpval_L = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_LC_ija_bbb(j,l,b)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L



                   ENDPARDO j,l,b

               execute server_barrier

               collective VNORM_bbb += VNORM_aux
               collective COEF_R_bbb += COEF_R_aux
               collective COEF_L_bbb += COEF_L_aux
#----------------alpha-beta-beta part--------------------------- |
               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0


                   PARDO i,l,b
                  REQUEST DAV_RC_ija_abb(i,l,b,root2) i
                  REQUEST DAV_LC_ija_abb(i,l,b,root2) i
                  REQUEST DAV_RC_ija_abb(i,l,b,root1) i
                  REQUEST DAV_LC_ija_abb(i,l,b,root1) i

                  DAV_temp_R_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root2)
                  DAV_temp_L_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root2)
                  DAV_temp_RC_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root1)
                  DAV_temp_LC_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root1)

                 tmpval = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_L_ija_abb(i,l,b)
                 tmpval_R = DAV_temp_L_ija_abb(i,l,b)*DAV_temp_RC_ija_abb(i,l,b)
                 tmpval_L = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_LC_ija_abb(i,l,b)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

                   ENDPARDO i,l,b

               execute server_barrier

               collective VNORM_abb += VNORM_aux
               collective COEF_R_abb += COEF_R_aux
               collective COEF_L_abb += COEF_L_aux
#----------------beta-alpha-alpha part------------------------  |

               VNORM_aux = 0.0
               COEF_R_aux = 0.0
               COEF_L_aux = 0.0


                   PARDO j,k,a
                 REQUEST DAV_RC_ija_baa(j,k,a,root2) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root2) j
                 REQUEST DAV_RC_ija_baa(j,k,a,root1) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root1) j

                 DAV_temp_R_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root2)
                 DAV_temp_L_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root2)
                 DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
                 DAV_temp_LC_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root1)

                 tmpval = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_L_ija_baa(j,k,a)
                 tmpval_R = DAV_temp_L_ija_baa(j,k,a)*DAV_temp_RC_ija_baa(j,k,a)
                 tmpval_L = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_LC_ija_baa(j,k,a)

                 VNORM_aux += tmpval
                 COEF_R_aux += tmpval_R
                 COEF_L_aux += tmpval_L

                   ENDPARDO j,k,a

               execute server_barrier

               collective VNORM_baa += VNORM_aux
               collective COEF_R_baa += COEF_R_aux
               collective COEF_L_baa += COEF_L_aux
#---------------------------------------------------------------|

               COEF_R += COEF_R_a
               COEF_L += COEF_L_a
               COEF_R += COEF_R_b
               COEF_L += COEF_L_b
               COEF_R += COEF_R_aaa
               COEF_L += COEF_L_aaa
               COEF_R += COEF_R_bbb
               COEF_L += COEF_L_bbb
               COEF_R += COEF_R_abb
               COEF_L += COEF_L_abb
               COEF_R += COEF_R_baa
               COEF_L += COEF_L_baa

               VNORM += VNORM_a
               VNORM += VNORM_b
               VNORM += VNORM_aaa
               VNORM += VNORM_bbb
               VNORM += VNORM_abb
               VNORM += VNORM_baa


#-------------------------------------------------------------- |

               norm_sqr = VNORM
               norm_sqr *= VNORM
               half = 0.5

               execute square_root norm_sqr half

#               IF norm_sqr > tresh_denom
               tmpval = 1.0/VNORM
               COEF_R *= tmpval
               COEF_L *= tmpval
#               ENDIF



             

#-----------Gramm - Schmit coefficients are done--------------- |
#-----------Now the subtraction itselfs------------------------ |


#----------------alpha part-----------------------------------  |

                               PARDO i
                 GET DAV_RC_h_a(i,root2)
                 GET DAV_LC_h_a(i,root2)

                 DAV_temp_R_h_a(i) = DAV_RC_h_a(i,root2)
                 DAV_temp_L_h_a(i) = DAV_LC_h_a(i,root2)

                 DAV_temp_2i_R_h_a(i,root1) = 0.0
                 DAV_temp_2i_L_h_a(i,root1) = 0.0

                 DAV_temp_R_h_a(i) *= COEF_R
                 DAV_temp_L_h_a(i) *= COEF_L
                 DAV_temp_R_h_a(i) *= -1.0
                 DAV_temp_L_h_a(i) *= -1.0

                 execute addrootindex DAV_temp_R_h_a DAV_temp_2i_R_h_a
                 execute addrootindex DAV_temp_L_h_a DAV_temp_2i_L_h_a


                 PUT DAV_RC_aux_h_a(i,root1) = DAV_temp_2i_R_h_a(i,root1)
                 PUT DAV_LC_aux_h_a(i,root1) = DAV_temp_2i_L_h_a(i,root1)

                               ENDPARDO i

               execute sip_barrier

               PARDO i           
               GET DAV_RC_aux_h_a(i,root1)
               GET DAV_LC_aux_h_a(i,root1)
               DAV_temp_2i_R_h_a(i,root1) = DAV_RC_aux_h_a(i,root1)
               DAV_temp_2i_L_h_a(i,root1) = DAV_LC_aux_h_a(i,root1)       
               PUT DAV_RC_h_a(i,root1) += DAV_temp_2i_R_h_a(i,root1)
               PUT DAV_LC_h_a(i,root1) += DAV_temp_2i_L_h_a(i,root1) 
               ENDPARDO i

               execute sip_barrier

#----------------beta part------------------------------------  |
                               PARDO j
                 GET DAV_RC_h_b(j,root2)
                 GET DAV_LC_h_b(j,root2)

                 DAV_temp_R_h_b(j) = DAV_RC_h_b(j,root2)
                 DAV_temp_L_h_b(j) = DAV_LC_h_b(j,root2)

                 DAV_temp_2i_R_h_b(j,root1) = 0.0
                 DAV_temp_2i_L_h_b(j,root1) = 0.0

                 DAV_temp_R_h_b(j) *= COEF_R
                 DAV_temp_L_h_b(j) *= COEF_L
                 DAV_temp_R_h_b(j) *= -1.0
                 DAV_temp_L_h_b(j) *= -1.0

                 execute addrootindex DAV_temp_R_h_b DAV_temp_2i_R_h_b
                 execute addrootindex DAV_temp_L_h_b DAV_temp_2i_L_h_b

                 PUT DAV_RC_aux_h_b(j,root1) = DAV_temp_2i_R_h_b(j,root1)
                 PUT DAV_RC_aux_h_b(j,root1) = DAV_temp_2i_L_h_b(j,root1)
                               ENDPARDO j

               execute sip_barrier

               PARDO j 
               GET DAV_RC_aux_h_b(j,root1)
               GET DAV_LC_aux_h_b(j,root1)
               DAV_temp_2i_R_h_b(j,root1) = DAV_RC_aux_h_b(j,root1)
               DAV_temp_2i_L_h_b(j,root1) = DAV_LC_aux_h_b(j,root1)
               PUT DAV_RC_h_b(j,root1) += DAV_temp_2i_R_h_b(j,root1)
               PUT DAV_LC_h_b(j,root1) += DAV_temp_2i_L_h_b(j,root1)
               ENDPARDO j

               execute sip_barrier


#----------------alpha-alpha-alpha part------------------------  |

                   PARDO i,k,a
                 REQUEST DAV_RC_ija_aaa(i,k,a,root2) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root2) i

                 DAV_temp_R_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root2)
                 DAV_temp_L_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root2)

                 DAV_temp_2i_R_ija_aaa(i,k,a,root1) = 0.0
                 DAV_temp_2i_L_ija_aaa(i,k,a,root1) = 0.0

                 DAV_temp_R_ija_aaa(i,k,a) *= COEF_R
                 DAV_temp_L_ija_aaa(i,k,a) *= COEF_L
                 DAV_temp_R_ija_aaa(i,k,a) *= -1.0
                 DAV_temp_L_ija_aaa(i,k,a) *= -1.0

                 execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
                 execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa



                   PREPARE DAV_RC_aux_ija_aaa(i,k,a,root1) = DAV_temp_2i_R_ija_aaa(i,k,a,root1)
                   PREPARE DAV_LC_aux_ija_aaa(i,k,a,root1) = DAV_temp_2i_L_ija_aaa(i,k,a,root1)

                   ENDPARDO i,k,a

               execute server_barrier

               PARDO i,k,a
               REQUEST DAV_RC_aux_ija_aaa(i,k,a,root1) i
               REQUEST DAV_LC_aux_ija_aaa(i,k,a,root1) i          
               DAV_temp_2i_R_ija_aaa(i,k,a,root1) = DAV_RC_aux_ija_aaa(i,k,a,root1)
               DAV_temp_2i_L_ija_aaa(i,k,a,root1) = DAV_LC_aux_ija_aaa(i,k,a,root1)
               PREPARE DAV_RC_ija_aaa(i,k,a,root1) += DAV_RC_aux_ija_aaa(i,k,a,root1)
               PREPARE DAV_LC_ija_aaa(i,k,a,root1) += DAV_LC_aux_ija_aaa(i,k,a,root1)
               ENDPARDO i,k,a
               execute server_barrier  
 
#----------------beta-beta-beta part---------------------------  |

                   PARDO j,l,b
                 REQUEST DAV_RC_ija_bbb(j,l,b,root2) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root2) j

                 DAV_temp_R_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root2)
                 DAV_temp_L_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root2)

                 DAV_temp_2i_R_ija_bbb(j,l,b,root1) = 0.0
                 DAV_temp_2i_L_ija_bbb(j,l,b,root1) = 0.0

                 DAV_temp_R_ija_bbb(j,l,b) *= COEF_R
                 DAV_temp_L_ija_bbb(j,l,b) *= COEF_L
                 DAV_temp_R_ija_bbb(j,l,b) *= -1.0
                 DAV_temp_L_ija_bbb(j,l,b) *= -1.0

                 execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
                 execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_L_ija_bbb

                   PREPARE DAV_RC_aux_ija_bbb(j,l,b,root1) = DAV_temp_2i_R_ija_bbb(j,l,b,root1)
                   PREPARE DAV_LC_aux_ija_bbb(j,l,b,root1) = DAV_temp_2i_L_ija_bbb(j,l,b,root1)

                   ENDPARDO j,l,b

               execute server_barrier

                 PARDO j,l,b
                 REQUEST DAV_RC_aux_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_aux_ija_bbb(j,l,b,root1) j
                 DAV_temp_2i_R_ija_bbb(j,l,b,root1) = DAV_RC_aux_ija_bbb(j,l,b,root1)
                 DAV_temp_2i_L_ija_bbb(j,l,b,root1) = DAV_LC_aux_ija_bbb(j,l,b,root1)
                 PREPARE DAV_RC_ija_bbb(j,l,b,root1) += DAV_temp_2i_R_ija_bbb(j,l,b,root1)
                 PREPARE DAV_LC_ija_bbb(j,l,b,root1) += DAV_temp_2i_L_ija_bbb(j,l,b,root1)
                 ENDPARDO j,l,b
                 execute server_barrier

#----------------alpha-beta-beta part--------------------------- |

                   PARDO i,l,b

                 REQUEST DAV_RC_ija_abb(i,l,b,root2) i
                 REQUEST DAV_LC_ija_abb(i,l,b,root2) i

                 DAV_temp_R_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root2)
                 DAV_temp_L_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root2)

                 DAV_temp_2i_R_ija_abb(i,l,b,root1) = 0.0
                 DAV_temp_2i_L_ija_abb(i,l,b,root1) = 0.0

                 DAV_temp_R_ija_abb(i,l,b) *= COEF_R
                 DAV_temp_L_ija_abb(i,l,b) *= COEF_L
                 DAV_temp_R_ija_abb(i,l,b) *= -1.0
                 DAV_temp_L_ija_abb(i,l,b) *= -1.0

                 execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
                 execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_L_ija_abb

                   PREPARE DAV_RC_aux_ija_abb(i,l,b,root1) = DAV_temp_2i_R_ija_abb(i,l,b,root1)
                   PREPARE DAV_LC_aux_ija_abb(i,l,b,root1) = DAV_temp_2i_L_ija_abb(i,l,b,root1)

                   ENDPARDO i,l,b

               execute server_barrier

                 PARDO i,l,b
                 REQUEST DAV_RC_aux_ija_abb(i,l,b,root1) i
                 REQUEST DAV_LC_aux_ija_abb(i,l,b,root1) i
                 DAV_temp_2i_R_ija_abb(i,l,b,root1) = DAV_RC_aux_ija_abb(i,l,b,root1)
                 DAV_temp_2i_L_ija_abb(i,l,b,root1) = DAV_LC_aux_ija_abb(i,l,b,root1)
                 PREPARE DAV_RC_ija_abb(i,l,b,root1) += DAV_temp_2i_R_ija_abb(i,l,b,root1)
                 PREPARE DAV_LC_ija_abb(i,l,b,root1) += DAV_temp_2i_L_ija_abb(i,l,b,root1)
                 ENDPARDO i,l,b
                 execute server_barrier

#----------------beta-alpha-alpha part-------------------------  |

                   PARDO j,k,a
                 REQUEST DAV_RC_ija_baa(j,k,a,root2) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root2) j

                 DAV_temp_R_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root2)
                 DAV_temp_L_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root2)

                 DAV_temp_2i_R_ija_baa(j,k,a,root1) = 0.0
                 DAV_temp_2i_L_ija_baa(j,k,a,root1) = 0.0

                 DAV_temp_R_ija_baa(j,k,a) *= COEF_R
                 DAV_temp_L_ija_baa(j,k,a) *= COEF_L
                 DAV_temp_R_ija_baa(j,k,a) *= -1.0
                 DAV_temp_L_ija_baa(j,k,a) *= -1.0

                 execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
                 execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_L_ija_baa

                   PREPARE DAV_RC_aux_ija_baa(j,k,a,root1) = DAV_temp_2i_R_ija_baa(j,k,a,root1)
                   PREPARE DAV_LC_aux_ija_baa(j,k,a,root1) = DAV_temp_2i_L_ija_baa(j,k,a,root1)

                   ENDPARDO j,k,a

               execute server_barrier

               PARDO j,k,a
               REQUEST DAV_RC_aux_ija_baa(j,k,a,root1) j
               REQUEST DAV_LC_aux_ija_baa(j,k,a,root1) j
               DAV_temp_2i_R_ija_baa(j,k,a,root1) = DAV_RC_aux_ija_baa(j,k,a,root1)
               DAV_temp_2i_L_ija_baa(j,k,a,root1) = DAV_LC_aux_ija_baa(j,k,a,root1)
               PREPARE DAV_RC_ija_baa(j,k,a,root1) += DAV_RC_aux_ija_baa(j,k,a,root1)
               PREPARE DAV_LC_ija_baa(j,k,a,root1) += DAV_LC_aux_ija_baa(j,k,a,root1)
               ENDPARDO j,k,a
               execute server_barrier


#-----------End of loop over roots-------------------------------|
           ENDDO root2
#------------End of loop over roots-----------------------------|            
           ENDDO root1

#=========================================================================
# ------------Normalization of orthogonalized vectors--------------------|
#=========================================================================

#-----------Loop over iterations---------------------------------|
           cnt_iter1 = iter
           cnt_iter1 += 1.0
           cnt_iter = 0.0

           DO niter
#----------Check if number of current iteration is exceeded------|           
           cnt_iter += 1.0
           IF cnt_iter ==  cnt_iter1
                                                            
           cnt = 0.0
#----------Loop over roots--------------------------------------|
           DO root1
#----------Check if number of roots is exceeded-----------------|
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF
#---------------------------------------------------------------
          VNORM = 0.0
          VNORM_a = 0.0
          VNORM_b = 0.0
          VNORM_aaa = 0.0
          VNORM_bbb = 0.0
          VNORM_abb = 0.0
          VNORM_baa = 0.0
#-----------------alpha-alpha part------------------------------|
           VNORM_aux = 0.0

               PARDO i
                 GET DAV_RC_h_a(i,root1)
                 GET DAV_LC_h_a(i,root1)

                 DAV_temp_RC_h_a(i) = DAV_RC_h_a(i,root1)
                 DAV_temp_LC_h_a(i) = DAV_LC_h_a(i,root1)

                 tmpval =  DAV_temp_LC_h_a(i)*DAV_temp_RC_h_a(i)
                 VNORM_aux += tmpval

               ENDPARDO i

               execute server_barrier

               collective VNORM_a += VNORM_aux
#-------------------beta-beta part------------------------------|
               VNORM_aux = 0.0

               PARDO j
                 GET DAV_RC_h_b(j,root1)
                 GET DAV_LC_h_b(j,root1)

                 DAV_temp_RC_h_b(j) = DAV_RC_h_b(j,root1)
                 DAV_temp_LC_h_b(j) = DAV_LC_h_b(j,root1)

                 tmpval =  DAV_temp_LC_h_b(j)*DAV_temp_RC_h_b(j)
                 VNORM_aux += tmpval

               ENDPARDO j

               execute server_barrier

               collective VNORM_b += VNORM_aux
#--------------alpha-alpha-alpha part----------------------------|

               VNORM_aux = 0.0

                   PARDO i,k,a
                 REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root1) i


                 DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1)
                 DAV_temp_LC_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root1)


                 tmpval = DAV_temp_RC_ija_aaa(i,k,a)*DAV_temp_LC_ija_aaa(i,k,a)

                 VNORM_aux += tmpval

                   ENDPARDO i,k,a

               execute server_barrier

               collective VNORM_aaa += VNORM_aux
#--------------beta-beta-beta part-------------------------------|
               VNORM_aux = 0.0

                   PARDO j,l,b
                 REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root1) j

                 DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
                 DAV_temp_LC_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root1)

                 tmpval = DAV_temp_RC_ija_bbb(j,l,b)*DAV_temp_LC_ija_bbb(j,l,b)

                 VNORM_aux += tmpval

                   ENDPARDO j,l,b

               execute server_barrier

               collective VNORM_bbb += VNORM_aux
#--------------alpha-beta-beta part------------------------------|
               VNORM_aux = 0.0

                   PARDO i,l,b
                  REQUEST DAV_RC_ija_abb(i,l,b,root1) i
                  REQUEST DAV_LC_ija_abb(i,l,b,root1) i

                  DAV_temp_RC_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root1)
                  DAV_temp_LC_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root1)

                 tmpval = DAV_temp_RC_ija_abb(i,l,b)*DAV_temp_LC_ija_abb(i,l,b)

                 VNORM_aux += tmpval

                   ENDPARDO i,l,b

               execute server_barrier

               collective VNORM_abb += VNORM_aux
#--------------beta-alpha-alpha part-----------------------------|
               VNORM_aux = 0.0

                   PARDO j,k,a
                 REQUEST DAV_RC_ija_baa(j,k,a,root1) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root1) j

                 DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
                 DAV_temp_LC_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root1)

                 tmpval = DAV_temp_RC_ija_baa(j,k,a)*DAV_temp_LC_ija_baa(j,k,a)

                 VNORM_aux += tmpval

                   ENDPARDO j,k,a

               execute server_barrier

               collective VNORM_baa += VNORM_aux
#--------------------------------------------------------------------------------|
               VNORM += VNORM_a
               VNORM += VNORM_b
               VNORM += VNORM_aaa
               VNORM += VNORM_bbb
               VNORM += VNORM_abb
               VNORM += VNORM_baa


               execute server_barrier
#----------Normalization factor--------------------------------------------------|

               norm_sqr = VNORM
               norm_sqr *= VNORM
               half = 0.5

               execute square_root norm_sqr half

#               IF norm_sqr < tresh_denom
#               VNORM = 1.0
#               ENDIF

               IF norm_sqr > tresh_denom

           minus = 0.0 

           tmpval = 1.0/VNORM
           IF tmpval < 0.0
           tmpval *= -1.0
           minus = 1.0 
           ENDIF


           half = 0.5

           execute square_root tmpval half

           VNORM =  tmpval

               ENDIF 

#--------Multiplication of vectors by normalization factors----------------------|


#-----------------alpha-alpha part------------------------------|
               PARDO i
                GET DAV_RC_h_a(i,root1)
                GET DAV_LC_h_a(i,root1)

                 DAV_temp_RC_h_a(i) = DAV_RC_h_a(i,root1)
                 DAV_temp_LC_h_a(i) = DAV_LC_h_a(i,root1)
 
                 DAV_temp_RC_h_a(i) *= VNORM
                 DAV_temp_LC_h_a(i) *= VNORM

                 DAV_temp_2i_RC_h_a(i,root1) = 0.0
                 DAV_temp_2i_LC_h_a(i,root1) = 0.0
                 DAV_temp_3i_RC_h_a(i,root1,niter) = 0.0
                 DAV_temp_3i_LC_h_a(i,root1,niter) = 0.0

                 IF minus == 1.0
                 DAV_temp_LC_h_a(i) *= -1.0
                 ENDIF

                 execute addrootindex DAV_temp_RC_h_a DAV_temp_2i_RC_h_a
                 execute addrootindex DAV_temp_LC_h_a DAV_temp_2i_LC_h_a
                 execute addrootindex DAV_temp_RC_h_a DAV_temp_3i_RC_h_a
                 execute addrootindex DAV_temp_LC_h_a DAV_temp_3i_LC_h_a

                 PUT DAV_RC_aux_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1)
                 PUT DAV_LC_aux_h_a(i,root1) = DAV_temp_2i_LC_h_a(i,root1)

                 PUT DAV_R_h_a(i,root1,niter) = DAV_temp_3i_RC_h_a(i,root1,niter)
                 PUT DAV_L_h_a(i,root1,niter) = DAV_temp_3i_LC_h_a(i,root1,niter)

               ENDPARDO i

               execute sip_barrier

               PARDO i  
               GET DAV_RC_aux_h_a(i,root1)
               GET DAV_LC_aux_h_a(i,root1)
               DAV_temp_2i_RC_h_a(i,root1) = DAV_RC_aux_h_a(i,root1)
               DAV_temp_2i_LC_h_a(i,root1) = DAV_LC_aux_h_a(i,root1)
               PUT DAV_RC_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1)
               PUT DAV_LC_h_a(i,root1) = DAV_temp_2i_LC_h_a(i,root1)
               ENDPARDO i

               execute sip_barrier
#-------------------beta-beta part------------------------------|
               PARDO j
                 GET DAV_RC_h_b(j,root1)
                 GET DAV_LC_h_b(j,root1)

                 DAV_temp_RC_h_b(j) = DAV_RC_h_b(j,root1)
                 DAV_temp_LC_h_b(j) = DAV_LC_h_b(j,root1)
                 
                 DAV_temp_RC_h_b(j) *= VNORM
                 DAV_temp_LC_h_b(j) *= VNORM

                 DAV_temp_2i_RC_h_b(j,root1) = 0.0
                 DAV_temp_2i_LC_h_b(j,root1) = 0.0
                 DAV_temp_3i_RC_h_b(j,root1,niter) = 0.0
                 DAV_temp_3i_LC_h_b(j,root1,niter) = 0.0


                 IF minus == 1.0
                 DAV_temp_LC_h_b(j) *= -1.0
                 ENDIF

                 execute addrootindex DAV_temp_RC_h_b DAV_temp_2i_RC_h_b
                 execute addrootindex DAV_temp_LC_h_b DAV_temp_2i_LC_h_b
                 execute addrootindex DAV_temp_RC_h_b DAV_temp_3i_RC_h_b
                 execute addrootindex DAV_temp_LC_h_b DAV_temp_3i_LC_h_b

                 PUT DAV_RC_aux_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)
                 PUT DAV_LC_aux_h_b(j,root1) = DAV_temp_2i_LC_h_b(j,root1)

                 PUT DAV_R_h_b(j,root1,niter) = DAV_temp_3i_RC_h_b(j,root1,niter)
                 PUT DAV_L_h_b(j,root1,niter) = DAV_temp_3i_LC_h_b(j,root1,niter)

               ENDPARDO j

               execute sip_barrier

               PARDO j
               GET DAV_RC_aux_h_b(j,root1)
               GET DAV_LC_aux_h_b(j,root1)
               DAV_temp_2i_RC_h_b(j,root1) = DAV_RC_aux_h_b(j,root1)
               DAV_temp_2i_LC_h_b(j,root1) = DAV_LC_aux_h_b(j,root1)
               PUT DAV_RC_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)
               PUT DAV_LC_h_b(j,root1) = DAV_temp_2i_LC_h_b(j,root1)
               ENDPARDO j

               execute sip_barrier


#--------------alpha-alpha-alpha part---------------------------|
                   PARDO i,k,a
                 REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root1) i

                 DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1)
                 DAV_temp_LC_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root1)

                 DAV_temp_RC_ija_aaa(i,k,a) *= VNORM
                 DAV_temp_LC_ija_aaa(i,k,a) *= VNORM


                 DAV_temp_2i_RC_ija_aaa(i,k,a,root1) = 0.0
                 DAV_temp_2i_LC_ija_aaa(i,k,a,root1) = 0.0
                 DAV_temp_3i_RC_ija_aaa(i,k,a,root1,niter) = 0.0
                 DAV_temp_3i_LC_ija_aaa(i,k,a,root1,niter) = 0.0


                 IF minus == 1.0
                 DAV_temp_LC_ija_aaa(i,k,a) *= -1.0
                 ENDIF

 
                 execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_2i_RC_ija_aaa
                 execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_2i_LC_ija_aaa
                 execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_3i_RC_ija_aaa
                 execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_3i_LC_ija_aaa

                 PREPARE DAV_RC_aux_ija_aaa(i,k,a,root1) = DAV_temp_2i_RC_ija_aaa(i,k,a,root1)
                 PREPARE DAV_LC_aux_ija_aaa(i,k,a,root1) = DAV_temp_2i_LC_ija_aaa(i,k,a,root1)

                 PREPARE DAV_R_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_RC_ija_aaa(i,k,a,root1,niter)
                 PREPARE DAV_L_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_LC_ija_aaa(i,k,a,root1,niter)

                   ENDPARDO i,k,a

               execute server_barrier

               PARDO i,k,a
               REQUEST DAV_RC_aux_ija_aaa(i,k,a,root1) i
               REQUEST DAV_LC_aux_ija_aaa(i,k,a,root1) i
               DAV_temp_2i_R_ija_aaa(i,k,a,root1) = DAV_RC_aux_ija_aaa(i,k,a,root1)
               DAV_temp_2i_L_ija_aaa(i,k,a,root1) = DAV_LC_aux_ija_aaa(i,k,a,root1)
               PREPARE DAV_RC_ija_aaa(i,k,a,root1) = DAV_RC_aux_ija_aaa(i,k,a,root1)
               PREPARE DAV_LC_ija_aaa(i,k,a,root1) = DAV_LC_aux_ija_aaa(i,k,a,root1)
               ENDPARDO i,k,a
               execute server_barrier


#--------------beta-beta-beta part------------------------------|
                   PARDO j,l,b
                 REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root1) j

                 DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
                 DAV_temp_LC_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root1)

                 DAV_temp_RC_ija_bbb(j,l,b) *= VNORM
                 DAV_temp_LC_ija_bbb(j,l,b) *= VNORM

                  DAV_temp_2i_RC_ija_bbb(j,l,b,root1) = 0.0
                  DAV_temp_2i_LC_ija_bbb(j,l,b,root1) = 0.0
                  DAV_temp_3i_RC_ija_bbb(j,l,b,root1,niter) = 0.0
                  DAV_temp_3i_LC_ija_bbb(j,l,b,root1,niter) = 0.0

                 IF minus == 1.0
                 DAV_temp_LC_ija_bbb(j,l,b) *= -1.0
                 ENDIF

                 execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_2i_RC_ija_bbb
                 execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_2i_LC_ija_bbb
                 execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_3i_RC_ija_bbb
                 execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_3i_LC_ija_bbb

                 PREPARE DAV_RC_aux_ija_bbb(j,l,b,root1) = DAV_temp_2i_RC_ija_bbb(j,l,b,root1)
                 PREPARE DAV_LC_aux_ija_bbb(j,l,b,root1) = DAV_temp_2i_LC_ija_bbb(j,l,b,root1)

                 PREPARE DAV_R_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_RC_ija_bbb(j,l,b,root1,niter)
                 PREPARE DAV_L_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_LC_ija_bbb(j,l,b,root1,niter)

                  ENDPARDO j,l,b

                 execute server_barrier

                 PARDO j,l,b
                 REQUEST DAV_RC_aux_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_aux_ija_bbb(j,l,b,root1) j
                 DAV_temp_2i_R_ija_bbb(j,l,b,root1) = DAV_RC_aux_ija_bbb(j,l,b,root1)
                 DAV_temp_2i_L_ija_bbb(j,l,b,root1) = DAV_LC_aux_ija_bbb(j,l,b,root1)
                 PREPARE DAV_RC_ija_bbb(j,l,b,root1) = DAV_temp_2i_R_ija_bbb(j,l,b,root1)
                 PREPARE DAV_LC_ija_bbb(j,l,b,root1) = DAV_temp_2i_L_ija_bbb(j,l,b,root1)
                 ENDPARDO j,l,b
                 execute server_barrier
                 
#--------------alpha-beta-beta part-----------------------------|
                   PARDO i,l,b
                  REQUEST DAV_RC_ija_abb(i,l,b,root1) i
                  REQUEST DAV_LC_ija_abb(i,l,b,root1) i

                  DAV_temp_RC_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root1)
                  DAV_temp_LC_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root1)

                  DAV_temp_RC_ija_abb(i,l,b) *= VNORM
                  DAV_temp_LC_ija_abb(i,l,b) *= VNORM

                  DAV_temp_2i_RC_ija_abb(i,l,b,root1) = 0.0
                  DAV_temp_2i_LC_ija_abb(i,l,b,root1) = 0.0
                  DAV_temp_3i_RC_ija_abb(i,l,b,root1,niter) = 0.0
                  DAV_temp_3i_LC_ija_abb(i,l,b,root1,niter) = 0.0

                  IF minus == 1.0
                  DAV_temp_LC_ija_abb(i,l,b) *= -1.0
                  ENDIF

                 execute addrootindex DAV_temp_RC_ija_abb DAV_temp_2i_RC_ija_abb
                 execute addrootindex DAV_temp_LC_ija_abb DAV_temp_2i_LC_ija_abb
                 execute addrootindex DAV_temp_RC_ija_abb DAV_temp_3i_RC_ija_abb
                 execute addrootindex DAV_temp_LC_ija_abb DAV_temp_3i_LC_ija_abb

                  PREPARE DAV_RC_aux_ija_abb(i,l,b,root1) = DAV_temp_2i_RC_ija_abb(i,l,b,root1)
                  PREPARE DAV_LC_aux_ija_abb(i,l,b,root1) = DAV_temp_2i_LC_ija_abb(i,l,b,root1)

                  PREPARE DAV_R_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_RC_ija_abb(i,l,b,root1,niter)
                  PREPARE DAV_L_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_LC_ija_abb(i,l,b,root1,niter)

                   ENDPARDO i,l,b

                 execute server_barrier

                 PARDO i,l,b
                 REQUEST DAV_RC_aux_ija_abb(i,l,b,root1) i
                 REQUEST DAV_LC_aux_ija_abb(i,l,b,root1) i
                 DAV_temp_2i_R_ija_abb(i,l,b,root1) = DAV_RC_aux_ija_abb(i,l,b,root1)
                 DAV_temp_2i_L_ija_abb(i,l,b,root1) = DAV_LC_aux_ija_abb(i,l,b,root1)
                 PREPARE DAV_RC_ija_abb(i,l,b,root1) = DAV_temp_2i_R_ija_abb(i,l,b,root1)
                 PREPARE DAV_LC_ija_abb(i,l,b,root1) = DAV_temp_2i_L_ija_abb(i,l,b,root1)
                 ENDPARDO i,l,b
                 execute server_barrier

                 
#--------------beta-alpha-alpha part----------------------------|
                   PARDO j,k,a
                 REQUEST DAV_RC_ija_baa(j,k,a,root1) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root1) j

                 DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
                 DAV_temp_LC_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root1)
               
                 DAV_temp_RC_ija_baa(j,k,a) *= VNORM 
                 DAV_temp_LC_ija_baa(j,k,a) *= VNORM 

                 DAV_temp_2i_RC_ija_baa(j,k,a,root1) = 0.0
                 DAV_temp_2i_LC_ija_baa(j,k,a,root1) = 0.0
                 DAV_temp_3i_RC_ija_baa(j,k,a,root1,niter) = 0.0
                 DAV_temp_3i_LC_ija_baa(j,k,a,root1,niter) = 0.0

                 IF minus == 1.0
                 DAV_temp_LC_ija_baa(j,k,a) *= -1.0
                 ENDIF

                 execute addrootindex DAV_temp_RC_ija_baa DAV_temp_2i_RC_ija_baa
                 execute addrootindex DAV_temp_LC_ija_baa DAV_temp_2i_LC_ija_baa
                 execute addrootindex DAV_temp_RC_ija_baa DAV_temp_3i_RC_ija_baa
                 execute addrootindex DAV_temp_LC_ija_baa DAV_temp_3i_LC_ija_baa

                 PREPARE DAV_RC_aux_ija_baa(j,k,a,root1) = DAV_temp_2i_RC_ija_baa(j,k,a,root1)
                 PREPARE DAV_LC_aux_ija_baa(j,k,a,root1) = DAV_temp_2i_LC_ija_baa(j,k,a,root1)

                 PREPARE DAV_R_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_RC_ija_baa(j,k,a,root1,niter)
                 PREPARE DAV_L_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_LC_ija_baa(j,k,a,root1,niter)

                 ENDPARDO j,k,a

               execute server_barrier

               PARDO j,k,a
               REQUEST DAV_RC_aux_ija_baa(j,k,a,root1) j
               REQUEST DAV_LC_aux_ija_baa(j,k,a,root1) j
               DAV_temp_2i_R_ija_baa(j,k,a,root1) = DAV_RC_aux_ija_baa(j,k,a,root1)
               DAV_temp_2i_L_ija_baa(j,k,a,root1) = DAV_LC_aux_ija_baa(j,k,a,root1)
               PREPARE DAV_RC_ija_baa(j,k,a,root1) = DAV_RC_aux_ija_baa(j,k,a,root1)
               PREPARE DAV_LC_ija_baa(j,k,a,root1) = DAV_LC_aux_ija_baa(j,k,a,root1)
               ENDPARDO j,k,a
               execute server_barrier


#---------------------------------------------------------------|
           ENDDO root1
           ENDIF 
           ENDDO niter 


           ENDPROC BIORTH
#          --------------
#-----end of biorthogonalization procedure----------------------|


#===============================================================|
#===============================================================|

#------procedure which check if convergence is reached----------|

           PROC CONVCHECK
#          -------------- 

           conv_true = 1.0 

#---------Step 1 - claculation of norm of correction vectors----|

           cnt = 0.0

#------------Loop over roots------------------------------------|
           DO root1
#----------Check if number of roots is exceeded-----------------|
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF

#---------------------------------------------------------------|
           RCNORM = 0.0
           LCNORM = 0.0 


           RCNORM_a = 0.0
           LCNORM_a = 0.0
           RCNORM_b = 0.0
           LCNORM_b = 0.0
           RCNORM_aaa = 0.0
           LCNORM_aaa = 0.0
           RCNORM_bbb = 0.0
           LCNORM_bbb = 0.0
           RCNORM_baa = 0.0
           LCNORM_baa = 0.0
           RCNORM_abb = 0.0
           LCNORM_abb = 0.0
#------------alpha-alpha part--------------------------------------|


               RCNORM_aux = 0.0
               LCNORM_aux = 0.0 

               PARDO i
                 GET DAV_RC_h_a(i,root1)
                 GET DAV_LC_h_a(i,root1)

                 DAV_temp_RC_h_a(i) = DAV_RC_h_a(i,root1)
                 DAV_temp_LC_h_a(i) = DAV_LC_h_a(i,root1)

                 tmpval_R = DAV_temp_RC_h_a(i)*DAV_temp_RC_h_a(i)
                 tmpval_L = DAV_temp_LC_h_a(i)*DAV_temp_LC_h_a(i)
                 
                 RCNORM_aux += tmpval_R
                 LCNORM_aux += tmpval_L

               ENDPARDO i

               execute server_barrier

               collective RCNORM_a += RCNORM_aux
               collective LCNORM_a += LCNORM_aux

#--------------beta - beta part -------------------------------------|
               RCNORM_aux = 0.0
               LCNORM_aux = 0.0

               PARDO j
                 GET DAV_RC_h_b(j,root1)
                 GET DAV_LC_h_b(j,root1)

                 DAV_temp_RC_h_b(j) = DAV_RC_h_b(j,root1)
                 DAV_temp_LC_h_b(j) = DAV_LC_h_b(j,root1)

                 tmpval_R = DAV_temp_RC_h_b(j)*DAV_temp_RC_h_b(j)
                 tmpval_L = DAV_temp_LC_h_b(j)*DAV_temp_LC_h_b(j)

                 RCNORM_aux += tmpval_R
                 LCNORM_aux += tmpval_L

               ENDPARDO j

               execute server_barrier

               collective RCNORM_b += RCNORM_aux
               collective LCNORM_b += LCNORM_aux


#--------------alpha-alpha-alpha-------------------------------------|
               RCNORM_aux = 0.0
               LCNORM_aux = 0.0

                   PARDO i,k,a
                 REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root1) i

                 DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1)
                 DAV_temp_LC_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root1)

                 tmpval_R = DAV_temp_RC_ija_aaa(i,k,a)*DAV_temp_RC_ija_aaa(i,k,a)
                 tmpval_L = DAV_temp_LC_ija_aaa(i,k,a)*DAV_temp_LC_ija_aaa(i,k,a)

                 RCNORM_aux += tmpval_R
                 LCNORM_aux += tmpval_L

               ENDPARDO i,k,a

               execute server_barrier

               collective RCNORM_aaa += RCNORM_aux
               collective LCNORM_aaa += LCNORM_aux
#--------------beta-beta-beta----------------------------------------|
               RCNORM_aux = 0.0
               LCNORM_aux = 0.0

                   PARDO j,l,b
                 REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root1) j

                 DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
                 DAV_temp_LC_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root1)

                 tmpval_R = DAV_temp_RC_ija_bbb(j,l,b)*DAV_temp_RC_ija_bbb(j,l,b)
                 tmpval_L = DAV_temp_LC_ija_bbb(j,l,b)*DAV_temp_LC_ija_bbb(j,l,b)

                 RCNORM_aux += tmpval_R
                 LCNORM_aux += tmpval_L

                   ENDPARDO j,l,b

               execute server_barrier

               collective RCNORM_bbb += RCNORM_aux
               collective LCNORM_bbb += LCNORM_aux
#--------------alpha-beta-beta---------------------------------------|

               RCNORM_aux = 0.0
               LCNORM_aux = 0.0

                   PARDO i,l,b
                 REQUEST DAV_RC_ija_abb(i,l,b,root1) i
                 REQUEST DAV_LC_ija_abb(i,l,b,root1) i

                 DAV_temp_RC_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root1)
                 DAV_temp_LC_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root1)

                 tmpval_R = DAV_temp_RC_ija_abb(i,l,b)*DAV_temp_RC_ija_abb(i,l,b)
                 tmpval_L = DAV_temp_LC_ija_abb(i,l,b)*DAV_temp_LC_ija_abb(i,l,b)

                 RCNORM_aux += tmpval_R
                 LCNORM_aux += tmpval_L

                   ENDPARDO i,l,b

               execute server_barrier

               collective RCNORM_abb += RCNORM_aux
               collective LCNORM_abb += LCNORM_aux
#--------------beta-alpha-alpha--------------------------------------|

               RCNORM_aux = 0.0
               LCNORM_aux = 0.0

                   PARDO j,k,a
                 REQUEST DAV_RC_ija_baa(j,k,a,root1) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root1) j

                 DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
                 DAV_temp_LC_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root1)

                 tmpval_R = DAV_temp_RC_ija_baa(j,k,a)*DAV_temp_RC_ija_baa(j,k,a)
                 tmpval_L = DAV_temp_LC_ija_baa(j,k,a)*DAV_temp_LC_ija_baa(j,k,a)

                 RCNORM_aux += tmpval_R
                 LCNORM_aux += tmpval_L

               ENDPARDO j,k,a

               execute server_barrier

               collective RCNORM_baa += RCNORM_aux
               collective LCNORM_baa += LCNORM_aux
#--------------------------------------------------------------------|
               RCNORM += RCNORM_a
               LCNORM += LCNORM_a
               RCNORM += RCNORM_b
               LCNORM += LCNORM_b                
               RCNORM += RCNORM_aaa
               LCNORM += LCNORM_aaa
               RCNORM += RCNORM_bbb
               LCNORM += LCNORM_bbb
               RCNORM += RCNORM_abb
               LCNORM += LCNORM_abb
               RCNORM += RCNORM_baa
               LCNORM += LCNORM_baa

               execute server_barrier  
               half = 0.5

               execute square_root RCNORM half
               execute square_root LCNORM half

               execute eomprintcorrnorm RCNORM LCNORM
#---------Set the convergence flag if it is reached-------------|


                IF RCNORM > tresh
                conv_true = 0.0
                ENDIF 

                IF LCNORM > tresh
                conv_true = 0.0
                ENDIF 

           ENDDO root1

                execute print_scalar conv_true 
               
           ENDPROC CONVCHECK
#          -----------------

#------end of convergence check procedure-----------------------|


           PROC INITGUESS_RL
#          -----------------


#---------------------------------------------------------------|
#  Here we do construction of Hbar_aa and Hbar_bb for small     |
#  matrix (nocc * nocc), used to generate initial guesses for   |
#        <L| and |R> vectors                                    |
#---------------------------------------------------------------|

#------------------alpha-alpha matrix---------------------------|
              DO i
               DO k
               GET Uii(k,i)
               tix(i,k) = Uii(k,i)
               tix(i,k) *= -1.0
               DAV_Hinitguess_a(i,k) = tix(i,k)
               ENDDO k
              ENDDO i
#------------------beta-beta matrix-----------------------------|
              DO j
               DO l
               GET Ujj(l,j)
               tjx(j,l) = Ujj(l,j)
               tjx(j,l) *= -1.0
               DAV_Hinitguess_b(j,l) = tjx(j,l)
               ENDDO l
              ENDDO j
        
              execute server_barrier
#---------------------------------------------------------------|
# Diagonalization of the small matrices and construction of the |
#          initial guesses itself                               |
#---------------------------------------------------------------|

           chunk_type = 1.0
           RL = 1.0
           execute eomchunk RL chunk_type
           execute eominitguess_ip DAV_Hinitguess_a DAV_R_initguess_static_a 
             
           execute server_barrier

           RL = 0.0
           execute eomchunk RL chunk_type
           execute eominitguess_ip DAV_Hinitguess_a DAV_L_initguess_static_a

           execute server_barrier

           RL = 1.0
#           execute eomchunk RL chunk_type
#           execute eominitguess_ip DAV_Hinitguess_b DAV_R_initguess_static_b

           RL = 0.0
#           execute eomchunk RL chunk_type
#           execute eominitguess_ip DAV_Hinitguess_b DAV_L_initguess_static_b

#           execute server_barrier

        
#---------------------------------------------------------------|
# Copying of obtained guess vectors into appropriate arrays     | 
#---------------------------------------------------------------|
           cnt = 0.0
#------------Loop over roots------------------------------------|
           DO root1
#----------Check if number of roots is exceeded-----------------|
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF


#---------Coping of alpha-alpha part----------------------------|
          DO i
          DAV_temp_2i_RC_h_a(i,root1) = DAV_R_initguess_static_a(i,root1)
          DAV_temp_2i_LC_h_a(i,root1) = DAV_L_initguess_static_a(i,root1)
          PUT DAV_R_initguess_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1)
          PUT DAV_L_initguess_h_a(i,root1) = DAV_temp_2i_LC_h_a(i,root1)
          ENDDO i
          execute sip_barrier
#---------Coping of beta-beta part------------------------------|
          DO j
          DAV_temp_2i_RC_h_b(j,root1) = DAV_R_initguess_static_a(j,root1)
          DAV_temp_2i_LC_h_b(j,root1) = DAV_L_initguess_static_a(j,root1)
          PUT DAV_R_initguess_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)
          PUT DAV_L_initguess_h_b(j,root1) = DAV_temp_2i_LC_h_b(j,root1)
          ENDDO j
          execute sip_barrier
#---------Coping of alpha-alpha-alpha part----------------------|
          PARDO i,k,a
          DAV_temp_2i_RC_ija_aaa(i,k,a,root1) = 0.0
          DAV_temp_2i_LC_ija_aaa(i,k,a,root1) = 0.0
          PREPARE DAV_R_initguess_ija_aaa(i,k,a,root1) = DAV_temp_2i_RC_ija_aaa(i,k,a,root1)
          PREPARE DAV_L_initguess_ija_aaa(i,k,a,root1) = DAV_temp_2i_LC_ija_aaa(i,k,a,root1)
          ENDPARDO i,k,a
          execute server_barrier
#---------Coping of beta-beta-beta part-------------------------|
          PARDO j,l,b
          DAV_temp_2i_RC_ija_bbb(j,l,b,root1) = 0.0
          PREPARE DAV_R_initguess_ija_bbb(j,l,b,root1) = DAV_temp_2i_RC_ija_bbb(j,l,b,root1)
          DAV_temp_2i_LC_ija_bbb(j,l,b,root1) = 0.0
          PREPARE DAV_L_initguess_ija_bbb(j,l,b,root1) = DAV_temp_2i_LC_ija_bbb(j,l,b,root1)
          ENDPARDO j,l,b
          execute server_barrier
#---------Coping of alpha-beta-beta part------------------------|
          PARDO i,l,b
          DAV_temp_2i_RC_ija_abb(i,l,b,root1) = 0.0
          PREPARE DAV_R_initguess_ija_abb(i,l,b,root1) = DAV_temp_2i_RC_ija_abb(i,l,b,root1)
          DAV_temp_2i_LC_ija_abb(i,l,b,root1) = 0.0
          PREPARE DAV_L_initguess_ija_abb(i,l,b,root1) = DAV_temp_2i_LC_ija_abb(i,l,b,root1)
          ENDPARDO i,l,b
          execute server_barrier
#---------Coping of beta-alpha-alpha part-----------------------|
          PARDO j,k,a
          DAV_temp_2i_RC_ija_baa(j,k,a,root1) = 0.0 
          PREPARE DAV_R_initguess_ija_baa(j,k,a,root1) = DAV_temp_2i_RC_ija_baa(j,k,a,root1)
          DAV_temp_2i_LC_ija_baa(j,k,a,root1) = 0.0
          PREPARE DAV_L_initguess_ija_baa(j,k,a,root1) = DAV_temp_2i_LC_ija_baa(j,k,a,root1)
          ENDPARDO j,k,a
          execute server_barrier
#---------------------------------------------------------------|
           ENDDO root1
#---------------------------------------------------------------|

#===============================================================|
#  contributions to the first Davidson vectors                  |
#             (for the first iteration)                         |
#  this is necessary for biorthogonalization procedure          |        
#===============================================================|
           cnt = 0.0
#------------Loop over roots------------------------------------|
           DO root1
#----------Check if number of roots is exceeded-----------------|
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF
#---------------------------------------------------------------|
               iter_one = 1.0
#-----------Loop over iterations---------------------------------|
               cnt_iter = 0.0

                   DO niter           
                   cnt_iter += 1.0
                   IF cnt_iter > iter_one
                   EXIT
                   ENDIF

#---------Coping of alpha-alpha part----------------------------|

               PARDO i
                  DAV_temp_3i_RC_h_a(i,root1,niter) = 0.0
                  DAV_temp_3i_LC_h_a(i,root1,niter) = 0.0

                  GET DAV_R_initguess_h_a(i,root1)
                  GET DAV_L_initguess_h_a(i,root1)
                    DAV_temp_RC_h_a(i) = DAV_R_initguess_h_a(i,root1)
                    DAV_temp_LC_h_a(i) = DAV_L_initguess_h_a(i,root1)

        
                    execute addrootindex DAV_temp_RC_h_a DAV_temp_3i_RC_h_a
                    execute addrootindex DAV_temp_LC_h_a DAV_temp_3i_LC_h_a


                 PUT DAV_R_h_a(i,root1,niter) = DAV_temp_3i_RC_h_a(i,root1,niter)
                 PUT DAV_L_h_a(i,root1,niter) = DAV_temp_3i_LC_h_a(i,root1,niter)
                 PUT DAV_RX_h_a(i,root1,niter) = DAV_temp_3i_RC_h_a(i,root1,niter)
                 PUT DAV_LX_h_a(i,root1,niter) = DAV_temp_3i_LC_h_a(i,root1,niter)

               ENDPARDO i

               execute sip_barrier

#---------Coping of beta-beta part------------------------------|

               PARDO j
                  DAV_temp_3i_RC_h_b(j,root1,niter) = 0.0
                  DAV_temp_3i_LC_h_b(j,root1,niter) = 0.0

                 GET DAV_R_initguess_h_b(j,root1)
                 GET DAV_L_initguess_h_b(j,root1)
                    DAV_temp_RC_h_b(j) = DAV_R_initguess_h_b(j,root1)
                    DAV_temp_LC_h_b(j) = DAV_L_initguess_h_b(j,root1)

                    execute addrootindex DAV_temp_RC_h_b DAV_temp_3i_RC_h_b
                    execute addrootindex DAV_temp_LC_h_b DAV_temp_3i_LC_h_b

                 PUT DAV_R_h_b(j,root1,niter) = DAV_temp_3i_RC_h_b(j,root1,niter)
                 PUT DAV_L_h_b(j,root1,niter) = DAV_temp_3i_LC_h_b(j,root1,niter)
                 PUT DAV_RX_h_b(j,root1,niter) = DAV_temp_3i_RC_h_b(j,root1,niter)
                 PUT DAV_LX_h_b(j,root1,niter) = DAV_temp_3i_LC_h_b(j,root1,niter)

               ENDPARDO j

               execute sip_barrier

#---------Coping of alpha-alpha-alpha part----------------------|

                   PARDO i,k,a


                    DAV_temp_3i_RC_ija_aaa(i,k,a,root1,niter) = 0.0
                    DAV_temp_3i_LC_ija_aaa(i,k,a,root1,niter) = 0.0

                 REQUEST DAV_R_initguess_ija_aaa(i,k,a,root1) i
                 REQUEST DAV_L_initguess_ija_aaa(i,k,a,root1) i

                  DAV_temp_RC_ija_aaa(i,k,a) = DAV_R_initguess_ija_aaa(i,k,a,root1)
                  DAV_temp_LC_ija_aaa(i,k,a) = DAV_L_initguess_ija_aaa(i,k,a,root1)

                  execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_3i_RC_ija_aaa
                  execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_3i_LC_ija_aaa

                 PREPARE DAV_R_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_RC_ija_aaa(i,k,a,root1,niter)
                 PREPARE DAV_L_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_LC_ija_aaa(i,k,a,root1,niter)
                 PREPARE DAV_RX_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_RC_ija_aaa(i,k,a,root1,niter)
                 PREPARE DAV_LX_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_LC_ija_aaa(i,k,a,root1,niter)
                   ENDPARDO i,k,a

               execute server_barrier
             
#---------Coping of beta-beta-beta part-------------------------|

                   PARDO j,l,b
                 DAV_temp_3i_RC_ija_bbb(j,l,b,root1,niter) = 0.0
                 DAV_temp_3i_LC_ija_bbb(j,l,b,root1,niter) = 0.0

                 REQUEST DAV_R_initguess_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_L_initguess_ija_bbb(j,l,b,root1) j

                  DAV_temp_RC_ija_bbb(j,l,b) = DAV_R_initguess_ija_bbb(j,l,b,root1)
                  DAV_temp_LC_ija_bbb(j,l,b) = DAV_L_initguess_ija_bbb(j,l,b,root1)

                  execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_3i_RC_ija_bbb
                  execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_3i_LC_ija_bbb

                 PREPARE DAV_R_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_RC_ija_bbb(j,l,b,root1,niter) 
                 PREPARE DAV_L_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_LC_ija_bbb(j,l,b,root1,niter)
                 PREPARE DAV_RX_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_RC_ija_bbb(j,l,b,root1,niter)
                 PREPARE DAV_LX_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_LC_ija_bbb(j,l,b,root1,niter)

                   ENDPARDO j,l,b

               execute server_barrier
#---------Coping of alpha-beta-beta part------------------------|

                   PARDO i,l,b
                 DAV_temp_3i_RC_ija_abb(i,l,b,root1,niter) = 0.0
                 DAV_temp_3i_LC_ija_abb(i,l,b,root1,niter) = 0.0

                 REQUEST DAV_R_initguess_ija_abb(i,l,b,root1) i
                 REQUEST DAV_L_initguess_ija_abb(i,l,b,root1) i

                  DAV_temp_RC_ija_abb(i,l,b) = DAV_R_initguess_ija_abb(i,l,b,root1)
                  DAV_temp_LC_ija_abb(i,l,b) = DAV_L_initguess_ija_abb(i,l,b,root1)

                  execute addrootindex DAV_temp_RC_ija_abb DAV_temp_3i_RC_ija_abb
                  execute addrootindex DAV_temp_LC_ija_abb DAV_temp_3i_LC_ija_abb  

                 PREPARE DAV_R_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_RC_ija_abb(i,l,b,root1,niter)
                 PREPARE DAV_L_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_LC_ija_abb(i,l,b,root1,niter)
                 PREPARE DAV_RX_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_RC_ija_abb(i,l,b,root1,niter)
                 PREPARE DAV_LX_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_LC_ija_abb(i,l,b,root1,niter)
                 
                   ENDPARDO i,l,b

               execute server_barrier

#---------Coping of beta-alpha-alpha part-----------------------|

                   PARDO j,k,a
                 DAV_temp_3i_RC_ija_baa(j,k,a,root1,niter) = 0.0
                 DAV_temp_3i_LC_ija_baa(j,k,a,root1,niter) = 0.0
 
                 REQUEST DAV_R_initguess_ija_baa(j,k,a,root1) j
                 REQUEST DAV_L_initguess_ija_baa(j,k,a,root1) j

                  DAV_temp_RC_ija_baa(j,k,a) = DAV_R_initguess_ija_baa(j,k,a,root1)
                  DAV_temp_LC_ija_baa(j,k,a) = DAV_L_initguess_ija_baa(j,k,a,root1)
                      

                  execute addrootindex DAV_temp_RC_ija_baa DAV_temp_3i_RC_ija_baa
                  execute addrootindex DAV_temp_LC_ija_baa DAV_temp_3i_LC_ija_baa

                 PREPARE DAV_R_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_RC_ija_baa(j,k,a,root1,niter) 
                 PREPARE DAV_L_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_LC_ija_baa(j,k,a,root1,niter)
                 PREPARE DAV_RX_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_RC_ija_baa(j,k,a,root1,niter)
                 PREPARE DAV_LX_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_LC_ija_baa(j,k,a,root1,niter)

                   ENDPARDO j,k,a

               execute server_barrier 
#========================================================================================


                  
                   ENDDO niter
           ENDDO root1
#---------------------------------------------------------------|



#---------------------------------------------------------------|

           ENDPROC INITGUESS_RL
#          --------------------

#          -------------------

#========================================================================================|
#                 GENERATION OF DIAGONAL ELEMENTS OF Hbar                                |
#========================================================================================|

           PROC HBARAUXDIAG
#          ----------------

#------------------------------------------|
#
# -----prepare f_ii diagonal = DDii
#
     PARDO i, i1

     GET   Uii(i1,i)
     Sii(i1,i)      = Uii(i1,i)
     execute return_diagonal Sii Sdii
     tii(i1,i)      = Sdii(i1,i)
     put DDii(i1,i) = tii(i1,i)

     ENDPARDO i, i1
#
# -----prepare f_jj diagonal = DDjj
#
     PARDO j, j1

     GET   Ujj(j1,j)
     Sjj(j1,j)      = Ujj(j1,j)
     execute return_diagonal Sjj Sdjj
     tjj(j1,j)      = Sdjj(j1,j)
     put DDjj(j1,j) = tjj(j1,j)
     ENDPARDO j, j1

     execute sip_barrier 
#
# -----prepare f_aa diagonal = DDaa
#
     PARDO a, a1

     GET   Uaa(a,a1)
     Saa(a,a1)      = Uaa(a,a1)
     taa(a,a1)      = Uaa(a,a1)
     execute return_diagonal Saa Sdaa
     taa(a,a1)      = Sdaa(a,a1)
     put DDaa(a,a1) = taa(a,a1)
     ENDPARDO a, a1

#
# -----prepare f_bb diagonal = DDbb
#
     PARDO b, b1

     GET  Ubb(b,b1)
     Sbb(b,b1)      = Ubb(b,b1)
     execute return_diagonal Sbb Sdbb
     tbb(b,b1)      = Sdbb(b,b1)
     put DDbb(b,b1) = tbb(b,b1)
     ENDPARDO b, b1
#------------------------------------------|
     execute sip_barrier    
#-----------alpha elements-----------------|
     PARDO i

     tis(i)=0.0

     do i1
      get DDii(i1,i)
      t1is(i1) = 1.0
      tii(i,i1)  = DDii(i1,i)
      t2is(i)  = tii(i,i1)*t1is(i1)
      tis(i)  += t2is(i)
     enddo i1
     PUT DAV_Hbar_diag_a(i) = tis(i)

     ENDPARDO i

     execute sip_barrier

#-----------beta elements------------------|
     PARDO j
 
     tjs(j)=0.0

     do j1 
      get DDjj(j1,j)
      t1js(j1) = 1.0
      tjj(j,j1)  = DDjj(j1,j)
      t2js(j)  = tjj(j,j1)*t1js(j1)
      tjs(j)  += t2js(j)      
     enddo j1
     PUT DAV_Hbar_diag_b(j) = tjs(j) 

     ENDPARDO j

     execute sip_barrier
#------------------------------------------|

     PARDO a, i, i1

              DAV_temp_R_ija_aaa(i1,i,a) = 0.0 

              DO kk1
        
           DAV_temp_R_ija_aaa_k(i1,i,a,kk1) = 0.0

           do i2
           GET   DDii(i2,i1) 
           tiaix_k(i2,a,i,kk1) = 1.0
           tii(i1,i2) = DDii(i2,i1)
           DAV_temp_RC_ija_aaa_k(i1,i,a,kk1)  = tiaix_k(i2,a,i,kk1)*tii(i1,i2)
           DAV_temp_R_ija_aaa_k(i1,i,a,kk1) += DAV_temp_RC_ija_aaa_k(i1,i,a,kk1)
           enddo i2

           do i2
           GET   DDii(i2,i)
           tiaix_k(i2,a,i1,kk1)  = 1.0
           tii(i,i2) = DDii(i2,i)
           DAV_temp_RC_ija_aaa_k(i1,i,a,kk1)  = tiaix_k(i2,a,i1,kk1)*tii(i,i2)
           DAV_temp_R_ija_aaa_k(i1,i,a,kk1) += DAV_temp_RC_ija_aaa_k(i1,i,a,kk1)
           enddo i2

           do a2
           GET   DDaa(a2,a)
           t2aixi_k(a2,i,i1,kk1)  =-1.0
           taa(a,a2) = DDaa(a2,a)
           DAV_temp_RC_ija_aaa_k(i1,i,a,kk1)  = t2aixi_k(a2,i,i1,kk1)*taa(a,a2)
           DAV_temp_R_ija_aaa_k(i1,i,a,kk1) += DAV_temp_RC_ija_aaa_k(i1,i,a,kk1)
           enddo a2
            
           DAV_temp_R_ija_aaa(i1,i,a) = DAV_temp_R_ija_aaa_k(i1,i,a,kk1)


           PREPARE DAV_Hbar_diag_aaa(i1,i,a) = DAV_temp_R_ija_aaa(i1,i,a)  
           ENDDO kk1
     ENDPARDO a, i, i1  

     execute server_barrier  
#--------------------------------------------------------------|
     PARDO b, j, j1

           DAV_temp_R_ija_bbb(j1,j,b) = 0.0

           DO kk1

           DAV_temp_R_ija_bbb_k(j1,j,b,kk1) = 0.0

           do j2
           GET   DDjj(j2,j1)
           tjbjx_k(j2,b,j,kk1)   = 1.0
           tjj(j1,j2)      = DDjj(j2,j1)
           DAV_temp_RC_ija_bbb_k(j1,j,b,kk1)  = tjbjx_k(j2,b,j,kk1)*tjj(j1,j2)
           DAV_temp_R_ija_bbb_k(j1,j,b,kk1) += DAV_temp_RC_ija_bbb_k(j1,j,b,kk1) 
           enddo j2

           do j2
           GET   DDjj(j2,j)
           tjbjx_k(j2,b,j1,kk1)  = 1.0
           tjj(j,j2)           = DDjj(j2,j)
           DAV_temp_RC_ija_bbb_k(j1,j,b,kk1)  = tjbjx_k(j2,b,j1,kk1)*tjj(j,j2)
           DAV_temp_R_ija_bbb_k(j1,j,b,kk1) += DAV_temp_RC_ija_bbb_k(j1,j,b,kk1)
           enddo j2

           do b2
           GET   DDbb(b2,b)
           t2bjxj_k(b2,j,j1,kk1)  =-1.0
           tbb(b,b2)           = DDbb(b2,b)
           DAV_temp_RC_ija_bbb_k(j1,j,b,kk1)  = t2bjxj_k(b2,j,j1,kk1)*tbb(b,b2)
           DAV_temp_R_ija_bbb_k(j1,j,b,kk1) += DAV_temp_RC_ija_bbb_k(j1,j,b,kk1)
           enddo b2

           DAV_temp_R_ija_bbb(j1,j,b) = DAV_temp_R_ija_bbb_k(j1,j,b,kk1)


           PREPARE DAV_Hbar_diag_bbb(j1,j,b) = DAV_temp_R_ija_bbb(j1,j,b)
           ENDDO kk1
     ENDPARDO b, j, j1

             execute server_barrier
#--------------------------------------------------------------|

     PARDO a, i, j1

           DAV_temp_R_ija_baa(j1,i,a) = 0.0

           DO kk1 
           
           DAV_temp_R_ija_baa_k(j1,i,a,kk1) = 0.0


           do j2
              GET                   DDjj(j2,j1)
              tjaix_k(j2,a,i,kk1)   = 1.0
              tjj(j1,j2)          = DDjj(j2,j1)
              DAV_temp_RC_ija_baa_k(j1,i,a,kk1) = tjaix_k(j2,a,i,kk1)*tjj(j1,j2)
             DAV_temp_R_ija_baa_k(j1,i,a,kk1) += DAV_temp_RC_ija_baa_k(j1,i,a,kk1)
           enddo j2

           do i2
              GET                   DDii(i2,i)
              tiajx_k(i2,a,j1,kk1)  = 1.0
              tii(i,i2)           = DDii(i2,i)
              DAV_temp_RC_ija_baa_k(j1,i,a,kk1) = tiajx_k(i2,a,j1,kk1)*tii(i,i2)
              DAV_temp_R_ija_baa_k(j1,i,a,kk1) += DAV_temp_RC_ija_baa_k(j1,i,a,kk1)
           enddo i2

           do a2
              GET                   DDaa(a2,a)
              t2aixj_k(a2,i,j1,kk1)  =-1.0
              taa(a,a2)           = DDaa(a2,a)
              DAV_temp_RC_ija_baa_k(j1,i,a,kk1)  = t2aixj_k(a2,i,j1,kk1)*taa(a,a2)
              DAV_temp_R_ija_baa_k(j1,i,a,kk1) += DAV_temp_RC_ija_baa_k(j1,i,a,kk1)
           enddo a2

          DAV_temp_R_ija_baa(j1,i,a) = DAV_temp_R_ija_baa_k(j1,i,a,kk1)

          PREPARE DAV_Hbar_diag_baa(j1,i,a) = DAV_temp_R_ija_baa(j1,i,a)
          ENDDO kk1
     ENDPARDO a, i, j1

               execute server_barrier
##--------------------------------------------------------------|
     PARDO b, j, i1

           DAV_temp_R_ija_abb(i1,j,b) = 0.0

           DO kk1  

           DAV_temp_R_ija_abb_k(i1,j,b,kk1) = 0.0
           

           do i2
              GET                   DDii(i2,i1)
              tibjx_k(i2,b,j,kk1)   = 1.0
              tii(i1,i2)          = DDii(i2,i1)
              DAV_temp_RC_ija_abb_k(i1,j,b,kk1)  = tibjx_k(i2,b,j,kk1)*tii(i1,i2)
              DAV_temp_R_ija_abb_k(i1,j,b,kk1) += DAV_temp_RC_ija_abb_k(i1,j,b,kk1)
           enddo i2

           do j2
              GET                   DDjj(j2,j)
              tjbix_k(j2,b,i1,kk1)  = 1.0
              tjj(j,j2)           = DDjj(j2,j)
              DAV_temp_RC_ija_abb_k(i1,j,b,kk1)  = tjbix_k(j2,b,i1,kk1)*tjj(j,j2)
              DAV_temp_R_ija_abb_k(i1,j,b,kk1) += DAV_temp_RC_ija_abb_k(i1,j,b,kk1)
           enddo j2

           do b2
              GET                   DDbb(b2,b)
              t2bjxi_k(b2,j,i1,kk1)  =-1.0
              tbb(b,b2)           = DDbb(b2,b)
              DAV_temp_RC_ija_abb_k(i1,j,b,kk1)  = t2bjxi_k(b2,j,i1,kk1)*tbb(b,b2)
              DAV_temp_R_ija_abb_k(i1,j,b,kk1) += DAV_temp_RC_ija_abb_k(i1,j,b,kk1)
           enddo b2

           DAV_temp_R_ija_abb(i1,j,b) = DAV_temp_R_ija_abb_k(i1,j,b,kk1)

           PREPARE DAV_Hbar_diag_abb(i1,j,b) = DAV_temp_R_ija_abb(i1,j,b)
           ENDDO kk1
     ENDPARDO b, j, i1 

           execute server_barrier
#--------------------------------------------------------------|
#--------------------------------------------------------------|
     PARDO a, i, i1

           DAV_temp_R_ija_aaa(i1,i,a) = 0.0

           DO kk1
           
           DAV_temp_R_ija_aaa_k(i1,i,a,kk1) = 0.0 

           do i2
           do i3  
              request                  Wiiii(i,i2,i1,i3) i
              Tiiii(i,i2,i1,i3)      = Wiiii(i,i2,i1,i3)
              execute return_diagonal4 Tiiii
              t1aiii_k(a,i2,i3,kk1)    = 1.0
              aux_iiii(i3,i2,i1,i) = Tiiii(i,i2,i1,i3)
              aux_iiak(i3,i2,a,kk1) = t1aiii_k(a,i2,i3,kk1)
              DAV_temp_RC_ija_aaa_k(i1,i,a,kk1) = aux_iiii(i3,i2,i1,i)*aux_iiak(i3,i2,a,kk1)
              DAV_temp_R_ija_aaa_k(i1,i,a,kk1) += DAV_temp_RC_ija_aaa_k(i1,i,a,kk1)
           enddo i3
           enddo i2

           DAV_temp_R_ija_aaa(i1,i,a) = DAV_temp_R_ija_aaa_k(i1,i,a,kk1)


           PREPARE DAV_Hbar_diag_aaa(i1,i,a) += DAV_temp_R_ija_aaa(i1,i,a)
           ENDDO kk1
     ENDPARDO a, i, i1         

          execute server_barrier
#---------------------------------------------------------------|
     PARDO b, j, j1

           DAV_temp_R_ija_bbb(j1,j,b) = 0.0

           DO kk1
           
           DAV_temp_R_ija_bbb_k(j1,j,b,kk1) = 0.0

           do j2
           do j3
              request                  Wjjjj(j,j2,j1,j3) j
              tjjjj(j,j2,j1,j3)      = Wjjjj(j,j2,j1,j3)
              execute return_diagonal4 Tjjjj
              t1bjxj_k(b,j2,j3,kk1)    = 1.0
              aux_jjjj(j3,j2,j1,j) = Tjjjj(j,j2,j1,j3)
              aux_jjbk(j3,j2,b,kk1) = t1bjxj_k(b,j2,j3,kk1)
              DAV_temp_RC_ija_bbb_k(j1,j,b,kk1) = aux_jjjj(j3,j2,j1,j)*aux_jjbk(j3,j2,b,kk1)
              DAV_temp_R_ija_bbb_k(j1,j,b,kk1) += DAV_temp_RC_ija_bbb_k(j1,j,b,kk1)
           enddo j3
           enddo j2  


           DAV_temp_R_ija_bbb(j1,j,b) = DAV_temp_R_ija_bbb_k(j1,j,b,kk1)

           PREPARE DAV_Hbar_diag_bbb(j1,j,b) += DAV_temp_R_ija_bbb(j1,j,b)
           ENDDO kk1 
     ENDPARDO b, j, j1

           execute server_barrier 
#---------------------------------------------------------------|
     PARDO a, i, j1

           DAV_temp_R_ija_baa(j1,i,a) = 0.0
   
           DO kk1  

           DAV_temp_R_ija_baa_k(j1,i,a,kk1) = 0.0  

           do i2
           do j3
              request                  Wiijj(i,i2,j1,j3) i
              tiijj(i,i2,j1,j3)      = Wiijj(i,i2,j1,j3)
              execute return_diagonal4 Tiijj
              t1aixj_k(a,i2,j3,kk1)    = 1.0
               aux_ijij(i2,j3,i,j1) = Tiijj(i,i2,j1,j3)
               aux_ijak(i2,j3,a,kk1) = t1aixj_k(a,i2,j3,kk1)
               DAV_temp_RC_ija_baa_k(j1,i,a,kk1)  = aux_ijij(i2,j3,i,j1)*aux_ijak(i2,j3,a,kk1)
               DAV_temp_R_ija_baa_k(j1,i,a,kk1) += DAV_temp_RC_ija_baa_k(j1,i,a,kk1)
           enddo j3
           enddo i2

           DAV_temp_R_ija_baa(j1,i,a) = DAV_temp_R_ija_baa_k(j1,i,a,kk1)

           PREPARE DAV_Hbar_diag_baa(j1,i,a) += DAV_temp_R_ija_baa(j1,i,a)
           ENDDO kk1
     ENDPARDO a, i, j1 

           execute server_barrier
#---------------------------------------------------------------|
     PARDO b, j, i1

           DAV_temp_R_ija_abb(i1,j,b) = 0.0

           DO kk1

           DAV_temp_R_ija_abb_k(i1,j,b,kk1) = 0.0

           do j2
           do i3
              request                  Wiijj(i1,i3,j,j2) i1
              tjjii(j,j2,i1,i3)      = Wiijj(i1,i3,j,j2)
              execute return_diagonal4 Tjjii
              t1bjxi_k(b,j2,i3,kk1)    = 1.0
               aux_ijij(i3,j2,i1,j) = Tjjii(j,j2,i1,i3)
               aux_ijbk(i3,j2,b,kk1) = t1bjxi_k(b,j2,i3,kk1)
               DAV_temp_RC_ija_abb_k(i1,j,b,kk1) = aux_ijij(i3,j2,i1,j)*aux_ijbk(i3,j2,b,kk1)
               DAV_temp_R_ija_abb_k(i1,j,b,kk1) += DAV_temp_RC_ija_abb_k(i1,j,b,kk1)
           enddo i3
           enddo j2


           DAV_temp_R_ija_abb(i1,j,b) = DAV_temp_R_ija_abb_k(i1,j,b,kk1)

           PREPARE DAV_Hbar_diag_abb(i1,j,b) += DAV_temp_R_ija_abb(i1,j,b)

           ENDDO kk1 
     ENDPARDO b, j, i1

            execute server_barrier
#---------------------------------------------------------------|
#---------------------------------------------------------------|
     PARDO a, i, i1

           DAV_temp_R_ija_aaa(i,i1,a) = 0.0
           DAV_temp_RC_ija_aaa(i1,i,a) = 0.0


           DO kk1
           
           DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = 0.0
 
           do a2
           do i3
              request                  Wiaai(i1,a,a2,i3) a
              taaii(a,a2,i1,i3)      = Wiaai(i1,a,a2,i3)
              execute return_diagonal4 Taaii
              t1iaxi_k(i,a2,i3,kk1)    = 1.0
              aux_iaia(i3,a2,i1,a) = Taaii(a,a2,i1,i3)
              aux_iaik(i3,a2,i,kk1) = t1iaxi_k(i,a2,i3,kk1)
              DAV_temp_RC_ija_aaa_k(i,i1,a,kk1) = aux_iaia(i3,a2,i1,a)*aux_iaik(i3,a2,i,kk1)
              DAV_temp_R_ija_aaa_k(i,i1,a,kk1)  += DAV_temp_RC_ija_aaa_k(i,i1,a,kk1)
           enddo i3
           enddo a2
           
           DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)

           DAV_temp_RC_ija_aaa(i1,i,a) = DAV_temp_R_ija_aaa(i,i1,a)


           PREPARE DAV_Hbar_diag_aaa(i,i1,a) += DAV_temp_R_ija_aaa(i,i1,a)
           PREPARE DAV_Hbar_diag_aaa(i1,i,a) += DAV_temp_RC_ija_aaa(i1,i,a)
           ENDDO kk1
     ENDPARDO a, i, i1

     execute server_barrier
#---------------------------------------------------------------| 
     PARDO b, j, j1

           DAV_temp_R_ija_bbb(j,j1,b) = 0.0 
           DAV_temp_RC_ija_bbb(j1,j,b) = 0.0

           DO kk1
           
           DAV_temp_R_ija_bbb_k(j1,j,b,kk1) = 0.0 

           do b2
           do j3 
              request                  Wjbbj(j1,b,b2,j3) b
              tbbjj(b,b2,j1,j3)      = Wjbbj(j1,b,b2,j3)
              execute return_diagonal4 Tbbjj
              t1jbxj_k(j,b2,j3,kk1)    = 1.0
              aux_jbjb(j3,b2,j1,b) = Tbbjj(b,b2,j1,j3)
              aux_jbjk(j3,b2,j,kk1) = t1jbxj_k(j,b2,j3,kk1)
              DAV_temp_RC_ija_bbb_k(j,j1,b,kk1) = aux_jbjb(j3,b2,j1,b)*aux_jbjk(j3,b2,j,kk1)
              DAV_temp_R_ija_bbb_k(j,j1,b,kk1)  += DAV_temp_RC_ija_bbb_k(j,j1,b,kk1)
           enddo j3
           enddo b2 
            
           DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
 
           DAV_temp_RC_ija_bbb(j1,j,b) = DAV_temp_R_ija_bbb(j,j1,b)

           PREPARE DAV_Hbar_diag_bbb(j,j1,b) += DAV_temp_R_ija_bbb(j,j1,b)
           PREPARE DAV_Hbar_diag_bbb(j1,j,b) += DAV_temp_RC_ija_bbb(j1,j,b)
           ENDDO kk1
     ENDPARDO b, j, j1

     execute server_barrier
#---------------------------------------------------------------|
     PARDO a, i, j1
 
           DAV_temp_R_ija_baa(j1,i,a) = 0.0

           DO kk1
           
           DAV_temp_R_ija_baa_k(j1,i,a,kk1) = 0.0 

           do a1
           do i1 
              request                  Wiaai(i1,a1,a,i) a
              taaii(a,a1,i,i1)       = Wiaai(i1,a1,a,i)
              execute return_diagonal4 Taaii
              t1aixj_k(a1,i1,j1,kk1)    = 1.0
              aux_iaia(i1,a1,i,a) = Taaii(a,a1,i,i1)
              aux_iajk(i1,a1,j1,kk1) = t1aixj_k(a1,i1,j1,kk1)
              DAV_temp_RC_ija_baa_k(j1,i,a,kk1) = aux_iaia(i1,a1,i,a)*aux_iajk(i1,a1,j1,kk1)
              DAV_temp_R_ija_baa_k(j1,i,a,kk1) += DAV_temp_RC_ija_baa_k(j1,i,a,kk1)
           enddo i1
           enddo a1

           DAV_temp_R_ija_baa(j1,i,a) = DAV_temp_R_ija_baa_k(j1,i,a,kk1)
           PREPARE DAV_Hbar_diag_baa(j1,i,a) += DAV_temp_R_ija_baa(j1,i,a)
           ENDDO kk1
     ENDPARDO a, i, j1 

     execute server_barrier
#---------------------------------------------------------------|
     PARDO b, j, i1

           DAV_temp_R_ija_abb(i1,j,b) = 0.0    

           DO kk1
       
           DAV_temp_R_ija_abb_k(i1,j,b,kk1) = 0.0

           do b1
           do j1
              request                  Wjbbj(j1,b1,b,j) b
              tbbjj(b,b1,j,j1)       = Wjbbj(j1,b1,b,j)
              execute return_diagonal4 Tbbjj
              t1bjxi_k(b1,j1,i1,kk1)    = 1.0
           aux_jbjb(j1,b1,j,b) = Tbbjj(b,b1,j,j1)
           aux_jbik(j1,b1,i1,kk1) = t1bjxi_k(b1,j1,i1,kk1)
           DAV_temp_RC_ija_abb_k(i1,j,b,kk1) = aux_jbjb(j1,b1,j,b)*aux_jbik(j1,b1,i1,kk1)
           DAV_temp_R_ija_abb_k(i1,j,b,kk1)  += DAV_temp_RC_ija_abb_k(i1,j,b,kk1)
           enddo j1
           enddo b1  

           DAV_temp_R_ija_abb(i1,j,b) = DAV_temp_R_ija_abb_k(i1,j,b,kk1)
           PREPARE DAV_Hbar_diag_abb(i1,j,b) += DAV_temp_R_ija_abb(i1,j,b)
           ENDDO kk1
     ENDPARDO b, j, i1 

     execute server_barrier
#---------------------------------------------------------------|
#--------------------Extra terms--------------------------------| 


     PARDO b, j, i

           DAV_temp_R_ija_abb(i,j,b) = 0.0

           DO kk1

           DAV_temp_R_ija_abb_k(i,j,b,kk1) = 0.0

             DO i1
             DO b1   
             REQUEST Wiibb(i1,i,b,b1) i1 
             tbbii(b,b1,i,i1)  =  Wiibb(i1,i,b,b1)  
             execute return_diagonal4 tbbii
             t1bjxi_k(b1,j,i1,kk1) = 1.0
             DAV_temp_RC_ija_abb_k(i,j,b,kk1)  = tbbii(b,b1,i,i1)*t1bjxi_k(b1,j,i1,kk1)
             DAV_temp_R_ija_abb_k(i,j,b,kk1) += DAV_temp_RC_ija_abb_k(i,j,b,kk1)
             ENDDO b1
             ENDDO i1   


           DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)

           PREPARE DAV_Hbar_diag_abb(i,j,b) += DAV_temp_R_ija_abb(i,j,b)

           ENDDO kk1
     ENDPARDO b, j, i

            execute server_barrier

#------------------------------------------------------------|

      PARDO a,i,j

           DAV_temp_R_ija_baa(j,i,a) = 0.0

           DO kk1

           DAV_temp_R_ija_baa_k(j,i,a,kk1) = 0.0

             DO j1
             DO a1
             REQUEST Wjjaa(j1,j,a,a1) j1
             taajj(a,a1,j,j1)  =  Wjjaa(j1,j,a,a1)
             execute return_diagonal4 taajj
             t1bixj_k(a1,i,j1,kk1) = 1.0
             DAV_temp_RC_ija_baa_k(j,i,a,kk1)  = taajj(a,a1,j,j1)*t1bixj_k(a1,i,j1,kk1)
             DAV_temp_R_ija_baa_k(j,i,a,kk1) += DAV_temp_RC_ija_baa_k(j,i,a,kk1)
             ENDDO a1
             ENDDO j1

             DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)

             PREPARE DAV_Hbar_diag_baa(j,i,a) += DAV_temp_R_ija_baa(j,i,a)
          
            ENDDO kk1
      ENDPARDO a,i,j

            execute server_barrier

#---------------------------------------------------------------|
#---------------------------------------------------------------|

#----------Diagonal elements of 3-body terms--------------------|

#----------alpha-alpha-alpha terms------------------------------|
      PARDO i,i1,a
           DO a1 
           DAV_temp_R_ija_aaa(i,i1,a) = 0.0  

           REQUEST T2aa(a1,i,a,i1) a1
           t2_aa(a1,i,a,i1) = T2aa(a1,i,a,i1) 

           execute make_3body_diag_ip t2_aa DAV_temp_R_ija_aaa
          
           PREPARE DAV_Hbar_diag_aaa(i,i1,a) += DAV_temp_R_ija_aaa(i,i1,a)

           ENDDO a1        
      ENDPARDO i,i1,a

      execute server_barrier
#----------beta-beta-beta terms---------------------------------|

      PARDO j,j1,b
           DO b1
           DAV_temp_R_ija_bbb(j,j1,b) = 0.0  

           REQUEST T2bb(b1,j,b,j1) b1
           t2_bb(b1,j,b,j1) = T2bb(b1,j,b,j1)
   
           execute make_3body_diag_ip t2_bb DAV_temp_R_ija_bbb

           PREPARE DAV_Hbar_diag_bbb(j,j1,b) += DAV_temp_R_ija_bbb(j,j1,b)

           ENDDO b1
      ENDPARDO j,j1,b

      execute server_barrier
#----------alpha-beta-beta terms--------------------------------|
      PARDO i,j1,b
           DO a1
           DAV_temp_R_ija_abb(i,j1,b) = 0.0 

           REQUEST T2ab(a1,i,b,j1) a1
           t2_ab(a1,i,b,j1) = T2ab(a1,i,b,j1)  

           execute make_3body_diag_ip t2_ab DAV_temp_R_ija_abb

           PREPARE DAV_Hbar_diag_abb(i,j1,b) += DAV_temp_R_ija_abb(i,j1,b)

           ENDDO a1
      ENDPARDO i,j1,b

      execute server_barrier

#----------beta-alpha-alpha terms-------------------------------|
      PARDO j,i1,a
           DO b1
           DAV_temp_R_ija_baa(j,i1,a) = 0.0

           REQUEST T2ab(a,i1,b1,j) a
           t2_ab(a,i1,b1,j) = T2ab(a,i1,b1,j) 
           t2_ba(b1,j,a,i1) = t2_ab(a,i1,b1,j)

           execute make_3body_diag_ip t2_ba DAV_temp_R_ija_baa

           PREPARE DAV_Hbar_diag_baa(j,i1,a) += DAV_temp_R_ija_baa(j,i1,a)

           ENDDO b1
      ENDPARDO j,i1,a

      execute server_barrier




#---------------------------------------------------------------|
           ENDPROC HBARAUXDIAG
#          -------------------

#=========================================================================================
#                   Antisymmetrization of right eigenvectors                             |
#=========================================================================================
          PROC ANTISYMM_R 
#         ---------------
       

 
#-------------alpha-alpha-alpha part----------------------------|

#-----------------auxiliary array-------------------------------|
      PARDO a,i,i1  
        
      IF iter == 0.0          
      REQUEST DAV_HR0_ija_aaa(i1,i,a,root1) i1
      DAV_temp_R_ija_aaa(i1,i,a) = DAV_HR0_ija_aaa(i1,i,a,root1) 
      ENDIF  

        IF iter > 0.0

         IF Mkcorr == 1.0
         REQUEST DAV_RC_ija_aaa(i1,i,a,root1) i1
         DAV_temp_R_ija_aaa(i1,i,a) = DAV_RC_ija_aaa(i1,i,a,root1)
         ENDIF

         IF Mkdav == 1.0
         REQUEST DAV_HR_prev_ija_aaa(i1,i,a,root1,niter_main) i1
         DAV_temp_R_ija_aaa(i1,i,a) = DAV_HR_prev_ija_aaa(i1,i,a,root1,niter_main)
         ENDIF

         IF Mkcorr1 == 1.0
         REQUEST DAV_HRC_ija_aaa(i1,i,a,root1) i1
         DAV_temp_R_ija_aaa(i1,i,a) = DAV_HRC_ija_aaa(i1,i,a,root1)
         ENDIF

        ENDIF

         PREPARE DAV_aux_ija_aaa(i1,i,a) = DAV_temp_R_ija_aaa(i1,i,a)

      ENDPARDO a,i,i1
      execute server_barrier
#---------------------------------------------------------------|

      PARDO a,i,i1
         DAV_temp_R_ija_aaa(i1,i,a) = 0.0
         DAV_temp_RC_ija_aaa(i,i1,a) = 0.0

         IF iter == 0.0
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
         
            IF i == i1
            REQUEST DAV_aux_ija_aaa(i1,i,a) i1
            DAV_temp_R_ija_aaa(i1,i,a) = DAV_aux_ija_aaa(i1,i,a)
            execute symm_force_i DAV_temp_R_ija_aaa(i1,i,a)
            PREPARE DAV_HR0_ija_aaa(i1,i,a,root1) = DAV_temp_R_ija_aaa(i1,i,a)
            ENDIF

            IF i < i1
            REQUEST DAV_HR0_ija_aaa(i1,i,a,root1) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_HR0_ija_aaa(i1,i,a,root1)
            DAV_temp_RC_ija_aaa(i,i1,a) *= -1.0
            PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) = DAV_temp_RC_ija_aaa(i,i1,a)
            ENDIF

#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
         ENDIF

        IF iter > 0.0
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
         IF Mkcorr == 1.0
          
            IF i == i1
            REQUEST DAV_aux_ija_aaa(i1,i,a) i1
            DAV_temp_R_ija_aaa(i1,i,a) =  DAV_aux_ija_aaa(i1,i,a)
            execute symm_force_i DAV_temp_R_ija_aaa(i1,i,a)
            PREPARE DAV_RC_ija_aaa(i1,i,a,root1) = DAV_temp_R_ija_aaa(i1,i,a)
            ENDIF

            IF i < i1
            REQUEST DAV_RC_ija_aaa(i1,i,a,root1) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_RC_ija_aaa(i1,i,a,root1)
            DAV_temp_RC_ija_aaa(i,i1,a) *= -1.0
            PREPARE DAV_RC_ija_aaa(i,i1,a,root1) = DAV_temp_RC_ija_aaa(i,i1,a)
            ENDIF

         ENDIF
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|          
         IF Mkdav == 1.0
                   
            IF i == i1
            REQUEST DAV_aux_ija_aaa(i1,i,a) i1
            DAV_temp_R_ija_aaa(i1,i,a) = DAV_aux_ija_aaa(i1,i,a)
            execute symm_force_i DAV_temp_R_ija_aaa(i1,i,a)
            PREPARE DAV_HR_prev_ija_aaa(i1,i,a,root1,niter_main) = DAV_temp_R_ija_aaa(i1,i,a)
            ENDIF

            IF i < i1
            REQUEST DAV_HR_prev_ija_aaa(i1,i,a,root1,niter_main) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_HR_prev_ija_aaa(i1,i,a,root1,niter_main)
            DAV_temp_RC_ija_aaa(i,i1,a) *= -1.0
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) = DAV_temp_RC_ija_aaa(i,i1,a)
            ENDIF

         ENDIF
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
         IF Mkcorr1 == 1.0  
           
            IF i == i1
            REQUEST DAV_aux_ija_aaa(i1,i,a) i1
            DAV_temp_R_ija_aaa(i1,i,a) = DAV_aux_ija_aaa(i1,i,a)
            execute symm_force_i DAV_temp_R_ija_aaa(i1,i,a)
            PREPARE DAV_HRC_ija_aaa(i1,i,a,root1) = DAV_temp_R_ija_aaa(i1,i,a)
            ENDIF

            IF i < i1
            REQUEST DAV_HRC_ija_aaa(i1,i,a,root1) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_HRC_ija_aaa(i1,i,a,root1)
            DAV_temp_RC_ija_aaa(i,i1,a) *= -1.0
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) = DAV_temp_RC_ija_aaa(i,i1,a)
            ENDIF

         ENDIF
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
        ENDIF
       

      ENDPARDO a,i,i1

      execute server_barrier 
#-------------beta-beta-beta part-------------------------------|


#--------------------auxiliary array----------------------------|      

      PARDO b,j,j1  

      IF iter == 0.0
      REQUEST DAV_HR0_ija_bbb(j1,j,b,root1) j1
      DAV_temp_R_ija_bbb(j1,j,b) = DAV_HR0_ija_bbb(j1,j,b,root1)
      ENDIF

        IF iter > 0.0

         IF Mkcorr == 1.0
         REQUEST DAV_RC_ija_bbb(j1,j,b,root1) j1
         DAV_temp_R_ija_bbb(j1,j,b) = DAV_RC_ija_bbb(j1,j,b,root1)
         ENDIF

         IF Mkdav == 1.0
         REQUEST DAV_HR_prev_ija_bbb(j1,j,b,root1,niter_main) j1
         DAV_temp_R_ija_bbb(j1,j,b) = DAV_HR_prev_ija_bbb(j1,j,b,root1,niter_main)
         ENDIF

         IF Mkcorr1 == 1.0
         REQUEST DAV_HRC_ija_bbb(j1,j,b,root1) j1
         DAV_temp_R_ija_bbb(j1,j,b) = DAV_HRC_ija_bbb(j1,j,b,root1)
         ENDIF

        ENDIF

         PREPARE DAV_aux_ija_bbb(j1,j,b) = DAV_temp_R_ija_bbb(j1,j,b)

      ENDPARDO b,j,j1
      execute server_barrier
#---------------------------------------------------------------|
      PARDO b,j,j1      
         DAV_temp_R_ija_bbb(j1,j,b) = 0.0
         DAV_temp_RC_ija_bbb(j1,j,b) = 0.0

         IF iter == 0.0
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|

            IF j == j1
            REQUEST DAV_aux_ija_bbb(j1,j,b) j1
            DAV_temp_R_ija_bbb(j1,j,b) = DAV_aux_ija_bbb(j1,j,b)
            execute symm_force_i DAV_temp_R_ija_bbb(j1,j,b)
            PREPARE DAV_HR0_ija_bbb(j1,j,b,root1) = DAV_temp_R_ija_bbb(j1,j,b)
            ENDIF

            IF j < j1
            REQUEST DAV_HR0_ija_bbb(j1,j,b,root1) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_HR0_ija_bbb(j1,j,b,root1)
            DAV_temp_RC_ija_bbb(j,j1,b) *= -1.0
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) = DAV_temp_RC_ija_bbb(j,j1,b)
            ENDIF


#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
            ENDIF

        IF iter > 0.0
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
         IF Mkcorr == 1.0
           
            IF j == j1
            REQUEST DAV_aux_ija_bbb(j1,j,b) j1 
            DAV_temp_R_ija_bbb(j1,j,b) = DAV_aux_ija_bbb(j1,j,b)
            execute symm_force_i DAV_temp_R_ija_bbb(j1,j,b)
            PREPARE DAV_RC_ija_bbb(j1,j,b,root1) = DAV_temp_R_ija_bbb(j1,j,b)
            ENDIF

            IF j < j1
            REQUEST DAV_RC_ija_bbb(j1,j,a,root1) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_RC_ija_bbb(j1,j,b,root1)
            DAV_temp_RC_ija_bbb(j,j1,b) *= -1.0
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) = DAV_temp_RC_ija_bbb(j,j1,b)
            ENDIF

         ENDIF
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|          
         IF Mkdav == 1.0
           
            IF j == j1
            REQUEST DAV_aux_ija_bbb(j1,j,b) j1
            DAV_temp_R_ija_bbb(j1,j,b) = DAV_aux_ija_bbb(j1,j,b)
            execute symm_force_i DAV_temp_R_ija_bbb(j1,j,b)
            PREPARE DAV_HR_prev_ija_bbb(j1,j,b,root1,niter_main) = DAV_temp_R_ija_bbb(j1,j,b)
            ENDIF

            IF j < j1
            REQUEST DAV_HR_prev_ija_bbb(j1,j,b,root1,niter_main) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_HR_prev_ija_bbb(j1,j,b,root1,niter_main)
            DAV_temp_RC_ija_bbb(j,j1,b) *= -1.0
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) = DAV_temp_RC_ija_bbb(j,j1,b)
            ENDIF

         ENDIF
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
         IF Mkcorr1 == 1.0

            IF j == j1
            REQUEST DAV_aux_ija_bbb(j1,j,b) j1
            DAV_temp_R_ija_bbb(j1,j,b) = DAV_aux_ija_bbb(j1,j,b)
            execute symm_force_i DAV_temp_R_ija_bbb(j1,j,b)
            PREPARE DAV_HRC_ija_bbb(j1,j,b,root1) = DAV_temp_R_ija_bbb(j1,j,b)
            ENDIF

            IF j < j1
            REQUEST DAV_HRC_ija_bbb(j1,j,b,root1) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_HRC_ija_bbb(j1,j,b,root1)
            DAV_temp_RC_ija_bbb(j,j1,b) *= -1.0
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) = DAV_temp_RC_ija_bbb(j,j1,b)
            ENDIF

         ENDIF  
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^|
        ENDIF  

      ENDPARDO b,j,j1

      execute server_barrier    
#---------------------------------------------------------------|
          ENDPROC ANTISYMM_R
#         ------------------

#=========================================================================================
#                   Antisymmetrization of left eigenvectors                              |
#=========================================================================================
          PROC ANTISYMM_L  
#         ---------------

          IF Mkcorr == 1.0

#-------------alpha-alpha-alpha part----------------------------|

#-------------auxiliary array-----------------------------------|

      PARDO a,i,i1

         REQUEST DAV_LC_ija_aaa(i1,i,a,root1) i1
         DAV_temp_L_ija_aaa(i1,i,a) = DAV_LC_ija_aaa(i1,i,a,root1)

         PREPARE DAV_aux_ija_aaa(i1,i,a) = DAV_temp_L_ija_aaa(i1,i,a)

      ENDPARDO a,i,i1
      execute server_barrier



#---------------------------------------------------------------|
      PARDO a,i,i1
        
         DAV_temp_L_ija_aaa(i1,i,a) = 0.0
         DAV_temp_LC_ija_aaa(i,i1,a) = 0.0
         DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) = 0.0
         DAV_temp_2i_LC_ija_aaa(i,i1,a,root1) = 0.0

         IF i == i1
         REQUEST DAV_aux_ija_aaa(i1,i,a) i1
         DAV_temp_L_ija_aaa(i1,i,a) = DAV_aux_ija_aaa(i1,i,a)
         execute symm_force_i DAV_temp_L_ija_aaa(i1,i,a)
         execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_RC_ija_aaa
         PREPARE DAV_LC_ija_aaa(i1,i,a,root1) = DAV_temp_2i_RC_ija_aaa(i1,i,a,root1)
         ENDIF  

         IF i < i1
         REQUEST DAV_LC_ija_aaa(i1,i,a,root1) i1
         DAV_temp_LC_ija_aaa(i,i1,a) = DAV_LC_ija_aaa(i1,i,a,root1)  
         DAV_temp_LC_ija_aaa(i,i1,a) *= -1.0
         execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_2i_LC_ija_aaa
         PREPARE DAV_LC_ija_aaa(i,i1,a,root1) = DAV_temp_2i_LC_ija_aaa(i,i1,a,root1)
         ENDIF 


      ENDPARDO a,i,i1

       execute server_barrier
#-------------auxiliary array-----------------------------------|

      PARDO b,j,j1
         
         REQUEST DAV_LC_ija_bbb(j1,j,b,root1) j1
         DAV_temp_L_ija_bbb(j1,j,b) = DAV_LC_ija_bbb(j1,j,b,root1)
         PREPARE DAV_aux_ija_bbb(j1,j,b) = DAV_temp_L_ija_bbb(j1,j,b)

      ENDPARDO b,j,j1
      execute server_barrier




#-------------beta-beta-beta part-------------------------------|
      PARDO b,j,j1
        
         DAV_temp_L_ija_bbb(j1,j,b) = 0.0
         DAV_temp_LC_ija_bbb(j1,j,b) = 0.0
         DAV_temp_2i_RC_ija_bbb(j1,j,b,root1) = 0.0
         DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0



         IF j == j1
         REQUEST DAV_aux_ija_bbb(j1,j,b) j1
         DAV_temp_L_ija_bbb(j1,j,b) = DAV_aux_ija_bbb(j1,j,b)
         execute symm_force_i DAV_temp_L_ija_bbb(j1,j,b)
         execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_RC_ija_bbb
         PREPARE DAV_LC_ija_bbb(j1,j,b,root1) = DAV_temp_2i_RC_ija_bbb(j1,j,b,root1)
         ENDIF

         IF j < j1
         REQUEST DAV_LC_ija_bbb(j1,j,b,root1) j1 
         DAV_temp_LC_ija_bbb(j,j1,b) = DAV_LC_ija_bbb(j1,j,b,root1)
         DAV_temp_LC_ija_bbb(j,j1,b) *= -1.0
         execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_2i_LC_ija_bbb
         PREPARE DAV_LC_ija_bbb(j,j1,b,root1) = DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
         ENDIF


      ENDPARDO b,j,j1 

         execute server_barrier 

         ENDIF
#---------------------------------------------------------------|
         ENDPROC ANTISYMM_L
#        ------------------

#=========================================================================================
#     MATRIX-VECTOR MULTIPLICATION PROCEDURE: Hbar*|R> (always connected)                |
#=========================================================================================

           PROC MAKE_Hbar_R
#          ----------------

            cnt = 0.0
#------------Loop over roots------------------------------------|
            DO root1
#----------Check if number of roots is exceeded-----------------|
            cnt += 1.0
            IF cnt > n_roots
            EXIT
            ENDIF
#---------------------------------------------------------------|


#--------------------------------------------------------------|
#            Zero out HR arrays                                |
#--------------------------------------------------------------| 

#---------------alpha part-------------------------------------|
      PARDO i
         DAV_temp_R_h_a(i) = 0.0
         DAV_temp_2i_RC_h_a(i,root1) = 0.0
         
         IF iter == 0.0            
         PUT DAV_HR0_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0            
            PUT DAV_RC_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1) 
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_a(i,root1,niter_main) = 0.0
            PUT DAV_HR_prev_h_a(i,root1,niter_main) = DAV_temp_3i_RC_h_a(i,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            PUT DAV_HRC_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1) 
            ENDIF
         ENDIF

      ENDPARDO i

      execute sip_barrier
#---------------beta part--------------------------------------|
      PARDO j
         DAV_temp_R_h_b(j) = 0.0
         DAV_temp_2i_RC_h_b(j,root1) = 0.0
         
         IF iter == 0.0
         PUT DAV_HR0_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            PUT DAV_RC_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_b(j,root1,niter_main) = 0.0
            PUT DAV_HR_prev_h_b(j,root1,niter_main) = DAV_temp_3i_RC_h_b(j,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            PUT DAV_HRC_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)
            ENDIF
         ENDIF

      ENDPARDO j

      execute sip_barrier
#-------------alpha-alpha-alpha part---------------------------|
      PARDO i,k,a
      DAV_temp_R_ija_aaa(i,k,a) = 0.0
      DAV_temp_2i_R_ija_aaa(i,k,a,root1) = 0.0

         IF iter == 0.0
         PREPARE DAV_HR0_ija_aaa(i,k,a,root1) = DAV_temp_2i_R_ija_aaa(i,k,a,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            PREPARE DAV_RC_ija_aaa(i,k,a,root1) = DAV_temp_2i_R_ija_aaa(i,k,a,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_aaa(i,k,a,root1,niter_main) = 0.0
            PREPARE DAV_HR_prev_ija_aaa(i,k,a,root1,niter_main) = DAV_temp_3i_R_ija_aaa(i,k,a,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            PREPARE DAV_HRC_ija_aaa(i,k,a,root1) = DAV_temp_2i_R_ija_aaa(i,k,a,root1)
            ENDIF
         ENDIF 

      ENDPARDO i,k,a  

      execute server_barrier

#-------------beta-beta-beta part------------------------------|
      PARDO j,l,b
      DAV_temp_R_ija_bbb(j,l,b) = 0.0
      DAV_temp_2i_R_ija_bbb(j,l,b,root1) = 0.0

         IF iter == 0.0
         PREPARE DAV_HR0_ija_bbb(j,l,b,root1) = DAV_temp_2i_R_ija_bbb(j,l,b,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            PREPARE DAV_RC_ija_bbb(j,l,b,root1) = DAV_temp_2i_R_ija_bbb(j,l,b,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_bbb(j,l,b,root1,niter_main) = 0.0
            PREPARE DAV_HR_prev_ija_bbb(j,l,b,root1,niter_main) = DAV_temp_3i_R_ija_bbb(j,l,b,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            PREPARE DAV_HRC_ija_bbb(j,l,b,root1) = DAV_temp_2i_R_ija_bbb(j,l,b,root1)
            ENDIF
         ENDIF


      ENDPARDO j,l,b

      execute server_barrier

#-------------alpha-beta-beta part-----------------------------|
      PARDO i,l,b
      DAV_temp_R_ija_abb(i,l,b) = 0.0 
      DAV_temp_2i_R_ija_abb(i,l,b,root1) = 0.0 

         IF iter == 0.0
         PREPARE DAV_HR0_ija_abb(i,l,b,root1) = DAV_temp_2i_R_ija_abb(i,l,b,root1)
         ENDIF
      
         IF iter > 0.0
            IF Mkcorr == 1.0
            PREPARE DAV_RC_ija_abb(i,l,b,root1) = DAV_temp_2i_R_ija_abb(i,l,b,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_abb(i,l,b,root1,niter_main) = 0.0
            PREPARE DAV_HR_prev_ija_abb(i,l,b,root1,niter_main) = DAV_temp_3i_R_ija_abb(i,l,b,root1,niter_main)
            ENDIF
      
            IF Mkcorr1 == 1.0
            PREPARE DAV_HRC_ija_abb(i,l,b,root1) = DAV_temp_2i_R_ija_abb(i,l,b,root1)
            ENDIF
         ENDIF


      ENDPARDO i,l,b

      execute server_barrier

#-------------beta-alpha-alpha part----------------------------|
      PARDO j,k,a
      DAV_temp_R_ija_baa(j,k,a) = 0.0
      DAV_temp_2i_R_ija_baa(j,k,a,root1) = 0.0  

         IF iter == 0.0
         PREPARE DAV_HR0_ija_baa(j,k,a,root1) = DAV_temp_2i_R_ija_baa(j,k,a,root1)
         ENDIF
      
         IF iter > 0.0
            IF Mkcorr == 1.0
            PREPARE DAV_RC_ija_baa(j,k,a,root1) = DAV_temp_2i_R_ija_baa(j,k,a,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_baa(j,k,a,root1,niter_main) = 0.0
            PREPARE DAV_HR_prev_ija_baa(j,k,a,root1,niter_main) = DAV_temp_3i_R_ija_baa(j,k,a,root1,niter_main)
            ENDIF
      
            IF Mkcorr1 == 1.0
            PREPARE DAV_HRC_ija_baa(j,k,a,root1) = DAV_temp_2i_R_ija_baa(j,k,a,root1)
            ENDIF
         ENDIF


      ENDPARDO j,k,a

      execute server_barrier
#--------------------------------------------------------------|


###############################################################|
#--------Matrix-vector multiplication itselfs------------------|
###############################################################|



###############################################################|
#---------------alpha part-------------------------------------|
###############################################################|



#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

#---- Hbar_j^i contribution (diagram S from my notes)----------|

      PARDO i,k

         DAV_temp_R_h_a(i) = 0.0       
         DAV_temp_2i_RC_h_a(i,root1) = 0.0

         GET   Uii(k,i)

         IF iter == 0.0
            GET DAV_R_initguess_h_a(k,root1)
              DAV_temp_RC_h_a(k) = DAV_R_initguess_h_a(k,root1)
              DAV_temp_R_h_a(i) = Uii(k,i)*DAV_temp_RC_h_a(k)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HR0_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            GET DAV_RX_h_a(k,root1,niter_main)
              DAV_temp_RC_h_a(k) = DAV_RX_h_a(k,root1,niter_main)
              DAV_temp_R_h_a(i) = Uii(k,i)*DAV_temp_RC_h_a(k)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a 
            PUT DAV_RC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_a(i,root1,niter_main) = 0.0
            GET DAV_R_h_a(k,root1,niter_main)
              DAV_temp_RC_h_a(k) = DAV_R_h_a(k,root1,niter_main)
              DAV_temp_R_h_a(i) = Uii(k,i)*DAV_temp_RC_h_a(k)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_3i_RC_h_a   
            PUT DAV_HR_prev_h_a(i,root1,niter_main) += DAV_temp_3i_RC_h_a(i,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            GET DAV_RC_h_a(k,root1)
              DAV_temp_RC_h_a(k) = DAV_RC_h_a(k,root1) 
              DAV_temp_R_h_a(i) = Uii(k,i)*DAV_temp_RC_h_a(k)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HRC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF
         ENDIF
      ENDPARDO i,k

      execute sip_barrier

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_ia contribution (diagrams 1 and 2)---------|
#
#----------alpha - alpha contribution--------------------------|

      PARDO i,k,a

         GET Uia(k,a)
          DO kk1

          DAV_temp_R_h_a(i) = 0.0
          DAV_temp_2i_RC_h_a(i,root1) = 0.0
          DAV_temp_RC_ija_aaa_k(i,k,a,kk1) = 0.0

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_aaa(i,k,a,root1) i
#            REQUEST DAV_R_initguess_ija_aaa(k,i,a,root1) k
              DAV_temp_RC_ija_aaa(i,k,a) = DAV_R_initguess_ija_aaa(i,k,a,root1)
#              DAV_temp_R_ija_aaa(k,i,a) = DAV_R_initguess_ija_aaa(k,i,a,root1)
#              t1aixi(i,k,a) = DAV_temp_R_ija_aaa(k,i,a)
#              DAV_temp_RC_ija_aaa(i,k,a) -= t1aixi(i,k,a) 
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k            
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_aaa_k(i,k,a,kk1)*Uia(k,a)
#              DAV_temp_R_h_a_k(i,kk1) *= 0.5
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HR0_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_aaa(i,k,a,root1,niter_main) i
#            REQUEST DAV_RX_ija_aaa(k,i,a,root1,niter_main) k
              DAV_temp_RC_ija_aaa(i,k,a) = DAV_RX_ija_aaa(i,k,a,root1,niter_main)
#              DAV_temp_R_ija_aaa(k,i,a) =  DAV_RX_ija_aaa(k,i,a,root1,niter_main)
#              t1aixi(i,k,a) = DAV_temp_R_ija_aaa(k,i,a) 
#              DAV_temp_RC_ija_aaa(i,k,a) -= t1aixi(i,k,a)
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_aaa_k(i,k,a,kk1)*Uia(k,a)
#              DAV_temp_R_h_a_k(i,kk1) *= 0.5
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_RC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
           ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_a(i,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_aaa(i,k,a,root1,niter_main) i
#            REQUEST DAV_R_ija_aaa(k,i,a,root1,niter_main) k
              DAV_temp_RC_ija_aaa(i,k,a) = DAV_R_ija_aaa(i,k,a,root1,niter_main)
#              DAV_temp_R_ija_aaa(k,i,a) =  DAV_R_ija_aaa(k,i,a,root1,niter_main) 
#              t1aixi(i,k,a) = DAV_temp_R_ija_aaa(k,i,a)
#              DAV_temp_RC_ija_aaa(i,k,a) -= t1aixi(i,k,a)
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_aaa_k(i,k,a,kk1)*Uia(k,a)
#              DAV_temp_R_h_a_k(i,kk1) *= 0.5
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_3i_RC_h_a 
            PUT DAV_HR_prev_h_a(i,root1,niter_main) += DAV_temp_3i_RC_h_a(i,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_aaa(i,k,a,root1) i 
#            REQUEST DAV_RC_ija_aaa(k,i,a,root1) k
              DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1)
#              DAV_temp_R_ija_aaa(k,i,a) =  DAV_RC_ija_aaa(k,i,a,root1)
#              t1aixi(i,k,a) = DAV_temp_R_ija_aaa(k,i,a)
#              DAV_temp_RC_ija_aaa(i,k,a) -= t1aixi(i,k,a)
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_aaa_k(i,k,a,kk1)*Uia(k,a)
#              DAV_temp_R_h_a_k(i,kk1) *= 0.5
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HRC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF
         ENDIF
        ENDDO kk1
      ENDPARDO i,k,a

      execute sip_barrier

#
#----------beta - beta contribution----------------------------|
#
      PARDO i,j,b

        

         GET Ujb(j,b)
         DO kk1  

         DAV_temp_R_h_a(i) = 0.0
         DAV_temp_2i_RC_h_a(i,root1) = 0.0
         DAV_temp_RC_ija_abb_k(i,j,b,kk1) = 0.0
          
         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_abb(i,j,b,root1) i
              DAV_temp_RC_ija_abb(i,j,b) = DAV_R_initguess_ija_abb(i,j,b,root1)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_abb_k(i,j,b,kk1)*Ujb(j,b)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
             PUT DAV_HR0_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
        ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_abb(i,j,b,root1,niter_main) i
              DAV_temp_RC_ija_abb(i,j,b) = DAV_RX_ija_abb(i,j,b,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_abb_k(i,j,b,kk1)*Ujb(j,b)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_RC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_a(i,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_abb(i,j,b,root1,niter_main) i
              DAV_temp_RC_ija_abb(i,j,b) = DAV_R_ija_abb(i,j,b,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_abb_k(i,j,b,kk1)*Ujb(j,b)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_3i_RC_h_a
            PUT DAV_HR_prev_h_a(i,root1,niter_main) += DAV_temp_3i_RC_h_a(i,root1,niter_main)
           ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_abb(i,j,b,root1) i
              DAV_temp_RC_ija_abb(i,j,b) = DAV_RC_ija_abb(i,j,b,root1)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = DAV_temp_RC_ija_abb_k(i,j,b,kk1)*Ujb(j,b)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HRC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF
         ENDIF
        ENDDO kk1
      ENDPARDO i,j,b

      execute sip_barrier


#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_jka^i contribution (diagrams 3 and 4 )-------------------------|
#
#------------- alpha - alpha - alpha contribution-----------------------|
#
      PARDO i2, i, i1, a
         DO kk1  
         DAV_temp_R_h_a(i) = 0.0
         DAV_temp_2i_RC_h_a(i,root1) = 0.0        
         DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1) = 0.0

         REQUEST  Wiiia(i2,i,i1,a) i2


         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_aaa(i2,i1,a,root1) i2
              DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_R_initguess_ija_aaa(i2,i1,a,root1)
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
              DAV_temp_R_h_a_k(i,kk1) = Wiiia(i2,i,i1,a)*DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1) 
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -0.5 
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HR0_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_aaa(i2,i1,a,root1,niter_main) i2
              DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_RX_ija_aaa(i2,i1,a,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
              DAV_temp_R_h_a_k(i,kk1) = Wiiia(i2,i,i1,a)*DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -0.5
             execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_RC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_a(i,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_aaa(i2,i1,a,root1,niter_main) i2
              DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_R_ija_aaa(i2,i1,a,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
              DAV_temp_R_h_a_k(i,kk1) = Wiiia(i2,i,i1,a)*DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -0.5
              execute addrootindex DAV_temp_R_h_a DAV_temp_3i_RC_h_a 
            PUT DAV_HR_prev_h_a(i,root1,niter_main) += DAV_temp_3i_RC_h_a(i,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_aaa(i2,i1,a,root1) i2
              DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_RC_ija_aaa(i2,i1,a,root1)
              execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
              DAV_temp_R_h_a_k(i,kk1) = Wiiia(i2,i,i1,a)*DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -0.5
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HRC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
           ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO i2, i, i1, a

      execute sip_barrier
#------------- alpha - beta - beta contribution------------------------|
       PARDO i, b, j1, i2
          DO kk1 
          DAV_temp_R_h_a(i) = 0.0
          DAV_temp_2i_RC_h_a(i,root1) = 0.0
          DAV_temp_RC_ija_abb_k(i2,j1,b,kk1) = 0.0

          REQUEST  Wiijb(i2,i,j1,b) i

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_abb(i2,j1,b,root1) i2
              DAV_temp_RC_ija_abb(i2,j1,b) = DAV_R_initguess_ija_abb(i2,j1,b,root1)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = Wiijb(i2,i,j1,b)*DAV_temp_RC_ija_abb_k(i2,j1,b,kk1)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HR0_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)          
        ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_abb(i2,j1,b,root1,niter_main) i2
              DAV_temp_RC_ija_abb(i2,j1,b) = DAV_RX_ija_abb(i2,j1,b,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = Wiijb(i2,i,j1,b)*DAV_temp_RC_ija_abb_k(i2,j1,b,kk1)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_RC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_a(i,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_abb(i2,j1,b,root1,niter_main) i2
              DAV_temp_RC_ija_abb(i2,j1,b) = DAV_R_ija_abb(i2,j1,b,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = Wiijb(i2,i,j1,b)*DAV_temp_RC_ija_abb_k(i2,j1,b,kk1)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_3i_RC_h_a
            PUT DAV_HR_prev_h_a(i,root1,niter_main) += DAV_temp_3i_RC_h_a(i,root1,niter_main)
           ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_abb(i2,j1,b,root1) i2
              DAV_temp_RC_ija_abb(i2,j1,b) = DAV_RC_ija_abb(i2,j1,b,root1)
              execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
              DAV_temp_R_h_a_k(i,kk1) = Wiijb(i2,i,j1,b)*DAV_temp_RC_ija_abb_k(i2,j1,b,kk1)
              DAV_temp_R_h_a(i) = DAV_temp_R_h_a_k(i,kk1)
              DAV_temp_R_h_a(i) *= -1.0
              execute addrootindex DAV_temp_R_h_a DAV_temp_2i_RC_h_a
            PUT DAV_HRC_h_a(i,root1) += DAV_temp_2i_RC_h_a(i,root1)
            ENDIF
         ENDIF
         ENDDO kk1 
       ENDPARDO i, b, j1, i2
        
       execute sip_barrier 
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|



###############################################################|
#---------------beta part--------------------------------------|
###############################################################|

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---- Hbar_j^i contribution (diagram S from my notes)----------|
#

      PARDO j,l
         DAV_temp_R_h_b(j) = 0.0
         DAV_temp_2i_RC_h_b(j,root1) = 0.0

         GET   Ujj(l,j)

         IF iter == 0.0
            GET DAV_R_initguess_h_b(l,root1)
              DAV_temp_RC_h_b(l) = DAV_R_initguess_h_b(l,root1)
              DAV_temp_R_h_b(j) = Ujj(l,j)*DAV_temp_RC_h_b(l)
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HR0_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            GET DAV_RX_h_b(l,root1,niter_main)
              DAV_temp_RC_h_b(l) = DAV_RX_h_b(l,root1,niter_main)
              DAV_temp_R_h_b(j) = Ujj(l,j)*DAV_temp_RC_h_b(l)
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_RC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_b(j,root1,niter_main) = 0.0
            GET DAV_R_h_b(l,root1,niter_main)
              DAV_temp_RC_h_b(l) = DAV_R_h_b(l,root1,niter_main)
              DAV_temp_R_h_b(j) = Ujj(l,j)*DAV_temp_RC_h_b(l)
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_3i_RC_h_b
            PUT DAV_HR_prev_h_b(j,root1,niter_main) += DAV_temp_3i_RC_h_b(j,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            GET DAV_RC_h_b(l,root1)
              DAV_temp_RC_h_b(l) = DAV_RC_h_b(l,root1)
              DAV_temp_R_h_b(j) = Ujj(l,j)*DAV_temp_RC_h_b(l)
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HRC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF
         ENDIF
      ENDPARDO j,l

      execute sip_barrier  


#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_ia contribution (diagrams 1 and 2)---------|
#
#----------beta - beta contribution--------------------------|
      PARDO j,l,b 
       

         GET Ujb(l,b)
         DO kk1
 
         DAV_temp_R_h_b(j) = 0.0
         DAV_temp_2i_RC_h_b(j,root1) = 0.0 
         DAV_temp_RC_ija_bbb_k(j,l,b,kk1) = 0.0

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_bbb(j,l,b,root1) j
#            REQUEST DAV_R_initguess_ija_bbb(l,j,b,root1) l
              DAV_temp_RC_ija_bbb(j,l,b) = DAV_R_initguess_ija_bbb(j,l,b,root1)
#              DAV_temp_R_ija_bbb(l,j,b) =  DAV_R_initguess_ija_bbb(l,j,b,root1)
#              t1ajxj(j,l,b) = DAV_temp_R_ija_bbb(l,j,b) 
#              DAV_temp_RC_ija_bbb(j,l,b) -= t1ajxj(j,l,b)
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_bbb_k(j,l,b,kk1)*Ujb(l,b)
#              DAV_temp_R_h_b_k(j,kk1) *= 0.5
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HR0_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_bbb(j,l,b,root1,niter_main) j
#            REQUEST DAV_RX_ija_bbb(l,j,b,root1,niter_main) l
              DAV_temp_RC_ija_bbb(j,l,b) = DAV_RX_ija_bbb(j,l,b,root1,niter_main)
#              DAV_temp_R_ija_bbb(l,j,b) = DAV_RX_ija_bbb(l,j,b,root1,niter_main)
#              t1ajxj(j,l,b) = DAV_temp_R_ija_bbb(l,j,b)
#              DAV_temp_RC_ija_bbb(j,l,b) -= t1ajxj(j,l,b)
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_bbb_k(j,l,b,kk1)*Ujb(l,b)
#              DAV_temp_R_h_b_k(j,kk1) *= 0.5
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_RC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_b(j,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_bbb(j,l,b,root1,niter_main) j
#            REQUEST DAV_R_ija_bbb(l,j,b,root1,niter_main) l
              DAV_temp_RC_ija_bbb(j,l,b) = DAV_R_ija_bbb(j,l,b,root1,niter_main)
#              DAV_temp_R_ija_bbb(l,j,b) =  DAV_R_ija_bbb(l,j,b,root1,niter_main)
#              t1ajxj(j,l,b) = DAV_temp_R_ija_bbb(l,j,b)
#              DAV_temp_RC_ija_bbb(j,l,b) -= t1ajxj(j,l,b)  
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_bbb_k(j,l,b,kk1)*Ujb(l,b)
#              DAV_temp_R_h_b_k(j,kk1) *= 0.5
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_3i_RC_h_b
            PUT DAV_HR_prev_h_b(j,root1,niter_main) += DAV_temp_3i_RC_h_b(j,root1,niter_main) 
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
#            REQUEST DAV_RC_ija_bbb(l,j,b,root1) l
              DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
#              DAV_temp_R_ija_bbb(l,j,b) =  DAV_RC_ija_bbb(l,j,b,root1)
#              t1ajxj(j,l,b) = DAV_temp_R_ija_bbb(l,j,b)
#              DAV_temp_RC_ija_bbb(j,l,b) -= t1ajxj(j,l,b)
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_bbb_k(j,l,b,kk1)*Ujb(l,b)
#              DAV_temp_R_h_b_k(j,kk1) *= 0.5
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HRC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF
         ENDIF
       ENDDO kk1   
      ENDPARDO j,l,b

      execute sip_barrier
#----------alpha - alpha contribution------------------------|
      PARDO j,k,a
       
      
         GET Uia(k,a)
         DO kk1

         DAV_temp_R_h_b(j) = 0.0
         DAV_temp_2i_RC_h_b(j,root1) = 0.0
         DAV_temp_RC_ija_baa_k(j,k,a,kk1) = 0.0

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_baa(j,k,a,root1) j
              DAV_temp_RC_ija_baa(j,k,a) = DAV_R_initguess_ija_baa(j,k,a,root1)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_baa_k(j,k,a,kk1)*Uia(k,a)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HR0_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_baa(j,k,a,root1,niter_main) j
              DAV_temp_RC_ija_baa(j,k,a) = DAV_RX_ija_baa(j,k,a,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_baa_k(j,k,a,kk1)*Uia(k,a)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_RC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_b(j,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_baa(j,k,a,root1,niter_main) j
              DAV_temp_RC_ija_baa(j,k,a) = DAV_R_ija_baa(j,k,a,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_baa_k(j,k,a,kk1)*Uia(k,a)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_3i_RC_h_b
            PUT DAV_HR_prev_h_b(j,root1,niter_main) += DAV_temp_3i_RC_h_b(j,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_baa(j,k,a,root1) j
              DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
              DAV_temp_R_h_b_k(j,kk1) = DAV_temp_RC_ija_baa_k(j,k,a,kk1)*Uia(k,a)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HRC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO j,k,a

      execute sip_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_jka^i contribution (diagrams 3 and 4 )-------------------------|
#
#------------- beta - beta - beta contribution-----------------------|
      PARDO j, b, j1, j2 
         DO kk1 

         DAV_temp_R_h_b(j) = 0.0
         DAV_temp_2i_RC_h_b(j,root1) = 0.0
         DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1) = 0.0

         REQUEST Wjjjb(j2,j,j1,b) j


         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_bbb(j2,j1,b,root1) j2
              DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_R_initguess_ija_bbb(j2,j1,b,root1)
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = Wjjjb(j2,j,j1,b)*DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              DAV_temp_R_h_b(j) *= -0.5
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HR0_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_bbb(j2,j1,b,root1,niter_main) j2
              DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_RX_ija_bbb(j2,j1,b,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = Wjjjb(j2,j,j1,b)*DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              DAV_temp_R_h_b(j) *= -0.5
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_RC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_b(j,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_bbb(j2,j1,b,root1,niter_main) j2
              DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_R_ija_bbb(j2,j1,b,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = Wjjjb(j2,j,j1,b)*DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              DAV_temp_R_h_b(j) *= -0.5
              execute addrootindex DAV_temp_R_h_b DAV_temp_3i_RC_h_b
            PUT DAV_HR_prev_h_b(j,root1,niter_main) += DAV_temp_3i_RC_h_b(j,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_bbb(j2,j1,b,root1) j2
              DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_RC_ija_bbb(j2,j1,b,root1)
              execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
              DAV_temp_R_h_b_k(j,kk1) = Wjjjb(j2,j,j1,b)*DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              DAV_temp_R_h_b(j) *= -0.5
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
           PUT DAV_HRC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF
         ENDIF

         ENDDO kk1  
      ENDPARDO j, b, j1, j2

      execute sip_barrier 

#------------- beta - alpha - alpha contribution---------------------|
#

      PARDO j, a, i1, j2
         REQUEST Wjjia(j2,j,i1,a) j
         DO kk1

         DAV_temp_R_h_b(j) = 0.0
         DAV_temp_2i_RC_h_b(j,root1) = 0.0
         DAV_temp_RC_ija_baa_k(j2,i1,a,kk1) = 0.0

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_baa(j2,i1,a,root1) j2
              DAV_temp_RC_ija_baa(j2,i1,a) = DAV_R_initguess_ija_baa(j2,i1,a,root1)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k 
              DAV_temp_R_h_b_k(j,kk1) = Wjjia(j2,j,i1,a)*DAV_temp_RC_ija_baa_k(j2,i1,a,kk1)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1) 
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HR0_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_baa(j2,i1,a,root1,niter_main) j2
              DAV_temp_RC_ija_baa(j2,i1,a) = DAV_RX_ija_baa(j2,i1,a,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
              DAV_temp_R_h_b_k(j,kk1) = Wjjia(j2,j,i1,a)*DAV_temp_RC_ija_baa_k(j2,i1,a,kk1)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_RC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_RC_h_b(j,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_baa(j2,i1,a,root1,niter_main) j2
              DAV_temp_RC_ija_baa(j2,i1,a) = DAV_R_ija_baa(j2,i1,a,root1,niter_main)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
              DAV_temp_R_h_b_k(j,kk1) = Wjjia(j2,j,i1,a)*DAV_temp_RC_ija_baa_k(j2,i1,a,kk1)
             DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_3i_RC_h_b   
            PUT DAV_HR_prev_h_b(j,root1,niter_main) += DAV_temp_3i_RC_h_b(j,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_baa(j2,i1,a,root1) j2
              DAV_temp_RC_ija_baa(j2,i1,a) = DAV_RC_ija_baa(j2,i1,a,root1)
              execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
              DAV_temp_R_h_b_k(j,kk1) = Wjjia(j2,j,i1,a)*DAV_temp_RC_ija_baa_k(j2,i1,a,kk1)
              DAV_temp_R_h_b(j) = DAV_temp_R_h_b_k(j,kk1)
              DAV_temp_R_h_b(j) *= -1.0
              execute addrootindex DAV_temp_R_h_b DAV_temp_2i_RC_h_b
            PUT DAV_HRC_h_b(j,root1) += DAV_temp_2i_RC_h_b(j,root1)
            ENDIF
         ENDIF
         ENDDO kk1  
      ENDPARDO j, a, i1, j2

      execute sip_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|



###############################################################|
#-------------alpha-alpha-alpha part---------------------------|
###############################################################|

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_k^ija contribution ------------------------|
#
      PARDO i,i1,a,i2
        REQUEST Wiiai(i2,i,a,i1) i2

          DO kk1

          DAV_temp_R_ija_aaa(i,i1,a) = 0.0
          DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
          DAV_temp_RC_h_a_k(i2,kk1) = 0.0

         IF iter == 0.0
            GET DAV_R_initguess_h_a(i2,root1)
            DAV_temp_RC_h_a(i2) = DAV_R_initguess_h_a(i2,root1)
            execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = Wiiai(i2,i,a,i1)*DAV_temp_RC_h_a_k(i2,kk1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) *= -1.0
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
           PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            GET DAV_RX_h_a(i2,root1,niter_main)
            DAV_temp_RC_h_a(i2) = DAV_RX_h_a(i2,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = Wiiai(i2,i,a,i1)*DAV_temp_RC_h_a_k(i2,kk1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) *= -1.0
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
           PREPARE DAV_RC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main) = 0.0
            GET DAV_R_h_a(i2,root1,niter_main)
            DAV_temp_RC_h_a(i2) = DAV_R_h_a(i2,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = Wiiai(i2,i,a,i1)*DAV_temp_RC_h_a_k(i2,kk1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) *= -1.0
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            GET DAV_RC_h_a(i2,root1)
            DAV_temp_RC_h_a(i2) = DAV_RC_h_a(i2,root1)
            execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = Wiiai(i2,i,a,i1)*DAV_temp_RC_h_a_k(i2,kk1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) *= -1.0
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa  DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO i,i1,a,i2

      execute server_barrier

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|
      PARDO a, i1, i, i2
        DO kk1
        DAV_temp_R_ija_aaa(i,i1,a) = 0.0
        DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0        
        DAV_temp_RC_ija_aaa_k(i,i2,a,kk1) = 0.0

        GET Uii(i2,i1)

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_aaa(i,i2,a,root1) i
            DAV_temp_RC_ija_aaa(i,i2,a) = DAV_R_initguess_ija_aaa(i,i2,a,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a,kk1)*Uii(i2,i1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
        ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_aaa(i,i2,a,root1,niter_main) i
            DAV_temp_RC_ija_aaa(i,i2,a) = DAV_RX_ija_aaa(i,i2,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a,kk1)*Uii(i2,i1)          
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_RC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_aaa(i,i2,a,root1,niter_main) i
            DAV_temp_RC_ija_aaa(i,i2,a) = DAV_R_ija_aaa(i,i2,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a,kk1)*Uii(i2,i1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_aaa(i,i2,a,root1) i
            DAV_temp_RC_ija_aaa(i,i2,a) = DAV_RC_ija_aaa(i,i2,a,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a,kk1)*Uii(i2,i1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO a, i1, i, i2

      execute server_barrier

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_j^i contribution (diagram 1.1)----------------|
#
      PARDO i,i1,a,i2
         DO kk1
        DAV_temp_R_ija_aaa(i,i1,a) = 0.0
        DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
        DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1) = 0.0       
 
        GET Uii(i2,i)

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_aaa(i2,i1,a,root1) i2
            DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_R_initguess_ija_aaa(i2,i1,a,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1)*Uii(i2,i)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_aaa(i2,i1,a,root1,niter_main) i2
            DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_RX_ija_aaa(i2,i1,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1)*Uii(i2,i)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_RC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_aaa(i2,i1,a,root1,niter_main) i2
            DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_R_ija_aaa(i2,i1,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1)*Uii(i2,i)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_aaa(i2,i1,a,root1) i2
            DAV_temp_RC_ija_aaa(i2,i1,a) = DAV_RC_ija_aaa(i2,i1,a,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i2,i1,a,kk1)*Uii(i2,i)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
           ENDIF
         ENDIF
         ENDDO kk1   
      ENDPARDO i,i1,a,i2

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)------------------|
#
      PARDO a, i, i1, a1
        
        GET Uaa(a,a1) 
             DO kk1

             DAV_temp_R_ija_aaa(i,i1,a) = 0.0
             DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
             DAV_temp_RC_ija_aaa_k(i,i1,a1,kk1) = 0.0

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_aaa(i,i1,a1,root1) i
            DAV_temp_RC_ija_aaa(i,i1,a1) = DAV_R_initguess_ija_aaa(i,i1,a1,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
         ENDIF

         IF iter > 0.0
           IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_aaa(i,i1,a1,root1,niter_main) i
            DAV_temp_RC_ija_aaa(i,i1,a1) = DAV_RX_ija_aaa(i,i1,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_RC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_aaa(i,i1,a1,root1,niter_main) i
            DAV_temp_RC_ija_aaa(i,i1,a1) = DAV_R_ija_aaa(i,i1,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_aaa(i,i1,a1,root1) i
            DAV_temp_RC_ija_aaa(i,i1,a1) = DAV_RC_ija_aaa(i,i1,a1,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDIF
         ENDIF
         ENDDO kk1 
      ENDPARDO a, i, i1, a1

      execute server_barrier

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|
#
      PARDO i, i1, i2, i3
            REQUEST             Wiiii(i2,i,i3,i1) i2
        
            DO kk1            

         IF iter == 0.0
            DO a

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1) = 0.0

            REQUEST DAV_R_initguess_ija_aaa(i2,i3,a,root1) i2
            DAV_temp_RC_ija_aaa(i2,i3,a) = DAV_R_initguess_ija_aaa(i2,i3,a,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iiii(i2,i3,i,i1) = Wiiii(i2,i,i3,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iiii(i2,i3,i,i1)*DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= 0.5
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDDO a
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO a

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1) = 0.0

            REQUEST DAV_RX_ija_aaa(i2,i3,a,root1,niter_main) i2
            DAV_temp_RC_ija_aaa(i2,i3,a) = DAV_RX_ija_aaa(i2,i3,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iiii(i2,i3,i,i1) = Wiiii(i2,i,i3,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iiii(i2,i3,i,i1)*DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= 0.5
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_RC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDDO a
            ENDIF

            IF Mkdav == 1.0
            DO a

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1) = 0.0

            REQUEST DAV_R_ija_aaa(i2,i3,a,root1,niter_main) i2
            DAV_temp_RC_ija_aaa(i2,i3,a) = DAV_R_ija_aaa(i2,i3,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iiii(i2,i3,i,i1) = Wiiii(i2,i,i3,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iiii(i2,i3,i,i1)*DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= 0.5
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa 
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main)
            ENDDO a
            ENDIF

            IF Mkcorr1 == 1.0
            DO a

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1) = 0.0

            REQUEST DAV_RC_ija_aaa(i2,i3,a,root1) i2
            DAV_temp_RC_ija_aaa(i2,i3,a) = DAV_RC_ija_aaa(i2,i3,a,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iiii(i2,i3,i,i1) = Wiiii(i2,i,i3,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iiii(i2,i3,i,i1)*DAV_temp_RC_ija_aaa_k(i2,i3,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) *= 0.5
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)
            ENDDO a
            ENDIF
         ENDIF
         ENDDO kk1 
      ENDPARDO i, i1, i2, i3

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)---------|
#
#-------------alpha-alpha-alpha part------------------------------| 
#
      PARDO i1, a, a1, i2
            REQUEST Wiaai(i2,a1,a,i1) a1
            DO kk1

         IF iter == 0.0
            DO i

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1) = 0.0

            REQUEST DAV_R_initguess_ija_aaa(i,i2,a1,root1) i
            DAV_temp_RC_ija_aaa(i,i2,a1) = DAV_R_initguess_ija_aaa(i,i2,a1,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i2,a1,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1)
            aux_iaia(i2,a1,i1,a) = Wiaai(i2,a1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iaia(i2,a1,i1,a)*aux_iaik(i2,a1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------| 

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            t1aixi(i1,i,a) *= -1.0
            execute addrootindex t1aixi DAV_temp_2i_RC_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i1,i,a,root1) += DAV_temp_2i_RC_ija_aaa(i1,i,a,root1)

            ENDDO i
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO i

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1) = 0.0


            REQUEST DAV_RX_ija_aaa(i,i2,a1,root1,niter_main) i
            DAV_temp_RC_ija_aaa(i,i2,a1) = DAV_RX_ija_aaa(i,i2,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i2,a1,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1)
            aux_iaia(i2,a1,i1,a) = Wiaai(i2,a1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iaia(i2,a1,i1,a)*aux_iaik(i2,a1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_RC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            t1aixi(i1,i,a) *= -1.0
            execute addrootindex t1aixi DAV_temp_2i_RC_ija_aaa
            PREPARE DAV_RC_ija_aaa(i1,i,a,root1) += DAV_temp_2i_RC_ija_aaa(i1,i,a,root1)

            ENDDO i
            ENDIF

#------------------------------------------------|

            IF Mkdav == 1.0
            DO i

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1) = 0.0  

            REQUEST DAV_R_ija_aaa(i,i2,a1,root1,niter_main) i
            DAV_temp_RC_ija_aaa(i,i2,a1) = DAV_R_ija_aaa(i,i2,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i2,a1,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1)
            aux_iaia(i2,a1,i1,a) = Wiaai(i2,a1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iaia(i2,a1,i1,a)*aux_iaik(i2,a1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main)

#--------------- i <-> j permuted term-------------|

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_3i_RC_ija_aaa(i1,i,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            t1aixi(i1,i,a) *= -1.0  
            execute addrootindex t1aixi DAV_temp_3i_RC_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i1,i,a,root1,niter_main) += DAV_temp_3i_RC_ija_aaa(i1,i,a,root1,niter_main)

            ENDDO i
            ENDIF

#------------------------------------------------|

            IF Mkcorr1 == 1.0
            DO i

            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1) = 0.0

            REQUEST DAV_RC_ija_aaa(i,i2,a1,root1) i
            DAV_temp_RC_ija_aaa(i,i2,a1) = DAV_RC_ija_aaa(i,i2,a1,root1)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i2,a1,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i2,a1,kk1)
            aux_iaia(i2,a1,i1,a) = Wiaai(i2,a1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_iaia(i2,a1,i1,a)*aux_iaik(i2,a1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            t1aixi(i1,i,a) *= -1.0
            execute addrootindex t1aixi DAV_temp_2i_RC_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i1,i,a,root1) += DAV_temp_2i_RC_ija_aaa(i1,i,a,root1)

            ENDDO i
            ENDIF
         ENDIF
            ENDDO kk1   
      ENDPARDO i1, a, a1, i2

      execute server_barrier

#-------------alpha-beta-beta part--------------------------------|
#-------step 1--------------|
      PARDO i1,a,b1,j2
            REQUEST Wjbai(j2,b1,a,i1) b1
            DO kk1

         IF iter == 0.0
            DO i
            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j2,b1,kk1) = 0.0
             
            REQUEST DAV_R_initguess_ija_abb(i,j2,b1,root1) i
            DAV_temp_RC_ija_abb(i,j2,b1) = DAV_R_initguess_ija_abb(i,j2,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j2,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j2,b1,kk1)
            aux_jbai(j2,b1,i1,a) = Wjbai(j2,b1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_jbai(j2,b1,i1,a)*aux_jbik(j2,b1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            execute addrootindex t1aixi DAV_temp_2i_RC_ija_aaa
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) *= -1.0
            PREPARE DAV_HR0_ija_aaa(i1,i,a,root1) += DAV_temp_2i_RC_ija_aaa(i1,i,a,root1)
            ENDDO i
         ENDIF

#------------------------------------------------|

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO i
            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j2,b1,kk1) = 0.0

            REQUEST DAV_RX_ija_abb(i,j2,b1,root1,niter_main) i
            DAV_temp_RC_ija_abb(i,j2,b1) = DAV_RX_ija_abb(i,j2,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j2,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j2,b1,kk1)
            aux_jbai(j2,b1,i1,a) = Wjbai(j2,b1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_jbai(j2,b1,i1,a)*aux_jbik(j2,b1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_RC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            execute addrootindex t1aixi DAV_temp_2i_RC_ija_aaa
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) *= -1.0
            PREPARE DAV_RC_ija_aaa(i1,i,a,root1) += DAV_temp_2i_RC_ija_aaa(i1,i,a,root1)
            ENDDO i
            ENDIF
#---------------------------------------------------------|
            IF Mkdav == 1.0
            DO i
            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_abb_k(i,j2,b1,kk1) = 0.0

            REQUEST DAV_R_ija_abb(i,j2,b1,root1,niter_main) i
            DAV_temp_RC_ija_abb(i,j2,b1) = DAV_R_ija_abb(i,j2,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j2,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j2,b1,kk1)
            aux_jbai(j2,b1,i1,a) = Wjbai(j2,b1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_jbai(j2,b1,i1,a)*aux_jbik(j2,b1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a,root1,niter_main)

#--------------- i <-> j permuted term-------------|

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_3i_RC_ija_aaa(i1,i,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            execute addrootindex t1aixi DAV_temp_3i_RC_ija_aaa
             DAV_temp_3i_RC_ija_aaa(i1,i,a,root1,niter_main) *= -1.0
            PREPARE DAV_HR_prev_ija_aaa(i1,i,a,root1,niter_main) += DAV_temp_3i_RC_ija_aaa(i1,i,a,root1,niter_main)
            ENDDO i
            ENDIF
#---------------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO i
            DAV_temp_R_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j2,b1,kk1) = 0.0

            REQUEST DAV_RC_ija_abb(i,j2,b1,root1) i
            DAV_temp_RC_ija_abb(i,j2,b1) = DAV_RC_ija_abb(i,j2,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j2,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j2,b1,kk1)
            aux_jbai(j2,b1,i1,a) = Wjbai(j2,b1,a,i1)
            DAV_temp_R_ija_aaa_k(i,i1,a,kk1) = aux_jbai(j2,b1,i1,a)*aux_jbik(j2,b1,i,kk1)
            DAV_temp_R_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HRC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_RC_ija_aaa(i,i1,a) = 0.0
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) = 0.0
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_temp_R_ija_aaa_k(i,i1,a,kk1)
            t1aixi(i1,i,a) = DAV_temp_RC_ija_aaa(i,i1,a)
            execute addrootindex t1aixi DAV_temp_2i_RC_ija_aaa
            DAV_temp_2i_RC_ija_aaa(i1,i,a,root1) *= -1.0
            PREPARE DAV_HRC_ija_aaa(i1,i,a,root1) += DAV_temp_2i_RC_ija_aaa(i1,i,a,root1)
            ENDDO i
            ENDIF
         ENDIF
            ENDDO kk1
      ENDPARDO i1,a,b1,j2

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

#      PARDO i,k,a
#         IF Mkcorr == 1.0
#         REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
#         DAV_temp_2i_RC_ija_aaa(i,k,a,root1) = DAV_RC_ija_aaa(i,k,a,root1)
#         execute dump_amp DAV_temp_2i_RC_ija_aaa
#         ENDIF
#      ENDPARDO i,k,a

#         execute server_barrier




###############################################################|
#-------------beta-beta-beta part------------------------------|
###############################################################|
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_k^ija contribution ------------------------|
#

      PARDO j,j1,b,j2
    
        REQUEST Wjjbj(j2,j,b,j1) j

         DO kk1
         DAV_temp_R_ija_bbb(j,j1,b) = 0.0     
         DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0
         DAV_temp_RC_h_b_k(j2,kk1) = 0.0

         IF iter == 0.0
            GET DAV_R_initguess_h_b(j2,root1)
            DAV_temp_RC_h_b(j2) = DAV_R_initguess_h_b(j2,root1)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k           
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = Wjjbj(j2,j,b,j1)*DAV_temp_RC_h_b_k(j2,kk1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) *= -1.0
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb  
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            GET DAV_RX_h_b(j2,root1,niter_main)
            DAV_temp_RC_h_b(j2) = DAV_RX_h_b(j2,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = Wjjbj(j2,j,b,j1)*DAV_temp_RC_h_b_k(j2,kk1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) *= -1.0
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) = 0.0
            GET DAV_R_h_b(j2,root1,niter_main)
            DAV_temp_RC_h_b(j2) = DAV_R_h_b(j2,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = Wjjbj(j2,j,b,j1)*DAV_temp_RC_h_b_k(j2,kk1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) *= -1.0
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            GET DAV_RC_h_b(j2,root1)
            DAV_temp_RC_h_b(j2) = DAV_RC_h_b(j2,root1)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = Wjjbj(j2,j,b,j1)*DAV_temp_RC_h_b_k(j2,kk1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) *= -1.0
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF
         ENDIF
         ENDDO kk1 
      ENDPARDO j,j1,b,j2

      execute server_barrier



#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|
#
      PARDO b, j1, j, j2
        DO kk1
        DAV_temp_R_ija_bbb(j,j1,b) = 0.0
        DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0
        DAV_temp_RC_ija_bbb_k(j,j2,b,kk1) = 0.0

        GET Ujj(j2,j1)

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_bbb(j,j2,b,root1) j
            DAV_temp_RC_ija_bbb(j,j2,b) = DAV_R_initguess_ija_bbb(j,j2,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b,kk1)*Ujj(j2,j1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_bbb(j,j2,b,root1,niter_main) j
            DAV_temp_RC_ija_bbb(j,j2,b) = DAV_RX_ija_bbb(j,j2,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b,kk1)*Ujj(j2,j1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_bbb(j,j2,b,root1,niter_main) j
            DAV_temp_RC_ija_bbb(j,j2,b) = DAV_R_ija_bbb(j,j2,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b,kk1)*Ujj(j2,j1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) 
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_bbb(j,j2,b,root1) j
            DAV_temp_RC_ija_bbb(j,j2,b) = DAV_RC_ija_bbb(j,j2,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b,kk1)*Ujj(j2,j1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO b, j1, j, j2

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_j^i contribution (diagram 1.1)----------------|
#

      PARDO j,j1,b,j2
        DO kk1
        DAV_temp_R_ija_bbb(j,j1,b) = 0.0
        DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0
        DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1) = 0.0

        GET Ujj(j2,j)

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_bbb(j2,j1,b,root1) j2
            DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_R_initguess_ija_bbb(j2,j1,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)*Ujj(j2,j)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_bbb(j2,j1,b,root1,niter_main) j2
            DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_RX_ija_bbb(j2,j1,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k 
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)*Ujj(j2,j)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF

            IF Mkdav == 1.0
            REQUEST DAV_R_ija_bbb(j2,j1,b,root1,niter_main) j2
            DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) = 0.0
            DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_R_ija_bbb(j2,j1,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)*Ujj(j2,j)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) 
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_bbb(j2,j1,b,root1) j2
            DAV_temp_RC_ija_bbb(j2,j1,b) = DAV_RC_ija_bbb(j2,j1,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j2,j1,b,kk1)*Ujj(j2,j)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF
         ENDIF
         ENDDO kk1 
      ENDPARDO j,j1,b,j2

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)------------------|
#
      PARDO b, j, j1, b1
        GET Ubb(b,b1)

        DO kk1
        DAV_temp_R_ija_bbb(j,j1,b) = 0.0 
        DAV_temp_RC_ija_bbb_k(j,j1,b1,kk1) = 0.0
        DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_bbb(j,j1,b1,root1) j
            DAV_temp_RC_ija_bbb(j,j1,b1) = DAV_R_initguess_ija_bbb(j,j1,b1,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k             
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)            
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_bbb(j,j1,b1,root1,niter_main) j
            DAV_temp_RC_ija_bbb(j,j1,b1) = DAV_RX_ija_bbb(j,j1,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) = 0.0
            REQUEST DAV_R_ija_bbb(j,j1,b1,root1,niter_main) j
            DAV_temp_RC_ija_bbb(j,j1,b1) = DAV_R_ija_bbb(j,j1,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb 
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_bbb(j,j1,b1,root1) j
            DAV_temp_RC_ija_bbb(j,j1,b1) = DAV_RC_ija_bbb(j,j1,b1,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO b, j, j1, b1

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|

      PARDO j, j1, j2, j3
        REQUEST Wjjjj(j2,j,j3,j1) j2

         DO kk1  

         IF iter == 0.0
            DO b

            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_R_initguess_ija_bbb(j2,j3,b,root1) j2
            DAV_temp_RC_ija_bbb(j2,j3,b) = DAV_R_initguess_ija_bbb(j2,j3,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_jjjj(j2,j3,j,j1) = Wjjjj(j2,j,j3,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jjjj(j2,j3,j,j1)*DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= 0.5
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDDO b
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO b

            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_RX_ija_bbb(j2,j3,b,root1,niter_main) j2
            DAV_temp_RC_ija_bbb(j2,j3,b) = DAV_RX_ija_bbb(j2,j3,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_jjjj(j2,j3,j,j1) = Wjjjj(j2,j,j3,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jjjj(j2,j3,j,j1)*DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= 0.5
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDDO b
            ENDIF
#------------------------------------------------------------
            IF Mkdav == 1.0
            DO b
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1) = 0.0
            DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) = 0.0

            REQUEST DAV_R_ija_bbb(j2,j3,b,root1,niter_main) j2
            DAV_temp_RC_ija_bbb(j2,j3,b) = DAV_R_ija_bbb(j2,j3,b,root1,niter_main)
            DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1) = DAV_temp_RC_ija_bbb(j2,j3,b)
            aux_jjjj(j2,j3,j,j1) = Wjjjj(j2,j,j3,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jjjj(j2,j3,j,j1)*DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= 0.5
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main)
            ENDDO b
            ENDIF
#-------------------------------------------------------------
            IF Mkcorr1 == 1.0
            DO b
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_RC_ija_bbb(j2,j3,b,root1) j2
            DAV_temp_RC_ija_bbb(j2,j3,b) = DAV_RC_ija_bbb(j2,j3,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_jjjj(j2,j3,j,j1) = Wjjjj(j2,j,j3,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jjjj(j2,j3,j,j1)*DAV_temp_RC_ija_bbb_k(j2,j3,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) *= 0.5
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
            ENDDO b
            ENDIF
         ENDIF
         ENDDO kk1 
      ENDPARDO j, j1, j2, j3

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)---------|
#
#-------------beta-beta-beta part---------------------------------| 
#
      PARDO j1, b, b1, j2
        REQUEST Wjbbj(j2,b1,b,j1) b1
        DO kk1

         IF iter == 0.0
            DO j
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_R_initguess_ija_bbb(j,j2,b1,root1) j
            DAV_temp_RC_ija_bbb(j,j2,b1) = DAV_R_initguess_ija_bbb(j,j2,b1,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_jbjb(j2,b1,j1,b) = Wjbbj(j2,b1,b,j1)
            aux_jbjk(j2,b1,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1)  
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jbjb(j2,b1,j1,b)*aux_jbjk(j2,b1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_2i_RC_ija_bbb(j1,j,b,root1) = 0.0
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            t1ajxj(j1,j,b) = DAV_temp_RC_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_2i_RC_ija_bbb 
            PREPARE DAV_HR0_ija_bbb(j1,j,b,root1) += DAV_temp_2i_RC_ija_bbb(j1,j,b,root1)
            ENDDO j
         ENDIF

#----------------------------------------------|

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO j
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_RX_ija_bbb(j,j2,b1,root1,niter_main) j
            DAV_temp_RC_ija_bbb(j,j2,b1) = DAV_RX_ija_bbb(j,j2,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_jbjb(j2,b1,j1,b) = Wjbbj(j2,b1,b,j1)
            aux_jbjk(j2,b1,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jbjb(j2,b1,j1,b)*aux_jbjk(j2,b1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)

#--------------- i <-> j permuted term-------------|
            
            DAV_temp_2i_RC_ija_bbb(j1,j,b,root1) = 0.0
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            t1ajxj(j1,j,b) = DAV_temp_RC_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_2i_RC_ija_bbb
            PREPARE DAV_RC_ija_bbb(j1,j,b,root1) += DAV_temp_2i_RC_ija_bbb(j1,j,b,root1)
            ENDDO j
            ENDIF
#-----------------------------------------------------------|
            IF Mkdav == 1.0
            DO j
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1) = 0.0
            DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) = 0.0
  
            REQUEST DAV_R_ija_bbb(j,j2,b1,root1,niter_main) j
            DAV_temp_RC_ija_bbb(j,j2,b1) = DAV_R_ija_bbb(j,j2,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_jbjb(j2,b1,j1,b) = Wjbbj(j2,b1,b,j1)
            aux_jbjk(j2,b1,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jbjb(j2,b1,j1,b)*aux_jbjk(j2,b1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main)

#--------------- i <-> j permuted term-------------|

            DAV_temp_3i_RC_ija_bbb(j1,j,b,root1,niter_main) = 0.0
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            t1ajxj(j1,j,b) = DAV_temp_RC_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_3i_RC_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j1,j,b,root1,niter_main) += DAV_temp_3i_RC_ija_bbb(j1,j,b,root1,niter_main)
            ENDDO j
            ENDIF
#-----------------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO j

            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_RC_ija_bbb(j,j2,b1,root1) j
            DAV_temp_RC_ija_bbb(j,j2,b1) = DAV_RC_ija_bbb(j,j2,b1,root1)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_jbjb(j2,b1,j1,b) = Wjbbj(j2,b1,b,j1)
            aux_jbjk(j2,b1,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j2,b1,kk1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_jbjb(j2,b1,j1,b)*aux_jbjk(j2,b1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_2i_RC_ija_bbb(j1,j,b,root1) = 0.0
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            t1ajxj(j1,j,b) = DAV_temp_RC_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_2i_RC_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j1,j,b,root1) += DAV_temp_2i_RC_ija_bbb(j1,j,b,root1)
            ENDDO j
            ENDIF
         ENDIF
         ENDDO kk1  
      ENDPARDO j1, b, b1, j2

      execute server_barrier
#-------------beta-alpha-alpha part-------------------------------|

      PARDO j1, b, a1, i2
        REQUEST Wiabj(i2,a1,b,j1) i2 
         DO kk1
         IF iter == 0.0
            DO j
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_baa_k(j,i2,a1,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_R_initguess_ija_baa(j,i2,a1,root1) j
            DAV_temp_RC_ija_baa(j,i2,a1) = DAV_R_initguess_ija_baa(j,i2,a1,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_iajk(i2,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i2,a1,kk1)
            aux_iajb(i2,a1,j1,b) = Wiabj(i2,a1,b,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_iajb(i2,a1,j1,b)*aux_iajk(i2,a1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HR0_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
#--------------- i <-> j permuted term-------------|
            DAV_temp_2i_RC_ija_bbb(j1,j,b,root1) = 0.0
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            t1ajxj(j1,j,b) = DAV_temp_RC_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_2i_RC_ija_bbb
            PREPARE DAV_HR0_ija_bbb(j1,j,b,root1) += DAV_temp_2i_RC_ija_bbb(j1,j,b,root1)
            ENDDO j
         ENDIF

#-----------------------------------------------|

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO j
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_baa_k(j,i2,a1,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_RX_ija_baa(j,i2,a1,root1,niter_main) j
            DAV_temp_RC_ija_baa(j,i2,a1) = DAV_RX_ija_baa(j,i2,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_iajk(i2,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i2,a1,kk1)
            aux_iajb(i2,a1,j1,b) = Wiabj(i2,a1,b,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_iajb(i2,a1,j1,b)*aux_iajk(i2,a1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
#--------------- i <-> j permuted term-------------|
            DAV_temp_2i_RC_ija_bbb(j1,j,b,root1) = 0.0
            t1ajxj(j1,j,b) = DAV_temp_R_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_2i_RC_ija_bbb
            PREPARE DAV_RC_ija_bbb(j1,j,b,root1) += DAV_temp_2i_RC_ija_bbb(j1,j,b,root1)
            ENDDO j
            ENDIF
#------------------------------------------------------------|
            IF Mkdav == 1.0
            DO j
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_baa_k(j,i2,a1,kk1) = 0.0
            DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main) = 0.0

            REQUEST DAV_R_ija_baa(j,i2,a1,root1,niter_main) j
            DAV_temp_RC_ija_baa(j,i2,a1) = DAV_R_ija_baa(j,i2,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_iajk(i2,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i2,a1,kk1)
            aux_iajb(i2,a1,j1,b) = Wiabj(i2,a1,b,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_iajb(i2,a1,j1,b)*aux_iajk(i2,a1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b,root1,niter_main)
#--------------- i <-> j permuted term-------------|
            DAV_temp_3i_RC_ija_bbb(j1,j,b,root1,niter_main) = 0.0
            t1ajxj(j1,j,b) = DAV_temp_R_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_3i_RC_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j1,j,b,root1,niter_main) += DAV_temp_3i_RC_ija_bbb(j1,j,b,root1,niter_main)
            ENDDO j
            ENDIF
#------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO j
            DAV_temp_R_ija_bbb(j,j1,b) = 0.0
            DAV_temp_RC_ija_baa_k(j,i2,a1,kk1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b,root1) = 0.0

            REQUEST DAV_RC_ija_baa(j,i2,a1,root1) j
            DAV_temp_RC_ija_baa(j,i2,a1) = DAV_RC_ija_baa(j,i2,a1,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_iajk(i2,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i2,a1,kk1)
            aux_iajb(i2,a1,j1,b) = Wiabj(i2,a1,b,j1)
            DAV_temp_R_ija_bbb_k(j,j1,b,kk1) = aux_iajb(i2,a1,j1,b)*aux_iajk(i2,a1,j,kk1)
            DAV_temp_R_ija_bbb(j,j1,b) = DAV_temp_R_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b,root1)
#--------------- i <-> j permuted term-------------|
            DAV_temp_2i_RC_ija_bbb(j1,j,b,root1) = 0.0
            t1ajxj(j1,j,b) = DAV_temp_R_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_2i_RC_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j1,j,b,root1) += DAV_temp_2i_RC_ija_bbb(j1,j,b,root1)
            ENDDO j
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO j1, b, a1, i2

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|



###############################################################|
#-------------alpha-beta-beta part-----------------------------|
###############################################################|
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_k^ija contribution ------------------------|
#
      PARDO b, i, j, i1
        REQUEST Wiibj(i1,i,b,j) b
         DO kk1
  
         DAV_temp_R_ija_abb(i,j,b) = 0.0
         DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
         DAV_temp_RC_h_a_k(i1,kk1) = 0.0



         IF iter == 0.0
         GET DAV_R_initguess_h_a(i1,root1)
         DAV_temp_RC_h_a(i1) = DAV_R_initguess_h_a(i1,root1)
         execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k
         DAV_temp_R_ija_abb_k(i,j,b,kk1) = Wiibj(i1,i,b,j)*DAV_temp_RC_h_a_k(i1,kk1)
         DAV_temp_R_ija_abb_k(i,j,b,kk1) *= -1.0
         DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
         execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
         PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            GET DAV_RX_h_a(i1,root1,niter_main)
            DAV_temp_RC_h_a(i1) = DAV_RX_h_a(i1,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = Wiibj(i1,i,b,j)*DAV_temp_RC_h_a_k(i1,kk1)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) *= -1.0
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDIF
#-----------------------------------------------------|
            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0
            GET DAV_R_h_a(i1,root1,niter_main)
            DAV_temp_RC_h_a(i1) = DAV_R_h_a(i1,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k 
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = Wiibj(i1,i,b,j)*DAV_temp_RC_h_a_k(i1,kk1)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) *= -1.0
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDIF
#-----------------------------------------------------|
            IF Mkcorr1 == 1.0
            GET DAV_RC_h_a(i1,root1)             
            DAV_temp_RC_h_a(i1) = DAV_RC_h_a(i1,root1)
            execute addrootindex DAV_temp_RC_h_a DAV_temp_RC_h_a_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = Wiibj(i1,i,b,j)*DAV_temp_RC_h_a_k(i1,kk1)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) *= -1.0
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDIF
         ENDIF
           
         ENDDO kk1
      ENDPARDO b, i, j, i1 

      execute server_barrier 

 
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|


      PARDO i, b, j1
           DO kk1  

 
         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_abb(i,j1,b,root1) i
            DO j

            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j1,b,kk1) = 0.0

            GET Ujj(j1,j)
            DAV_temp_RC_ija_abb(i,j1,b) = DAV_R_initguess_ija_abb(i,j1,b,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = DAV_temp_RC_ija_abb_k(i,j1,b,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO j  
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_abb(i,j1,b,root1,niter_main) i
            DO j

            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j1,b,kk1) = 0.0

            GET Ujj(j1,j)
            DAV_temp_RC_ija_abb(i,j1,b) = DAV_RX_ija_abb(i,j1,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) =  DAV_temp_RC_ija_abb_k(i,j1,b,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO j
            ENDIF
#------------------------------------------|
            IF Mkdav == 1.0
            REQUEST DAV_R_ija_abb(i,j1,b,root1,niter_main) i 
            DO j

            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0           
            DAV_temp_RC_ija_abb_k(i,j1,b,kk1) = 0.0           

            GET Ujj(j1,j)
            DAV_temp_RC_ija_abb(i,j1,b) = DAV_R_ija_abb(i,j1,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) =  DAV_temp_RC_ija_abb_k(i,j1,b,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDDO j 
            ENDIF
#------------------------------------------|
            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_abb(i,j1,b,root1) i
            DO j

            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j1,b,kk1) = 0.0

            GET Ujj(j1,j)
            DAV_temp_RC_ija_abb(i,j1,b) = DAV_RC_ija_abb(i,j1,b,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) =  DAV_temp_RC_ija_abb_k(i,j1,b,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO j  
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO i, b, j1

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_j^i contribution (diagram 1.1)----------------|
#
      PARDO b, j, i1 
         DO kk1 
         

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_abb(i1,j,b,root1) i1
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b,kk1) = 0.0

            GET Uii(i1,i)
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_R_initguess_ija_abb(i1,j,b,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = DAV_temp_RC_ija_abb_k(i1,j,b,kk1)*Uii(i1,i)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_abb(i1,j,b,root1,niter_main) i1
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b,kk1) = 0.0
   
            GET Uii(i1,i)
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_RX_ija_abb(i1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k  
            DAV_temp_R_ija_abb_k(i,j,b,kk1) =  DAV_temp_RC_ija_abb_k(i1,j,b,kk1)*Uii(i1,i)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
            ENDIF
#---------------------------------------------------|
            IF Mkdav == 1.0
           REQUEST DAV_R_ija_abb(i1,j,b,root1,niter_main) i1
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b,kk1) = 0.0

            GET Uii(i1,i)
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_R_ija_abb(i1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) =  DAV_temp_RC_ija_abb_k(i1,j,b,kk1)*Uii(i1,i)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDDO i
            ENDIF
#---------------------------------------------------|
            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_abb(i1,j,b,root1) i1
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b,kk1) = 0.0

            GET Uii(i1,i)
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_RC_ija_abb(i1,j,b,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = DAV_temp_RC_ija_abb_k(i1,j,b,kk1)*Uii(i1,i)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= -1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO b, j, i1 

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)------------------|
#
      PARDO j, i, b1
         DO kk1

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_abb(i,j,b1,root1) i
           DO b
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j,b1,kk1) = 0.0 

            GET Ubb(b,b1)
            DAV_temp_RC_ija_abb(i,j,b1) = DAV_R_initguess_ija_abb(i,j,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = DAV_temp_RC_ija_abb_k(i,j,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1) 
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO b
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_abb(i,j,b1,root1,niter_main) i
            DO b
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j,b1,kk1) = 0.0 

            GET Ubb(b,b1)
            DAV_temp_RC_ija_abb(i,j,b1) = DAV_RX_ija_abb(i,j,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) =  DAV_temp_RC_ija_abb_k(i,j,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)  
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO b
            ENDIF
#----------------------------------------------------|
            IF Mkdav == 1.0
            REQUEST DAV_R_ija_abb(i,j,b1,root1,niter_main) i
            DO b
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0
            DAV_temp_RC_ija_abb_k(i,j,b1,kk1) = 0.0

            GET Ubb(b,b1)
            DAV_temp_RC_ija_abb(i,j,b1) = DAV_R_ija_abb(i,j,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = DAV_temp_RC_ija_abb_k(i,j,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDDO b
            ENDIF
#----------------------------------------------------|
            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_abb(i,j,b1,root1) i
            DO b
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j,b1,kk1) = 0.0

            GET Ubb(b,b1)
            DAV_temp_RC_ija_abb(i,j,b1) = DAV_RC_ija_abb(i,j,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            DAV_temp_R_ija_abb_k(i,j,b,kk1) =  DAV_temp_RC_ija_abb_k(i,j,b1,kk1)*Ubb(b,b1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO b
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO j, i ,b1

      execute server_barrier  
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|

      PARDO i, j, j1, i1
        REQUEST  Wiijj(i1,i,j1,j) i1 
         DO kk1 

         IF iter == 0.0
            DO b  

            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j1,b,kk1) = 0.0

            REQUEST DAV_R_initguess_ija_abb(i1,j1,b,root1) i1
            DAV_temp_RC_ija_abb(i1,j1,b) = DAV_R_initguess_ija_abb(i1,j1,b,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_ijij(i,j,i1,j1) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ijij(i,j,i1,j1)*DAV_temp_RC_ija_abb_k(i1,j1,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= 1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO b
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO b

            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j1,b,kk1) = 0.0

            REQUEST DAV_RX_ija_abb(i1,j1,b,root1,niter_main) i1
            DAV_temp_RC_ija_abb(i1,j1,b) = DAV_RX_ija_abb(i1,j1,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k 
            aux_ijij(i,j,i1,j1) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ijij(i,j,i1,j1)*DAV_temp_RC_ija_abb_k(i1,j1,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= 1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO b
            ENDIF
#-----------------------------------------------|
            IF Mkdav == 1.0
            DO b 
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j1,b,kk1) = 0.0

            REQUEST DAV_R_ija_abb(i1,j1,b,root1,niter_main) i1
            DAV_temp_RC_ija_abb(i1,j1,b) = DAV_R_ija_abb(i1,j1,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_ijij(i,j,i1,j1) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ijij(i,j,i1,j1)*DAV_temp_RC_ija_abb_k(i1,j1,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= 1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDDO b
           ENDIF
#-----------------------------------------------|
            IF Mkcorr1 == 1.0
            DO b

            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j1,b,kk1) = 0.0

            REQUEST DAV_RC_ija_abb(i1,j1,b,root1) i1
            DAV_temp_RC_ija_abb(i1,j1,b) = DAV_RC_ija_abb(i1,j1,b,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_ijij(i,j,i1,j1) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ijij(i,j,i1,j1)*DAV_temp_RC_ija_abb_k(i1,j1,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            DAV_temp_R_ija_abb(i,j,b) *= 1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO b
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO i, j, j1, i1

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)---------|
#
#------------alpha-alpha-alpha part-------------------------------| 
#------step 2-----|
      PARDO j, b, i1, a
        REQUEST Wiabj(i1,a,b,j) i1
        DO kk1

         IF iter == 0.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i1,a,kk1) = 0.0
 
            REQUEST DAV_R_initguess_ija_aaa(i,i1,a,root1) i
#            REQUEST DAV_R_initguess_ija_aaa(i1,i,a,root1) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_R_initguess_ija_aaa(i,i1,a,root1)
#            DAV_temp_R_ija_aaa(i1,i,a) =  DAV_R_initguess_ija_aaa(i1,i,a,root1)
#            t1aixi(i,i1,a) = DAV_temp_R_ija_aaa(i1,i,a)
#            DAV_temp_RC_ija_aaa(i,i1,a) -= t1aixi(i,i1,a)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i1,a,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a,kk1)
            aux_iajb(i1,a,j,b) = Wiabj(i1,a,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_iajb(i1,a,j,b)*aux_iaik(i1,a,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
#            DAV_temp_2i_R_ija_abb(i,j,b,root1) *= 0.5
            PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i1,a,kk1) = 0.0

            REQUEST DAV_RX_ija_aaa(i,i1,a,root1,niter_main) i
#            REQUEST DAV_RX_ija_aaa(i1,i,a,root1,niter_main) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_RX_ija_aaa(i,i1,a,root1,niter_main)
#            DAV_temp_R_ija_aaa(i1,i,a) =  DAV_RX_ija_aaa(i1,i,a,root1,niter_main)
#            t1aixi(i,i1,a) = DAV_temp_R_ija_aaa(i1,i,a)
#            DAV_temp_RC_ija_aaa(i,i1,a) -= t1aixi(i,i1,a)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i1,a,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a,kk1)
            aux_iajb(i1,a,j,b) = Wiabj(i1,a,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_iajb(i1,a,j,b)*aux_iaik(i1,a,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
#            DAV_temp_2i_R_ija_abb(i,j,b,root1) *= 0.5
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
            ENDIF
#-----------------------------------------------------|
            IF Mkdav == 1.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i1,a,kk1) = 0.0

            REQUEST DAV_R_ija_aaa(i,i1,a,root1,niter_main) i
#            REQUEST DAV_R_ija_aaa(i1,i,a,root1,niter_main) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_R_ija_aaa(i,i1,a,root1,niter_main)
#            DAV_temp_R_ija_aaa(i1,i,a) =  DAV_R_ija_aaa(i1,i,a,root1,niter_main)          
#            t1aixi(i,i1,a) = DAV_temp_R_ija_aaa(i1,i,a)
#            DAV_temp_RC_ija_aaa(i,i1,a) -= t1aixi(i,i1,a)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i1,a,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a,kk1)
            aux_iajb(i1,a,j,b) = Wiabj(i1,a,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_iajb(i1,a,j,b)*aux_iaik(i1,a,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
#            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) *= 0.5
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDDO i
            ENDIF
#-----------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_aaa_k(i,i1,a,kk1) = 0.0

            REQUEST DAV_RC_ija_aaa(i,i1,a,root1) i
#            REQUEST DAV_RC_ija_aaa(i1,i,a,root1) i1
            DAV_temp_RC_ija_aaa(i,i1,a) = DAV_RC_ija_aaa(i,i1,a,root1)
#            DAV_temp_R_ija_aaa(i1,i,a) = DAV_RC_ija_aaa(i1,i,a,root1)
#            t1aixi(i,i1,a) = DAV_temp_R_ija_aaa(i1,i,a)
#            DAV_temp_RC_ija_aaa(i,i1,a) -= t1aixi(i,i1,a)
            execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_RC_ija_aaa_k
            aux_iaik(i1,a,i,kk1) = DAV_temp_RC_ija_aaa_k(i,i1,a,kk1)
            aux_iajb(i1,a,j,b) = Wiabj(i1,a,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_iajb(i1,a,j,b)*aux_iaik(i1,a,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
#            DAV_temp_2i_R_ija_abb(i,j,b,root1) *= 0.5
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO j, b, i1, a 

      execute server_barrier
#------------alpha-beta-beta part---------------------------------|
      PARDO j, b, j1, b1
        REQUEST Wjbbj(j1,b1,b,j) b1
        DO kk1 

         IF iter == 0.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j1,b1,kk1) = 0.0

            REQUEST DAV_R_initguess_ija_abb(i,j1,b1,root1) i
            DAV_temp_RC_ija_abb(i,j1,b1) = DAV_R_initguess_ija_abb(i,j1,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j1,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j1,b1,kk1)
            aux_jbjb(j,b,j1,b1) = Wjbbj(j1,b1,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_jbjb(j,b,j1,b1)*aux_jbik(j1,b1,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j1,b1,kk1) = 0.0

            REQUEST DAV_RX_ija_abb(i,j1,b1,root1,niter_main) i
            DAV_temp_RC_ija_abb(i,j1,b1) = DAV_RX_ija_abb(i,j1,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j1,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j1,b1,kk1)
            aux_jbjb(j,b,j1,b1) = Wjbbj(j1,b1,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_jbjb(j,b,j1,b1)*aux_jbik(j1,b1,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
            ENDIF
#--------------------------------------------------------------|
            IF Mkdav == 1.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0
            DAV_temp_RC_ija_abb_k(i,j1,b1,kk1) = 0.0

            REQUEST DAV_R_ija_abb(i,j1,b1,root1,niter_main) i
            DAV_temp_RC_ija_abb(i,j1,b1) = DAV_R_ija_abb(i,j1,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j1,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j1,b1,kk1)
            aux_jbjb(j,b,j1,b1) = Wjbbj(j1,b1,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_jbjb(j,b,j1,b1)*aux_jbik(j1,b1,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDDO i
            ENDIF
#--------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO i
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_RC_ija_abb_k(i,j1,b1,kk1) = 0.0

            REQUEST DAV_RC_ija_abb(i,j1,b1,root1) i
            DAV_temp_RC_ija_abb(i,j1,b1) = DAV_RC_ija_abb(i,j1,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_jbik(j1,b1,i,kk1) = DAV_temp_RC_ija_abb_k(i,j1,b1,kk1) 
            aux_jbjb(j,b,j1,b1) = Wjbbj(j1,b1,b,j)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_jbjb(j,b,j1,b1)*aux_jbik(j1,b1,i,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb 
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO i
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO j, b, j1, b1

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

###############################################################|
#-------------beta-alpha-alpha part----------------------------|
###############################################################|

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_k^ija contribution ------------------------|
#

      PARDO a, j, i, j1      

        REQUEST Wjjai(j1,j,a,i) a
        DO kk1 

        DAV_temp_R_ija_baa(j,i,a) = 0.0
        DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
        DAV_temp_RC_h_b_k(j1,kk1) = 0.0 


         IF iter == 0.0
            GET DAV_R_initguess_h_b(j1,root1)
            DAV_temp_RC_h_b(j1) = DAV_R_initguess_h_b(j1,root1)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = Wjjai(j1,j,a,i)*DAV_temp_RC_h_b_k(j1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) *= -1.0
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            GET DAV_RX_h_b(j1,root1,niter_main)
            DAV_temp_RC_h_b(j1) = DAV_RX_h_b(j1,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = Wjjai(j1,j,a,i)*DAV_temp_RC_h_b_k(j1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) *= -1.0
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDIF
#----------------------------------------------------|
            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            GET DAV_R_h_b(j1,root1,niter_main)
            DAV_temp_RC_h_b(j1) = DAV_R_h_b(j1,root1,niter_main)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = Wjjai(j1,j,a,i)*DAV_temp_RC_h_b_k(j1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) *= -1.0
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main)
            ENDIF
#----------------------------------------------------|
            IF Mkcorr1 == 1.0
            GET DAV_RC_h_b(j1,root1)
            DAV_temp_RC_h_b(j1) = DAV_RC_h_b(j1,root1)
            execute addrootindex DAV_temp_RC_h_b DAV_temp_RC_h_b_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = Wjjai(j1,j,a,i)*DAV_temp_RC_h_b_k(j1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) *= -1.0
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa 
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDIF
         ENDIF
        ENDDO kk1 
      ENDPARDO a, j, i, j1

      execute server_barrier


#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|

      PARDO j, a, i1
         DO kk1        

         DAV_temp_RC_ija_baa_k(j,i1,a,kk1) = 0.0  

         IF iter == 0.0           
            REQUEST DAV_R_initguess_ija_baa(j,i1,a,root1) j
                        

            DO i
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0

            GET Uii(i1,i)
            DAV_temp_RC_ija_baa(j,i1,a) = DAV_R_initguess_ija_baa(j,i1,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a,kk1)*Uii(i1,i)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)   
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO i
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_baa(j,i1,a,root1,niter_main) j
            DO i
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
           

            GET Uii(i1,i)
            DAV_temp_RC_ija_baa(j,i1,a) = DAV_RX_ija_baa(j,i1,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a,kk1)*Uii(i1,i)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO i
            ENDIF
#-------------------------------------------------------------|
            IF Mkdav == 1.0

            REQUEST DAV_R_ija_baa(j,i1,a,root1,niter_main) j
            DO i
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            GET Uii(i1,i)
            DAV_temp_RC_ija_baa(j,i1,a) = DAV_R_ija_baa(j,i1,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a,kk1)*Uii(i1,i)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main)
            ENDDO i
            ENDIF
#-------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_baa(j,i1,a,root1) j
            DO i
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0

            GET Uii(i1,i)
            DAV_temp_RC_ija_baa(j,i1,a) = DAV_RC_ija_baa(j,i1,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a,kk1)*Uii(i1,i)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO i
            ENDIF
         ENDIF

         ENDDO kk1
     ENDPARDO j, a, i1

      execute server_barrier   
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_j^i contribution (diagram 1.1)----------------|
#
      PARDO a, i, j1
          DO kk1     

          DAV_temp_RC_ija_baa_k(j1,i,a,kk1) = 0.0
 
         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_baa(j1,i,a,root1) j1
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0

            GET Ujj(j1,j)
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_R_initguess_ija_baa(j1,i,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
         ENDIF


         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_baa(j1,i,a,root1,niter_main) j1
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0

            GET Ujj(j1,j)
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_RX_ija_baa(j1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k   
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
            ENDIF
#--------------------------------------------------------------|
            IF Mkdav == 1.0
            REQUEST DAV_R_ija_baa(j1,i,a,root1,niter_main) j1
            DO j
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            GET Ujj(j1,j)
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_R_ija_baa(j1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) 
            ENDDO j
            ENDIF
#--------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_baa(j1,i,a,root1) j1
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            GET Ujj(j1,j)
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_RC_ija_baa(j1,i,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a,kk1)*Ujj(j1,j)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= -1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
            ENDIF
         ENDIF

         ENDDO kk1
      ENDPARDO a, i, j1

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)------------------|
#
      PARDO i, j, a1
         DO kk1 
         DAV_temp_RC_ija_baa_k(j,i,a1,kk1) = 0.0

         IF iter == 0.0
            REQUEST DAV_R_initguess_ija_baa(j,i,a1,root1) j
            DAV_temp_RC_ija_baa(j,i,a1) = DAV_R_initguess_ija_baa(j,i,a1,root1) 
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k          
  
            DO a
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            GET Uaa(a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1) 
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO a
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_baa(j,i,a1,root1,niter_main) j
            DAV_temp_RC_ija_baa(j,i,a1) = DAV_RX_ija_baa(j,i,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k

            DO a
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            GET Uaa(a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa 
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO a
            ENDIF
#---------------------------------------------------------------|
            IF Mkdav == 1.0
            REQUEST DAV_R_ija_baa(j,i,a1,root1,niter_main) j
            DAV_temp_RC_ija_baa(j,i,a1) = DAV_R_ija_baa(j,i,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k

            DO a
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            GET Uaa(a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) 
            ENDDO a
            ENDIF
#---------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_baa(j,i,a1,root1) j
            DAV_temp_RC_ija_baa(j,i,a1) = DAV_RC_ija_baa(j,i,a1,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k

            DO a
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            GET Uaa(a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = DAV_temp_RC_ija_baa_k(j,i,a1,kk1)*Uaa(a,a1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO a
            ENDIF
         ENDIF

         ENDDO kk1
      ENDPARDO i, j, a1

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|

      PARDO i, j, j1, i1
        REQUEST Wiijj(i1,i,j1,j) i1
        DO kk1  

         IF iter == 0.0
            DO a
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i1,a,kk1) = 0.0

            REQUEST DAV_R_initguess_ija_baa(j1,i1,a,root1) j1
            DAV_temp_RC_ija_baa(j1,i1,a) = DAV_R_initguess_ija_baa(j1,i1,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jiji(j1,i1,j,i) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jiji(j1,i1,j,i)*DAV_temp_RC_ija_baa_k(j1,i1,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= 1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO a
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO a
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i1,a,kk1) = 0.0
            REQUEST DAV_RX_ija_baa(j1,i1,a,root1,niter_main) j1
            DAV_temp_RC_ija_baa(j1,i1,a) = DAV_RX_ija_baa(j1,i1,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jiji(j1,i1,j,i) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jiji(j1,i1,j,i)*DAV_temp_RC_ija_baa_k(j1,i1,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= 1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO a
            ENDIF
#----------------------------------------------|
            IF Mkdav == 1.0
            DO a
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i1,a,kk1) = 0.0

            REQUEST DAV_R_ija_baa(j1,i1,a,root1,niter_main) j1
            DAV_temp_RC_ija_baa(j1,i1,a) = DAV_R_ija_baa(j1,i1,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jiji(j1,i1,j,i) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jiji(j1,i1,j,i)*DAV_temp_RC_ija_baa_k(j1,i1,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= 1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main)
            ENDDO a
            ENDIF
#----------------------------------------------|
            IF Mkcorr1 == 1.0
            DO a
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i1,a,kk1) = 0.0
            REQUEST DAV_RC_ija_baa(j1,i1,a,root1) j1
            DAV_temp_RC_ija_baa(j1,i1,a) = DAV_RC_ija_baa(j1,i1,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jiji(j1,i1,j,i) = Wiijj(i1,i,j1,j)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jiji(j1,i1,j,i)*DAV_temp_RC_ija_baa_k(j1,i1,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            DAV_temp_R_ija_baa(j,i,a) *= 1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO a
            ENDIF
         ENDIF
        ENDDO kk1 
      ENDPARDO i, j, j1, i1

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)---------|
#
#------------beta-beta-beta part----------------------------------| 
      PARDO i, a, j1, b
        REQUEST Wjbai(j1,b,a,i) b  
        DO kk1 

        IF iter == 0.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j1,b,kk1) = 0.0 

            REQUEST DAV_R_initguess_ija_bbb(j,j1,b,root1) j
#            REQUEST DAV_R_initguess_ija_bbb(j1,j,b,root1) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_R_initguess_ija_bbb(j,j1,b,root1)
#            DAV_temp_R_ija_bbb(j1,j,b) = DAV_R_initguess_ija_bbb(j1,j,b,root1)
#            t1ajxj(j,j1,b) = DAV_temp_R_ija_bbb(j1,j,b)
#            DAV_temp_RC_ija_bbb(j,j1,b) -= t1ajxj(j,j1,b) 
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_iajb(i,a,j1,b) = Wjbai(j1,b,a,i)
            aux_jbjk(j1,b,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iajb(i,a,j1,b)*aux_jbjk(j1,b,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            DAV_temp_2i_R_ija_baa(j,i,a,root1) *= 0.5
#            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j1,b,kk1) = 0.0

            REQUEST DAV_RX_ija_bbb(j,j1,b,root1,niter_main) j
#            REQUEST DAV_RX_ija_bbb(j1,j1,b,root1,niter_main) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_RX_ija_bbb(j,j1,b,root1,niter_main)
#            DAV_temp_R_ija_bbb(j1,j,b) =  DAV_RX_ija_bbb(j1,j,b,root1,niter_main)
#            t1ajxj(j,j1,b) = DAV_temp_R_ija_bbb(j1,j,b)
#            DAV_temp_RC_ija_bbb(j,j1,b) -= t1ajxj(j,j1,b)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_iajb(i,a,j1,b) = Wjbai(j1,b,a,i)
            aux_jbjk(j1,b,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iajb(i,a,j1,b)*aux_jbjk(j1,b,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
#            DAV_temp_2i_R_ija_baa(j,i,a,root1) *= 0.5
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
            ENDIF
#---------------------------------------------------------------|
            IF Mkdav == 1.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j1,b,kk1) = 0.0

            REQUEST DAV_R_ija_bbb(j,j1,b,root1,niter_main) j
#            REQUEST DAV_R_ija_bbb(j1,j,b,root1,niter_main) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_R_ija_bbb(j,j1,b,root1,niter_main)
#            DAV_temp_R_ija_bbb(j1,j,b) =  DAV_R_ija_bbb(j1,j,b,root1,niter_main)
#            t1ajxj(j,j1,b) = DAV_temp_R_ija_bbb(j1,j,b)
#            DAV_temp_RC_ija_bbb(j,j1,b) -= t1ajxj(j,j1,b)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_iajb(i,a,j1,b) = Wjbai(j1,b,a,i)
            aux_jbjk(j1,b,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iajb(i,a,j1,b)*aux_jbjk(j1,b,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
#            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) *= 0.5
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main)
            ENDDO j
            ENDIF
#---------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_bbb_k(j,j1,b,kk1) = 0.0

            REQUEST DAV_RC_ija_bbb(j,j1,b,root1) j
#            REQUEST DAV_RC_ija_bbb(j1,j,b,root1) j1
            DAV_temp_RC_ija_bbb(j,j1,b) = DAV_RC_ija_bbb(j,j1,b,root1)
#            DAV_temp_R_ija_bbb(j1,j,b) = DAV_RC_ija_bbb(j1,j,b,root1)
#            t1ajxj(j,j1,b) = DAV_temp_R_ija_bbb(j1,j,b)
#            DAV_temp_RC_ija_bbb(j,j1,b) -= t1ajxj(j,j1,b)
            execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_RC_ija_bbb_k
            aux_iajb(i,a,j1,b) = Wjbai(j1,b,a,i)
            aux_jbjk(j1,b,j,kk1) = DAV_temp_RC_ija_bbb_k(j,j1,b,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iajb(i,a,j1,b)*aux_jbjk(j1,b,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
#            DAV_temp_2i_R_ija_baa(j,i,a,root1) *= 0.5
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO i, a, j1, b

      execute server_barrier

#------------beta-alpha-alpha-------------------------------------|
      PARDO i, a, i1, a1 
        REQUEST Wiaai(i1,a1,a,i) a1   
        DO kk1

        IF iter == 0.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j,i1,a1,kk1) = 0.0

            REQUEST DAV_R_initguess_ija_baa(j,i1,a1,root1) j
            DAV_temp_RC_ija_baa(j,i1,a1) = DAV_R_initguess_ija_baa(j,i1,a1,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_iaia(i,a,i1,a1) = Wiaai(i1,a1,a,i)
            aux_iajk(i1,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iaia(i,a,i1,a1)*aux_iajk(i1,a1,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j,i1,a1,kk1) = 0.0

            REQUEST DAV_RX_ija_baa(j,i1,a1,root1,niter_main) j
            DAV_temp_RC_ija_baa(j,i1,a1) = DAV_RX_ija_baa(j,i1,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k  
            aux_iaia(i,a,i1,a1) = Wiaai(i1,a1,a,i)
            aux_iajk(i1,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iaia(i,a,i1,a1)*aux_iajk(i1,a1,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
            ENDIF
#--------------------------------------------------|
            IF Mkdav == 1.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_baa_k(j,i1,a1,kk1) = 0.0

            REQUEST DAV_R_ija_baa(j,i1,a1,root1,niter_main) j
            DAV_temp_RC_ija_baa(j,i1,a1) = DAV_R_ija_baa(j,i1,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_iaia(i,a,i1,a1) = Wiaai(i1,a1,a,i)
            aux_iajk(i1,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iaia(i,a,i1,a1)*aux_iajk(i1,a1,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main)
            ENDDO j
            ENDIF
#--------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO j
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j,i1,a1,kk1) = 0.0

            REQUEST DAV_RC_ija_baa(j,i1,a1,root1) j
            DAV_temp_RC_ija_baa(j,i1,a1) = DAV_RC_ija_baa(j,i1,a1,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_iaia(i,a,i1,a1) = Wiaai(i1,a1,a,i)
            aux_iajk(i1,a1,j,kk1) = DAV_temp_RC_ija_baa_k(j,i1,a1,kk1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_iaia(i,a,i1,a1)*aux_iajk(i1,a1,j,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO j
           ENDIF
         ENDIF
        ENDDO kk1  
      ENDPARDO i, a, i1, a1 

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#----- Hbar_bj^ai contribution (diagrams 6) aka forgotten term of Victor Lotrich |
#--------------------------------------------------------------------------------|

#---------alpha-beta-beta part---------------------------------|
      PARDO b, b1, i, i1
        REQUEST Wiibb(i1,i,b,b1) b
        DO kk1 

        IF iter == 0.0
            DO j
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b1,kk1) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0 

            REQUEST DAV_R_initguess_ija_abb(i1,j,b1,root1) i1
            DAV_temp_RC_ija_abb(i1,j,b1) = DAV_R_initguess_ija_abb(i1,j,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_ibjk(i1,b1,j,kk1) = DAV_temp_RC_ija_abb_k(i1,j,b1,kk1)
            aux_ibib(i1,b1,i,b) = Wiibb(i1,i,b,b1)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ibib(i1,b1,i,b)*aux_ibjk(i1,b1,j,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HR0_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO j
         ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            DO j
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b1,kk1) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0

            REQUEST DAV_RX_ija_abb(i1,j,b1,root1,niter_main) i1
            DAV_temp_RC_ija_abb(i1,j,b1) = DAV_RX_ija_abb(i1,j,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_ibib(i,b,i1,b1) = Wiibb(i1,i,b,b1)
            aux_ibjk(i1,b1,j,kk1) = DAV_temp_RC_ija_abb_k(i1,j,b1,kk1)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ibib(i,b,i1,b1)*aux_ibjk(i1,b1,j,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO j
            ENDIF
#------------------------------------------------------------------|
            IF Mkdav == 1.0
            DO j
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b1,kk1) = 0.0
            DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main) = 0.0

            REQUEST DAV_R_ija_abb(i1,j,b1,root1,niter_main) i1
            DAV_temp_RC_ija_abb(i1,j,b1) = DAV_R_ija_abb(i1,j,b1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_ibib(i,b,i1,b1) = Wiibb(i1,i,b,b1)
            aux_ibjk(i1,b1,j,kk1) = DAV_temp_RC_ija_abb_k(i1,j,b1,kk1)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ibib(i,b,i1,b1)*aux_ibjk(i1,b1,j,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j,b,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j,b,root1,niter_main)
            ENDDO j
            ENDIF
#------------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO j
            DAV_temp_R_ija_abb(i,j,b) = 0.0
            DAV_temp_RC_ija_abb_k(i1,j,b1,kk1) = 0.0
            DAV_temp_2i_R_ija_abb(i,j,b,root1) = 0.0

            REQUEST DAV_RC_ija_abb(i1,j,b1,root1) i1
            DAV_temp_RC_ija_abb(i1,j,b1) = DAV_RC_ija_abb(i1,j,b1,root1)
            execute addrootindex DAV_temp_RC_ija_abb DAV_temp_RC_ija_abb_k
            aux_ibib(i,b,i1,b1) = Wiibb(i1,i,b,b1)
            aux_ibjk(i1,b1,j,kk1) = DAV_temp_RC_ija_abb_k(i1,j,b1,kk1)
            DAV_temp_R_ija_abb_k(i,j,b,kk1) = aux_ibib(i,b,i1,b1)*aux_ibjk(i1,b1,j,kk1)
            DAV_temp_R_ija_abb(i,j,b) = DAV_temp_R_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HRC_ija_abb(i,j,b,root1) += DAV_temp_2i_R_ija_abb(i,j,b,root1)
            ENDDO j
            ENDIF
         ENDIF
         ENDDO kk1
      ENDPARDO b, b1, i, i1

      execute server_barrier
#---------beta-alpha-alpha part--------------------------------|
      PARDO a, a1, j, j1 
        REQUEST Wjjaa(j1,j,a,a1) a
        DO kk1
  
        IF iter == 0.0
            DO i
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i,a1,kk1) = 0.0


            REQUEST DAV_R_initguess_ija_baa(j1,i,a1,root1) j1
            DAV_temp_RC_ija_baa(j1,i,a1) = DAV_R_initguess_ija_baa(j1,i,a1,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jaik(j1,a1,i,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a1,kk1)
            aux_jaja(j,a,j1,a1) = Wjjaa(j1,j,a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jaja(j,a,j1,a1)*aux_jaik(j1,a1,i,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO i
         ENDIF

        IF iter > 0.0
            IF Mkcorr == 1.0
            DO i
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i,a1,kk1) = 0.0

            REQUEST DAV_RX_ija_baa(j1,i,a1,root1,niter_main) j1
            DAV_temp_RC_ija_baa(j1,i,a1) = DAV_RX_ija_baa(j1,i,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jaik(j1,a1,i,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a1,kk1)
            aux_jaja(j,a,j1,a1) = Wjjaa(j1,j,a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jaja(j,a,j1,a1)*aux_jaik(j1,a1,i,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_RC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO i
            ENDIF
#-------------------------------------------------------------------|
            IF Mkdav == 1.0
            DO i
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i,a1,kk1) = 0.0

            REQUEST DAV_R_ija_baa(j1,i,a1,root1,niter_main) j1
            DAV_temp_RC_ija_baa(j1,i,a1) = DAV_R_ija_baa(j1,i,a1,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jaik(j1,a1,i,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a1,kk1)
            aux_jaja(j,a,j1,a1) = Wjjaa(j1,j,a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jaja(j,a,j1,a1)*aux_jaik(j1,a1,i,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i,a,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i,a,root1,niter_main)
            ENDDO i
            ENDIF
#-------------------------------------------------------------------|
            IF Mkcorr1 == 1.0
            DO i
            DAV_temp_R_ija_baa(j,i,a) = 0.0
            DAV_temp_2i_R_ija_baa(j,i,a,root1) = 0.0
            DAV_temp_RC_ija_baa_k(j1,i,a1,kk1) = 0.0

            REQUEST DAV_RC_ija_baa(j1,i,a1,root1) j1
            DAV_temp_RC_ija_baa(j1,i,a1) = DAV_RC_ija_baa(j1,i,a1,root1)
            execute addrootindex DAV_temp_RC_ija_baa DAV_temp_RC_ija_baa_k
            aux_jaik(j1,a1,i,kk1) = DAV_temp_RC_ija_baa_k(j1,i,a1,kk1)
            aux_jaja(j,a,j1,a1) = Wjjaa(j1,j,a,a1)
            DAV_temp_R_ija_baa_k(j,i,a,kk1) = aux_jaja(j,a,j1,a1)*aux_jaik(j1,a1,i,kk1)
            DAV_temp_R_ija_baa(j,i,a) = DAV_temp_R_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HRC_ija_baa(j,i,a,root1) += DAV_temp_2i_R_ija_baa(j,i,a,root1)
            ENDDO i
            ENDIF
         ENDIF
        ENDDO kk1
      ENDPARDO a, a1, j, j1 

      execute server_barrier 
#>>>>>>>>>>>>>>>>>>3-body terms>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

       PARDO a1
       tax(a1) = 0.0
       PUT Iax(a1) = tax(a1)
       ENDPARDO a1

       execute sip_barrier

       PARDO b1
       tbx(b1) = 0.0
       PUT Ibx(b1) = tbx(b1)
       ENDPARDO b1

       execute sip_barrier

       PARDO a1
       tax(a1) = 0.0
       PUT I1ax(a1) = tax(a1)
       ENDPARDO a1

       execute sip_barrier

       PARDO b1
       tbx(b1) = 0.0
       PUT I1bx(b1) = tbx(b1)
       ENDPARDO b1

       execute sip_barrier


#-----------------Intermediates------------------------------------------|
##########################################################################
#--------------alpha-alpha-alpha contribution----------------------------|
      PARDO a, i1, i
          DO kk1  
          kk1_aaa(i1,i,a,kk1) = 0.0

            IF iter == 0.0
            REQUEST DAV_R_initguess_ija_aaa(i1,i,a,root1) i1
            DAV_temp_RC_ija_aaa(i1,i,a) = DAV_R_initguess_ija_aaa(i1,i,a,root1)
            execute addrootindex DAV_temp_RC_ija_aaa kk1_aaa
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_aaa(i1,i,a,root1,niter_main) i1
            DAV_temp_RC_ija_aaa(i1,i,a) = DAV_RX_ija_aaa(i1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa kk1_aaa
            ENDIF

            IF Mkdav == 1.0
            REQUEST DAV_R_ija_aaa(i1,i,a,root1,niter_main) i1
            DAV_temp_RC_ija_aaa(i1,i,a) = DAV_R_ija_aaa(i1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_aaa kk1_aaa
            ENDIF 

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_aaa(i1,i,a,root1) i1
            DAV_temp_RC_ija_aaa(i1,i,a) = DAV_RC_ija_aaa(i1,i,a,root1) 
            execute addrootindex DAV_temp_RC_ija_aaa kk1_aaa
            ENDIF
         ENDIF 

          DO a1
               REQUEST            VSpipi(a1,i1,a,i) a1
               taxk(a1,kk1)      = VSpipi(a1,i1,a,i)*kk1_aaa(i1,i,a,kk1)
               taxk(a1,kk1)     *= 0.5
               tax(a1) = taxk(a1,kk1)
               PUT Iax(a1) += tax(a1)
            ENDDO a1

            ENDDO kk1
      ENDPARDO a, i1, i 

      execute sip_barrier
#--------------beta-beta-beta contribution-------------------------------|
      PARDO b, j1, j
          DO kk1
          kk1_bbb(j1,j,b,kk1) = 0.0

            IF iter == 0.0
            REQUEST DAV_R_initguess_ija_bbb(j1,j,b,root1) j1
            DAV_temp_RC_ija_bbb(j1,j,b) = DAV_R_initguess_ija_bbb(j1,j,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb kk1_bbb
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_bbb(j1,j,b,root1,niter_main) j1
            DAV_temp_RC_ija_bbb(j1,j,b) = DAV_RX_ija_bbb(j1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb kk1_bbb
            ENDIF

            IF Mkdav == 1.0
            REQUEST DAV_R_ija_bbb(j1,j,b,root1,niter_main) j1
            DAV_temp_RC_ija_bbb(j1,j,b) = DAV_R_ija_bbb(j1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_bbb kk1_bbb
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_bbb(j1,j,b,root1) j1
            DAV_temp_RC_ija_bbb(j1,j,b) = DAV_RC_ija_bbb(j1,j,b,root1)
            execute addrootindex DAV_temp_RC_ija_bbb kk1_bbb
            ENDIF
         ENDIF

            DO b1
               REQUEST            VSqjqj(b1,j1,b,j) b1
               tbxk(b1,kk1)      = VSqjqj(b1,j1,b,j)*kk1_bbb(j1,j,b,kk1)
               tbxk(b1,kk1)     *= 0.5
               tbx(b1) = tbxk(b1,kk1)
               PUT Ibx(b1) += tbx(b1)
            ENDDO b1
 
          ENDDO kk1
      ENDPARDO b, j1, j

      execute sip_barrier
#--------------alpha-beta-beta contribution------------------------------|
      PARDO b, i1, j 
          DO kk1
          kk1_abb(i1,j,b,kk1) = 0.0

            IF iter == 0.0
            REQUEST DAV_R_initguess_ija_abb(i1,j,b,root1) i1
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_R_initguess_ija_abb(i1,j,b,root1) 
            execute addrootindex DAV_temp_RC_ija_abb kk1_abb
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_abb(i1,j,b,root1,niter_main) i1
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_RX_ija_abb(i1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb kk1_abb
            ENDIF

            IF Mkdav == 1.0
            REQUEST DAV_R_ija_abb(i1,j,b,root1,niter_main) i1
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_R_ija_abb(i1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_abb kk1_abb
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_abb(i1,j,b,root1) i1
            DAV_temp_RC_ija_abb(i1,j,b) = DAV_RC_ija_abb(i1,j,b,root1)
            execute addrootindex DAV_temp_RC_ija_abb kk1_abb
            ENDIF
         ENDIF

            DO a1
               REQUEST            Vpiqj(a1,i1,b,j) a1
               taxk(a1,kk1)      = Vpiqj(a1,i1,b,j)*kk1_abb(i1,j,b,kk1)
               tax(a1) = taxk(a1,kk1)
               PUT I1ax(a1) += tax(a1)
            ENDDO a1

          ENDDO kk1 
      ENDPARDO b, i1, j

      execute sip_barrier 
#--------------beta-alpha-alpha contribution-----------------------------|
      PARDO a, j1, i
          DO kk1
          kk1_baa(j1,i,a,kk1) = 0.0

            IF iter == 0.0
            REQUEST DAV_R_initguess_ija_baa(j1,i,a,root1) j1
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_R_initguess_ija_baa(j1,i,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa kk1_baa
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            REQUEST DAV_RX_ija_baa(j1,i,a,root1,niter_main) j1
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_RX_ija_baa(j1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa kk1_baa
            ENDIF

            IF Mkdav == 1.0
            REQUEST DAV_R_ija_baa(j1,i,a,root1,niter_main) j1
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_R_ija_baa(j1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_RC_ija_baa kk1_baa
            ENDIF

            IF Mkcorr1 == 1.0
            REQUEST DAV_RC_ija_baa(j1,i,a,root1) j1
            DAV_temp_RC_ija_baa(j1,i,a) = DAV_RC_ija_baa(j1,i,a,root1)
            execute addrootindex DAV_temp_RC_ija_baa kk1_baa
            ENDIF
         ENDIF

            DO b1
               REQUEST            Vpiqj(a,i,b1,j1) a
               tbxk(b1,kk1)      = Vpiqj(a,i,b1,j1)*kk1_baa(j1,i,a,kk1)
               tbx(b1) = tbxk(b1,kk1)
               PUT I1bx(b1) += tbx(b1)
            ENDDO b1
         ENDDO kk1
      ENDPARDO a, j1, i

      execute sip_barrier
#----------------Contributions itself------------------------------------|
##########################################################################
#--------------alpha-alpha-alpha part------------------------------------|
      PARDO a1, a, i1, i
            DO kk1
            taxk(a,kk1) = 0.0 

            DAV_temp_R_ija_aaa(i,i1,a1) = 0.0
            DAV_temp_2i_R_ija_aaa(i,i1,a1,root1) = 0.0
            REQUEST                     T2aa(a1,i1,a,i) a1
            GET                         Iax(a)
            GET                         I1ax(a)
            tax(a) = Iax(a)
            tax(a) += I1ax(a)  
            execute addrootindex tax taxk       

            taixi_k(a1,i1,i,kk1)        = T2aa(a1,i1,a,i)*taxk(a,kk1)
            taixi(a1,i1,i)        = taixi_k(a1,i1,i,kk1)
            taixi(a1,i1,i)       *= -1.0
            DAV_temp_R_ija_aaa(i,i1,a1) = taixi(a1,i1,i)

            IF iter == 0.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_HR0_ija_aaa(i,i1,a1,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a1,root1)
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa
            PREPARE DAV_RC_ija_aaa(i,i1,a1,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a1,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_aaa(i,i1,a1,root1,niter_main) = 0.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
            PREPARE DAV_HR_prev_ija_aaa(i,i1,a1,root1,niter_main) += DAV_temp_3i_R_ija_aaa(i,i1,a1,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2i_R_ija_aaa            
            PREPARE DAV_HRC_ija_aaa(i,i1,a1,root1) += DAV_temp_2i_R_ija_aaa(i,i1,a1,root1)
            ENDIF
         ENDIF

         ENDDO kk1  
      ENDPARDO a1, a, i1, i

      execute server_barrier
#--------------beta-alpha-alpha part-------------------------------------|
      PARDO a1, b, i1, j
            DO kk1 
            tbxk(b,kk1) = 0.0

            DAV_temp_R_ija_baa(j,i1,a1) = 0.0
            DAV_temp_2i_R_ija_baa(j,i1,a1,root1) = 0.0
            REQUEST                     T2ab(a1,i1,b,j) a1
            GET                         I1bx(b)
            GET                         Ibx(b)
            tbx(b) = I1bx(b)
            tbx(b) += Ibx(b)              
            execute addrootindex tbx tbxk

            taixj_k(a1,i1,j,kk1)        = T2ab(a1,i1,b,j)*tbxk(b,kk1)
            taixj(a1,i1,j) = taixj_k(a1,i1,j,kk1)
            taixj(a1,i1,j)       *= -1.0
            DAV_temp_R_ija_baa(j,i1,a1) = taixj(a1,i1,j)

            IF iter == 0.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HR0_ija_baa(j,i1,a1,root1) += DAV_temp_2i_R_ija_baa(j,i1,a1,root1)
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_RC_ija_baa(j,i1,a1,root1) += DAV_temp_2i_R_ija_baa(j,i1,a1,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_baa(j,i1,a1,root1,niter_main) = 0.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
            PREPARE DAV_HR_prev_ija_baa(j,i1,a1,root1,niter_main) += DAV_temp_3i_R_ija_baa(j,i1,a1,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            execute addrootindex DAV_temp_R_ija_baa DAV_temp_2i_R_ija_baa
            PREPARE DAV_HRC_ija_baa(j,i1,a1,root1) += DAV_temp_2i_R_ija_baa(j,i1,a1,root1)
            ENDIF
         ENDIF

         ENDDO kk1  
      ENDPARDO a1, b, i1, j

      execute server_barrier
#--------------beta-beta-beta part---------------------------------------|
      PARDO b1, b, j1, j
            DO kk1  
            tbxk(b,kk1) = 0.0 


            DAV_temp_R_ija_bbb(j,j1,b1) = 0.0
            DAV_temp_2i_R_ija_bbb(j,j1,b1,root1) = 0.0
            REQUEST                     T2bb(b1,j1,b,j) b1
            GET                         Ibx(b)
            GET                         I1bx(b)
            tbx(b) = Ibx(b)
            tbx(b) += I1bx(b)
            execute addrootindex tbx tbxk

            tbjxj_k(b1,j1,j,kk1)        = T2bb(b1,j1,b,j)*tbxk(b,kk1)
            tbjxj(b1,j1,j) = tbjxj_k(b1,j1,j,kk1)
            tbjxj(b1,j1,j)       *= -1.0
            DAV_temp_R_ija_bbb(j,j1,b1) = tbjxj(b1,j1,j)

            IF iter == 0.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb 
            PREPARE DAV_HR0_ija_bbb(j,j1,b1,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b1,root1)
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_RC_ija_bbb(j,j1,b1,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b1,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_bbb(j,j1,b1,root1,niter_main) = 0.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
            PREPARE DAV_HR_prev_ija_bbb(j,j1,b1,root1,niter_main) += DAV_temp_3i_R_ija_bbb(j,j1,b1,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2i_R_ija_bbb
            PREPARE DAV_HRC_ija_bbb(j,j1,b1,root1) += DAV_temp_2i_R_ija_bbb(j,j1,b1,root1)
            ENDIF
         ENDIF

         ENDDO kk1  
      ENDPARDO b1, b, j1, j

      execute server_barrier
#-------------alpha-beta-beta part---------------------------------------|
      PARDO b1, a, j1, i
            DO kk1 
            taxk(a,kk1) = 0.0
 
            DAV_temp_R_ija_abb(i,j1,b1) = 0.0
            DAV_temp_2i_R_ija_abb(i,j1,b1,root1) = 0.0
            REQUEST                     T2ab(a,i,b1,j1) a
            GET                         I1ax(a)
            GET                         Iax(a)
            tax(a) = I1ax(a)
            tax(a) += Iax(a)
            execute addrootindex tax taxk
            t_qjpi(b1,j1,a,i) = T2ab(a,i,b1,j1)

            tbjxi_k(b1,j1,i,kk1)        = t_qjpi(b1,j1,a,i)*taxk(a,kk1)
            tbjxi(b1,j1,i) = tbjxi_k(b1,j1,i,kk1) 
            tbjxi(b1,j1,i)       *= -1.0
            DAV_temp_R_ija_abb(i,j1,b1) = tbjxi(b1,j1,i)

            IF iter == 0.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HR0_ija_abb(i,j1,b1,root1) += DAV_temp_2i_R_ija_abb(i,j1,b1,root1)
            ENDIF

         IF iter > 0.0
            IF Mkcorr == 1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_RC_ija_abb(i,j1,b1,root1) += DAV_temp_2i_R_ija_abb(i,j1,b1,root1)
            ENDIF

            IF Mkdav == 1.0
            DAV_temp_3i_R_ija_abb(i,j1,b1,root1,niter_main) = 0.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
            PREPARE DAV_HR_prev_ija_abb(i,j1,b1,root1,niter_main) += DAV_temp_3i_R_ija_abb(i,j1,b1,root1,niter_main)
            ENDIF

            IF Mkcorr1 == 1.0
            execute addrootindex DAV_temp_R_ija_abb DAV_temp_2i_R_ija_abb
            PREPARE DAV_HRC_ija_abb(i,j1,b1,root1) += DAV_temp_2i_R_ija_abb(i,j1,b1,root1)
            ENDIF
         ENDIF

         ENDDO kk1
      ENDPARDO b1, a, j1, i

      execute server_barrier  


#      CALL ANTISYMM_R

#--------------------------------------------------------------|
      ENDDO root1
###############################################################| 
#    Here we do corrections to each right eigenvector          |
###############################################################|
      IF Mkcorr == 1.0   
#---------------------------------------------------------------|
            cnt = 0.0
#------------Loop over roots------------------------------------|
      DO root1
#----------Check if number of roots is exceeded-----------------|
      cnt += 1.0
      IF cnt > n_roots
      EXIT
      ENDIF

 
   
 
#>>>>>>>>>>>>>>>>> Numerators >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#ddff
#--------------alpha part---------------------------------------|
      PARDO i
      execute eomgetroot cnt EIG
      DAV_temp_2i_RC_h_a(i,root1) = 0.0

      GET DAV_RC_h_a(i,root1) 
      GET DAV_RX_h_a(i,root1,niter_main)
      DAV_temp_RC_h_a(i) = DAV_RC_h_a(i,root1)
      DAV_temp_R_h_a(i) = DAV_RX_h_a(i,root1,niter_main)
      DAV_temp_R_h_a(i) *= EIG  
      DAV_temp_RC_h_a(i) -= DAV_temp_R_h_a(i)

      execute addrootindex DAV_temp_RC_h_a DAV_temp_2i_RC_h_a 
      PUT DAV_RC_aux_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1)

      ENDPARDO i


      execute sip_barrier
#--------------beta part----------------------------------------|
      PARDO j
      execute eomgetroot cnt EIG
      DAV_temp_2i_RC_h_b(j,root1) = 0.0

      GET DAV_RC_h_b(j,root1)
      GET DAV_RX_h_b(j,root1,niter_main)
      DAV_temp_RC_h_b(j) = DAV_RC_h_b(j,root1)
      DAV_temp_R_h_b(j) = DAV_RX_h_b(j,root1,niter_main)
      DAV_temp_R_h_b(j) *= EIG
      DAV_temp_RC_h_b(j) -= DAV_temp_R_h_b(j)
      execute addrootindex DAV_temp_RC_h_b DAV_temp_2i_RC_h_b
      PUT DAV_RC_aux_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)

      ENDPARDO j

      execute sip_barrier 
#------------alpha-alpha-alpha part-----------------------------|
      PARDO i,k,a
      execute eomgetroot cnt EIG
      DAV_temp_2i_RC_ija_aaa(i,k,a,root1) = 0.0

      REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
      REQUEST DAV_RX_ija_aaa(i,k,a,root1,niter_main) i   
      DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1) 
      DAV_temp_R_ija_aaa(i,k,a) = DAV_RX_ija_aaa(i,k,a,root1,niter_main)
      DAV_temp_R_ija_aaa(i,k,a) *= EIG
      DAV_temp_RC_ija_aaa(i,k,a) -= DAV_temp_R_ija_aaa(i,k,a)
      execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_2i_RC_ija_aaa
      PREPARE DAV_RC_aux_ija_aaa(i,k,a,root1) = DAV_temp_2i_RC_ija_aaa(i,k,a,root1)

#      execute dump_amp DAV_temp_2i_RC_ija_aaa   

      ENDPARDO i,k,a

      execute server_barrier
#------------beta-beta-beta part--------------------------------|
      PARDO j,l,b
      execute eomgetroot cnt EIG
      DAV_temp_2i_RC_ija_bbb(j,l,b,root1) = 0.0

      REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
      REQUEST DAV_RX_ija_bbb(j,l,b,root1,niter_main) j
      DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
      DAV_temp_R_ija_bbb(j,l,b) = DAV_RX_ija_bbb(j,l,b,root1,niter_main)
      DAV_temp_R_ija_bbb(j,l,b) *= EIG
      DAV_temp_RC_ija_bbb(j,l,b) -= DAV_temp_R_ija_bbb(j,l,b)
      execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_2i_RC_ija_bbb
      PREPARE DAV_RC_aux_ija_bbb(j,l,b,root1) = DAV_temp_2i_RC_ija_bbb(j,l,b,root1)


      ENDPARDO j,l,b

      execute server_barrier
#------------alpha-beta-beta part-------------------------------|
      PARDO i,l,b
      execute eomgetroot cnt EIG
      DAV_temp_2i_RC_ija_abb(i,l,b,root1) = 0.0

      REQUEST DAV_RC_ija_abb(i,l,b,root1) i
      REQUEST DAV_RX_ija_abb(i,l,b,root1,niter_main) i
      DAV_temp_RC_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root1)
      DAV_temp_R_ija_abb(i,l,b) = DAV_RX_ija_abb(i,l,b,root1,niter_main)
      DAV_temp_R_ija_abb(i,l,b) *= EIG
      DAV_temp_RC_ija_abb(i,l,b) -= DAV_temp_R_ija_abb(i,l,b)
      execute addrootindex DAV_temp_RC_ija_abb DAV_temp_2i_RC_ija_abb
      PREPARE DAV_RC_aux_ija_abb(i,l,b,root1) = DAV_temp_2i_RC_ija_abb(i,l,b,root1)


      ENDPARDO i,l,b  

      execute server_barrier
#------------beta-alpha-alpha part------------------------------|
      PARDO j,k,a 
      execute eomgetroot cnt EIG
      DAV_temp_2i_RC_ija_baa(j,k,a,root1) = 0.0

      REQUEST DAV_RC_ija_baa(j,k,a,root1) j
      REQUEST DAV_RX_ija_baa(j,k,a,root1,niter_main) j
      DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
      DAV_temp_R_ija_baa(j,k,a) = DAV_RX_ija_baa(j,k,a,root1,niter_main)
      DAV_temp_R_ija_baa(j,k,a) *= EIG
      DAV_temp_RC_ija_baa(j,k,a) -= DAV_temp_R_ija_baa(j,k,a)
      execute addrootindex DAV_temp_RC_ija_baa DAV_temp_2i_RC_ija_baa
      PREPARE DAV_RC_aux_ija_baa(j,k,a,root1) = DAV_temp_2i_RC_ija_baa(j,k,a,root1)


      ENDPARDO j,k,a
#---------------------------------------------------------------|
      execute server_barrier

#>>>>>>>>>>>>>>>>>> Denominators >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

#---------------------------------------------------------------|
      PARDO i
         execute eomgetroot cnt EIG
         DAV_temp_2i_RC_h_a(i,root1) = 0.0

         GET DAV_RC_aux_h_a(i,root1)
         GET DAV_Hbar_diag_a(i) 
         DAV_temp_RC_h_a(i) = DAV_RC_aux_h_a(i,root1)
         DAV_temp_R_h_a(i) = DAV_Hbar_diag_a(i)
         t1is(i) = 1.0
         t1is(i) *= EIG
         t1is(i) -= DAV_temp_R_h_a(i)

         execute apply_den1 DAV_temp_RC_h_a t1is
         execute addrootindex DAV_temp_RC_h_a DAV_temp_2i_RC_h_a

#         execute dump_amp DAV_temp_2i_RC_h_a

         PUT DAV_RC_h_a(i,root1) = DAV_temp_2i_RC_h_a(i,root1)
      ENDPARDO i

      execute sip_barrier
#---------------------------------------------------------------|
      PARDO j
         execute eomgetroot cnt EIG
         DAV_temp_2i_RC_h_b(j,root1) = 0.0

         GET DAV_RC_aux_h_b(j,root1)
         GET DAV_Hbar_diag_b(j)
         DAV_temp_RC_h_b(j) = DAV_RC_aux_h_b(j,root1)
         DAV_temp_R_h_b(j) = DAV_Hbar_diag_b(j)
         t1js(j)  = 1.0
         t1js(j) *= EIG
         t1js(j) -= DAV_temp_R_h_b(j)

         execute apply_den1 DAV_temp_RC_h_b t1js
         execute addrootindex DAV_temp_RC_h_b DAV_temp_2i_RC_h_b

#         execute dump_amp DAV_temp_2i_RC_h_b

         PUT DAV_RC_h_b(j,root1) = DAV_temp_2i_RC_h_b(j,root1)
      ENDPARDO j

      execute sip_barrier
#------------alpha-alpha-alpha part-----------------------------|
      PARDO i,k,a
         execute eomgetroot cnt EIG
         DAV_temp_2i_RC_ija_aaa(i,k,a,root1) = 0.0

         REQUEST DAV_RC_aux_ija_aaa(i,k,a,root1) i
         REQUEST DAV_Hbar_diag_aaa(i,k,a) i
         DAV_temp_RC_ija_aaa(i,k,a) = DAV_RC_aux_ija_aaa(i,k,a,root1)
         DAV_temp_R_ija_aaa(i,k,a) = DAV_Hbar_diag_aaa(i,k,a)
         DAV_temp_LC_ija_aaa(i,k,a) = 1.0
         DAV_temp_LC_ija_aaa(i,k,a) *= EIG
         DAV_temp_LC_ija_aaa(i,k,a) -= DAV_temp_R_ija_aaa(i,k,a)
         execute apply_den3 DAV_temp_RC_ija_aaa DAV_temp_LC_ija_aaa
         execute addrootindex DAV_temp_RC_ija_aaa DAV_temp_2i_RC_ija_aaa

#         execute dump_amp DAV_temp_2i_RC_ija_aaa

         PREPARE DAV_RC_ija_aaa(i,k,a,root1) =  DAV_temp_2i_RC_ija_aaa(i,k,a,root1)
      ENDPARDO i,k,a

      execute server_barrier
#------------beta-beta-beta part--------------------------------|
      PARDO j,l,b
         execute eomgetroot cnt EIG
         DAV_temp_2i_RC_ija_bbb(j,l,b,root1) = 0.0

         REQUEST DAV_RC_aux_ija_bbb(j,l,b,root1) j
         REQUEST DAV_Hbar_diag_bbb(j,l,b) j
         DAV_temp_RC_ija_bbb(j,l,b) = DAV_RC_aux_ija_bbb(j,l,b,root1)
         DAV_temp_R_ija_bbb(j,l,b) = DAV_Hbar_diag_bbb(j,l,b)
         DAV_temp_LC_ija_bbb(j,l,b) = 1.0  
         DAV_temp_LC_ija_bbb(j,l,b) *= EIG
         DAV_temp_LC_ija_bbb(j,l,b) -= DAV_temp_R_ija_bbb(j,l,b)
         execute apply_den3 DAV_temp_RC_ija_bbb DAV_temp_LC_ija_bbb
         execute addrootindex DAV_temp_RC_ija_bbb DAV_temp_2i_RC_ija_bbb

#         execute dump_amp DAV_temp_2i_RC_ija_bbb

         PREPARE DAV_RC_ija_bbb(j,l,b,root1) = DAV_temp_2i_RC_ija_bbb(j,l,b,root1)
      ENDPARDO j,l,b

      execute server_barrier
#------------alpha-beta-beta part-------------------------------|
      PARDO i,l,b
         execute eomgetroot cnt EIG
         DAV_temp_2i_RC_ija_abb(i,l,b,root1) = 0.0

         REQUEST DAV_RC_aux_ija_abb(i,l,b,root1) i
         REQUEST DAV_Hbar_diag_abb(i,l,b) i
         DAV_temp_RC_ija_abb(i,l,b) = DAV_RC_aux_ija_abb(i,l,b,root1)
         DAV_temp_R_ija_abb(i,l,b) = DAV_Hbar_diag_abb(i,l,b)
         DAV_temp_LC_ija_abb(i,l,b) = 1.0
         DAV_temp_LC_ija_abb(i,l,b) *= EIG
         DAV_temp_LC_ija_abb(i,l,b) -= DAV_temp_R_ija_abb(i,l,b)
         execute apply_den3 DAV_temp_RC_ija_abb DAV_temp_LC_ija_abb
         execute addrootindex DAV_temp_RC_ija_abb DAV_temp_2i_RC_ija_abb

         PREPARE DAV_RC_ija_abb(i,l,b,root1) = DAV_temp_2i_RC_ija_abb(i,l,b,root1)
      ENDPARDO i,l,b

      execute server_barrier 
#------------beta-alpha-alpha part------------------------------|
      PARDO j,k,a

         execute eomgetroot cnt EIG
         DAV_temp_2i_RC_ija_baa(j,k,a,root1) = 0.0


         REQUEST DAV_RC_aux_ija_baa(j,k,a,root1) j
         REQUEST DAV_Hbar_diag_baa(j,k,a) j
         DAV_temp_RC_ija_baa(j,k,a) = DAV_RC_aux_ija_baa(j,k,a,root1)
         DAV_temp_R_ija_baa(j,k,a) = DAV_Hbar_diag_baa(j,k,a)
         DAV_temp_LC_ija_baa(j,k,a) = 1.0
         DAV_temp_LC_ija_baa(j,k,a) *= EIG 
         DAV_temp_LC_ija_baa(j,k,a) -= DAV_temp_R_ija_baa(j,k,a)
         execute apply_den3 DAV_temp_RC_ija_baa DAV_temp_LC_ija_baa
         execute addrootindex DAV_temp_RC_ija_baa DAV_temp_2i_RC_ija_baa

         PREPARE DAV_RC_ija_baa(j,k,a,root1) = DAV_temp_2i_RC_ija_baa(j,k,a,root1)
      ENDPARDO j,k,a

      execute server_barrier
#---------------------------------------------------------------|

#      CALL ANTISYMM_R

      ENDDO root1
      
     
      ENDIF


           ENDPROC MAKE_Hbar_R
#          -------------------

#=========================================================================================
#     MATRIX-VECTOR MULTIPLICATION PROCEDURE: <L|*Hbar (contain disconnected terms)      |
#=========================================================================================

           PROC MAKE_L_Hbar 
#          ----------------

            cnt = 0.0
#------------Loop over roots------------------------------------|
            DO root1
#----------Check if number of roots is exceeded-----------------|
            cnt += 1.0
            IF cnt > n_roots
            EXIT
            ENDIF
#---------------------------------------------------------------|

#--------------------------------------------------------------|
#            Zero out LH arrays                                |
#--------------------------------------------------------------| 
#
#---------------alpha part-------------------------------------|
      PARDO i
            DAV_temp_2i_LC_h_a(i,root1) = 0.0 
            PUT DAV_LC_h_a(i,root1) = DAV_temp_2i_LC_h_a(i,root1)
      ENDPARDO i
      execute sip_barrier 
#--------------beta part---------------------------------------|
      PARDO j
            DAV_temp_2i_LC_h_b(j,root1) = 0.0
            PUT DAV_LC_h_b(j,root1) = DAV_temp_2i_LC_h_b(j,root1)
      ENDPARDO j
      execute sip_barrier
#--------------alpha-alpha-alpha part--------------------------|
      PARDO i,k,a
            DAV_temp_2i_LC_ija_aaa(i,k,a,root1) = 0.0
            PREPARE DAV_LC_ija_aaa(i,k,a,root1) = DAV_temp_2i_LC_ija_aaa(i,k,a,root1)
      ENDPARDO i,k,a
      execute server_barrier  
#--------------beta-beta-beta part-----------------------------|
      PARDO j,l,b
            DAV_temp_2i_LC_ija_bbb(j,l,b,root1) = 0.0
            PREPARE DAV_LC_ija_bbb(j,l,b,root1) = DAV_temp_2i_LC_ija_bbb(j,l,b,root1)
      ENDPARDO j,l,b
      execute server_barrier
#--------------alpha-beta-beta part----------------------------|
      PARDO i,l,b
            DAV_temp_2i_LC_ija_abb(i,l,b,root1) = 0.0
            PREPARE DAV_LC_ija_abb(i,l,b,root1) = DAV_temp_2i_LC_ija_abb(i,l,b,root1)
      ENDPARDO i,l,b
      execute server_barrier
#--------------beta-alpha-alpha part---------------------------|
      PARDO j,k,a
            DAV_temp_2i_LC_ija_baa(j,k,a,root1) = 0.0
            PREPARE DAV_LC_ija_baa(j,k,a,root1) = DAV_temp_2i_LC_ija_baa(j,k,a,root1)
      ENDPARDO j,k,a
      execute server_barrier
#--------------------------------------------------------------|

###############################################################|
#--------Vector-matrix multiplication itselfs------------------|
###############################################################|


################################################################|
##---------------alpha part-------------------------------------|
################################################################|


#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---- Hbar_j^i contribution (diagram S from my notes)----------|
#
      PARDO i,k
         DAV_temp_L_h_a(i) = 0.0
         DAV_temp_2i_LC_h_a(i,root1) = 0.0

         GET   Uii(i,k)

            GET DAV_LX_h_a(k,root1,niter_main)
              DAV_temp_LC_h_a(k) = DAV_LX_h_a(k,root1,niter_main)
              DAV_temp_L_h_a(i) = Uii(i,k)*DAV_temp_LC_h_a(k)
              DAV_temp_L_h_a(i) *= -1.0
              execute addrootindex DAV_temp_L_h_a DAV_temp_2i_LC_h_a
            PUT DAV_LC_h_a(i,root1) += DAV_temp_2i_LC_h_a(i,root1)
          
       ENDPARDO i,k 
       execute sip_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_k^ija contribution ------------------------|
#
#------------- alpha - alpha - alpha contribution--------------|
      PARDO i,i1,a,i2
          DO kk1        

          DAV_temp_L_h_a(i) = 0.0
          DAV_temp_2i_LC_h_a(i,root1) = 0.0
          DAV_temp_LC_ija_aaa_k(i2,i1,a,kk1) = 0.0 

         REQUEST Wiiai(i,i2,a,i1) i
         REQUEST DAV_LX_ija_aaa(i2,i1,a,root1,niter_main) i2
              DAV_temp_LC_ija_aaa(i2,i1,a) = DAV_LX_ija_aaa(i2,i1,a,root1,niter_main)
              execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_LC_ija_aaa_k
              DAV_temp_L_h_a_k(i,kk1) = Wiiai(i,i2,a,i1)*DAV_temp_LC_ija_aaa_k(i2,i1,a,kk1)
              DAV_temp_L_h_a(i) = DAV_temp_L_h_a_k(i,kk1)
              DAV_temp_L_h_a(i) *= -1.0
              execute addrootindex DAV_temp_L_h_a DAV_temp_2i_LC_h_a  
        PUT DAV_LC_h_a(i,root1) += DAV_temp_2i_LC_h_a(i,root1)

         ENDDO kk1  
      ENDPARDO i,i1,a,i2
      execute sip_barrier
#------------- alpha - beta - beta contribution----------------|
      PARDO b, i, j, i1
        DO kk1          

        DAV_temp_L_h_a(i) = 0.0
        DAV_temp_2i_LC_h_a(i,root1) = 0.0
        DAV_temp_LC_ija_abb_k(i1,j,b,kk1) = 0.0 

        REQUEST Wiibj(i,i1,b,j) i
        REQUEST DAV_LX_ija_abb(i1,j,b,root1,niter_main) i1
             DAV_temp_LC_ija_abb(i1,j,b) = DAV_LX_ija_abb(i1,j,b,root1,niter_main)
             execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
             DAV_temp_L_h_a_k(i,kk1) = Wiibj(i,i1,b,j)*DAV_temp_LC_ija_abb_k(i1,j,b,kk1)
             DAV_temp_L_h_a(i) = DAV_temp_L_h_a_k(i,kk1)
             DAV_temp_L_h_a(i) *= -1.0
             execute addrootindex DAV_temp_L_h_a DAV_temp_2i_LC_h_a
        PUT DAV_LC_h_a(i,root1) += DAV_temp_2i_LC_h_a(i,root1)
        ENDDO kk1
      ENDPARDO b, i, j, i1
      execute sip_barrier 
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

################################################################|
##---------------beta part--------------------------------------|
################################################################|

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---- Hbar_j^i contribution (diagram S from my notes)----------|
#
      PARDO j,l
         DAV_temp_L_h_b(j) = 0.0
         DAV_temp_2i_LC_h_b(j,root1) = 0.0

         GET   Ujj(j,l)

            GET DAV_LX_h_b(l,root1,niter_main)
              DAV_temp_LC_h_b(l) = DAV_LX_h_b(l,root1,niter_main)
              DAV_temp_L_h_b(j) = Ujj(j,l)*DAV_temp_LC_h_b(l)
              DAV_temp_L_h_b(j) *= -1.0
              execute addrootindex DAV_temp_L_h_b DAV_temp_2i_LC_h_b
            PUT DAV_LC_h_b(j,root1) += DAV_temp_2i_LC_h_b(j,root1)

       ENDPARDO j,l
       execute sip_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_k^ija contribution ------------------------|
#
#------------- beta - beta - beta contribution-----------------|
      PARDO j,j1,b,j2
        DO kk1  
        DAV_temp_L_h_b(j) = 0.0
        DAV_temp_2i_LC_h_b(j,root1) = 0.0
        DAV_temp_LC_ija_bbb_k(j2,j1,b,kk1) = 0.0

        REQUEST Wjjbj(j,j2,b,j1) j
        REQUEST DAV_LX_ija_bbb(j2,j1,b,root1,niter_main) j2
              DAV_temp_LC_ija_bbb(j2,j1,b) = DAV_LX_ija_bbb(j2,j1,b,root1,niter_main)
              execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_LC_ija_bbb_k
              DAV_temp_L_h_b_k(j,kk1) = Wjjbj(j,j2,b,j1)*DAV_temp_LC_ija_bbb_k(j2,j1,b,kk1)
              DAV_temp_L_h_b(j) = DAV_temp_L_h_b_k(j,kk1)
              DAV_temp_L_h_b(j) *= -1.0
              execute addrootindex DAV_temp_L_h_b DAV_temp_2i_LC_h_b
            PUT DAV_LC_h_b(j,root1) += DAV_temp_2i_LC_h_b(j,root1)
        ENDDO kk1
      ENDPARDO j,j1,b,j2
      execute sip_barrier
#------------- beta - alpha - alpha----------------------------|
      PARDO a, j, i, j1
        DO kk1
        DAV_temp_L_h_b(j) = 0.0
        DAV_temp_2i_LC_h_b(j,root1) = 0.0
        DAV_temp_LC_ija_baa_k(j1,i,a,kk1) = 0.0

        REQUEST Wjjai(j,j1,a,i) j
        REQUEST DAV_LX_ija_baa(j1,i,a,root1,niter_main) j1
              DAV_temp_LC_ija_baa(j1,i,a) = DAV_LX_ija_baa(j1,i,a,root1,niter_main)
              execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k 
              DAV_temp_L_h_b_k(j,kk1) = Wjjai(j,j1,a,i)*DAV_temp_LC_ija_baa_k(j1,i,a,kk1)
              DAV_temp_L_h_b(j) = DAV_temp_L_h_b_k(j,kk1)
             DAV_temp_L_h_b(j) *= -1.0
              execute addrootindex DAV_temp_L_h_b DAV_temp_2i_LC_h_b
            PUT DAV_LC_h_b(j,root1) += DAV_temp_2i_LC_h_b(j,root1)
        ENDDO kk1
      ENDPARDO a, j, i, j1 
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
      execute sip_barrier 
###############################################################|
#-------------alpha-alpha-alpha part---------------------------|
###############################################################|
#
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------------- disconnected term ------------------------|
#
      PARDO i,i1,a 
           DO kk1
           DAV_temp_2i_LC_ija_aaa(i,i1,a,root1) = 0.0  
           DAV_temp_2i_L_ija_aaa(i1,i,a,root1) = 0.0
           DAV_temp_LC_ija_aaa_k(i,i1,a,kk1) = 0.0
           DAV_temp_L_ija_aaa_k(i1,i,a,kk1) = 0.0
           DAV_temp_LC_h_a_k(i,kk1) = 0.0 

           GET Uia(i1,a)
           GET DAV_LX_h_a(i,root1,niter_main)
           DAV_temp_LC_h_a(i) = DAV_LX_h_a(i,root1,niter_main)
           execute addrootindex DAV_temp_LC_h_a DAV_temp_LC_h_a_k   
           DAV_temp_LC_ija_aaa_k(i,i1,a,kk1) = DAV_temp_LC_h_a_k(i,kk1)^Uia(i1,a)
           DAV_temp_LC_ija_aaa_k(i,i1,a,kk1) *= 0.5
           DAV_temp_LC_ija_aaa(i,i1,a) = DAV_temp_LC_ija_aaa_k(i,i1,a,kk1)
           execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_2i_LC_ija_aaa    
           PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_LC_ija_aaa(i,i1,a,root1)
           DAV_temp_L_ija_aaa(i1,i,a) = DAV_temp_LC_ija_aaa(i,i1,a)
           DAV_temp_L_ija_aaa(i1,i,a) *= -1.0
           execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa
           PREPARE DAV_LC_ija_aaa(i1,i,a,root1) += DAV_temp_2i_L_ija_aaa(i1,i,a,root1)


           ENDDO kk1
      ENDPARDO i,i1,a

          execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------Hbar_ika^j contribution------------------------------|
#
      PARDO i, i2, i1, a
         DAV_temp_2i_LC_ija_aaa(i,i1,a,root1) = 0.0

         DO kk1 
         DAV_temp_LC_h_a_k(i2,kk1) = 0.0
         DAV_temp_LC_ija_aaa_k(i,i1,a,kk1) = 0.0        

         REQUEST  Wiiia(i,i2,i1,a) i
         GET DAV_LX_h_a(i2,root1,niter_main)
         DAV_temp_LC_h_a(i2) = DAV_LX_h_a(i2,root1,niter_main)
         execute addrootindex DAV_temp_LC_h_a DAV_temp_LC_h_a_k
         DAV_temp_LC_ija_aaa_k(i,i1,a,kk1) = Wiiia(i,i2,i1,a)*DAV_temp_LC_h_a_k(i2,kk1)
         DAV_temp_LC_ija_aaa(i,i1,a) = DAV_temp_LC_ija_aaa_k(i,i1,a,kk1)
         execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_2i_LC_ija_aaa 
         DAV_temp_2i_LC_ija_aaa(i,i1,a,root1) *= -0.5
         PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_LC_ija_aaa(i,i1,a,root1)
         ENDDO kk1

      ENDPARDO i, i2, i1, a

      execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|

      PARDO a, i1, i, i2
         DO kk1
         DAV_temp_L_ija_aaa(i,i1,a) = 0.0
         DAV_temp_2i_L_ija_aaa(i,i1,a,root1) = 0.0
         DAV_temp_LC_ija_aaa_k(i,i2,a,kk1) = 0.0

         GET Uii(i1,i2)
         REQUEST DAV_LX_ija_aaa(i,i2,a,root1,niter_main) i
         DAV_temp_LC_ija_aaa(i,i2,a) = DAV_LX_ija_aaa(i,i2,a,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_LC_ija_aaa_k
         DAV_temp_L_ija_aaa_k(i,i1,a,kk1) = DAV_temp_LC_ija_aaa_k(i,i2,a,kk1)*Uii(i1,i2)
         DAV_temp_L_ija_aaa(i,i1,a) = DAV_temp_L_ija_aaa_k(i,i1,a,kk1)
         DAV_temp_L_ija_aaa(i,i1,a) *= -1.0
         execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa
         PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_L_ija_aaa(i,i1,a,root1)
         ENDDO kk1
      ENDPARDO a, i1, i, i2

         execute server_barrier   
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>| 
#
#------------- Hbar_j^i contribution (diagram 1.1)-------------|

      PARDO i,i1,a,i2
         DO kk1  
         DAV_temp_L_ija_aaa(i,i1,a) = 0.0
         DAV_temp_2i_L_ija_aaa(i,i1,a,root1) = 0.0
         DAV_temp_LC_ija_aaa_k(i,i1,a,kk1) = 0.0

         GET Uii(i,i2)
         REQUEST DAV_LX_ija_aaa(i2,i1,a,root1,niter_main) i2
         DAV_temp_LC_ija_aaa(i2,i1,a) = DAV_LX_ija_aaa(i2,i1,a,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_LC_ija_aaa_k
         DAV_temp_L_ija_aaa_k(i,i1,a,kk1) = DAV_temp_LC_ija_aaa_k(i2,i1,a,kk1)*Uii(i,i2)
         DAV_temp_L_ija_aaa(i,i1,a) = DAV_temp_L_ija_aaa_k(i,i1,a,kk1)
         DAV_temp_L_ija_aaa(i,i1,a) *= -1.0
         execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa
         PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_L_ija_aaa(i,i1,a,root1)
         ENDDO kk1
      ENDPARDO i,i1,a,i2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)---------------|

      PARDO a, i, i1, a1
         DO kk1
         DAV_temp_L_ija_aaa(i,i1,a) = 0.0
         DAV_temp_LC_ija_aaa_k(i,i1,a1,kk1) = 0.0
         DAV_temp_2i_L_ija_aaa(i,i1,a,root1) = 0.0

         GET Uaa(a1,a)
         REQUEST DAV_LX_ija_aaa(i,i1,a1,root1,niter_main) i
         DAV_temp_LC_ija_aaa(i,i1,a1) = DAV_LX_ija_aaa(i,i1,a1,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_LC_ija_aaa_k
         DAV_temp_L_ija_aaa_k(i,i1,a,kk1) = DAV_temp_LC_ija_aaa_k(i,i1,a1,kk1)*Uaa(a1,a)
         DAV_temp_L_ija_aaa(i,i1,a) = DAV_temp_L_ija_aaa_k(i,i1,a,kk1)
         execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa
         PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_L_ija_aaa(i,i1,a,root1)
         ENDDO kk1 
      ENDPARDO a, i, i1, a1
         execute server_barrier 
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|

      PARDO i, i1, i2, i3
         DO kk1 
         REQUEST             Wiiii(i,i2,i1,i3) i
       
         DO a
         DAV_temp_LC_ija_aaa_k(i2,i3,a,kk1) = 0.0
         DAV_temp_2i_L_ija_aaa(i,i1,a,root1) = 0.0
         DAV_temp_L_ija_aaa(i,i1,a) = 0.0

         REQUEST DAV_LX_ija_aaa(i2,i3,a,root1,niter_main) i2
         DAV_temp_LC_ija_aaa(i2,i3,a) = DAV_LX_ija_aaa(i2,i3,a,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_LC_ija_aaa_k
         DAV_temp_L_ija_aaa_k(i,i1,a,kk1) = Wiiii(i,i2,i1,i3)*DAV_temp_LC_ija_aaa_k(i2,i3,a,kk1)
         DAV_temp_L_ija_aaa(i,i1,a) = DAV_temp_L_ija_aaa_k(i,i1,a,kk1)
         DAV_temp_L_ija_aaa(i,i1,a) *= 0.5
         execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa
         PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_L_ija_aaa(i,i1,a,root1)
         ENDDO a
         ENDDO kk1 
      ENDPARDO i, i1, i2, i3
         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)------|
#
#-------------alpha-alpha-alpha part---------------------------| 
#--------------------------------------------------------------|

      PARDO i1, a, a1, i2
            DO kk1
            REQUEST Wiaai(i1,a,a1,i2) a
            DO i

            DAV_temp_LC_ija_aaa_k(i,i2,a1,kk1) = 0.0
            DAV_temp_2i_L_ija_aaa(i,i1,a,root1) = 0.0
            DAV_temp_2i_LC_ija_aaa(i1,i,a,root1) = 0.0            

            REQUEST DAV_LX_ija_aaa(i,i2,a1,root1,niter_main) i
            DAV_temp_LC_ija_aaa(i,i2,a1) = DAV_LX_ija_aaa(i,i2,a1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_LC_ija_aaa_k 
            aux_iaik(i2,a1,i,kk1) = DAV_temp_LC_ija_aaa_k(i,i2,a1,kk1)
            aux_iaia(i2,a1,i1,a) = Wiaai(i1,a,a1,i2)
            DAV_temp_L_ija_aaa_k(i,i1,a,kk1) = aux_iaik(i2,a1,i,kk1)*aux_iaia(i2,a1,i1,a)
            DAV_temp_L_ija_aaa(i,i1,a) = DAV_temp_L_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa
            PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_L_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------|

            t1aixi(i1,i,a) = DAV_temp_L_ija_aaa(i,i1,a)
            t1aixi(i1,i,a) *= -1.0
            execute addrootindex t1aixi DAV_temp_2i_LC_ija_aaa
            PREPARE DAV_LC_ija_aaa(i1,i,a,root1) += DAV_temp_2i_LC_ija_aaa(i1,i,a,root1)
            ENDDO i
            ENDDO kk1  
      ENDPARDO i1, a, a1, i2
            execute server_barrier
#-------------alpha-beta-beta part-----------------------------|

      PARDO i1,a,b1,j2
            DO kk1
            REQUEST Wiabj(i1,a,b1,j2) i1
            DO i
            DAV_temp_LC_ija_abb_k(i,j2,b1,kk1) = 0.0
            DAV_temp_2i_L_ija_aaa(i,i1,a,root1) = 0.0

            REQUEST DAV_LX_ija_abb(i,j2,b1,root1,niter_main) i
            DAV_temp_LC_ija_abb(i,j2,b1) = DAV_LX_ija_abb(i,j2,b1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
            aux_jbik(j2,b1,i,kk1) = DAV_temp_LC_ija_abb_k(i,j2,b1,kk1)
            aux_jbia(j2,b1,i1,a) = Wiabj(i1,a,b1,j2)
            DAV_temp_L_ija_aaa_k(i,i1,a,kk1) = aux_jbik(j2,b1,i,kk1)*aux_jbia(j2,b1,i1,a)
            DAV_temp_L_ija_aaa_k(i,i1,a,kk1) *= 0.5
            DAV_temp_L_ija_aaa(i,i1,a) = DAV_temp_L_ija_aaa_k(i,i1,a,kk1)
            execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2i_L_ija_aaa
            PREPARE DAV_LC_ija_aaa(i,i1,a,root1) += DAV_temp_2i_L_ija_aaa(i,i1,a,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_2i_LC_ija_aaa(i1,i,a,root1) = 0.0
            t1aixi(i1,i,a) = DAV_temp_L_ija_aaa(i,i1,a)
            execute addrootindex t1aixi DAV_temp_2i_LC_ija_aaa
            DAV_temp_2i_LC_ija_aaa(i1,i,a,root1) *= -1.0
            PREPARE DAV_LC_ija_aaa(i1,i,a,root1) += DAV_temp_2i_LC_ija_aaa(i1,i,a,root1)


            ENDDO i
            ENDDO kk1
      ENDPARDO i1,a,b1,j2
            execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

###############################################################|
#----------------beta-beta-beta part---------------------------|
###############################################################|
#
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------------- disconnected term ------------------------|

      PARDO j,j1,b
           DO kk1
           DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0
           DAV_temp_2i_L_ija_bbb(j1,j,b,root1) = 0.0
           DAV_temp_LC_ija_bbb_k(j,j1,b,kk1) = 0.0
           DAV_temp_LC_h_b_k(j,kk1) = 0.0

           GET Ujb(j1,b)
           GET DAV_LX_h_b(j,root1,niter_main)
           DAV_temp_LC_h_b(j) = DAV_LX_h_b(j,root1,niter_main)
           execute addrootindex DAV_temp_LC_h_b DAV_temp_LC_h_b_k
           DAV_temp_LC_ija_bbb_k(j,j1,b,kk1) = DAV_temp_LC_h_b_k(j,kk1)^Ujb(j1,b)
           DAV_temp_LC_ija_bbb_k(j,j1,b,kk1) *= 0.5
           DAV_temp_LC_ija_bbb(j,j1,b) = DAV_temp_LC_ija_bbb_k(j,j1,b,kk1)
           execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_2i_LC_ija_bbb
           PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
           DAV_temp_L_ija_bbb(j1,j,b) = DAV_temp_LC_ija_bbb(j,j1,b)
           DAV_temp_L_ija_bbb(j1,j,b) *= -1.0
           execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_L_ija_bbb  
           PREPARE DAV_LC_ija_bbb(j1,j,b,root1) += DAV_temp_2i_L_ija_bbb(j1,j,b,root1)

           ENDDO kk1 
      ENDPARDO j,j1,b

           execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------Hbar_ika^j contribution------------------------------|

      PARDO j, b, j1, j2
         DO kk1
         DAV_temp_LC_h_b_k(j2,kk1) = 0.0
         DAV_temp_LC_ija_bbb_k(j,j1,b,kk1) = 0.0
         DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0

         REQUEST  Wjjjb(j,j2,j1,b) j
         GET DAV_LX_h_b(j2,root1,niter_main)
         DAV_temp_LC_h_b(j2) = DAV_LX_h_b(j2,root1,niter_main)
         execute addrootindex DAV_temp_LC_h_b DAV_temp_LC_h_b_k  
         DAV_temp_LC_ija_bbb_k(j,j1,b,kk1) = Wjjjb(j,j2,j1,b)*DAV_temp_LC_h_b_k(j2,kk1)
         DAV_temp_LC_ija_bbb(j,j1,b) = DAV_temp_LC_ija_bbb_k(j,j1,b,kk1)
         execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_2i_LC_ija_bbb
         DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) *= -0.5
         PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
         ENDDO kk1
      ENDPARDO j, b, j1, j2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|

      PARDO b, j1, j, j2
         DAV_temp_L_ija_bbb(j,j1,b) = 0.0
         DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0

         GET Ujj(j1,j2)
         tjj(j2,j1) = Ujj(j1,j2)
         REQUEST DAV_LX_ija_bbb(j,j2,b,root1,niter_main) j
         DAV_temp_LC_ija_bbb(j,j2,b) = DAV_LX_ija_bbb(j,j2,b,root1,niter_main)
         DAV_temp_L_ija_bbb(j,j1,b) = DAV_temp_LC_ija_bbb(j,j2,b)*tjj(j2,j1)
         DAV_temp_L_ija_bbb(j,j1,b) *= -1.0
         execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_LC_ija_bbb
         PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
      ENDPARDO b, j1, j, j2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>| 
#
#------------- Hbar_j^i contribution (diagram 1.1)-------------|
#
      PARDO j,j1,b,j2
         DO kk1
         DAV_temp_L_ija_bbb(j,j1,b) = 0.0
         DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0
         DAV_temp_LC_ija_bbb_k(j2,j1,b,kk1) = 0.0

         GET Ujj(j,j2)
         REQUEST DAV_LX_ija_bbb(j2,j1,b,root1,niter_main) j2
         DAV_temp_LC_ija_bbb(j2,j1,b) = DAV_LX_ija_bbb(j2,j1,b,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_LC_ija_bbb_k
         DAV_temp_L_ija_bbb_k(j,j1,b,kk1) = DAV_temp_LC_ija_bbb_k(j2,j1,b,kk1)*Ujj(j,j2)
         DAV_temp_L_ija_bbb(j,j1,b) = DAV_temp_L_ija_bbb_k(j,j1,b,kk1)
         DAV_temp_L_ija_bbb(j,j1,b) *= -1.0
         execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_LC_ija_bbb
         PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
         ENDDO kk1
      ENDPARDO j,j1,b,j2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)---------------|
#
      PARDO b, j, j1, b1
         DO kk1 
         DAV_temp_L_ija_bbb(j,j1,b) = 0.0
         DAV_temp_LC_ija_bbb_k(j,j1,b1,kk1) = 0.0
         DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0

         GET Ubb(b1,b)
         REQUEST DAV_LX_ija_bbb(j,j1,b1,root1,niter_main) j
         DAV_temp_LC_ija_bbb(j,j1,b1) = DAV_LX_ija_bbb(j,j1,b1,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_LC_ija_bbb_k
         DAV_temp_L_ija_bbb_k(j,j1,b,kk1) = DAV_temp_LC_ija_bbb_k(j,j1,b1,kk1)*Ubb(b1,b)
         DAV_temp_L_ija_bbb(j,j1,b) = DAV_temp_L_ija_bbb_k(j,j1,b,kk1)
         execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_LC_ija_bbb
         PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
         ENDDO kk1  
      ENDPARDO b, j, j1, b1

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|

      PARDO j, j1, j2, j3
         DO kk1
         REQUEST             Wjjjj(j,j2,j1,j3) j

         DO b
         DAV_temp_LC_ija_bbb_k(j2,j3,b,kk1) = 0.0
         DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0

         REQUEST DAV_LX_ija_bbb(j2,j3,b,root1,niter_main) j2
         DAV_temp_LC_ija_bbb(j2,j3,b) = DAV_LX_ija_bbb(j2,j3,b,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_LC_ija_bbb_k 
         DAV_temp_L_ija_bbb_k(j,j1,b,kk1) = Wjjjj(j,j2,j1,j3)*DAV_temp_LC_ija_bbb_k(j2,j3,b,kk1)
         DAV_temp_L_ija_bbb_k(j,j1,b,kk1) *= 0.5
         DAV_temp_L_ija_bbb(j,j1,b) = DAV_temp_L_ija_bbb_k(j,j1,b,kk1)
         execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_LC_ija_bbb
         PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
         ENDDO b
         ENDDO kk1
      ENDPARDO j, j1, j2, j3

         execute server_barrier  
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)------|
#
#-------------beta-beta-beta part------------------------------|
#--------------------------------------------------------------|


#--------------------------------------------------------------| 
      PARDO j1, b, b1, j2
            DO kk1
            REQUEST Wjbbj(j1,b,b1,j2) b
            DO j
            DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0
            DAV_temp_LC_ija_bbb_k(j,j2,b1,kk1) = 0.0

            REQUEST DAV_LX_ija_bbb(j,j2,b1,root1,niter_main) j
            DAV_temp_LC_ija_bbb(j,j2,b1) = DAV_LX_ija_bbb(j,j2,b1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_LC_ija_bbb_k
            aux_jbjk(j2,b1,j,kk1) = DAV_temp_LC_ija_bbb_k(j,j2,b1,kk1)
            aux_jbjb(j2,b1,j1,b) = Wjbbj(j1,b,b1,j2)
            DAV_temp_L_ija_bbb_k(j,j1,b,kk1) = aux_jbjk(j2,b1,j,kk1)*aux_jbjb(j2,b1,j1,b)
            DAV_temp_L_ija_bbb(j,j1,b) = DAV_temp_L_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_LC_ija_bbb
            PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)
#--------------- i <-> j permuted term-------------|
            DAV_temp_2i_L_ija_bbb(j1,j,b,root1) = 0.0  
            t1ajxj(j1,j,b) = DAV_temp_L_ija_bbb(j,j1,b)
            t1ajxj(j1,j,b) *= -1.0
            execute addrootindex t1ajxj DAV_temp_2i_L_ija_bbb
            PREPARE DAV_LC_ija_bbb(j1,j,b,root1) += DAV_temp_2i_L_ija_bbb(j1,j,b,root1)
            ENDDO j
            ENDDO kk1
      ENDPARDO j1, b, b1, j2

            execute server_barrier 
#-------------beta-alpha-alpha part----------------------------|
      PARDO j1,b,a1,i2
            DO kk1   
            REQUEST Wjbai(j1,b,a1,i2) b
            DO j
            DAV_temp_2i_LC_ija_bbb(j,j1,b,root1) = 0.0
            DAV_temp_LC_ija_baa_k(j,i2,a1,kk1) = 0.0

            REQUEST DAV_LX_ija_baa(j,i2,a1,root1,niter_main) j
            DAV_temp_LC_ija_baa(j,i2,a1) = DAV_LX_ija_baa(j,i2,a1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k
            aux_iajk(i2,a1,j,kk1) = DAV_temp_LC_ija_baa_k(j,i2,a1,kk1)
            aux_iajb(i2,a1,j1,b) = Wjbai(j1,b,a1,i2)
            DAV_temp_L_ija_bbb_k(j,j1,b,kk1) = aux_iajk(i2,a1,j,kk1)*aux_iajb(i2,a1,j1,b)
            DAV_temp_L_ija_bbb_k(j,j1,b,kk1) *= 0.5
            DAV_temp_L_ija_bbb(j,j1,b) = DAV_temp_L_ija_bbb_k(j,j1,b,kk1)
            execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2i_LC_ija_bbb
            PREPARE DAV_LC_ija_bbb(j,j1,b,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b,root1)

#--------------- i <-> j permuted term-------------|

            DAV_temp_2i_L_ija_bbb(j1,j,b,root1) = 0.0
            t1ajxj(j1,j,b) = DAV_temp_L_ija_bbb(j,j1,b)
            execute addrootindex t1ajxj DAV_temp_2i_L_ija_bbb
            DAV_temp_2i_L_ija_bbb(j1,j,b,root1) *= -1.0
            PREPARE DAV_LC_ija_bbb(j1,j,b,root1) += DAV_temp_2i_L_ija_bbb(j1,j,b,root1)


            ENDDO j
            ENDDO kk1
      ENDPARDO j1,b,a1,i2

            execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

###############################################################|
#---------------alpha-beta-beta part---------------------------|
###############################################################|
#
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------------- disconnected term ------------------------|

      PARDO i,j1,b
           DO kk1
           DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0
           DAV_temp_LC_ija_abb_k(i,j1,b,kk1) = 0.0
           DAV_temp_LC_h_a_k(i,kk1) = 0.0

           GET Ujb(j1,b)
           GET DAV_LX_h_a(i,root1,niter_main)
           DAV_temp_LC_h_a(i) = DAV_LX_h_a(i,root1,niter_main)
           execute addrootindex DAV_temp_LC_h_a DAV_temp_LC_h_a_k
           DAV_temp_LC_ija_abb_k(i,j1,b,kk1) = DAV_temp_LC_h_a_k(i,kk1)^Ujb(j1,b)
           DAV_temp_LC_ija_abb(i,j1,b) = DAV_temp_LC_ija_abb_k(i,j1,b,kk1)
           execute addrootindex DAV_temp_LC_ija_abb DAV_temp_2i_LC_ija_abb
           PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
           ENDDO kk1 
      ENDPARDO i,j1,b

           execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------Hbar_ika^j contribution------------------------------|
#
      PARDO i, b, j1, i2
         DO kk1
         DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0
         DAV_temp_LC_h_a_k(i2,kk1) = 0.0

         REQUEST  Wiijb(i,i2,j1,b) i
         GET DAV_LX_h_a(i2,root1,niter_main)
         DAV_temp_LC_h_a(i2) = DAV_LX_h_a(i2,root1,niter_main)
         execute addrootindex DAV_temp_LC_h_a DAV_temp_LC_h_a_k
         DAV_temp_LC_ija_abb_k(i,j1,b,kk1) = Wiijb(i,i2,j1,b)*DAV_temp_LC_h_a_k(i2,kk1)
         DAV_temp_LC_ija_abb(i,j1,b) = DAV_temp_LC_ija_abb_k(i,j1,b,kk1)
         DAV_temp_LC_ija_abb(i,j1,b) *= -1.0 
         execute addrootindex DAV_temp_LC_ija_abb DAV_temp_2i_LC_ija_abb 
         PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
         ENDDO kk1
      ENDPARDO i, b, j1, i2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|

      PARDO b, j1, i, j2
         DO kk1
         DAV_temp_L_ija_abb(i,j1,b) = 0.0
         DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0
         DAV_temp_LC_ija_abb_k(i,j2,b,kk1) = 0.0

         GET Ujj(j1,j2)
         REQUEST DAV_LX_ija_abb(i,j2,b,root1,niter_main) i
         DAV_temp_LC_ija_abb(i,j2,b) = DAV_LX_ija_abb(i,j2,b,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
         DAV_temp_L_ija_abb_k(i,j1,b,kk1) = DAV_temp_LC_ija_abb_k(i,j2,b,kk1)*Ujj(j1,j2)
         DAV_temp_L_ija_abb(i,j1,b) = DAV_temp_L_ija_abb_k(i,j1,b,kk1)
         DAV_temp_L_ija_abb(i,j1,b) *= -1.0
         execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_LC_ija_abb
         PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
         ENDDO kk1
      ENDPARDO b, j1, i, j2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>| 
#
#------------- Hbar_j^i contribution (diagram 1.1)-------------|
#
      PARDO i,j1,b,i2
         DO kk1 
         DAV_temp_L_ija_abb(i,j1,b) = 0.0
         DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0
         DAV_temp_LC_ija_abb_k(i2,j1,b,kk1) = 0.0

         GET Uii(i,i2)
         REQUEST DAV_LX_ija_abb(i2,j1,b,root1,niter_main) i2
         DAV_temp_LC_ija_abb(i2,j1,b) = DAV_LX_ija_abb(i2,j1,b,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
         DAV_temp_L_ija_abb_k(i,j1,b,kk1) = DAV_temp_LC_ija_abb_k(i2,j1,b,kk1)*Uii(i,i2)
         DAV_temp_L_ija_abb(i,j1,b) = DAV_temp_L_ija_abb_k(i,j1,b,kk1)
         DAV_temp_L_ija_abb(i,j1,b) *= -1.0
         execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_LC_ija_abb
         PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
         ENDDO kk1
      ENDPARDO i,j1,b,i2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)---------------|
#
      PARDO b, i, j1, b1
         DO kk1
         DAV_temp_L_ija_abb(i,j1,b) = 0.0
         DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0
         DAV_temp_LC_ija_abb_k(i,j1,b1,kk1) = 0.0 

         GET Ubb(b1,b)
         REQUEST DAV_LX_ija_abb(i,j1,b1,root1,niter_main) i
         DAV_temp_LC_ija_abb(i,j1,b1) = DAV_LX_ija_abb(i,j1,b1,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
         DAV_temp_L_ija_abb_k(i,j1,b,kk1) = DAV_temp_LC_ija_abb_k(i,j1,b1,kk1)*Ubb(b1,b)
         DAV_temp_L_ija_abb(i,j1,b) = DAV_temp_L_ija_abb_k(i,j1,b,kk1)
         execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_LC_ija_abb
         PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
         ENDDO kk1 
      ENDPARDO b, i, j1, b1

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
##---------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|

      PARDO i, j1, i2, j3
         DO kk1
         REQUEST             Wiijj(i,i2,j1,j3) i
         DO b
         DAV_temp_LC_ija_abb_k(i2,j3,b,kk1) = 0.0
         DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0

         REQUEST DAV_LX_ija_abb(i2,j3,b,root1,niter_main) i2
         DAV_temp_LC_ija_abb(i2,j3,b) = DAV_LX_ija_abb(i2,j3,b,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
         DAV_temp_L_ija_abb_k(i,j1,b,kk1) = Wiijj(i,i2,j1,j3)*DAV_temp_LC_ija_abb_k(i2,j3,b,kk1)
         DAV_temp_L_ija_abb(i,j1,b) = DAV_temp_L_ija_abb_k(i,j1,b,kk1)
         DAV_temp_L_ija_abb(i,j1,b) *= 1.0
         execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_LC_ija_abb
         PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
         ENDDO b
         ENDDO kk1 
      ENDPARDO i, j1, i2, j3

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)------|
#
#-------------alpha-beta-beta part-----------------------------|
      PARDO j1,b,b1,j2
            DO kk1 
            REQUEST Wjbbj(j1,b,b1,j2) b
           
            DO i
            DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0
            DAV_temp_LC_ija_abb_k(i,j2,b1,kk1) = 0.0

            REQUEST DAV_LX_ija_abb(i,j2,b1,root1,niter_main) i
            DAV_temp_LC_ija_abb(i,j2,b1) = DAV_LX_ija_abb(i,j2,b1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
            aux_jbik(j2,b1,i,kk1) = DAV_temp_LC_ija_abb_k(i,j2,b1,kk1)
            aux_jbjb(j2,b1,j1,b) = Wjbbj(j1,b,b1,j2)
            DAV_temp_L_ija_abb_k(i,j1,b,kk1) = aux_jbik(j2,b1,i,kk1)*aux_jbjb(j2,b1,j1,b)
            DAV_temp_L_ija_abb(i,j1,b) = DAV_temp_L_ija_abb_k(i,j1,b,kk1)
            execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_LC_ija_abb
            PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
            ENDDO i
            ENDDO kk1
      ENDPARDO j1,b,b1,j2
            
            execute server_barrier
#-------------alpha-alpha-alpha part---------------------------|
      PARDO j1, b, a1, i2
            DO kk1
            REQUEST Wjbai(j1,b,a1,i2) b
            DO i
            DAV_temp_2i_LC_ija_abb(i,j1,b,root1) = 0.0
            DAV_temp_LC_ija_aaa_k(i,i2,a1,kk1) = 0.0

            REQUEST DAV_LX_ija_aaa(i,i2,a1,root1,niter_main) i
            REQUEST DAV_LX_ija_aaa(i2,i,a1,root1,niter_main) i2
            DAV_temp_LC_ija_aaa(i,i2,a1) = DAV_LX_ija_aaa(i,i2,a1,root1,niter_main)
            DAV_temp_L_ija_aaa(i2,i,a1) = DAV_LX_ija_aaa(i2,i,a1,root1,niter_main)
            t1aixi(i,i2,a1) = DAV_temp_L_ija_aaa(i2,i,a1)
            DAV_temp_LC_ija_aaa(i,i2,a1) -= t1aixi(i,i2,a1)  

            execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_LC_ija_aaa_k
            aux_iaik(i2,a1,i,kk1) = DAV_temp_LC_ija_aaa_k(i,i2,a1,kk1)
            aux_iajb(i2,a1,j1,b) = Wjbai(j1,b,a1,i2)
            DAV_temp_L_ija_abb_k(i,j1,b,kk1) = aux_iaik(i2,a1,i,kk1)*aux_iajb(i2,a1,j1,b)
            DAV_temp_L_ija_abb(i,j1,b) = DAV_temp_L_ija_abb_k(i,j1,b,kk1)
            execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_LC_ija_abb
            PREPARE DAV_LC_ija_abb(i,j1,b,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b,root1)
            ENDDO i
            ENDDO kk1
      ENDPARDO j1, b, a1, i2

            execute server_barrier

#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|

###############################################################|
#-------------beta-alpha-alpha part----------------------------|
###############################################################|
#
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------------- disconnected term ------------------------|

      PARDO j,i1,a
       DO kk1 
       DAV_temp_LC_h_b_k(j,kk1) = 0.0
       DAV_temp_2i_LC_ija_baa(j,i1,a,root1) = 0.0       

       GET Uia(i1,a)
       GET DAV_LX_h_b(j,root1,niter_main)
       DAV_temp_LC_h_b(j) = DAV_LX_h_b(j,root1,niter_main)
       execute addrootindex DAV_temp_LC_h_b DAV_temp_LC_h_b_k 
       DAV_temp_LC_ija_baa_k(j,i1,a,kk1) = Uia(i1,a)^DAV_temp_LC_h_b_k(j,kk1)
       DAV_temp_LC_ija_baa(j,i1,a) = DAV_temp_LC_ija_baa_k(j,i1,a,kk1)
       execute addrootindex DAV_temp_LC_ija_baa DAV_temp_2i_LC_ija_baa  
       PREPARE DAV_LC_ija_baa(j,i1,a,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a,root1)
       ENDDO kk1
      ENDPARDO j,i1,a

       execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------Hbar_ika^j contribution------------------------------|

      PARDO j, a, i1, j2
         DO kk1 
         DAV_temp_2i_LC_ija_baa(j,i1,a,root1) = 0.0
         DAV_temp_LC_h_b_k(j2,kk1) = 0.0

         REQUEST  Wjjia(j,j2,i1,a) j
         GET DAV_LX_h_b(j2,root1,niter_main)
         DAV_temp_LC_h_b(j2) = DAV_LX_h_b(j2,root1,niter_main)
         execute addrootindex DAV_temp_LC_h_b DAV_temp_LC_h_b_k
         DAV_temp_LC_ija_baa_k(j,i1,a,kk1) = Wjjia(j,j2,i1,a)*DAV_temp_LC_h_b_k(j2,kk1)
         DAV_temp_LC_ija_baa(j,i1,a) = DAV_temp_LC_ija_baa_k(j,i1,a,kk1)
         DAV_temp_LC_ija_baa(j,i1,a) *= -1.0
         execute addrootindex DAV_temp_LC_ija_baa DAV_temp_2i_LC_ija_baa
         PREPARE DAV_LC_ija_baa(j,i1,a,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a,root1)
        ENDDO kk1
      ENDPARDO j, a, i1, j2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------ Hbar_j^i contribution (diagram 2)----------------|
#
      PARDO a, i1, j, i2
          DO kk1
         DAV_temp_L_ija_baa(j,i1,a) = 0.0
         DAV_temp_2i_LC_ija_baa(j,i1,a,root1) = 0.0
         DAV_temp_LC_ija_baa_k(j,i2,a,kk1) = 0.0 

         GET Uii(i1,i2)
         REQUEST DAV_LX_ija_baa(j,i2,a,root1,niter_main) j
         DAV_temp_LC_ija_baa(j,i2,a) = DAV_LX_ija_baa(j,i2,a,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k
         DAV_temp_L_ija_baa_k(j,i1,a,kk1) = DAV_temp_LC_ija_baa_k(j,i2,a,kk1)*Uii(i1,i2)
         DAV_temp_L_ija_baa(j,i1,a) = DAV_temp_L_ija_baa_k(j,i1,a,kk1)
         DAV_temp_L_ija_baa(j,i1,a) *= -1.0
         execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_LC_ija_baa
         PREPARE DAV_LC_ija_baa(j,i1,a,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a,root1)
         ENDDO kk1
      ENDPARDO a, i1, j, i2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>| 
#
#------------- Hbar_j^i contribution (diagram 1.1)-------------|
#
      PARDO j,i1,a,j2
         DO kk1
         DAV_temp_L_ija_baa(j,i1,a) = 0.0
         DAV_temp_2i_LC_ija_baa(j,i1,a,root1) = 0.0
         DAV_temp_LC_ija_baa_k(j2,i1,a,kk1) = 0.0

         GET Ujj(j,j2)
         REQUEST DAV_LX_ija_baa(j2,i1,a,root1,niter_main) j2
         DAV_temp_LC_ija_baa(j2,i1,a) = DAV_LX_ija_baa(j2,i1,a,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k
         DAV_temp_L_ija_baa_k(j,i1,a,kk1) = DAV_temp_LC_ija_baa_k(j2,i1,a,kk1)*Ujj(j,j2)
         DAV_temp_L_ija_baa(j,i1,a) = DAV_temp_L_ija_baa_k(j,i1,a,kk1)
         DAV_temp_L_ija_baa(j,i1,a) *= -1.0
         execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_LC_ija_baa
         PREPARE DAV_LC_ija_baa(j,i1,a,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a,root1)
         ENDDO kk1
      ENDPARDO j,i1,a,j2

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#------------- Hbar_a^b contribution (diagram 1)---------------|
#
      PARDO a, j, i1, a1
         DO kk1 
         DAV_temp_2i_LC_ija_baa(j,i1,a,root1) = 0.0
         DAV_temp_LC_ija_baa_k(j,i1,a1,kk1) = 0.0

         DAV_temp_L_ija_baa(j,i1,a) = 0.0
         GET Uaa(a1,a)
         REQUEST DAV_LX_ija_baa(j,i1,a1,root1,niter_main) j
         DAV_temp_LC_ija_baa(j,i1,a1) = DAV_LX_ija_baa(j,i1,a1,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k
         DAV_temp_L_ija_baa_k(j,i1,a,kk1) = DAV_temp_LC_ija_baa_k(j,i1,a1,kk1)*Uaa(a1,a)
         DAV_temp_L_ija_baa(j,i1,a) = DAV_temp_L_ija_baa_k(j,i1,a,kk1)
         execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_LC_ija_baa
         PREPARE DAV_LC_ija_baa(j,i1,a,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a,root1)
         ENDDO kk1
      ENDPARDO a, j, i1, a1

         execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------- Hbar_kl^ij contribution (diagrams 7 and 8)---------|

      PARDO j, i, j2, i3
         DO kk1   
         REQUEST             Wiijj(i,i3,j,j2) i
         DO a
         DAV_temp_2i_LC_ija_baa(j,i,a,root1) = 0.0
         DAV_temp_LC_ija_baa_k(j2,i3,a,kk1) = 0.0

         REQUEST DAV_LX_ija_baa(j2,i3,a,root1,niter_main) j2
         DAV_temp_LC_ija_baa(j2,i3,a) = DAV_LX_ija_baa(j2,i3,a,root1,niter_main)
         execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k
         aux_jiji(j2,i3,j,i) = Wiijj(i,i3,j,j2)
         DAV_temp_L_ija_baa_k(j,i,a,kk1) =  aux_jiji(j2,i3,j,i)*DAV_temp_LC_ija_baa_k(j2,i3,a,kk1)
         DAV_temp_L_ija_baa(j,i,a) = DAV_temp_L_ija_baa_k(j,i,a,kk1)
         DAV_temp_L_ija_baa(j,i,a) *= 1.0
         execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_LC_ija_baa
         PREPARE DAV_LC_ija_baa(j,i,a,root1) += DAV_temp_2i_LC_ija_baa(j,i,a,root1)
         ENDDO a
         ENDDO kk1 
      ENDPARDO j, i, j2, i3

         execute server_barrier 
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#------------- Hbar_bj^ai contribution (diagrams 3 and 5)------|
#
#-------------beta-beta-beta part------------------------------| 
      PARDO i1, a, a1, i2
            DO kk1 
            REQUEST Wiaai(i1,a,a1,i2) a
            DO j
            DAV_temp_2i_LC_ija_baa(j,i1,a,root1) = 0.0
            DAV_temp_LC_ija_baa_k(j,i2,a1,kk1) = 0.0

            REQUEST DAV_LX_ija_baa(j,i2,a1,root1,niter_main) j
            DAV_temp_LC_ija_baa(j,i2,a1) = DAV_LX_ija_baa(j,i2,a1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k
            aux_iajk(i2,a1,j,kk1) = DAV_temp_LC_ija_baa_k(j,i2,a1,kk1)
            aux_iaia(i2,a1,i1,a) = Wiaai(i1,a,a1,i2)
            DAV_temp_L_ija_baa_k(j,i1,a,kk1) = aux_iajk(i2,a1,j,kk1)*aux_iaia(i2,a1,i1,a)
            DAV_temp_L_ija_baa(j,i1,a) = DAV_temp_L_ija_baa_k(j,i1,a,kk1)
            execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_LC_ija_baa
            PREPARE DAV_LC_ija_baa(j,i1,a,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a,root1)
            ENDDO j
            ENDDO kk1 
      ENDPARDO i1, a, a1, i2

            execute server_barrier
#-------------beta-alpha-alpha part----------------------------|
      PARDO i1,a,b1,j2
            DO kk1 
            REQUEST Wiabj(i1,a,b1,j2) i1
            DO j
            DAV_temp_2i_LC_ija_baa(j,i1,a,root1) = 0.0
            DAV_temp_LC_ija_bbb_k(j,j2,b1,kk1) = 0.0

            REQUEST DAV_LX_ija_bbb(j,j2,b1,root1,niter_main) j
            REQUEST DAV_LX_ija_bbb(j2,j,b1,root1,niter_main) j2
            DAV_temp_LC_ija_bbb(j,j2,b1) = DAV_LX_ija_bbb(j,j2,b1,root1,niter_main)
            DAV_temp_L_ija_bbb(j2,j,b1) = DAV_LX_ija_bbb(j2,j,b1,root1,niter_main) 
            t1ajxj(j,j2,b1) = DAV_temp_L_ija_bbb(j2,j,b1)
            DAV_temp_LC_ija_bbb(j,j2,b1) -= t1ajxj(j,j2,b1)

            execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_LC_ija_bbb_k
            aux_jbjk(j2,b1,j,kk1) = DAV_temp_LC_ija_bbb_k(j,j2,b1,kk1)
            aux_jbia(j2,b1,i1,a) = Wiabj(i1,a,b1,j2)
            DAV_temp_L_ija_baa_k(j,i1,a,kk1) = aux_jbjk(j2,b1,j,kk1)*aux_jbia(j2,b1,i1,a)
            DAV_temp_L_ija_baa(j,i1,a) = DAV_temp_L_ija_baa_k(j,i1,a,kk1)
            execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_LC_ija_baa
            PREPARE DAV_LC_ija_baa(j,i1,a,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a,root1)
            ENDDO j
            ENDDO kk1
      ENDPARDO i1,a,b1,j2

           execute server_barrier
#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|


#>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#----- Hbar_bj^ai contribution (diagrams 6) aka forgotten term of Victor Lotrich |
#--------------------------------------------------------------------------------|
#
#---------alpha-beta-beta part---------------------------------|

      PARDO b, b1, i, i1
            DO kk1
        REQUEST Wiibb(i,i1,b1,b) b1
            DO j
            DAV_temp_2i_LC_ija_abb(i,j,b,root1) = 0.0
            DAV_temp_LC_ija_abb_k(i1,j,b1,kk1) = 0.0

            REQUEST DAV_LX_ija_abb(i1,j,b1,root1,niter_main) i1
            DAV_temp_LC_ija_abb(i1,j,b1) = DAV_LX_ija_abb(i1,j,b1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_abb DAV_temp_LC_ija_abb_k
            DAV_temp_L_ija_abb_k(i,j,b,kk1) = Wiibb(i,i1,b1,b)*DAV_temp_LC_ija_abb_k(i1,j,b1,kk1)
            DAV_temp_L_ija_abb(i,j,b) = DAV_temp_L_ija_abb_k(i,j,b,kk1)
            execute addrootindex DAV_temp_L_ija_abb DAV_temp_2i_LC_ija_abb
            PREPARE DAV_LC_ija_abb(i,j,b,root1) += DAV_temp_2i_LC_ija_abb(i,j,b,root1)
            ENDDO j
            ENDDO kk1
      ENDPARDO b, b1, i, i1

            execute server_barrier
#---------beta-alpha-alpha part--------------------------------|
      PARDO a,a1,j,j1
            DO kk1 
        REQUEST Wjjaa(j,j1,a1,a) a1
            DO i
            DAV_temp_LC_ija_baa_k(j1,i,a1,kk1) = 0.0
            DAV_temp_2i_LC_ija_baa(j,i,a,root1) = 0.0 

            REQUEST DAV_LX_ija_baa(j1,i,a1,root1,niter_main) j1
            DAV_temp_LC_ija_baa(j1,i,a1) = DAV_LX_ija_baa(j1,i,a1,root1,niter_main)
            execute addrootindex DAV_temp_LC_ija_baa DAV_temp_LC_ija_baa_k
            DAV_temp_L_ija_baa_k(j,i,a,kk1) = Wjjaa(j,j1,a1,a)*DAV_temp_LC_ija_baa_k(j1,i,a1,kk1)
            DAV_temp_L_ija_baa(j,i,a) = DAV_temp_L_ija_baa_k(j,i,a,kk1)
            execute addrootindex DAV_temp_L_ija_baa DAV_temp_2i_LC_ija_baa
            PREPARE DAV_LC_ija_baa(j,i,a,root1) += DAV_temp_2i_LC_ija_baa(j,i,a,root1)
            ENDDO i
            ENDDO kk1
       ENDPARDO a,a1,j,j1
 
            execute server_barrier
#>>>>>>>>>>>>>>>>>>3-body terms>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
       PARDO a1
       tax(a1) = 0.0
       PUT I1ax(a1) = tax(a1)
       ENDPARDO a1

       execute sip_barrier

       PARDO b1
       tbx(b1) = 0.0
       PUT I1bx(b1) = tbx(b1)
       ENDPARDO b1

       execute sip_barrier

       PARDO a1
       tax(a1) = 0.0
       PUT Iax(a1) = tax(a1)
       ENDPARDO a1
  
       execute sip_barrier

       PARDO b1
       tbx(b1) = 0.0
       PUT Ibx(b1) = tbx(b1)
       ENDPARDO b1

       execute sip_barrier


#-----------------Intermediates------------------------------------------|
##########################################################################
#--------------alpha-alpha-alpha contribution----------------------------|
      PARDO a, i1, i
          DO kk1
            kk1_aaa(i1,i,a,kk1) = 0.0

            REQUEST DAV_LX_ija_aaa(i1,i,a,root1,niter_main) i1
            DAV_temp_L_ija_aaa(i1,i,a) = DAV_LX_ija_aaa(i1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_L_ija_aaa kk1_aaa
          DO a1
               REQUEST             T2aa(a1,i1,a,i) a1
               taxk(a1,kk1)      = T2aa(a1,i1,a,i)*kk1_aaa(i1,i,a,kk1)
               taxk(a1,kk1)     *= 0.5
               tax(a1) = taxk(a1,kk1)
               PUT I1ax(a1) += tax(a1)
          ENDDO a1
          ENDDO kk1
      ENDPARDO a, i1, i

      execute sip_barrier 
#--------------beta-beta-beta contribution-------------------------------|
     PARDO b, j1, j
          DO kk1
            kk1_bbb(j1,j,b,kk1) = 0.0

            REQUEST DAV_LX_ija_bbb(j1,j,b,root1,niter_main) j1
            DAV_temp_L_ija_bbb(j1,j,b) = DAV_LX_ija_bbb(j1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_L_ija_bbb kk1_bbb
          DO b1
               REQUEST             T2bb(b1,j1,b,j) b1
               tbxk(b1,kk1)      = T2bb(b1,j1,b,j)*kk1_bbb(j1,j,b,kk1)
               tbxk(b1,kk1)     *= 0.5
               tbx(b1) = tbxk(b1,kk1)
               PUT I1bx(b1) += tbx(b1)
          ENDDO b1
          ENDDO kk1
     ENDPARDO b, j1, j   

     execute sip_barrier 
#--------------alpha-beta-beta contribution------------------------------|
      PARDO b, i1, j
          DO kk1
            kk1_abb(i1,j,b,kk1) = 0.0

            REQUEST DAV_LX_ija_abb(i1,j,b,root1,niter_main) i1
            DAV_temp_L_ija_abb(i1,j,b) = DAV_LX_ija_abb(i1,j,b,root1,niter_main)
            execute addrootindex DAV_temp_L_ija_abb kk1_abb
          DO a1
               REQUEST            T2ab(a1,i1,b,j) a1
               taxk(a1,kk1)      = T2ab(a1,i1,b,j)*kk1_abb(i1,j,b,kk1)
               tax(a1) = taxk(a1,kk1)
               PUT Iax(a1) += tax(a1)
          ENDDO a1
          ENDDO kk1
      ENDPARDO b, i1, j

      execute sip_barrier
#--------------beta-alpha-alpha contribution-----------------------------|
      PARDO a, j1, i
          DO kk1
            kk1_baa(j1,i,a,kk1) = 0.0

            REQUEST DAV_LX_ija_baa(j1,i,a,root1,niter_main) j1
            DAV_temp_L_ija_baa(j1,i,a) = DAV_LX_ija_baa(j1,i,a,root1,niter_main)
            execute addrootindex DAV_temp_L_ija_baa kk1_baa
          DO b1
               REQUEST            T2ab(a,i,b1,j1) a
               tbxk(b1,kk1)      = T2ab(a,i,b1,j1)*kk1_baa(j1,i,a,kk1)
               tbx(b1) = tbxk(b1,kk1)
               PUT Ibx(b1) += tbx(b1)
          ENDDO b1
          ENDDO kk1
      ENDPARDO a, j1, i

      execute sip_barrier
#----------------Contributions itself------------------------------------|
##########################################################################
#--------------alpha-alpha-alpha part------------------------------------|
      PARDO a1, a, i1, i
            DO kk1
            taxk(a,kk1) = 0.0
            DAV_temp_2i_LC_ija_aaa(i,i1,a1,root1) = 0.0
            DAV_temp_LC_ija_aaa(i,i1,a1) = 0.0

            REQUEST                     VSpipi(a1,i1,a,i) a1
            GET                         I1ax(a)
            GET                         Iax(a)
            tax(a)  = I1ax(a)
            tax1(a)  = Iax(a)
            tax1(a) *= 0.5
            tax(a) += tax1(a)
            execute addrootindex tax taxk 

            taixi_k(a1,i1,i,kk1)        = VSpipi(a1,i1,a,i)*taxk(a,kk1)
            taixi(a1,i1,i) = taixi_k(a1,i1,i,kk1)
            taixi(a1,i1,i)       *= -1.0
            DAV_temp_LC_ija_aaa(i,i1,a1) = taixi(a1,i1,i)
            execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_2i_LC_ija_aaa
            PREPARE DAV_LC_ija_aaa(i,i1,a1,root1) += DAV_temp_2i_LC_ija_aaa(i,i1,a1,root1)

            ENDDO kk1
      ENDPARDO a1, a, i1, i

           execute server_barrier
#--------------beta-alpha-alpha part-------------------------------------|
      PARDO a1, b, i1, j
            DO kk1
            tbxk(b,kk1) = 0.0

            DAV_temp_2i_LC_ija_baa(j,i1,a1,root1) = 0.0
            DAV_temp_LC_ija_baa(j,i1,a1) = 0.0 

            REQUEST                     Vpiqj(a1,i1,b,j) a1
            GET                         Ibx(b)
            GET                         I1bx(b)
            tbx(b) = Ibx(b)
            tbx1(b) = I1bx(b)
            tbx1(b) *= 2.0   
            tbx(b) += tbx1(b)
            execute addrootindex tbx tbxk 

            taixj_k(a1,i1,j,kk1)         = Vpiqj(a1,i1,b,j)*tbxk(b,kk1)
            taixj(a1,i1,j)   = taixj_k(a1,i1,j,kk1)
            taixj(a1,i1,j)       *= -1.0
            DAV_temp_LC_ija_baa(j,i1,a1) = taixj(a1,i1,j)
            execute addrootindex DAV_temp_LC_ija_baa DAV_temp_2i_LC_ija_baa
            PREPARE DAV_LC_ija_baa(j,i1,a1,root1) += DAV_temp_2i_LC_ija_baa(j,i1,a1,root1)

            ENDDO kk1  
      ENDPARDO a1, b, i1, j

           execute server_barrier 
#--------------beta-beta-beta part---------------------------------------|
      PARDO b1, b, j1, j
            DO kk1            
            tbxk(b,kk1) = 0.0

            DAV_temp_2i_LC_ija_bbb(j,j1,b1,root1) = 0.0
            DAV_temp_LC_ija_bbb(j,j1,b1) = 0.0

            REQUEST                     VSqjqj(b1,j1,b,j) b1
            GET                         I1bx(b)
            GET                         Ibx(b)
            tbx(b) = I1bx(b)
            tbx1(b) = Ibx(b)
            tbx1(b) *= 0.5
            tbx(b) += tbx1(b)
            execute addrootindex tbx tbxk 

            tbjxj_k(b1,j1,j,kk1)        = VSqjqj(b1,j1,b,j)*tbxk(b,kk1)
            tbjxj(b1,j1,j) = tbjxj_k(b1,j1,j,kk1)
            tbjxj(b1,j1,j)       *= -1.0
            DAV_temp_LC_ija_bbb(j,j1,b1) = tbjxj(b1,j1,j)
            execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_2i_LC_ija_bbb
            PREPARE DAV_LC_ija_bbb(j,j1,b1,root1) += DAV_temp_2i_LC_ija_bbb(j,j1,b1,root1)

            ENDDO kk1   
      ENDPARDO b1, b, j1, j   

            execute server_barrier
#-------------alpha-beta-beta part---------------------------------------|
      PARDO b1, a, j1, i
            DO kk1
            taxk(a,kk1) = 0.0
            DAV_temp_2i_LC_ija_abb(i,j1,b1,root1) = 0.0
            DAV_temp_LC_ija_abb(i,j1,b1) = 0.0            

            REQUEST                     Vpiqj(a,i,b1,j1) b1
            GET                         Iax(a)
            GET                         I1ax(a)
            tax(a) = Iax(a)
            tax1(a) = I1ax(a)
            tax1(a) *= 2.0
            tax(a) += tax1(a)  
            execute addrootindex tax taxk
            t_qjpi(b1,j1,a,i) = Vpiqj(a,i,b1,j1)

            DAV_temp_LC_ija_abb_k(i,j1,b1,kk1)        = t_qjpi(b1,j1,a,i)*taxk(a,kk1)
            DAV_temp_LC_ija_abb_k(i,j1,b1,kk1) *= -1.0
            DAV_temp_LC_ija_abb(i,j1,b1) = DAV_temp_LC_ija_abb_k(i,j1,b1,kk1)
            execute addrootindex DAV_temp_LC_ija_abb DAV_temp_2i_LC_ija_abb
            PREPARE DAV_LC_ija_abb(i,j1,b1,root1) += DAV_temp_2i_LC_ija_abb(i,j1,b1,root1)
            ENDDO kk1
      ENDPARDO b1, a, j1, i

            execute server_barrier
#------------------------------------------------------------------------|
     
#       CALL ANTISYMM_L

#--------------------------------------------------------------|
            ENDDO root1
###############################################################| 
#    Here we do corrections to each left eigenvector           |
###############################################################|

#---------------------------------------------------------------|
            cnt = 0.0
#------------Loop over roots------------------------------------|
            DO root1
#----------Check if number of roots is exceeded-----------------|
            cnt += 1.0
            IF cnt > n_roots
            EXIT
            ENDIF
#>>>>>>>>>>>>>>>>> Numerators >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#ddff
#--------------alpha part---------------------------------------|
      PARDO i
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_h_a(i,root1) = 0.0

      GET DAV_LC_h_a(i,root1)
      GET DAV_LX_h_a(i,root1,niter_main)
      DAV_temp_LC_h_a(i) = DAV_LC_h_a(i,root1)
      DAV_temp_L_h_a(i) = DAV_LX_h_a(i,root1,niter_main)
      DAV_temp_L_h_a(i) *= EIG
      DAV_temp_LC_h_a(i) -= DAV_temp_L_h_a(i) 
      execute addrootindex DAV_temp_LC_h_a DAV_temp_2i_LC_h_a  
      PUT DAV_LC_aux_h_a(i,root1) = DAV_temp_2i_LC_h_a(i,root1)

      ENDPARDO i

      execute sip_barrier  
#--------------beta part----------------------------------------|
      PARDO j
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_h_b(j,root1) = 0.0

      GET DAV_LC_h_b(j,root1)
      GET DAV_LX_h_b(j,root1,niter_main)
      DAV_temp_LC_h_b(j) = DAV_LC_h_b(j,root1)
      DAV_temp_L_h_b(j) = DAV_LX_h_b(j,root1,niter_main)
      DAV_temp_L_h_b(j) *= EIG
      DAV_temp_LC_h_b(j) -= DAV_temp_L_h_b(j)
      execute addrootindex DAV_temp_LC_h_b DAV_temp_2i_LC_h_b 
      PUT DAV_LC_aux_h_b(j,root1) = DAV_temp_2i_LC_h_b(j,root1)

      ENDPARDO j

      execute sip_barrier
#------------alpha-alpha-alpha part-----------------------------|
      PARDO i,k,a
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_ija_aaa(i,k,a,root1) = 0.0

      REQUEST DAV_LC_ija_aaa(i,k,a,root1) i
      REQUEST DAV_LX_ija_aaa(i,k,a,root1,niter_main) i
      DAV_temp_LC_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root1)
      DAV_temp_L_ija_aaa(i,k,a) = DAV_LX_ija_aaa(i,k,a,root1,niter_main)
      DAV_temp_L_ija_aaa(i,k,a) *= EIG
      DAV_temp_LC_ija_aaa(i,k,a) -= DAV_temp_L_ija_aaa(i,k,a)
      execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_2i_LC_ija_aaa
      PREPARE DAV_LC_aux_ija_aaa(i,k,a,root1) = DAV_temp_2i_LC_ija_aaa(i,k,a,root1)

      ENDPARDO i,k,a

      execute server_barrier 
#------------beta-beta-beta part--------------------------------|
      PARDO j,l,b
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_ija_bbb(j,l,b,root1) = 0.0

      REQUEST DAV_LC_ija_bbb(j,l,b,root1) j
      REQUEST DAV_LX_ija_bbb(j,l,b,root1,niter_main) j
      DAV_temp_LC_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root1)
      DAV_temp_L_ija_bbb(j,l,b) = DAV_LX_ija_bbb(j,l,b,root1,niter_main)
      DAV_temp_L_ija_bbb(j,l,b) *= EIG
      DAV_temp_LC_ija_bbb(j,l,b) -= DAV_temp_L_ija_bbb(j,l,b)
      execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_2i_LC_ija_bbb 
      PREPARE DAV_LC_aux_ija_bbb(j,l,b,root1) = DAV_temp_2i_LC_ija_bbb(j,l,b,root1)

      ENDPARDO j,l,b

      execute server_barrier 
#------------alpha-beta-beta part-------------------------------|
      PARDO i,l,b
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_ija_abb(i,l,b,root1) = 0.0

      REQUEST DAV_LC_ija_abb(i,l,b,root1) i
      REQUEST DAV_LX_ija_abb(i,l,b,root1,niter_main) i
      DAV_temp_LC_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root1)
      DAV_temp_L_ija_abb(i,l,b) = DAV_LX_ija_abb(i,l,b,root1,niter_main)
      DAV_temp_L_ija_abb(i,l,b) *= EIG
      DAV_temp_LC_ija_abb(i,l,b) -= DAV_temp_L_ija_abb(i,l,b)
      execute addrootindex DAV_temp_LC_ija_abb DAV_temp_2i_LC_ija_abb
      PREPARE DAV_LC_aux_ija_abb(i,l,b,root1) = DAV_temp_2i_LC_ija_abb(i,l,b,root1)

      ENDPARDO i,l,b

      execute server_barrier 
#------------beta-alpha-alpha part------------------------------|
      PARDO j,k,a
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_ija_baa(j,k,a,root1) = 0.0

      REQUEST DAV_LC_ija_baa(j,k,a,root1) j
      REQUEST DAV_LX_ija_baa(j,k,a,root1,niter_main) j
      DAV_temp_LC_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root1)
      DAV_temp_L_ija_baa(j,k,a) = DAV_LX_ija_baa(j,k,a,root1,niter_main)
      DAV_temp_L_ija_baa(j,k,a) *= EIG
      DAV_temp_LC_ija_baa(j,k,a) -= DAV_temp_L_ija_baa(j,k,a)
      execute addrootindex DAV_temp_LC_ija_baa DAV_temp_2i_LC_ija_baa 
      PREPARE DAV_LC_aux_ija_baa(j,k,a,root1) = DAV_temp_2i_LC_ija_baa(j,k,a,root1)

      ENDPARDO j,k,a
#---------------------------------------------------------------|
      execute server_barrier

#>>>>>>>>>>>>>>>>>> Denominators >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>|
#
#---------------------------------------------------------------|
#

#---------------------------------------------------------------|
      PARDO i
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_h_a(i,root1) = 0.0

      GET DAV_LC_aux_h_a(i,root1)
      GET DAV_Hbar_diag_a(i)
      DAV_temp_LC_h_a(i) = DAV_LC_aux_h_a(i,root1)
      DAV_temp_L_h_a(i) = DAV_Hbar_diag_a(i)
      t1is(i) = 1.0
      t1is(i) *= EIG
      t1is(i) -= DAV_temp_L_h_a(i)
      execute apply_den1 DAV_temp_LC_h_a t1is 
      execute addrootindex DAV_temp_LC_h_a DAV_temp_2i_LC_h_a

#      execute dump_amp DAV_temp_2i_LC_h_a

      PUT DAV_LC_h_a(i,root1) = DAV_temp_2i_LC_h_a(i,root1)
      ENDPARDO i

      execute sip_barrier
#---------------------------------------------------------------|
      PARDO j
      execute eomgetroot cnt EIG
      DAV_temp_2i_LC_h_b(j,root1) = 0.0

      GET DAV_LC_aux_h_b(j,root1)
      GET DAV_Hbar_diag_b(j)
      DAV_temp_LC_h_b(j) = DAV_LC_aux_h_b(j,root1)
      DAV_temp_L_h_b(j) = DAV_Hbar_diag_b(j)
      t1js(j) = 1.0
      t1js(j) *= EIG
      t1js(j) -= DAV_temp_L_h_b(j)
      execute apply_den1 DAV_temp_LC_h_b t1js
      execute addrootindex DAV_temp_LC_h_b DAV_temp_2i_LC_h_b


      PUT DAV_LC_h_b(j,root1) = DAV_temp_2i_LC_h_b(j,root1)
      ENDPARDO j

      execute sip_barrier
#------------alpha-alpha-alpha part-----------------------------| 
      PARDO i,k,a
         execute eomgetroot cnt EIG
         DAV_temp_2i_LC_ija_aaa(i,k,a,root1) = 0.0

         REQUEST DAV_LC_aux_ija_aaa(i,k,a,root1) i
         REQUEST DAV_Hbar_diag_aaa(i,k,a) i
         DAV_temp_LC_ija_aaa(i,k,a) = DAV_LC_aux_ija_aaa(i,k,a,root1)
         DAV_temp_L_ija_aaa(i,k,a) = DAV_Hbar_diag_aaa(i,k,a)
         DAV_temp_RC_ija_aaa(i,k,a) = 1.0
         DAV_temp_RC_ija_aaa(i,k,a) *= EIG
         DAV_temp_RC_ija_aaa(i,k,a) -= DAV_temp_L_ija_aaa(i,k,a)
          
         execute apply_den3 DAV_temp_LC_ija_aaa DAV_temp_RC_ija_aaa
         execute addrootindex DAV_temp_LC_ija_aaa DAV_temp_2i_LC_ija_aaa

#         execute dump_amp DAV_temp_2i_LC_ija_aaa

         PREPARE DAV_LC_ija_aaa(i,k,a,root1) = DAV_temp_2i_LC_ija_aaa(i,k,a,root1)
      ENDPARDO i,k,a

         execute server_barrier
#------------beta-beta-beta part--------------------------------|
      PARDO j,l,b
         execute eomgetroot cnt EIG
         DAV_temp_2i_LC_ija_bbb(j,l,b,root1) = 0.0

         REQUEST DAV_LC_aux_ija_bbb(j,l,b,root1) j
         REQUEST DAV_Hbar_diag_bbb(j,l,b) j
         DAV_temp_LC_ija_bbb(j,l,b) = DAV_LC_aux_ija_bbb(j,l,b,root1)
         DAV_temp_L_ija_bbb(j,l,b) = DAV_Hbar_diag_bbb(j,l,b)
         DAV_temp_RC_ija_bbb(j,l,b) = 1.0
         DAV_temp_RC_ija_bbb(j,l,b) *= EIG
         DAV_temp_RC_ija_bbb(j,l,b) -= DAV_temp_L_ija_bbb(j,l,b)
         execute apply_den3 DAV_temp_LC_ija_bbb DAV_temp_RC_ija_bbb
         execute addrootindex DAV_temp_LC_ija_bbb DAV_temp_2i_LC_ija_bbb

#         execute dump_amp DAV_temp_2i_LC_ija_bbb

         PREPARE DAV_LC_ija_bbb(j,l,b,root1) = DAV_temp_2i_LC_ija_bbb(j,l,b,root1)
      ENDPARDO j,l,b

         execute server_barrier
#------------alpha-beta-beta part-------------------------------|
      PARDO i,l,b
         execute eomgetroot cnt EIG
         DAV_temp_2i_LC_ija_abb(i,l,b,root1) = 0.0

         REQUEST DAV_LC_aux_ija_abb(i,l,b,root1) i
         REQUEST DAV_Hbar_diag_abb(i,l,b) i
         DAV_temp_LC_ija_abb(i,l,b) = DAV_LC_aux_ija_abb(i,l,b,root1)
         DAV_temp_L_ija_abb(i,l,b) = DAV_Hbar_diag_abb(i,l,b)
         DAV_temp_RC_ija_abb(i,l,b) = 1.0
         DAV_temp_RC_ija_abb(i,l,b) *= EIG
         DAV_temp_RC_ija_abb(i,l,b) -= DAV_temp_L_ija_abb(i,l,b)
         execute apply_den3 DAV_temp_LC_ija_abb DAV_temp_RC_ija_abb
         execute addrootindex DAV_temp_LC_ija_abb DAV_temp_2i_LC_ija_abb

#         execute dump_amp DAV_temp_2i_LC_ija_abb  

         PREPARE DAV_LC_ija_abb(i,l,b,root1) = DAV_temp_2i_LC_ija_abb(i,l,b,root1)
      ENDPARDO i,l,b

         execute server_barrier 
#------------beta-alpha-alpha part------------------------------|
      PARDO j,k,a
         execute eomgetroot cnt EIG
         DAV_temp_2i_LC_ija_baa(j,k,a,root1) = 0.0

         REQUEST DAV_LC_aux_ija_baa(j,k,a,root1) j
         REQUEST DAV_Hbar_diag_baa(j,k,a) j
         DAV_temp_LC_ija_baa(j,k,a) = DAV_LC_aux_ija_baa(j,k,a,root1)
         DAV_temp_L_ija_baa(j,k,a) = DAV_Hbar_diag_baa(j,k,a)
         DAV_temp_RC_ija_baa(j,k,a) = 1.0
         DAV_temp_RC_ija_baa(j,k,a) *= EIG
         DAV_temp_RC_ija_baa(j,k,a) -= DAV_temp_L_ija_baa(j,k,a)
         execute apply_den3 DAV_temp_LC_ija_baa DAV_temp_RC_ija_baa
         execute addrootindex DAV_temp_LC_ija_baa DAV_temp_2i_LC_ija_baa 

#           execute dump_amp DAV_temp_2i_LC_ija_baa

         PREPARE DAV_LC_ija_baa(j,k,a,root1) = DAV_temp_2i_LC_ija_baa(j,k,a,root1)
      ENDPARDO j,k,a

         execute server_barrier  
#---------------------------------------------------------------|


      ENDDO root1

         

           ENDPROC MAKE_L_Hbar
#          ------------------- 


#=========================================================================================
#     CONSTRUCTION OF DAVIDSON MATRIX: <DAV_L | Hbar | DAV_R >                           |
#=========================================================================================

           PROC MAKE_HAUXMATR
#          ------------------

           IF iter == 0.0

                DO auxind1
                DO auxind2
                 DAV_Haux(auxind1,auxind2) = 0.0
                ENDDO auxind2
               ENDDO auxind1



#------Step 1 - contribution of initial guess vectors to the Davidson matrix-------------|


#------------Loops over roots------------------------------------|
           cnt = 0.0
           DO root1
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF

              cnt2 = 0.0
              DO root2
              cnt2 += 1.0
              IF cnt2 > n_roots
              EXIT
              ENDIF
         
#----------------------------------------------------------------|
                 haux_val = 0.0
                 haux_val_a = 0.0
                 haux_val_b = 0.0
                 haux_val_aaa = 0.0
                 haux_val_abb = 0.0
                 haux_val_bbb = 0.0
                 haux_val_baa = 0.0
#------------alpha-alpha part------------------------------------|
                 VNORM_aux = 0.0

               PARDO i
                 GET DAV_HR0_h_a(i,root2)
                 GET DAV_L_initguess_h_a(i,root1)

                 DAV_temp_R_h_a(i) = DAV_HR0_h_a(i,root2)
                 DAV_temp_L_h_a(i) = DAV_L_initguess_h_a(i,root1)


                 tmpval =  DAV_temp_L_h_a(i)*DAV_temp_R_h_a(i)
                 VNORM_aux += tmpval
               ENDPARDO i
                 

               execute server_barrier

               collective haux_val_a += VNORM_aux
               


#------------beta-beta part--------------------------------------|  
                 VNORM_aux = 0.0

               PARDO j
                 GET DAV_HR0_h_b(j,root2)
                 GET DAV_L_initguess_h_b(j,root1)

                 DAV_temp_R_h_b(j) = DAV_HR0_h_b(j,root2)
                 DAV_temp_L_h_b(j) = DAV_L_initguess_h_b(j,root1)

                 tmpval =  DAV_temp_L_h_b(j)*DAV_temp_R_h_b(j)
                 VNORM_aux += tmpval
               ENDPARDO j

               execute server_barrier

               collective haux_val_b += VNORM_aux
         
#-----------alpha-alpha-alpha part--------------------------------|
                 VNORM_aux = 0.0

                   PARDO i,k,a
                    REQUEST DAV_HR0_ija_aaa(i,k,a,root2) i
                    REQUEST DAV_L_initguess_ija_aaa(i,k,a,root1) i

                    DAV_temp_R_ija_aaa(i,k,a) = DAV_HR0_ija_aaa(i,k,a,root2)
                    DAV_temp_L_ija_aaa(i,k,a) = DAV_L_initguess_ija_aaa(i,k,a,root1)

                    tmpval = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_L_ija_aaa(i,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO i,k,a

               execute server_barrier

               collective haux_val_aaa += VNORM_aux
               
#-----------beta-beta-beta part-----------------------------------|
                 VNORM_aux = 0.0

                   PARDO j,l,b
                    REQUEST DAV_HR0_ija_bbb(j,l,b,root2) j
                    REQUEST DAV_L_initguess_ija_bbb(j,l,b,root1) j

                    DAV_temp_R_ija_bbb(j,l,b) = DAV_HR0_ija_bbb(j,l,b,root2)
                    DAV_temp_L_ija_bbb(j,l,b) = DAV_L_initguess_ija_bbb(j,l,b,root1)


                    tmpval = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_L_ija_bbb(j,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO j,l,b

               execute server_barrier

               collective haux_val_bbb += VNORM_aux
#-----------alpha-beta-beta part----------------------------------|
                 VNORM_aux = 0.0

                   PARDO i,l,b
                    REQUEST DAV_HR0_ija_abb(i,l,b,root2) i
                    REQUEST DAV_L_initguess_ija_abb(i,l,b,root1) i

                    DAV_temp_R_ija_abb(i,l,b) = DAV_HR0_ija_abb(i,l,b,root2)
                    DAV_temp_L_ija_abb(i,l,b) = DAV_L_initguess_ija_abb(i,l,b,root1)

                    tmpval = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_L_ija_abb(i,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO i,l,b

               execute server_barrier

               collective haux_val_abb += VNORM_aux
#-----------beta-alpha-alpha part---------------------------------|
                 VNORM_aux = 0.0

                   PARDO j,k,a
                    REQUEST DAV_HR0_ija_baa(j,k,a,root2) j
                    REQUEST DAV_L_initguess_ija_baa(j,k,a,root1) j

                    DAV_temp_R_ija_baa(j,k,a) = DAV_HR0_ija_baa(j,k,a,root2)
                    DAV_temp_L_ija_baa(j,k,a) = DAV_L_initguess_ija_baa(j,k,a,root1)

                    tmpval = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_L_ija_baa(j,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO j,k,a

               execute server_barrier

               collective haux_val_baa += VNORM_aux
#-----------------------------------------------------------------|

               execute server_barrier


               haux_val += haux_val_a
               haux_val += haux_val_b
               haux_val += haux_val_aaa
               haux_val += haux_val_bbb
               haux_val += haux_val_abb
               haux_val += haux_val_baa

#-----------------------------------------------------------------|
              execute server_barrier 


               DO auxind1
                IF auxind1 == root1
                DO auxind2 
                 IF auxind2 == root2
                 DAV_Haux(auxind1,auxind2) = haux_val
                 ENDIF
                ENDDO auxind2
               ENDIF
               ENDDO auxind1
#-----------------------------------------------------------------|
              ENDDO root2
           ENDDO root1
           ENDIF


#=================================================================|

           IF iter > 0.0


#------------Contributions to the HAUX----------------------------|


#--------------Substep 1------------------------------------------|
#----------- Davidson vectors and new correction------------------|
#---------- C+(dav)*Heff*C(cor)-----------------------------------|

#------------Loops over roots-------------------------------------|

           cnt = 0.0
           DO root1
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF

               iuu = 0.0

               cnt_iter = 0.0
               DO niter           
               cnt_iter += 1.0
               IF cnt_iter > iter
               EXIT
               ENDIF

                  cnt2 = 0.0
                  DO root2
                  cnt2 += 1.0
                  IF cnt2 > n_roots
                  EXIT
                  ENDIF
#-----------------------------------------------------------------|
                 iuu += 1.0 
                 haux_val = 0.0

                 haux_val_a = 0.0
                 haux_val_b = 0.0
                 haux_val_aaa = 0.0
                 haux_val_abb = 0.0
                 haux_val_bbb = 0.0
                 haux_val_baa = 0.0

#-------------alpha-alpha part------------------------------------|
               VNORM_aux = 0.0

               PARDO i
                 GET DAV_HRC_h_a(i,root1)
                 GET DAV_L_h_a(i,root2,niter)

                 DAV_temp_R_h_a(i) = DAV_HRC_h_a(i,root1)
                 DAV_temp_L_h_a(i) = DAV_L_h_a(i,root2,niter)

                 tmpval =  DAV_temp_L_h_a(i)*DAV_temp_R_h_a(i)
                 VNORM_aux += tmpval
               ENDPARDO i

              
               execute server_barrier

               collective haux_val_a += VNORM_aux
#-------------beta-beta part--------------------------------------|
                 VNORM_aux = 0.0

               PARDO j
                 GET DAV_HRC_h_b(j,root1)
                 GET DAV_L_h_b(j,root2,niter)

                 DAV_temp_R_h_b(j) = DAV_HRC_h_b(j,root1)
                 DAV_temp_L_h_b(j) = DAV_L_h_b(j,root2,niter)

                 tmpval =  DAV_temp_L_h_b(j)*DAV_temp_R_h_b(j)
                 VNORM_aux += tmpval
               ENDPARDO j

           
               execute server_barrier

               collective haux_val_b += VNORM_aux
#-------------alpha-alpha-alpha part-------------------------------|
                 VNORM_aux = 0.0

                   PARDO i,k,a
                    REQUEST DAV_HRC_ija_aaa(i,k,a,root1) i
                    REQUEST DAV_L_ija_aaa(i,k,a,root2,niter) i

                    DAV_temp_R_ija_aaa(i,k,a) = DAV_HRC_ija_aaa(i,k,a,root1)
                    DAV_temp_L_ija_aaa(i,k,a) = DAV_L_ija_aaa(i,k,a,root2,niter)

                    tmpval = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_L_ija_aaa(i,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO i,k,a
               execute server_barrier

               collective haux_val_aaa += VNORM_aux
#-----------beta-beta-beta part-----------------------------------|
                 VNORM_aux = 0.0

                   PARDO j,l,b
                    REQUEST DAV_HRC_ija_bbb(j,l,b,root1) j
                    REQUEST DAV_L_ija_bbb(j,l,b,root2,niter) j

                    DAV_temp_R_ija_bbb(j,l,b) = DAV_HRC_ija_bbb(j,l,b,root1)
                    DAV_temp_L_ija_bbb(j,l,b) = DAV_L_ija_bbb(j,l,b,root2,niter)

                    tmpval = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_L_ija_bbb(j,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO j,l,b
               execute server_barrier

               collective haux_val_bbb += VNORM_aux
#-----------alpha-beta-beta part----------------------------------|
                 VNORM_aux = 0.0

                   PARDO i,l,b
                    REQUEST DAV_HRC_ija_abb(i,l,b,root1) i
                    REQUEST DAV_L_ija_abb(i,l,b,root2,niter) i

                    DAV_temp_R_ija_abb(i,l,b) = DAV_HRC_ija_abb(i,l,b,root1)
                    DAV_temp_L_ija_abb(i,l,b) = DAV_L_ija_abb(i,l,b,root2,niter)

                    tmpval = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_L_ija_abb(i,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO i,l,b
               execute server_barrier

               collective haux_val_abb += VNORM_aux
#-----------beta-alpha-alpha part---------------------------------|
                 VNORM_aux = 0.0

                   PARDO j,k,a
                    REQUEST DAV_HRC_ija_baa(j,k,a,root1) j
                    REQUEST DAV_L_ija_baa(j,k,a,root2,niter) j

                    DAV_temp_R_ija_baa(j,k,a) = DAV_HRC_ija_baa(j,k,a,root1)
                    DAV_temp_L_ija_baa(j,k,a) = DAV_L_ija_baa(j,k,a,root2,niter)

                    tmpval = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_L_ija_baa(j,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO j,k,a

               execute server_barrier

               collective haux_val_baa += VNORM_aux

#-----------------------------------------------------------------|
                execute server_barrier


               haux_val += haux_val_a
               haux_val += haux_val_b
               haux_val += haux_val_aaa
               haux_val += haux_val_bbb
               haux_val += haux_val_abb
               haux_val += haux_val_baa
#-----------------------------------------------------------------|

               execute server_barrier

#-----------------------------------------------------------------|
              label1 = 0.0
              label2 = 0.0
              label1 += iuu 
              label2 += cnt
              label2 += ist 

#-----------------------------------------------------------------|
               cnt3 =0.0
               DO auxind1
               cnt3 += 1.0
                IF cnt3 == label1

                cnt4 = 0.0
                DO auxind2
                cnt4 += 1.0
                 IF cnt4 == label2
                 DAV_Haux(auxind1,auxind2) = haux_val
                 ENDIF
                ENDDO auxind2

               ENDIF
               ENDDO auxind1
#-----------------------------------------------------------------|
                  ENDDO root2
               ENDDO niter
           ENDDO root1

#--------------Substep 2------------------------------------------|
#------------- New vectors with each other -----------------------|

#------------Loops over roots-------------------------------------|
           cnt = 0.0
           DO root1
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF

              cnt2 = 0.0
              DO root2
              cnt2 += 1.0
              IF cnt2 > n_roots
              EXIT
              ENDIF
#----------------------------------------------------------------|
                 haux_val = 0.0

                 haux_val_a = 0.0
                 haux_val_b = 0.0
                 haux_val_aaa = 0.0
                 haux_val_abb = 0.0
                 haux_val_bbb = 0.0
                 haux_val_baa = 0.0

#------------alpha-alpha part------------------------------------|
              VNORM_aux = 0.0

               PARDO i
                 GET DAV_HRC_h_a(i,root1)
                 GET DAV_LC_h_a(i,root2)
    

                 DAV_temp_R_h_a(i) = DAV_HRC_h_a(i,root1)
                 DAV_temp_L_h_a(i) = DAV_LC_h_a(i,root2)

                 tmpval =  DAV_temp_L_h_a(i)*DAV_temp_R_h_a(i)
                 VNORM_aux += tmpval
               ENDPARDO i

               execute server_barrier

               collective haux_val_a += VNORM_aux

#-------------beta-beta part-------------------------------------|
                 VNORM_aux = 0.0

               PARDO j
                 GET DAV_HRC_h_b(j,root1)
                 GET DAV_LC_h_b(j,root2)

                 DAV_temp_R_h_b(j) = DAV_HRC_h_b(j,root1)
                 DAV_temp_L_h_b(j) = DAV_LC_h_b(j,root2)

                 tmpval =  DAV_temp_L_h_b(j)*DAV_temp_R_h_b(j)
                 VNORM_aux += tmpval
               ENDPARDO j

               execute server_barrier

               collective haux_val_b += VNORM_aux

#-----------alpha-alpha-alpha part--------------------------------|
                 VNORM_aux = 0.0

                   PARDO i,k,a
                    REQUEST DAV_HRC_ija_aaa(i,k,a,root1) i
                    REQUEST DAV_LC_ija_aaa(i,k,a,root2) i

                    DAV_temp_R_ija_aaa(i,k,a) = DAV_HRC_ija_aaa(i,k,a,root1)
                    DAV_temp_L_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root2)

                    tmpval = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_L_ija_aaa(i,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO i,k,a

               execute server_barrier

               collective haux_val_aaa += VNORM_aux

#-----------beta-beta-beta part-----------------------------------|
                 VNORM_aux = 0.0

                   PARDO j,l,b
                    REQUEST DAV_HRC_ija_bbb(j,l,b,root1) j
                    REQUEST DAV_LC_ija_bbb(j,l,b,root2) j

                    DAV_temp_R_ija_bbb(j,l,b) = DAV_HRC_ija_bbb(j,l,b,root1)
                    DAV_temp_L_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root2)

                    tmpval = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_L_ija_bbb(j,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO j,l,b

               execute server_barrier

               collective haux_val_bbb += VNORM_aux
#-----------alpha-beta-beta part----------------------------------|
                 VNORM_aux = 0.0

                   PARDO i,l,b
                    REQUEST DAV_HRC_ija_abb(i,l,b,root1) i
                    REQUEST DAV_LC_ija_abb(i,l,b,root2) i

                    DAV_temp_R_ija_abb(i,l,b) = DAV_HRC_ija_abb(i,l,b,root1)
                    DAV_temp_L_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root2)

                    tmpval = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_L_ija_abb(i,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO i,l,b

               execute server_barrier

               collective haux_val_abb += VNORM_aux
#-----------beta-alpha-alpha part---------------------------------|
                 VNORM_aux = 0.0

                   PARDO j,k,a
                    REQUEST DAV_HRC_ija_baa(j,k,a,root1) j
                    REQUEST DAV_LC_ija_baa(j,k,a,root2) j

                    DAV_temp_R_ija_baa(j,k,a) = DAV_HRC_ija_baa(j,k,a,root1)
                    DAV_temp_L_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root2)

                    tmpval = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_L_ija_baa(j,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO j,k,a

               execute server_barrier

               collective haux_val_baa += VNORM_aux
#----------------------------------------------------------------|
                execute server_barrier

               haux_val += haux_val_a
               haux_val += haux_val_b
               haux_val += haux_val_aaa
               haux_val += haux_val_bbb
               haux_val += haux_val_abb
               haux_val += haux_val_baa
 

#-----------------------------------------------------------------|
               execute server_barrier

#-----------------indexing labels--------------------------------|
              label1 = 0.0
              label2 = 0.0
              label1 += cnt2
              label1 += ist
              label2 += cnt
              label2 += ist
#----------------------------------------------------------------|
               cnt3 = 0.0
               DO auxind1
               cnt3 += 1.0
                IF cnt3 == label1

                cnt4 = 0.0
                DO auxind2
                cnt4 += 1.0
                 IF cnt4 == label2

                 DAV_Haux(auxind1,auxind2) = haux_val
                 ENDIF
                ENDDO auxind2

               ENDIF
               ENDDO auxind1
#----------------------------------------------------------------|
              ENDDO root2
           ENDDO root1


#--------------Substep 3------------------------------------------|
#----------- Davidson vectors and new correction------------------|
#------------ C+(cor)*Heff*C(dav) --------------------------------|


#------------Loop over iterations---------------------------------|
           iuu = 0.0

           cnt_iter = 0.0
           DO niter
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF


                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                       iuu += 1.0

                       cnt2 = 0.0
                       DO root2
                       cnt2 += 1.0
                       IF cnt2 > n_roots
                       EXIT
                       ENDIF
#-----------------------------------------------------------------|
                    haux_val = 0.0

                 haux_val_a = 0.0
                 haux_val_b = 0.0
                 haux_val_aaa = 0.0
                 haux_val_abb = 0.0
                 haux_val_bbb = 0.0
                 haux_val_baa = 0.0

#-------------alpha-alpha part------------------------------------|
               VNORM_aux = 0.0

               PARDO i
                 GET DAV_HR_prev_h_a(i,root1,niter)
                 GET DAV_LC_h_a(i,root2)

                 DAV_temp_R_h_a(i) = DAV_HR_prev_h_a(i,root1,niter)
                 DAV_temp_L_h_a(i) = DAV_LC_h_a(i,root2)

                 tmpval =  DAV_temp_L_h_a(i)*DAV_temp_R_h_a(i)
                 VNORM_aux += tmpval
               ENDPARDO i

               execute server_barrier

               collective haux_val_a += VNORM_aux

#---------------beta-beta part------------------------------------|
               VNORM_aux = 0.0

               PARDO j
                 GET DAV_HR_prev_h_b(j,root1,niter)
                 GET DAV_LC_h_b(j,root2)

                 DAV_temp_R_h_b(j) = DAV_HR_prev_h_b(j,root1,niter)
                 DAV_temp_L_h_b(j) = DAV_LC_h_b(j,root2)

                 tmpval =  DAV_temp_L_h_b(j)*DAV_temp_R_h_b(j)
                 VNORM_aux += tmpval
               ENDPARDO j

               execute server_barrier

               collective haux_val_b += VNORM_aux

#---------------alpha-alpha-alpha part----------------------------|
                 VNORM_aux = 0.0

                   PARDO i,k,a
                    REQUEST DAV_HR_prev_ija_aaa(i,k,a,root1,niter) i
                    REQUEST DAV_LC_ija_aaa(i,k,a,root2) i

                    DAV_temp_R_ija_aaa(i,k,a) = DAV_HR_prev_ija_aaa(i,k,a,root1,niter)
                    DAV_temp_L_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root2)

                    tmpval = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_L_ija_aaa(i,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO i,k,a

               execute server_barrier

               collective haux_val_aaa += VNORM_aux

#---------------beta-beta-beta part-------------------------------|
                 VNORM_aux = 0.0

                   PARDO j,l,b
                    REQUEST DAV_HR_prev_ija_bbb(j,l,b,root1,niter) j
                    REQUEST DAV_LC_ija_bbb(j,l,b,root2) j

                    DAV_temp_R_ija_bbb(j,l,b) = DAV_HR_prev_ija_bbb(j,l,b,root1,niter)
                    DAV_temp_L_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root2)

                    tmpval = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_L_ija_bbb(j,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO j,l,b

               execute server_barrier

               collective haux_val_bbb += VNORM_aux

#---------------alpha-beta-beta part------------------------------|
                 VNORM_aux = 0.0

                   PARDO i,l,b
                    REQUEST DAV_HR_prev_ija_abb(i,l,b,root1,niter) i
                    REQUEST DAV_LC_ija_abb(i,l,b,root2) i

                    DAV_temp_R_ija_abb(i,l,b) = DAV_HR_prev_ija_abb(i,l,b,root1,niter)
                    DAV_temp_L_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root2)

                    tmpval = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_L_ija_abb(i,l,b)
                    VNORM_aux += tmpval
                   ENDPARDO i,l,b

               execute server_barrier

               collective haux_val_abb += VNORM_aux

#---------------beta-alpha-alpha part-----------------------------|
                 VNORM_aux = 0.0

                   PARDO j,k,a
                    REQUEST DAV_HR_prev_ija_baa(j,k,a,root1,niter) j
                    REQUEST DAV_LC_ija_baa(j,k,a,root2) j

                    DAV_temp_R_ija_baa(j,k,a) = DAV_HR_prev_ija_baa(j,k,a,root1,niter)
                    DAV_temp_L_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root2)

                    tmpval = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_L_ija_baa(j,k,a)
                    VNORM_aux += tmpval
                   ENDPARDO j,k,a

               execute server_barrier

               collective haux_val_baa += VNORM_aux
   
#-----------------------------------------------------------------|
               execute server_barrier



               haux_val += haux_val_a
               haux_val += haux_val_b
               haux_val += haux_val_aaa
               haux_val += haux_val_bbb
               haux_val += haux_val_abb
               haux_val += haux_val_baa
#-----------------------------------------------------------------|

               execute server_barrier
 
#-----------------indexing labels--------------------------------|
              label1 = 0.0
              label2 = 0.0
              label1 += cnt2
              label1 += ist
              label2 += iuu 
#-----------------------------------------------------------------|
               cnt3 =0.0
               DO auxind1
               cnt3 += 1.0
                IF cnt3 == label1

                cnt4 = 0.0
                DO auxind2
                cnt4 += 1.0
                 IF cnt4 == label2
                 DAV_Haux(auxind1,auxind2) = haux_val
                 ENDIF
                ENDDO auxind2

               ENDIF
               ENDDO auxind1
#-----------------------------------------------------------------|
                       ENDDO root2 
                 ENDDO root1
           ENDDO niter
#=================================================================|
           ENDIF


           ENDPROC MAKE_HAUXMATR
#          ---------------------

#=========================================================================================
#             DIAGONALIZATION OF DAVIDSON MATRIX                                         |
#    AND CONSTRUCTION OF NEW APPROXIMATIONS TO EOM-IP EIGENVECTORS                       |
#=========================================================================================

           PROC DAVDIAG
#          ------------
#-----------------------------------------------------------------|
#       Diagonalization of small Davidson matrix                  |
#-----------------------------------------------------------------|        

       execute eomiter iter n_roots

       execute server_barrier 
        
       execute eomdiag DAV_Haux

       execute server_barrier
#-----------------------------------------------------------------|
#     Set up eigenvectors of small Davidson matrix                |
#-----------------------------------------------------------------|

       execute setauxvec DAV_R_aux DAV_L_aux  
       execute server_barrier
#-----------------------------------------------------------------|
#      Construction of approximation to the |R> and <L|           |
#-----------------------------------------------------------------|



#-----------------------------------------------------------------|
#----------------alpha-alpha part---------------------------------|
#-----------------------------------------------------------------|



#--------| Loop over blocks of target new vector |----------------|
                      PARDO i

                      DAV_temp_R_h_a(i) = 0.0
                      DAV_temp_L_h_a(i) = 0.0

#-----------------------------------------------------------------|

#-----------------------------------------------------------------|

#-----Total number of new approximations is nroots*niter+nroots---|
#-----| Loop over index of new approximations |-------------------|
                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots
 
                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF         

                         DAV_RX_temp_a(i,auxind1) = 0.0
                         DAV_LX_temp_a(i,auxind1) = 0.0

                        PUT DAV_RX_aux_h_a(i,auxind1) = DAV_RX_temp_a(i,auxind1)
                        PUT DAV_LX_aux_h_a(i,auxind1) = DAV_LX_temp_a(i,auxind1)


#--------| Contribution from Davidson vectors |-------------------|

           iqq = 0.0
#--------| Loop over iterartions |--------------------------------|
           cnt_iter = 0.0
           DO niter
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF
#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                      iqq += 1.0

                       DAV_temp_3i_R_h_a(i,root1,niter) = 0.0
                       DAV_temp_3i_L_h_a(i,root1,niter) = 0.0

                         GET DAV_R_h_a(i,root1,niter)
                         GET DAV_L_h_a(i,root1,niter) 
                       
                       DAV_temp_R_h_a(i) = DAV_R_h_a(i,root1,niter)
                       DAV_temp_L_h_a(i) = DAV_L_h_a(i,root1,niter)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                       cnt4 = 0.0     
                       DO auxind2
                       cnt4 += 1.0 
                       IF cnt4 == iqq

                         DAV_temp_2ii_R_h_a(i,auxind2) = 0.0
                         DAV_temp_2ii_L_h_a(i,auxind2) = 0.0

                         execute addrootindex DAV_temp_R_h_a DAV_temp_2ii_R_h_a
                         execute addrootindex DAV_temp_L_h_a DAV_temp_2ii_L_h_a
                         DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                         DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1) 

                         DAV_RX_temp_a(i,auxind1) = DAV_temp_2ii_R_h_a(i,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                         DAV_LX_temp_a(i,auxind1) = DAV_temp_2ii_L_h_a(i,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

                        PUT DAV_RX_aux_h_a(i,auxind1) += DAV_RX_temp_a(i,auxind1)
                        PUT DAV_LX_aux_h_a(i,auxind1) += DAV_LX_temp_a(i,auxind1)


                       ENDIF   
                       ENDDO auxind2 
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
#---------| End of loop over iterations |--------------------------|
           ENDDO niter

#---------------------------------------------------------------------|
#---------------------------------------------------------------------|

#--------| Contribution from Davidson correction |----------------|

#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF


                 DAV_temp_2i_R_h_a(i,root1) = 0.0 
                 DAV_temp_2i_L_h_a(i,root1) = 0.0 

                 GET DAV_RC_h_a(i,root1)
                 GET DAV_LC_h_a(i,root1)
                 DAV_temp_R_h_a(i) = DAV_RC_h_a(i,root1)
                 DAV_temp_L_h_a(i) = DAV_LC_h_a(i,root1)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                    iuu = 0.0
                    iuu += cnt
                    iuu += ist

                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iuu

                         DAV_temp_2ii_R_h_a(i,auxind2) = 0.0
                         DAV_temp_2ii_L_h_a(i,auxind2) = 0.0

                         execute addrootindex DAV_temp_R_h_a DAV_temp_2ii_R_h_a
                         execute addrootindex DAV_temp_L_h_a DAV_temp_2ii_L_h_a
                         DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                         DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                         DAV_RX_temp_a(i,auxind1) = DAV_temp_2ii_R_h_a(i,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                         DAV_LX_temp_a(i,auxind1) = DAV_temp_2ii_L_h_a(i,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

                        PUT DAV_RX_aux_h_a(i,auxind1) += DAV_RX_temp_a(i,auxind1)
                        PUT DAV_LX_aux_h_a(i,auxind1) += DAV_LX_temp_a(i,auxind1)


                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1

#-----| End of loop over index of new approximations |------------|
                   ENDDO auxind1
#--------| End of loop over blocks of target new vector |---------|
                      ENDPARDO i
#-----------------------------------------------------------------|

           execute sip_barrier      

#=================================================================|
#----------------- beta-beta part --------------------------------|
#=================================================================|

#--------| Loop over blocks of target new vector |----------------|


                      PARDO j

                      DAV_temp_R_h_b(j) = 0.0
                      DAV_temp_L_h_b(j) = 0.0

#-----------------------------------------------------------------|
#-----------------------------------------------------------------|

#-----Total number of new approximations is nroots*niter+nroots---|
#-----| Loop over index of new approximations |-------------------|

                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_b(j,auxind1) = 0.0
                         DAV_LX_temp_b(j,auxind1) = 0.0

                        PUT DAV_RX_aux_h_b(j,auxind1) = DAV_RX_temp_b(j,auxind1)
                        PUT DAV_LX_aux_h_b(j,auxind1) = DAV_LX_temp_b(j,auxind1)


#--------| Contribution from Davidson vectors |-------------------|

           iqq = 0.0
#--------| Loop over iterartions |--------------------------------|
           cnt_iter = 0.0
           DO niter
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF
#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                       iqq += 1.0

                       DAV_temp_3i_R_h_b(j,root1,niter) = 0.0
                       DAV_temp_3i_L_h_b(j,root1,niter) = 0.0

                         GET DAV_R_h_b(j,root1,niter)
                         GET DAV_L_h_b(j,root1,niter)

                       DAV_temp_R_h_b(j) = DAV_R_h_b(j,root1,niter)
                       DAV_temp_L_h_b(j) = DAV_L_h_b(j,root1,niter)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iqq

                         DAV_temp_2ii_R_h_b(j,auxind2) = 0.0
                         DAV_temp_2ii_L_h_b(j,auxind2) = 0.0

                         execute addrootindex DAV_temp_R_h_b DAV_temp_2ii_R_h_b
                         execute addrootindex DAV_temp_L_h_b DAV_temp_2ii_L_h_b
                         DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                         DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                         DAV_RX_temp_b(j,auxind1) = DAV_temp_2ii_R_h_b(j,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                         DAV_LX_temp_b(j,auxind1) = DAV_temp_2ii_L_h_b(j,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

                        PUT DAV_RX_aux_h_b(j,auxind1) += DAV_RX_temp_b(j,auxind1)
                        PUT DAV_LX_aux_h_b(j,auxind1) += DAV_LX_temp_b(j,auxind1)



                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
#---------| End of loop over iterations |--------------------------|
                            ENDDO niter

#---------------------------------------------------------------------|
#---------------------------------------------------------------------|

#--------| Contribution from Davidson correction |----------------|

#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF


                 DAV_temp_2i_R_h_b(j,root1) = 0.0
                 DAV_temp_2i_L_h_b(j,root1) = 0.0

                 GET DAV_RC_h_b(j,root1)
                 GET DAV_LC_h_b(j,root1)
                 DAV_temp_R_h_b(j) = DAV_RC_h_b(j,root1)
                 DAV_temp_L_h_b(j) = DAV_LC_h_b(j,root1)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                    iuu = 0.0
                    iuu += cnt
                    iuu += ist

                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iuu

                         DAV_temp_2ii_R_h_b(j,auxind2) = 0.0
                         DAV_temp_2ii_L_h_b(j,auxind2) = 0.0

                         execute addrootindex DAV_temp_R_h_b DAV_temp_2ii_R_h_b
                         execute addrootindex DAV_temp_L_h_b DAV_temp_2ii_L_h_b
                         DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                         DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                         DAV_RX_temp_b(j,auxind1) = DAV_temp_2ii_R_h_b(j,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                         DAV_LX_temp_b(j,auxind1) = DAV_temp_2ii_L_h_b(j,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

                        PUT DAV_RX_aux_h_b(j,auxind1) += DAV_RX_temp_b(j,auxind1)
                        PUT DAV_LX_aux_h_b(j,auxind1) += DAV_LX_temp_b(j,auxind1)


                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
#-----| End of loop over index of new approximations |------------|
                   ENDDO auxind1
#--------| End of loop over blocks of target new vector |---------|
                   ENDPARDO j
#-----------------------------------------------------------------|

           execute sip_barrier


#=================================================================|
#-----------------alpha-alpha-alpha part--------------------------|
#=================================================================|


#--------------Zero out arrays------------------------------------|



             PARDO i,k,a

                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_aaa(i,k,a,auxind1) = 0.0
                         DAV_LX_temp_aaa(i,k,a,auxind1) = 0.0

                   PREPARE DAV_RX_aux_ija_aaa(i,k,a,auxind1) = DAV_RX_temp_aaa(i,k,a,auxind1)
                   PREPARE DAV_LX_aux_ija_aaa(i,k,a,auxind1) = DAV_LX_temp_aaa(i,k,a,auxind1)


                  ENDDO auxind1  
           ENDPARDO i,k,a

           execute server_barrier  



#--------| Loop over blocks of target new vector |----------------|
           PARDO i,k,a

             DAV_temp_R_ija_aaa(i,k,a) = 0.0
             DAV_temp_L_ija_aaa(i,k,a) = 0.0          

#-----------------------------------------------------------------|
#-----Total number of new approximations is nroots*niter+nroots---|
#-----| Loop over index of new approximations |-------------------|
                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_aaa(i,k,a,auxind1) = 0.0
                         DAV_LX_temp_aaa(i,k,a,auxind1) = 0.0

#--------| Contribution from Davidson vectors |-------------------|
           iqq = 0.0
#--------| Loop over iterartions |--------------------------------|
           cnt_iter = 0.0
           DO niter
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF
#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                       iqq += 1.0

               REQUEST DAV_R_ija_aaa(i,k,a,root1,niter) i
               REQUEST DAV_L_ija_aaa(i,k,a,root1,niter) i
               DAV_temp_R_ija_aaa(i,k,a) = DAV_R_ija_aaa(i,k,a,root1,niter)
               DAV_temp_L_ija_aaa(i,k,a) = DAV_L_ija_aaa(i,k,a,root1,niter)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iqq

                          DAV_temp_2ii_R_ija_aaa(i,k,a,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_aaa(i,k,a,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2ii_R_ija_aaa
                          execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2ii_L_ija_aaa
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

               DAV_RX_temp_aaa(i,k,a,auxind1) = DAV_temp_2ii_R_ija_aaa(i,k,a,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
               DAV_LX_temp_aaa(i,k,a,auxind1) = DAV_temp_2ii_L_ija_aaa(i,k,a,auxind2)*DAV_L_aux_temp(auxind2,auxind1)
                   PREPARE DAV_RX_aux_ija_aaa(i,k,a,auxind1) += DAV_RX_temp_aaa(i,k,a,auxind1)
                   PREPARE DAV_LX_aux_ija_aaa(i,k,a,auxind1) += DAV_LX_temp_aaa(i,k,a,auxind1) 



                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
#---------| End of loop over iterations |--------------------------|
                            ENDDO niter

#---------------------------------------------------------------------|
#---------------------------------------------------------------------|

#--------| Contribution from Davidson correction |----------------|

#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                 REQUEST DAV_RC_ija_aaa(i,k,a,root1) i
                 REQUEST DAV_LC_ija_aaa(i,k,a,root1) i
                 DAV_temp_R_ija_aaa(i,k,a) = DAV_RC_ija_aaa(i,k,a,root1)
                 DAV_temp_L_ija_aaa(i,k,a) = DAV_LC_ija_aaa(i,k,a,root1)          
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                    iuu = 0.0
                    iuu += cnt
                    iuu += ist

                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iuu

                          DAV_temp_2ii_R_ija_aaa(i,k,a,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_aaa(i,k,a,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_aaa DAV_temp_2ii_R_ija_aaa
                          execute addrootindex DAV_temp_L_ija_aaa DAV_temp_2ii_L_ija_aaa
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                 DAV_RX_temp_aaa(i,k,a,auxind1) = DAV_temp_2ii_R_ija_aaa(i,k,a,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                 DAV_LX_temp_aaa(i,k,a,auxind1) = DAV_temp_2ii_L_ija_aaa(i,k,a,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

                   PREPARE DAV_RX_aux_ija_aaa(i,k,a,auxind1) += DAV_RX_temp_aaa(i,k,a,auxind1)
                   PREPARE DAV_LX_aux_ija_aaa(i,k,a,auxind1) += DAV_LX_temp_aaa(i,k,a,auxind1)


                       ENDIF 
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
#-----| End of loop over index of new approximations |------------|
                   ENDDO auxind1
#--------| End of loop over blocks of target new vector |---------|
           ENDPARDO i,k,a
#-----------------------------------------------------------------|

           execute server_barrier

#=================================================================|
#--------------------beta-beta-beta part--------------------------|
#=================================================================|


             PARDO j,l,b

                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_bbb(j,l,b,auxind1) = 0.0
                         DAV_LX_temp_bbb(j,l,b,auxind1) = 0.0


                   PREPARE DAV_RX_aux_ija_bbb(j,l,b,auxind1) = DAV_RX_temp_bbb(j,l,b,auxind1)
                   PREPARE DAV_LX_aux_ija_bbb(j,l,b,auxind1) = DAV_LX_temp_bbb(j,l,b,auxind1)

                  ENDDO auxind1
           ENDPARDO j,l,b

           execute server_barrier

#--------| Loop over blocks of target new vector |----------------|
           PARDO j,l,b

             DAV_temp_R_ija_bbb(j,l,b) = 0.0
             DAV_temp_L_ija_bbb(j,l,b) = 0.0

#-----------------------------------------------------------------|

#-----Total number of new approximations is nroots*niter+nroots---|
#-----| Loop over index of new approximations |-------------------|
                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_bbb(j,l,b,auxind1) = 0.0
                         DAV_LX_temp_bbb(j,l,b,auxind1) = 0.0

#--------| Contribution from Davidson vectors |-------------------|
           iqq = 0.0
#--------| Loop over iterartions |--------------------------------|
           cnt_iter = 0.0
           DO niter
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF
#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                       iqq += 1.0

               REQUEST DAV_R_ija_bbb(j,l,b,root1,niter) j
               REQUEST DAV_L_ija_bbb(j,l,b,root1,niter) j
               DAV_temp_R_ija_bbb(j,l,b) = DAV_R_ija_bbb(j,l,b,root1,niter)
               DAV_temp_L_ija_bbb(j,l,b) = DAV_L_ija_bbb(j,l,b,root1,niter)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iqq

                          DAV_temp_2ii_R_ija_bbb(j,l,b,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_bbb(j,l,b,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2ii_R_ija_bbb
                          execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2ii_L_ija_bbb
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                DAV_RX_temp_bbb(j,l,b,auxind1) = DAV_temp_2ii_R_ija_bbb(j,l,b,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                DAV_LX_temp_bbb(j,l,b,auxind1) = DAV_temp_2ii_L_ija_bbb(j,l,b,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

                           PREPARE DAV_RX_aux_ija_bbb(j,l,b,auxind1) += DAV_RX_temp_bbb(j,l,b,auxind1)
                           PREPARE DAV_LX_aux_ija_bbb(j,l,b,auxind1) += DAV_LX_temp_bbb(j,l,b,auxind1)

#--------------------------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------


                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
#---------| End of loop over iterations |--------------------------|
                 ENDDO niter

#---------------------------------------------------------------------|
#---------------------------------------------------------------------|

#--------| Contribution from Davidson correction |----------------|

#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                 REQUEST DAV_RC_ija_bbb(j,l,b,root1) j
                 REQUEST DAV_LC_ija_bbb(j,l,b,root1) j
                 DAV_temp_R_ija_bbb(j,l,b) = DAV_RC_ija_bbb(j,l,b,root1)
                 DAV_temp_L_ija_bbb(j,l,b) = DAV_LC_ija_bbb(j,l,b,root1)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                    iuu = 0.0
                    iuu += cnt
                    iuu += ist

                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iuu

                          DAV_temp_2ii_R_ija_bbb(j,l,b,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_bbb(j,l,b,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_bbb DAV_temp_2ii_R_ija_bbb
                          execute addrootindex DAV_temp_L_ija_bbb DAV_temp_2ii_L_ija_bbb
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

               DAV_RX_temp_bbb(j,l,b,auxind1) = DAV_temp_2ii_R_ija_bbb(j,l,b,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
               DAV_LX_temp_bbb(j,l,b,auxind1) = DAV_temp_2ii_L_ija_bbb(j,l,b,auxind2)*DAV_L_aux_temp(auxind2,auxind1)
                           PREPARE DAV_RX_aux_ija_bbb(j,l,b,auxind1) += DAV_RX_temp_bbb(j,l,b,auxind1)
                           PREPARE DAV_LX_aux_ija_bbb(j,l,b,auxind1) += DAV_LX_temp_bbb(j,l,b,auxind1)




                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
                 
#-----| End of loop over index of new approximations |------------|
                   ENDDO auxind1
#--------| End of loop over blocks of target new vector |---------|
           ENDPARDO j,l,b
#-----------------------------------------------------------------|

           execute server_barrier

#=================================================================|
#--------------------alpha-beta-beta part-------------------------|
#=================================================================|


#-----------------zero out arrays---------------------------------|


             PARDO i,l,b

                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_abb(i,l,b,auxind1) = 0.0
                         DAV_LX_temp_abb(i,l,b,auxind1) = 0.0

                   PREPARE DAV_RX_aux_ija_abb(i,l,b,auxind1) = DAV_RX_temp_abb(i,l,b,auxind1)
                   PREPARE DAV_LX_aux_ija_abb(i,l,b,auxind1) = DAV_LX_temp_abb(i,l,b,auxind1)

                  ENDDO auxind1
           ENDPARDO i,l,b

           execute server_barrier



#--------| Loop over blocks of target new vector |----------------|

           PARDO i,l,b

             DAV_temp_R_ija_abb(i,l,b) = 0.0
             DAV_temp_L_ija_abb(i,l,b) = 0.0

#-----------------------------------------------------------------|
#-----Total number of new approximations is nroots*niter+nroots---|
#-----| Loop over index of new approximations |-------------------|
                   cnt3 = 0.0
                   izz = n_roots*iter
                  izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_abb(i,l,b,auxind1) = 0.0
                         DAV_LX_temp_abb(i,l,b,auxind1) = 0.0
#--------| Contribution from Davidson vectors |-------------------|
           iqq = 0.0
#--------| Loop over iterartions |--------------------------------|           
           cnt_iter = 0.0
           DO niter
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF
#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                       iqq += 1.0

               REQUEST DAV_R_ija_abb(i,l,b,root1,niter) i
               REQUEST DAV_L_ija_abb(i,l,b,root1,niter) i
               DAV_temp_R_ija_abb(i,l,b) = DAV_R_ija_abb(i,l,b,root1,niter)
               DAV_temp_L_ija_abb(i,l,b) = DAV_L_ija_abb(i,l,b,root1,niter)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iqq

                          DAV_temp_2ii_R_ija_abb(i,l,b,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_abb(i,l,b,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_abb DAV_temp_2ii_R_ija_abb
                          execute addrootindex DAV_temp_L_ija_abb DAV_temp_2ii_L_ija_abb
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                DAV_RX_temp_abb(i,l,b,auxind1) = DAV_temp_2ii_R_ija_abb(i,l,b,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                DAV_LX_temp_abb(i,l,b,auxind1) = DAV_temp_2ii_L_ija_abb(i,l,b,auxind2)*DAV_L_aux_temp(auxind2,auxind1)
                   PREPARE DAV_RX_aux_ija_abb(i,l,b,auxind1) += DAV_RX_temp_abb(i,l,b,auxind1)
                   PREPARE DAV_LX_aux_ija_abb(i,l,b,auxind1) += DAV_LX_temp_abb(i,l,b,auxind1)


                       ENDIF
                       ENDDO auxind2

                 ENDDO root1
#---------| End of loop over iterations |--------------------------|
                 ENDDO niter

#---------------------------------------------------------------------|
#---------------------------------------------------------------------|

#--------| Contribution from Davidson correction |----------------|

#--------| Loop over roots |--------------------------------------|
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                 REQUEST DAV_RC_ija_abb(i,l,b,root1) i
                 REQUEST DAV_LC_ija_abb(i,l,b,root1) i
                 DAV_temp_R_ija_abb(i,l,b) = DAV_RC_ija_abb(i,l,b,root1)
                 DAV_temp_L_ija_abb(i,l,b) = DAV_LC_ija_abb(i,l,b,root1)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                    iuu = 0.0
                    iuu += cnt
                    iuu += ist

                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iuu

                          DAV_temp_2ii_R_ija_abb(i,l,b,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_abb(i,l,b,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_abb DAV_temp_2ii_R_ija_abb
                          execute addrootindex DAV_temp_L_ija_abb DAV_temp_2ii_L_ija_abb
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                DAV_RX_temp_abb(i,l,b,auxind1) = DAV_temp_2ii_R_ija_abb(i,l,b,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                DAV_LX_temp_abb(i,l,b,auxind1) = DAV_temp_2ii_L_ija_abb(i,l,b,auxind2)*DAV_L_aux_temp(auxind2,auxind1)
                   PREPARE DAV_RX_aux_ija_abb(i,l,b,auxind1) += DAV_RX_temp_abb(i,l,b,auxind1)
                   PREPARE DAV_LX_aux_ija_abb(i,l,b,auxind1) += DAV_LX_temp_abb(i,l,b,auxind1)


                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                   ENDDO root1
#-----| End of loop over index of new approximations |------------|
                   ENDDO auxind1
#--------| End of loop over blocks of target new vector |---------|
           ENDPARDO i,l,b
#-----------------------------------------------------------------|

          execute server_barrier

#=================================================================|
#-----------------beta-alpha-alpha part--------------------------|
#=================================================================|



#----------------Zero out arrays----------------------------------|

             PARDO j,k,a

                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_baa(j,k,a,auxind1) = 0.0
                         DAV_LX_temp_baa(j,k,a,auxind1) = 0.0

                   PREPARE DAV_RX_aux_ija_baa(j,k,a,auxind1) = DAV_RX_temp_baa(j,k,a,auxind1)
                   PREPARE DAV_LX_aux_ija_baa(j,k,a,auxind1) = DAV_LX_temp_baa(j,k,a,auxind1)

                  ENDDO auxind1
           ENDPARDO j,k,a

           execute server_barrier




#--------| Loop over blocks of target new vector |----------------|
            PARDO j,k,a
             DAV_temp_R_ija_baa(j,k,a) = 0.0
             DAV_temp_L_ija_baa(j,k,a) = 0.0

#-----------------------------------------------------------------|
#-----Total number of new approximations is nroots*niter+nroots---|
#-----| Loop over index of new approximations |-------------------|
                   cnt3 = 0.0
                   izz = n_roots*iter
                   izz += n_roots

                   DO auxind1
                   cnt3 += 1.0
                   IF cnt3 > izz
                   EXIT
                   ENDIF

                         DAV_RX_temp_baa(j,k,a,auxind1) = 0.0
                         DAV_LX_temp_baa(j,k,a,auxind1) = 0.0

#--------| Contribution from Davidson vectors |-------------------|
           iqq = 0.0
#--------| Loop over iterartions |--------------------------------|
           cnt_iter = 0.0
           DO niter
           cnt_iter += 1.0
           IF cnt_iter > iter
           EXIT
           ENDIF
#--------| Loop over roots |--------------------------------------|           
                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                       iqq += 1.0

               REQUEST DAV_R_ija_baa(j,k,a,root1,niter) j
               REQUEST DAV_L_ija_baa(j,k,a,root1,niter) j
               DAV_temp_R_ija_baa(j,k,a) = DAV_R_ija_baa(j,k,a,root1,niter)
               DAV_temp_L_ija_baa(j,k,a) = DAV_L_ija_baa(j,k,a,root1,niter)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iqq

                          DAV_temp_2ii_R_ija_baa(j,k,a,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_baa(j,k,a,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_baa DAV_temp_2ii_R_ija_baa
                          execute addrootindex DAV_temp_L_ija_baa DAV_temp_2ii_L_ija_baa
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

                DAV_RX_temp_baa(j,k,a,auxind1) = DAV_temp_2ii_R_ija_baa(j,k,a,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
                DAV_LX_temp_baa(j,k,a,auxind1) = DAV_temp_2ii_L_ija_baa(j,k,a,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

            PREPARE DAV_RX_aux_ija_baa(j,k,a,auxind1) += DAV_RX_temp_baa(j,k,a,auxind1)
            PREPARE DAV_LX_aux_ija_baa(j,k,a,auxind1) += DAV_LX_temp_baa(j,k,a,auxind1)




                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                  ENDDO root1
#---------| End of loop over iterations |--------------------------|
                  ENDDO niter

#---------------------------------------------------------------------|
#---------------------------------------------------------------------|

#--------| Contribution from Davidson correction |----------------|

#--------| Loop over roots |--------------------------------------|

                 cnt = 0.0
                 DO root1
                 cnt += 1.0
                 IF cnt > n_roots
                 EXIT
                 ENDIF

                 REQUEST DAV_RC_ija_baa(j,k,a,root1) j
                 REQUEST DAV_LC_ija_baa(j,k,a,root1) j
                 DAV_temp_R_ija_baa(j,k,a) = DAV_RC_ija_baa(j,k,a,root1)
                 DAV_temp_L_ija_baa(j,k,a) = DAV_LC_ija_baa(j,k,a,root1)
#--------| Auxiliary loop for indexing of elements of auxilary vectors |---|
                    iuu = 0.0
                    iuu += cnt
                    iuu += ist

                       cnt4 = 0.0
                       DO auxind2
                       cnt4 += 1.0
                       IF cnt4 == iuu

                          DAV_temp_2ii_R_ija_baa(j,k,a,auxind2) = 0.0
                          DAV_temp_2ii_L_ija_baa(j,k,a,auxind2) = 0.0

                          execute addrootindex DAV_temp_R_ija_baa DAV_temp_2ii_R_ija_baa
                          execute addrootindex DAV_temp_L_ija_baa DAV_temp_2ii_L_ija_baa
                          DAV_R_aux_temp(auxind2,auxind1) = DAV_R_aux(auxind2,auxind1)
                          DAV_L_aux_temp(auxind2,auxind1) = DAV_L_aux(auxind2,auxind1)

             DAV_RX_temp_baa(j,k,a,auxind1) = DAV_temp_2ii_R_ija_baa(j,k,a,auxind2)*DAV_R_aux_temp(auxind2,auxind1)
             DAV_LX_temp_baa(j,k,a,auxind1) = DAV_temp_2ii_L_ija_baa(j,k,a,auxind2)*DAV_L_aux_temp(auxind2,auxind1)

            PREPARE DAV_RX_aux_ija_baa(j,k,a,auxind1) += DAV_RX_temp_baa(j,k,a,auxind1)
            PREPARE DAV_LX_aux_ija_baa(j,k,a,auxind1) += DAV_LX_temp_baa(j,k,a,auxind1)



                       ENDIF
                       ENDDO auxind2
#---------| End of loop over roots |------------------------------|
                 ENDDO root1
#-----| End of loop over index of new approximations |------------|
                   ENDDO auxind1
#--------| End of loop over blocks of target new vector |---------|
                   ENDPARDO j,k,a
#-----------------------------------------------------------------|
           execute server_barrier

#-----------------------------------------------------------------|

           ENDPROC DAVDIAG
#          ---------------

#=========================================================================================
#   Selection of new approximations for |R> and <L|: root homing procedure               |
#=========================================================================================

           PROC ROOT_HOMING
#          ----------------

#--------------Step 1 - calculation of overlap table------------------------|



#--------| Find index of current iteration |-------------------------------|
               cnt_iter = 0.0
               DO niter
               cnt_iter += 1.0
               

               IF cnt_iter == iter

#-----------| Loop over roots of previous iteration |----------------------------|
           cnt = 0.0
           DO root1
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF


#-----------| Loop over auxiliary index of new approximation to |R> and <L| -----|
                  cnt2 = 0.0
                  izz = n_roots*iter
                  izz += n_roots
                  DO auxind1
                  cnt2 += 1.0 
                  IF cnt2 > izz          
                  EXIT  
                  ENDIF 
#----------------------------------------------------------------|
                  over_val_r = 0.0
                  over_val_l = 0.0

                 over_val_r_a = 0.0
                 over_val_l_a = 0.0
                 over_val_r_b = 0.0
                 over_val_l_b = 0.0
                 over_val_r_aaa = 0.0
                 over_val_l_aaa = 0.0
                 over_val_r_abb = 0.0
                 over_val_l_abb = 0.0
                 over_val_r_bbb = 0.0
                 over_val_l_bbb = 0.0
                 over_val_r_baa = 0.0
                 over_val_l_baa = 0.0

#-----------------------alpha-alpha part-------------------------|
                  ROVER_aux = 0.0
                  LOVER_aux = 0.0 

                  PARDO i
                    GET DAV_RX_aux_h_a(i,auxind1)                  
                    GET DAV_RX_h_a(i,root1,niter)
                    GET DAV_LX_aux_h_a(i,auxind1)
                    GET DAV_LX_h_a(i,root1,niter)

                    DAV_temp_R_h_a(i) = DAV_RX_aux_h_a(i,auxind1)
                    DAV_temp_RC_h_a(i) = DAV_RX_h_a(i,root1,niter)
                    DAV_temp_L_h_a(i) = DAV_LX_aux_h_a(i,auxind1)
                    DAV_temp_LC_h_a(i) = DAV_LX_h_a(i,root1,niter)

                    tmpval = DAV_temp_R_h_a(i)*DAV_temp_RC_h_a(i)
                    tmpval1 = DAV_temp_L_h_a(i)*DAV_temp_LC_h_a(i)
                    
                                        
                    ROVER_aux += tmpval
                    LOVER_aux += tmpval1                    

                  ENDPARDO i

 
                    execute server_barrier 
                    collective over_val_r_a += ROVER_aux
                    collective over_val_l_a += LOVER_aux

#-----------------------beta-beta part---------------------------|
                  ROVER_aux = 0.0
                  LOVER_aux = 0.0

                  PARDO j
                    GET DAV_RX_aux_h_b(j,auxind1)
                    GET DAV_RX_h_b(j,root1,niter)
                    GET DAV_LX_aux_h_b(j,auxind1)
                    GET DAV_LX_h_b(j,root1,niter)

                    DAV_temp_R_h_b(j) = DAV_RX_aux_h_b(j,auxind1)
                    DAV_temp_RC_h_b(j) = DAV_RX_h_b(j,root1,niter)
                    DAV_temp_L_h_b(j) = DAV_LX_aux_h_b(j,auxind1)
                    DAV_temp_LC_h_b(j) = DAV_LX_h_b(j,root1,niter)

                    tmpval = DAV_temp_R_h_b(j)*DAV_temp_RC_h_b(j)
                    tmpval1 = DAV_temp_L_h_b(j)*DAV_temp_LC_h_b(j)

                    ROVER_aux += tmpval
                    LOVER_aux += tmpval1

                  ENDPARDO j

                    execute server_barrier

                    collective over_val_r_b += ROVER_aux
                    collective over_val_l_b += LOVER_aux
#-----------------------alpha-alpha-alpha part-------------------|
                  ROVER_aux = 0.0
                  LOVER_aux = 0.0

                  PARDO i,k,a
                    REQUEST DAV_RX_aux_ija_aaa(i,k,a,auxind1) i
                    REQUEST DAV_RX_ija_aaa(i,k,a,root1,niter) i
                    REQUEST DAV_LX_aux_ija_aaa(i,k,a,auxind1) i
                    REQUEST DAV_LX_ija_aaa(i,k,a,root1,niter) i
 
                    DAV_temp_R_ija_aaa(i,k,a) = DAV_RX_aux_ija_aaa(i,k,a,auxind1)
                    DAV_temp_RC_ija_aaa(i,k,a) = DAV_RX_ija_aaa(i,k,a,root1,niter)
                    DAV_temp_L_ija_aaa(i,k,a) = DAV_LX_aux_ija_aaa(i,k,a,auxind1)
                    DAV_temp_LC_ija_aaa(i,k,a) = DAV_LX_ija_aaa(i,k,a,root1,niter) 

                    tmpval = DAV_temp_R_ija_aaa(i,k,a)*DAV_temp_RC_ija_aaa(i,k,a)
                    tmpval1 = DAV_temp_L_ija_aaa(i,k,a)*DAV_temp_LC_ija_aaa(i,k,a)

                    ROVER_aux += tmpval
                    LOVER_aux += tmpval1

                  ENDPARDO i,k,a

                    execute server_barrier

                    collective over_val_r_aaa += ROVER_aux
                    collective over_val_l_aaa += LOVER_aux  
#-----------------------beta-beta-beta part----------------------|
                  ROVER_aux = 0.0
                  LOVER_aux = 0.0

                  PARDO j,l,b
                    REQUEST DAV_RX_aux_ija_bbb(j,l,b,auxind1) j
                    REQUEST DAV_RX_ija_bbb(j,l,b,root1,niter) j
                    REQUEST DAV_LX_aux_ija_bbb(j,l,b,auxind1) j
                    REQUEST DAV_LX_ija_bbb(j,l,b,root1,niter) j

                    DAV_temp_R_ija_bbb(j,l,b) = DAV_RX_aux_ija_bbb(j,l,b,auxind1)
                    DAV_temp_RC_ija_bbb(j,l,b) = DAV_RX_ija_bbb(j,l,b,root1,niter)
                    DAV_temp_L_ija_bbb(j,l,b) = DAV_LX_aux_ija_bbb(j,l,b,auxind1)
                    DAV_temp_LC_ija_bbb(j,l,b) = DAV_LX_ija_bbb(j,l,b,root1,niter)

                    tmpval = DAV_temp_R_ija_bbb(j,l,b)*DAV_temp_RC_ija_bbb(j,l,b)
                    tmpval1 = DAV_temp_L_ija_bbb(j,l,b)*DAV_temp_LC_ija_bbb(j,l,b)

                    ROVER_aux += tmpval
                    LOVER_aux += tmpval1

                  ENDPARDO j,l,b

                    execute server_barrier

                    collective over_val_r_bbb += ROVER_aux
                    collective over_val_l_bbb += LOVER_aux
#-----------------------alpha-beta-beta part---------------------|
                  ROVER_aux = 0.0
                  LOVER_aux = 0.0

                  PARDO i,l,b
                    REQUEST DAV_RX_aux_ija_abb(i,l,b,auxind1) i
                    REQUEST DAV_RX_ija_abb(i,l,b,root1,niter) i
                    REQUEST DAV_LX_aux_ija_abb(i,l,b,auxind1) i
                    REQUEST DAV_LX_ija_abb(i,l,b,root1,niter) i

                    DAV_temp_R_ija_abb(i,l,b) = DAV_RX_aux_ija_abb(i,l,b,auxind1)
                    DAV_temp_RC_ija_abb(i,l,b) = DAV_RX_ija_abb(i,l,b,root1,niter)
                    DAV_temp_L_ija_abb(i,l,b) = DAV_LX_aux_ija_abb(i,l,b,auxind1)
                    DAV_temp_LC_ija_abb(i,l,b) = DAV_LX_ija_abb(i,l,b,root1,niter)

                    tmpval = DAV_temp_R_ija_abb(i,l,b)*DAV_temp_RC_ija_abb(i,l,b)
                    tmpval1 = DAV_temp_L_ija_abb(i,l,b)*DAV_temp_LC_ija_abb(i,l,b)

                    ROVER_aux += tmpval
                    LOVER_aux += tmpval1

                  ENDPARDO i,l,b

                    execute server_barrier 

                    collective over_val_r_abb += ROVER_aux
                    collective over_val_l_abb += LOVER_aux
#-----------------------beta-alpha-alpha part--------------------|
                  ROVER_aux = 0.0
                  LOVER_aux = 0.0

                  PARDO j,k,a

                   REQUEST DAV_RX_aux_ija_baa(j,k,a,auxind1) j
                    REQUEST DAV_RX_ija_baa(j,k,a,root1,niter) j
                    REQUEST DAV_LX_aux_ija_baa(j,k,a,auxind1) j
                    REQUEST DAV_LX_ija_baa(j,k,a,root1,niter) j

                    DAV_temp_R_ija_baa(j,k,a) = DAV_RX_aux_ija_baa(j,k,a,auxind1)
                    DAV_temp_RC_ija_baa(j,k,a) = DAV_RX_ija_baa(j,k,a,root1,niter)
                    DAV_temp_L_ija_baa(j,k,a) = DAV_LX_aux_ija_baa(j,k,a,auxind1)
                    DAV_temp_LC_ija_baa(j,k,a) = DAV_LX_ija_baa(j,k,a,root1,niter)

                    tmpval = DAV_temp_R_ija_baa(j,k,a)*DAV_temp_RC_ija_baa(j,k,a)
                    tmpval1 = DAV_temp_L_ija_baa(j,k,a)*DAV_temp_LC_ija_baa(j,k,a)

                    ROVER_aux += tmpval
                    LOVER_aux += tmpval1

                  ENDPARDO j,k,a
                  
                    execute server_barrier

                    collective over_val_r_baa += ROVER_aux
                    collective over_val_l_baa += LOVER_aux
#-----------------Overlap matrices-------------------------------|
                   over_val_r += over_val_r_a                    
                   over_val_r += over_val_r_b
                   over_val_r += over_val_r_aaa
                   over_val_r += over_val_r_bbb
                   over_val_r += over_val_r_abb
                   over_val_r += over_val_r_baa

                   over_val_l += over_val_l_a
                   over_val_l += over_val_l_b
                   over_val_l += over_val_l_aaa
                   over_val_l += over_val_l_bbb
                   over_val_l += over_val_l_abb
                   over_val_l += over_val_l_baa 

                   execute server_barrier   


                  OVER_R(auxind1,root1) = over_val_r 
                  OVER_L(auxind1,root1) = over_val_l
#----------------------------------------------------------------|
                  ENDDO auxind1
               ENDDO root1
           ENDIF    
           ENDDO niter

           execute server_barrier

#------------Define maximal overlaps----------------------------|

           chunk_type = 1.0
           RL = 1.0
           execute eomchunk RL chunk_type
           execute eomovertable OVER_R
           RL = 0.0
           execute eomchunk RL chunk_type
           execute eomovertable OVER_L

#---------------Step 2 - root homing itselfs--------------------|


#------| Loop over homing roots |-------------------------------|
           cnt = 0.0
           DO root1
           cnt += 1.0
           IF cnt > n_roots
           EXIT
           ENDIF

#------| Loop over new approximations for |R> and <L|-----------| 

                 chunk_type = 1.0
                 RL = 1.0
                 execute eomchunk RL chunk_type
                 execute eomovermax cnt maxover_r
                 RL = 0.0
                 execute eomchunk RL chunk_type
                 execute eomovermax cnt maxover_l

                  
#-----------Right eigenvectors----------------------------------|
                  cnt2 = 0.0   
                  DO auxind1
                  cnt2 += 1.0
                  IF cnt2 == maxover_r
                 
                     cnt3 = iter
                     cnt3 += 1.0
                     cnt4 = 0.0 
                     DO niter
                       cnt4 += 1.0
                       IF cnt4 == cnt3 
#--------------alpha-alpha part--------------------------------|
               PARDO i
                 DAV_temp_3i_R_h_a(i,root1,niter) = 0.0
                 GET DAV_RX_aux_h_a(i,auxind1)
                 DAV_temp_R_h_a(i) = DAV_RX_aux_h_a(i,auxind1)
                 execute addrootindex DAV_temp_R_h_a DAV_temp_3i_R_h_a
                 PUT DAV_RX_h_a(i,root1,niter) = DAV_temp_3i_R_h_a(i,root1,niter)
               ENDPARDO i

               execute sip_barrier
#--------------beta-beta part----------------------------------|
               PARDO j
                 DAV_temp_3i_R_h_b(j,root1,niter) = 0.0
                 GET DAV_RX_aux_h_b(j,auxind1)
                 DAV_temp_R_h_b(j) = DAV_RX_aux_h_b(j,auxind1)
                 execute addrootindex DAV_temp_R_h_b DAV_temp_3i_R_h_b
                 PUT DAV_RX_h_b(j,root1,niter) = DAV_temp_3i_R_h_b(j,root1,niter)
               ENDPARDO j

               execute sip_barrier
#--------------alpha-alpha-alpha part--------------------------|
               PARDO i,k,a
                 DAV_temp_3i_R_ija_aaa(i,k,a,root1,niter) = 0.0
                 REQUEST DAV_RX_aux_ija_aaa(i,k,a,auxind1) i
                 DAV_temp_R_ija_aaa(i,k,a) = DAV_RX_aux_ija_aaa(i,k,a,auxind1)
                 execute addrootindex DAV_temp_R_ija_aaa DAV_temp_3i_R_ija_aaa
                 PREPARE DAV_RX_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_R_ija_aaa(i,k,a,root1,niter)
               ENDPARDO i,k,a

               execute server_barrier
#--------------beta-beta-beta part-----------------------------|
               PARDO j,l,b
                 DAV_temp_3i_R_ija_bbb(j,l,b,root1,niter) = 0.0
                 REQUEST DAV_RX_aux_ija_bbb(j,l,b,auxind1) j
                 DAV_temp_R_ija_bbb(j,l,b) = DAV_RX_aux_ija_bbb(j,l,b,auxind1)
                 execute addrootindex DAV_temp_R_ija_bbb DAV_temp_3i_R_ija_bbb
                 PREPARE DAV_RX_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_R_ija_bbb(j,l,b,root1,niter)
               ENDPARDO j,l,b

               execute server_barrier
#--------------alpha-beta-beta part----------------------------|
               PARDO i,l,b
                 DAV_temp_3i_R_ija_abb(i,l,b,root1,niter) = 0.0
                 REQUEST DAV_RX_aux_ija_abb(i,l,b,auxind1) i
                 DAV_temp_R_ija_abb(i,l,b) = DAV_RX_aux_ija_abb(i,l,b,auxind1)
                 execute addrootindex DAV_temp_R_ija_abb DAV_temp_3i_R_ija_abb
                 PREPARE DAV_RX_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_R_ija_abb(i,l,b,root1,niter)
               ENDPARDO i,l,b

               execute server_barrier
#--------------beta-alpha-alpha part---------------------------|
               PARDO j,k,a
                 DAV_temp_3i_R_ija_baa(j,k,a,root1,niter) = 0.0
                 REQUEST DAV_RX_aux_ija_baa(j,k,a,auxind1) j
                 DAV_temp_R_ija_baa(j,k,a) = DAV_RX_aux_ija_baa(j,k,a,auxind1)
                 execute addrootindex DAV_temp_R_ija_baa DAV_temp_3i_R_ija_baa
                 PREPARE DAV_RX_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_R_ija_baa(j,k,a,root1,niter) 
               ENDPARDO j,k,a

               execute server_barrier
#--------------------------------------------------------------|
                       ENDIF 
                     ENDDO niter 
                  ENDIF
                  ENDDO auxind1


#-------------Left eigenvectors---------------------------------|
                  cnt2 = 0.0
                  DO auxind1
                  cnt2 += 1.0
                  IF cnt2 == maxover_l
   
                     cnt3 = iter
                     cnt3 += 1.0
                     cnt4 = 0.0
                     DO niter
                       cnt4 += 1.0
                       IF cnt4 == cnt3
#--------------alpha-alpha part--------------------------------|
               PARDO i
                 DAV_temp_3i_L_h_a(i,root1,niter) = 0.0     
                 GET DAV_LX_aux_h_a(i,auxind1)
                 DAV_temp_L_h_a(i) = DAV_LX_aux_h_a(i,auxind1)
                 execute addrootindex DAV_temp_L_h_a DAV_temp_3i_L_h_a
                 PUT DAV_LX_h_a(i,root1,niter) = DAV_temp_3i_L_h_a(i,root1,niter)
               ENDPARDO i

               execute sip_barrier
#--------------beta-beta part----------------------------------|
               PARDO j
                 DAV_temp_3i_L_h_b(j,root1,niter) = 0.0
                 GET DAV_LX_aux_h_b(j,auxind1)
                 DAV_temp_L_h_b(j) = DAV_LX_aux_h_b(j,auxind1)
                 execute addrootindex DAV_temp_L_h_b DAV_temp_3i_L_h_b  
                 PUT DAV_LX_h_b(j,root1,niter) = DAV_temp_3i_L_h_b(j,root1,niter)
               ENDPARDO j

               execute sip_barrier
#--------------alpha-alpha-alpha part--------------------------|
               PARDO i,k,a
               DAV_temp_3i_L_ija_aaa(i,k,a,root1,niter) = 0.0
               REQUEST DAV_LX_aux_ija_aaa(i,k,a,auxind1) i
               DAV_temp_L_ija_aaa(i,k,a) = DAV_LX_aux_ija_aaa(i,k,a,auxind1)
               execute addrootindex DAV_temp_L_ija_aaa DAV_temp_3i_L_ija_aaa
               PREPARE DAV_LX_ija_aaa(i,k,a,root1,niter) = DAV_temp_3i_L_ija_aaa(i,k,a,root1,niter)
               ENDPARDO i,k,a

               execute server_barrier
#--------------beta-beta-beta part-----------------------------|
               PARDO j,l,b
               DAV_temp_3i_L_ija_bbb(j,l,b,root1,niter) = 0.0
               REQUEST DAV_LX_aux_ija_bbb(j,l,b,auxind1) j
               DAV_temp_L_ija_bbb(j,l,b) = DAV_LX_aux_ija_bbb(j,l,b,auxind1)
               execute addrootindex DAV_temp_L_ija_bbb DAV_temp_3i_L_ija_bbb
               PREPARE DAV_LX_ija_bbb(j,l,b,root1,niter) = DAV_temp_3i_L_ija_bbb(j,l,b,root1,niter) 
               ENDPARDO j,l,b

               execute server_barrier
#--------------alpha-beta-beta part----------------------------|
               PARDO i,l,b
               DAV_temp_3i_L_ija_abb(i,l,b,root1,niter) = 0.0
               REQUEST DAV_LX_aux_ija_abb(i,l,b,auxind1) i
               DAV_temp_L_ija_abb(i,l,b) = DAV_LX_aux_ija_abb(i,l,b,auxind1)
               execute addrootindex DAV_temp_L_ija_abb DAV_temp_3i_L_ija_abb
               PREPARE DAV_LX_ija_abb(i,l,b,root1,niter) = DAV_temp_3i_L_ija_abb(i,l,b,root1,niter) 
               ENDPARDO i,l,b

               execute server_barrier
#--------------beta-alpha-alpha part---------------------------|
               PARDO j,k,a
               DAV_temp_3i_L_ija_baa(j,k,a,root1,niter) = 0.0
               REQUEST DAV_LX_aux_ija_baa(j,k,a,auxind1) j
               DAV_temp_L_ija_baa(j,k,a) = DAV_LX_aux_ija_baa(j,k,a,auxind1)
               execute addrootindex DAV_temp_L_ija_baa DAV_temp_3i_L_ija_baa
               PREPARE DAV_LX_ija_baa(j,k,a,root1,niter) = DAV_temp_3i_L_ija_baa(j,k,a,root1,niter)
               ENDPARDO j,k,a

               execute server_barrier
#--------------------------------------------------------------|
                       ENDIF
                     ENDDO niter
                  ENDIF
                  ENDDO auxind1


#------| End of loop over homing roots |-----------------------|
           ENDDO root1

           ENDPROC ROOT_HOMING
#          -------------------

#--------------------------------------------------------------------------------------------

#===============================================================|
#                    Main program                               |
#===============================================================|

      F12CALC = 1.0
 
      create DAV_R_h_a
      create DAV_R_h_b
      create DAV_L_h_a
      create DAV_L_h_b
      create DAV_RC_h_a
      create DAV_RC_h_b
      create DAV_LC_h_a
      create DAV_LC_h_b

      create DAV_RC_aux_h_a
      create DAV_RC_aux_h_b
      create DAV_LC_aux_h_a
      create DAV_LC_aux_h_b

      create DAV_R_initguess_h_a
      create DAV_R_initguess_h_b
      create DAV_L_initguess_h_a
      create DAV_L_initguess_h_b
      create DAV_RX_h_a
      create DAV_RX_h_b
      create DAV_LX_h_a
      create DAV_LX_h_b
      create DDii
      create DDjj
      create DDaa
      create DDbb
      create DAV_Hbar_diag_a
      create DAV_Hbar_diag_b
      create DAV_HR0_h_a
      create DAV_HR0_h_b
      create DAV_HR_prev_h_a
      create DAV_HR_prev_h_b
      create DAV_HRC_h_a
      create DAV_HRC_h_b
      create DAV_RX_aux_h_a
      create DAV_LX_aux_h_a
      create DAV_RX_aux_h_b
      create DAV_LX_aux_h_b 
      create I1ax
      create I1bx
      create Iax
      create Ibx

      execute sip_barrier

#       tresh_denom = 0.00000000001

#---------Read integrals and Hbar-------------------------------|

        CALL READ_DATA

#--------Auxiliary procedure for--------------------------------| 
#-------generation of diagonal elements of Hbar-----------------|

        CALL HBARAUXDIAG

#-------Set up parameters of the iterational procedure  --------|
        iter = 0.0
        iter_max = 20.0
        conv_true = 0.0
        n_roots = 1.0 
        cnt_target_roots = 0.0 
        execute eomiter iter n_roots
        execute sip_barrier
        execute server_barrier
#---------------------------------------------------------------|
#   Get number of target roots from ZMAT file                   |
#---------------------------------------------------------------|
        execute eomiproots n_target_roots       
#---------------------------------------------------------------|
#       Loop over target roots                                  |
#---------------------------------------------------------------|
         DO target_roots       
         cnt_target_roots += 1.0
         IF cnt_target_roots > n_target_roots
         EXIT
         ENDIF

         execute eomtargetroot iter cnt_target_roots
         iter = 0.0
#---------------------------------------------------------------|
#        Calculation of the initial guess                       |
#---------------------------------------------------------------|
        CALL INITGUESS_RL

#--------Set up markers-----------------------------------------|
        Mkcorr = 0.0
        Mkdav = 0.0
        Mkcorr1 = 0.0 
#---------------------------------------------------------------|

       CALL MAKE_Hbar_R

        CALL MAKE_HAUXMATR

#---------------------------------------------------------------|
#       Davidson iterations                                     |
#---------------------------------------------------------------|
        DO niter_main
        iter += 1.0
        IF iter > iter_max
        EXIT
        ENDIF

        execute eomiter iter n_roots
        execute sip_barrier
        execute server_barrier
#---------------------------------------------------------------|
        ist = n_roots*iter
#---------Set up markers----------------------------------------|
        Mkcorr =  1.0
        Mkdav =   0.0
        Mkcorr1 = 0.0

#---------- Calculation of the Davidson correction vector-------|

        CALL MAKE_Hbar_R
        CALL MAKE_L_Hbar

#------- Calculation of the norm of correction vectors ---------|
#------- and check for convergence -----------------------------|
        tresh = 0.000001
        
        CALL CONVCHECK
         
#-----------Bi-orthogonalization of correction vectors----------|
#--------------------- and Davidson vectors --------------------|
        CALL BIORTH   

#---------------------------------------------------------------|
#---------------------------------------------------------------|

#----------Hbar*|Davidson vector>-------------------------------|
#---------Set up markers----------------------------------------|
        Mkcorr =  0.0
        Mkdav  =  1.0
        Mkcorr1 = 0.0
#---------------------------------------------------------------|

        CALL MAKE_Hbar_R

#----------Hbar*|Correction vector>-----------------------------|
#---------Set up markers----------------------------------------|
        Mkcorr =  0.0
        Mkdav  =  0.0
        Mkcorr1 = 1.0
#---------------------------------------------------------------|

        CALL MAKE_Hbar_R
#---------------------------------------------------------------|
#---------------------------------------------------------------|


#-----------Formation of the intermediate matrix ---------------|
#------------ for the obtaining of new eigenvalues and new -----|
#--------------------- guess vectors ---------------------------|

        CALL MAKE_HAUXMATR

#---------------------------------------------------------------| 
#          Diagonalization of intermediate matrix               |
#          and construction of new vectors                      |
#---------------------------------------------------------------|

        CALL DAVDIAG

#---------------------------------------------------------------|
#            Root homing procedure                              |
#---------------------------------------------------------------|

        CALL ROOT_HOMING
#---------------------------------------------------------------|
#     Prepare arrays with energies and eigenvectors             |
#     for storage on disc. Then quit if convergence is reached  |
#---------------------------------------------------------------|     
        IF conv_true == 1.0   
#----------------------------------------|
          odin = 1.0

           cnt2 = 0.0

           DO root2
           cnt2 += 1.0
           IF cnt2 > odin
           EXIT
           ENDIF

#----------------------------------------|
#    Right eigenvectors                  |
#----------------------------------------|


#------------------------------------| 
           PARDO i
           DAV_temp_R_h_a_targ(i,target_roots) = 0.0 
           GET DAV_RX_h_a(i,root2,niter_main)
           DAV_temp_R_h_a(i) = DAV_RX_h_a(i,root2,niter_main)
           execute addrootindex DAV_temp_R_h_a DAV_temp_R_h_a_targ
           PREPARE IP_EVEC_R_h_a(i,target_roots) = DAV_temp_R_h_a_targ(i,target_roots) 
           ENDPARDO i

           execute server_barrier
#------------------------------------|
           PARDO j
           DAV_temp_R_h_b_targ(j,target_roots) = 0.0
           GET DAV_RX_h_b(j,root2,niter_main)
           DAV_temp_R_h_b(j) = DAV_RX_h_b(j,root2,niter_main)
           execute addrootindex DAV_temp_R_h_b DAV_temp_R_h_b_targ
           PREPARE IP_EVEC_R_h_b(j,target_roots) = DAV_temp_R_h_b_targ(j,target_roots)
           ENDPARDO j

           execute server_barrier
#------------------------------------|
           PARDO i,k,a
           DAV_RX_temp_aaa_targ(i,k,a,target_roots) = 0.0
           REQUEST DAV_RX_ija_aaa(i,k,a,root2,niter_main) i
           DAV_temp_R_ija_aaa(i,k,a) = DAV_RX_ija_aaa(i,k,a,root2,niter_main)
           execute addrootindex DAV_temp_R_ija_aaa DAV_RX_temp_aaa_targ
           PREPARE IP_EVEC_R_ija_aaa(i,k,a,target_roots) = DAV_RX_temp_aaa_targ(i,k,a,target_roots)
           ENDPARDO i,k,a

           execute server_barrier

           PARDO j,l,b
           DAV_RX_temp_bbb_targ(j,l,b,target_roots) = 0.0
           REQUEST DAV_RX_ija_bbb(j,l,b,root2,niter_main) j
           DAV_temp_R_ija_bbb(j,l,b) = DAV_RX_ija_bbb(j,l,b,root2,niter_main)
           execute addrootindex DAV_temp_R_ija_bbb DAV_RX_temp_bbb_targ
           PREPARE IP_EVEC_R_ija_bbb(j,l,b,target_roots) = DAV_RX_temp_bbb_targ(j,l,b,target_roots)
           ENDPARDO j,l,b

           execute server_barrier
           
           PARDO i,j,b
           DAV_RX_temp_abb_targ(i,j,b,target_roots) = 0.0
           REQUEST DAV_RX_ija_abb(i,j,b,root2,niter_main) i
           DAV_temp_R_ija_abb(i,j,b) = DAV_RX_ija_abb(i,j,b,root2,niter_main)
           execute addrootindex DAV_temp_R_ija_abb DAV_RX_temp_abb_targ
           PREPARE IP_EVEC_R_ija_abb(i,j,b,target_roots) = DAV_RX_temp_abb_targ(i,j,b,target_roots)
           ENDPARDO i,j,b

           execute server_barrier

           PARDO j,i,a
           DAV_RX_temp_baa_targ(j,i,a,target_roots) = 0.0
           REQUEST DAV_RX_ija_baa(j,i,a,root2,niter_main) j
           DAV_temp_R_ija_baa(j,i,a) = DAV_RX_ija_baa(j,i,a,root2,niter_main)  
           execute addrootindex DAV_temp_R_ija_baa DAV_RX_temp_baa_targ
           PREPARE IP_EVEC_R_ija_baa(j,i,a,target_roots) = DAV_RX_temp_baa_targ(j,i,a,target_roots)
           ENDPARDO j,i,a 
           
           execute server_barrier
#----------------------------------------|
#     Left eigenvectors                  |
#----------------------------------------|

           PARDO i
           DAV_temp_L_h_a_targ(i,target_roots) = 0.0
           GET DAV_LX_h_a(i,root2,niter_main)
           DAV_temp_L_h_a(i) = DAV_LX_h_a(i,root2,niter_main)
           execute addrootindex DAV_temp_L_h_a DAV_temp_L_h_a_targ
           PREPARE IP_EVEC_L_h_a(i,target_roots) = DAV_temp_L_h_a_targ(i,target_roots)
           ENDPARDO i

           execute server_barrier
#------------------------------------|
           PARDO j
           DAV_temp_L_h_b_targ(j,target_roots) = 0.0
           GET DAV_LX_h_b(j,root2,niter_main)
           DAV_temp_L_h_b(j) = DAV_LX_h_b(j,root2,niter_main)
           execute addrootindex DAV_temp_L_h_b DAV_temp_L_h_b_targ
           PREPARE IP_EVEC_L_h_b(j,target_roots) = DAV_temp_L_h_b_targ(j,target_roots)
           ENDPARDO j

           execute server_barrier
#------------------------------------|

           PARDO i,k,a
           DAV_LX_temp_aaa_targ(i,k,a,target_roots) = 0.0
           REQUEST DAV_LX_ija_aaa(i,k,a,root2,niter_main) i
           DAV_temp_L_ija_aaa(i,k,a) = DAV_LX_ija_aaa(i,k,a,root2,niter_main)
           execute addrootindex DAV_temp_L_ija_aaa DAV_LX_temp_aaa_targ
           PREPARE IP_EVEC_L_ija_aaa(i,k,a,target_roots) = DAV_LX_temp_aaa_targ(i,k,a,target_roots)
           ENDPARDO i,k,a

           execute server_barrier

           PARDO j,l,b
           DAV_LX_temp_bbb_targ(j,l,b,target_roots) = 0.0
           REQUEST DAV_LX_ija_bbb(j,l,b,root2,niter_main) j
           DAV_temp_L_ija_bbb(j,l,b) = DAV_LX_ija_bbb(j,l,b,root2,niter_main)
           execute addrootindex DAV_temp_L_ija_bbb DAV_LX_temp_bbb_targ
           PREPARE IP_EVEC_L_ija_bbb(j,l,b,target_roots) = DAV_LX_temp_bbb_targ(j,l,b,target_roots)
           ENDPARDO j,l,b

           execute server_barrier

           PARDO i,j,b
           DAV_LX_temp_abb_targ(i,j,b,target_roots) = 0.0
           REQUEST DAV_LX_ija_abb(i,j,b,root2,niter_main) i
           DAV_temp_L_ija_abb(i,j,b) = DAV_LX_ija_abb(i,j,b,root2,niter_main)
           execute addrootindex DAV_temp_L_ija_abb DAV_LX_temp_abb_targ
           PREPARE IP_EVEC_L_ija_abb(i,j,b,target_roots) = DAV_LX_temp_abb_targ(i,j,b,target_roots)
           ENDPARDO i,j,b

           execute server_barrier

           PARDO j,i,a
           DAV_LX_temp_baa_targ(j,i,a,target_roots) = 0.0
           REQUEST DAV_LX_ija_baa(j,i,a,root2,niter_main) j
           DAV_temp_L_ija_baa(j,i,a) = DAV_LX_ija_baa(j,i,a,root2,niter_main)
           execute addrootindex DAV_temp_L_ija_baa DAV_LX_temp_baa_targ
           PREPARE IP_EVEC_L_ija_baa(j,i,a,target_roots) = DAV_LX_temp_baa_targ(j,i,a,target_roots)
           ENDPARDO j,i,a

           execute server_barrier
          
           ENDDO root2

        EXIT
        ENDIF
#---------------------------------------------------------------| 
        ENDDO niter_main 
#---------------------------------------------------------------|
#   Copy computed eigenvalue to the static array                |
#---------------------------------------------------------------|
        DO kk1 
        ip_eomcc_info(kk1,target_roots) = EIG
        ENDDO kk1

        DO kk1
        execute eomgetroot odin EIG
        tmp_IP_EVAL(kk1,target_roots) = EIG
        PREPARE IP_EVAL(kk1,target_roots) = tmp_IP_EVAL(kk1,target_roots)
        ENDDO kk1

        execute server_barrier
#---------------------------------------------------------------|


#---------------------------------------------------------------|
#          End of loop over target roots                        |
#---------------------------------------------------------------|
        ENDDO target_roots
#---------------------------------------------------------------|
#                    ...Done !!!                                |
#---------------------------------------------------------------|
        execute server_barrier 
#---------------------------------------------------------------|
#       Print out eigenvalues to the file                       |
#---------------------------------------------------------------|
        printnumber = 41.0

        execute print_rel_info printnumber ip_eomcc_info
#---------------------------------------------------------------|

         cnt_target_roots = 0.0         

         DO target_roots
         cnt_target_roots += 1.0
         IF cnt_target_roots > n_target_roots
 
         DO kk1
         tmp_IP_EVAL(kk1,target_roots) = 0.0
         PREPARE IP_EVAL(kk1,target_roots) = tmp_IP_EVAL(kk1,target_roots)
         ENDDO kk1 

         execute server_barrier
#------------------------------------|
           PARDO i
           DAV_temp_R_h_a_targ(i,target_roots) = 0.0
           PREPARE IP_EVEC_R_h_a(i,target_roots) = DAV_temp_R_h_a_targ(i,target_roots)
           PREPARE IP_EVEC_L_h_a(i,target_roots) = DAV_temp_R_h_a_targ(i,target_roots)
           ENDPARDO i
#------------------------------------|
           PARDO j
           DAV_temp_R_h_b_targ(j,target_roots) = 0.0
           PREPARE IP_EVEC_R_h_b(j,target_roots) = DAV_temp_R_h_b_targ(j,target_roots)
           PREPARE IP_EVEC_L_h_b(j,target_roots) = DAV_temp_R_h_b_targ(j,target_roots)
           ENDPARDO j
#------------------------------------|
           PARDO i,k,a
           DAV_RX_temp_aaa_targ(i,k,a,target_roots) = 0.0
           PREPARE IP_EVEC_R_ija_aaa(i,k,a,target_roots) = DAV_RX_temp_aaa_targ(i,k,a,target_roots)
           PREPARE IP_EVEC_L_ija_aaa(i,k,a,target_roots) = DAV_RX_temp_aaa_targ(i,k,a,target_roots)
           ENDPARDO i,k,a

           PARDO j,l,b
           DAV_RX_temp_bbb_targ(j,l,b,target_roots) = 0.0
           PREPARE IP_EVEC_R_ija_bbb(j,l,b,target_roots) = DAV_RX_temp_bbb_targ(j,l,b,target_roots)
           PREPARE IP_EVEC_L_ija_bbb(j,l,b,target_roots) = DAV_RX_temp_bbb_targ(j,l,b,target_roots)
           ENDPARDO j,l,b

           PARDO i,j,b
           DAV_RX_temp_abb_targ(i,j,b,target_roots) = 0.0
           PREPARE IP_EVEC_R_ija_abb(i,j,b,target_roots) = DAV_RX_temp_abb_targ(i,j,b,target_roots)
           PREPARE IP_EVEC_L_ija_abb(i,j,b,target_roots) = DAV_RX_temp_abb_targ(i,j,b,target_roots)
           ENDPARDO i,j,b

           PARDO j,i,a
           DAV_RX_temp_baa_targ(j,i,a,target_roots) = 0.0
           PREPARE IP_EVEC_R_ija_baa(j,i,a,target_roots) = DAV_RX_temp_baa_targ(j,i,a,target_roots)
           PREPARE IP_EVEC_L_ija_baa(j,i,a,target_roots) = DAV_RX_temp_baa_targ(j,i,a,target_roots)
           ENDPARDO j,i,a

#------------------------------------|
           execute server_barrier
         ENDIF


         ENDDO target_roots

#---------------------------------------------------------------|
#  Dump integrals, eigenvectors and eigenvalues to the disc     |
#---------------------------------------------------------------|

        execute blocks_to_list                VSaaai
        execute blocks_to_list                VSbbbj
        execute blocks_to_list                VSpipi(p,i,p1,i1)
        execute blocks_to_list                VSqjqj(q,j,q1,j1) 
        execute blocks_to_list                Vaabj
        execute blocks_to_list                Vbbai
        execute blocks_to_list                Vpiqj(p,i,q,j) 
        execute blocks_to_list                IP_EVAL
        execute blocks_to_list                IP_EVEC_R_h_a 
        execute blocks_to_list                IP_EVEC_R_h_b
        execute blocks_to_list                IP_EVEC_R_ija_aaa
        execute blocks_to_list                IP_EVEC_R_ija_bbb
        execute blocks_to_list                IP_EVEC_R_ija_abb
        execute blocks_to_list                IP_EVEC_R_ija_baa
        execute blocks_to_list                IP_EVEC_L_h_a
        execute blocks_to_list                IP_EVEC_L_h_a
        execute blocks_to_list                IP_EVEC_L_ija_aaa
        execute blocks_to_list                IP_EVEC_L_ija_bbb
        execute blocks_to_list                IP_EVEC_L_ija_abb
        execute blocks_to_list                IP_EVEC_L_ija_baa
#         IF F12CALC == 1.0
#      execute blocks_to_list Hbar_ijka_F12
#      execute blocks_to_list Hbar_ijka_F12S
#         ENDIF


        execute write_blocks_to_list
        execute server_barrier


#---------------------------------------------------------------|
                       ENDSIAL IP_EOMCCSDDAV_F12

